!function(t,e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define("JZZ",[],e);else{if(t.JZZ&&t.JZZ.MIDI)return;t.JZZ=e()}}(this,function(){function c(){this._orig=this,this._ready=!1,this._queue=[],this._err=[]}function p(t,e){setTimeout(function(){t._resume()},e)}function f(t){t._resume()}function l(t,e,n){t[n]=function(){var t=arguments,i=e._image();return this._push(f,[i]),i[n].apply(i,t)}}function _(t){t instanceof Function?t.apply(this):console.log(t)}function d(t){t instanceof Function?t.apply(this):console.log(t)}function m(t){this._break("closed"),t._resume()}function v(t){if(t.length){var e=t.shift();if(t.length){var n=this;this._slip(d,[function(){v.apply(n,[t])}])}try{this._repair(),e.apply(this)}catch(t){this._break(t.toString())}}else this._break()}function g(t,e){for(var n=0;n<t.length;n++)if(t[n]===e)return;t.push(e)}function y(t,e){for(var n=0;n<t.length;n++)if(t[n]===e)return void t.splice(n,1)}function w(){c.apply(this)}function M(t,e,n){if(void 0===e)return M(t,[],[]);if(t instanceof Object){for(var i=0;i<e.length;i++)if(e[i]===t)return n[i];var o;o=t instanceof Array?[]:{},e.push(t),n.push(o);for(var r in t)t.hasOwnProperty(r)&&(o[r]=M(t[r],e,n));return o}return t}function I(){var t,e;for(this._orig._info.engine=Z._type,this._orig._info.version=Z._version,this._orig._info.sysex=Z._sysex,this._orig._info.inputs=[],this._orig._info.outputs=[],S=[],O=[],Z._allOuts={},Z._allIns={},t=0;t<Z._outs.length;t++)(e=Z._outs[t]).engine=Z,Z._allOuts[e.name]=e,this._orig._info.outputs.push({name:e.name,manufacturer:e.manufacturer,version:e.version,engine:Z._type}),S.push(e);for(t=0;t<J._outs.length;t++)e=J._outs[t],this._orig._info.outputs.push({name:e.name,manufacturer:e.manufacturer,version:e.version,engine:e.type}),S.push(e);for(t=0;t<Z._ins.length;t++)(e=Z._ins[t]).engine=Z,Z._allIns[e.name]=e,this._orig._info.inputs.push({name:e.name,manufacturer:e.manufacturer,version:e.version,engine:Z._type}),O.push(e);for(t=0;t<J._ins.length;t++)e=J._ins[t],this._orig._info.inputs.push({name:e.name,manufacturer:e.manufacturer,version:e.version,engine:e.type}),O.push(e)}function C(){this._slip(I,[]),Z._refresh(this)}function E(t,e){if(void 0===t)return e.slice();var n,i,o=[];if(t instanceof RegExp){for(i=0;i<e.length;i++)t.test(e[i].name)&&o.push(e[i]);return o}for(t instanceof Function&&(t=t(e)),t instanceof Array||(t=[t]),n=0;n<t.length;n++)for(i=0;i<e.length;i++)(t[n]+""==i+""||t[n]===e[i].name||t[n]instanceof Object&&t[n].name===e[i].name)&&o.push(e[i]);return o}function A(t,e){var n;n=e instanceof RegExp?"Port matching "+e+" not found":e instanceof Object||void 0===e?"Port not found":'Port "'+e+'" not found',t._crash(n)}function B(t,e){var n=E(e,S);if(n.length){for(var o=0;o<n.length;o++)n[o]=function(t){return function(){t.engine._openOut(this,t.name)}}(n[o]);t._slip(v,[n]),t._resume()}else A(t,e)}function x(t,e){var n=E(e,O);if(n.length){for(var o=0;o<n.length;o++)n[o]=function(t){return function(){t.engine._openIn(this,t.name)}}(n[o]);t._slip(v,[n]),t._resume()}else A(t,e)}function P(t,e){t._slip(N,[e]),t._resume()}function q(){c.apply(this),this._handles=[],this._outs=[]}function L(t){this._receive(t)}function k(t){this._emit(t)}function D(t){t instanceof Function?g(this._orig._handles,t):g(this._orig._outs,t)}function z(t){void 0===t?(this._orig._handles=[],this._orig._outs=[]):t instanceof Function?y(this._orig._handles,t):y(this._orig._outs,t)}function F(t,e){this._orig._mpe||(this._orig._mpe=new bt),this._orig._mpe.setup(t,e)}function T(t,e){q.apply(this),this._port=t._orig,this._chan=e,l(this,this._port,"ch"),l(this,this._port,"mpe"),l(this,this._port,"connect"),l(this,this._port,"disconnect"),l(this,this._port,"close")}function j(t,e,n){q.apply(this),this._port=t._orig,this._master=e,this._band=n,l(this,this._port,"ch"),l(this,this._port,"mpe"),l(this,this._port,"connect"),l(this,this._port,"disconnect"),l(this,this._port,"close")}function W(){c.apply(this),this._handles=[],l(this,b,"refresh"),l(this,b,"openMidiOut"),l(this,b,"openMidiIn"),l(this,b,"onChange"),l(this,b,"close")}function N(t){t instanceof Function&&(this._orig._handles.length||Z._watch(),g(this._orig._handles,t))}function R(t){void 0===t?this._orig._handles=[]:y(this._orig._handles,t),this._orig._handles.length||Z._unwatch()}function V(t,e,n,i){if(function(t,e,n,i){var o;if(t.length!=n.length||e.length!=i.length)return!0;for(o=0;o<t.length;o++)if(t[o].name!=n[o].name)return!0;for(o=0;o<e.length;o++)if(e[o].name!=i[o].name)return!0;return!1}(t,e,n,i)){var o,r=[],s=[],u=[],a=[],h={};for(o=0;o<t.length;o++)h[t[o].name]=!0;for(o=0;o<n.length;o++)h[n[o].name]||r.push(n[o]);for(h={},o=0;o<n.length;o++)h[n[o].name]=!0;for(o=0;o<t.length;o++)h[t[o].name]||u.push(t[o]);for(h={},o=0;o<e.length;o++)h[e[o].name]=!0;for(o=0;o<i.length;o++)h[i[o].name]||s.push(i[o]);for(h={},o=0;o<i.length;o++)h[i[o].name]=!0;for(o=0;o<e.length;o++)h[e[o].name]||a.push(e[o]);return r.length||u.length||s.length||a.length?{inputs:{added:r,removed:u},outputs:{added:s,removed:a}}:void 0}}function G(e){for(t=0;t<b._watcher._handles.length;t++)b._watcher._handles[t].apply(b,[e])}function H(){if("undefined"!=typeof module&&module.exports)return t=require("jazz-midi"),Z._type="node",Z._main=t,Z._pool=[],Z._newPlugin=function(){return new t.MIDI},void et();var t;this._break()}function Q(){var t=document.createElement("div");t.style.visibility="hidden",document.body.appendChild(t);var e,n=document.createElement("object");if(n.style.visibility="hidden",n.style.width="0px",n.style.height="0px",n.classid="CLSID:1ACE1618-1C7D-4561-AEE1-34842AA85E90",n.type="audio/x-jazz",document.body.appendChild(n),n.isJazz)return e=n,Z._type="plugin",Z._main=e,Z._pool=[e],Z._newPlugin=function(){var t=document.createElement("object");return t.style.visibility="hidden",t.style.width="0px",e.style.height="0px",t.classid="CLSID:1ACE1618-1C7D-4561-AEE1-34842AA85E90",t.type="audio/x-jazz",document.body.appendChild(t),t.isJazz?t:void 0},void et();this._break()}function U(){if(navigator.requestMIDIAccess){var t=this;return navigator.requestMIDIAccess({}).then(function(e){nt(e),t._resume()},function(e){t._crash(e)}),void this._pause()}this._break()}function K(){if(navigator.requestMIDIAccess){var t=this;return navigator.requestMIDIAccess({sysex:!0}).then(function(e){nt(e,!0),t._resume()},function(e){t._crash(e)}),void this._pause()}this._break()}function X(){var t,e,n=this;this._pause(),document.addEventListener("jazz-midi-msg",function i(o){if(t=!0,e||(e=document.getElementById("jazz-midi-msg")),e){var r,s,u,a=[];try{a=JSON.parse(e.innerText)}catch(t){}e.innerText="",document.removeEventListener("jazz-midi-msg",i),"version"===a[0]?(r=e,s=a[2],Z._type="extension",Z._version=s,Z._sysex=!0,Z._pool=[],Z._outs=[],Z._ins=[],Z._inArr=[],Z._outArr=[],Z._inMap={},Z._outMap={},Z._outsW=[],Z._insW=[],Z.refreshClients=[],Z._msg=r,Z._newPlugin=function(){var t={id:Z._pool.length};t.id?document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["new"]})):t.ready=!0,Z._pool.push(t)},Z._newPlugin(),Z._refresh=function(t){Z.refreshClients.push(t),t._pause(),setTimeout(function(){document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["refresh"]}))},0)},_closeAll=function(){for(var t=0;t<this.clients.length;t++)this._close(this.clients[t])},Z._openOut=function(t,e){var n=Z._outMap[e];if(!n){Z._pool.length<=Z._outArr.length&&Z._newPlugin();var i=Z._pool[Z._outArr.length];(n={name:e,clients:[],info:{name:e,manufacturer:Z._allOuts[e].manufacturer,version:Z._allOuts[e].version,type:"MIDI-out",sysex:Z._sysex,engine:Z._type},_start:function(){document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["openout",i.id,e]}))},_close:function(t){Z._closeOut(t)},_closeAll:_closeAll,_receive:function(t){var e=t.slice();e.splice(0,0,"play",i.id),document.dispatchEvent(new CustomEvent("jazz-midi",{detail:e}))}}).plugin=i,i.output=n,Z._outArr.push(n),Z._outMap[e]=n}t._orig._impl=n,g(n.clients,t._orig),t._info=n.info,t._receive=function(t){n._receive(t)},t._close=function(){n._close(this)},n.open||(n.plugin.ready&&n._start(),t._pause())},Z._openIn=function(t,e){var n=Z._inMap[e];if(!n){Z._pool.length<=Z._inArr.length&&Z._newPlugin();var i=Z._pool[Z._inArr.length];(n={name:e,clients:[],info:{name:e,manufacturer:Z._allIns[e].manufacturer,version:Z._allIns[e].version,type:"MIDI-in",sysex:Z._sysex,engine:Z._type},_start:function(){document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["openin",i.id,e]}))},_close:function(t){Z._closeIn(t)},_closeAll:_closeAll}).plugin=i,i.input=n,Z._inArr.push(n),Z._inMap[e]=n}t._orig._impl=n,g(n.clients,t._orig),t._info=n.info,t._close=function(){n._close(this)},n.open||(n.plugin.ready&&n._start(),t._pause())},Z._closeOut=function(t){var e=t._impl;y(e.clients,t._orig),e.clients.length||(e.open=!1,document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["closeout",e.plugin.id]})))},Z._closeIn=function(t){var e=t._impl;y(e.clients,t._orig),e.clients.length||(e.open=!1,document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["closein",e.plugin.id]})))},Z._close=function(){},Z._watch=function(){Z._insW=Z._ins,Z._outsW=Z._outs,u=setInterval(function(){document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["refresh"]}))},250)},Z._unwatch=function(){clearInterval(u),u=void 0},document.addEventListener("jazz-midi-msg",function(t){var e,n,i,o=Z._msg.innerText.split("\n");for(Z._msg.innerText="",n=0;n<o.length;n++){var r=[];try{r=JSON.parse(o[n])}catch(t){}if(r.length)if("refresh"===r[0]){if(r[1].ins){for(i=0;i<r[1].ins.length;i++)r[1].ins[i].type=Z._type;Z._ins=r[1].ins}if(r[1].outs){for(i=0;i<r[1].outs.length;i++)r[1].outs[i].type=Z._type;Z._outs=r[1].outs}for(i=0;i<Z.refreshClients.length;i++)Z.refreshClients[i]._resume();Z.refreshClients=[];var s=V(Z._insW,Z._outsW,Z._ins,Z._outs);if(s){for(Z._insW=Z._ins,Z._outsW=Z._outs,i=0;i<s.inputs.removed.length;i++)(e=Z._inMap[s.inputs.removed[i].name])&&e._closeAll();for(i=0;i<s.outputs.removed.length;i++)(e=Z._outMap[s.outputs.removed[i].name])&&e._closeAll();u&&G(s)}}else if("version"===r[0]){var a=Z._pool[r[1]];a&&(a.ready=!0,a.input&&a.input._start(),a.output&&a.output._start())}else if("openout"===r[0]){if(e=Z._pool[r[1]].output)if(r[2]==e.name){if(e.open=!0,e.clients)for(i=0;i<e.clients.length;i++)e.clients[i]._resume()}else if(e.clients)for(i=0;i<e.clients.length;i++)e.clients[i]._crash()}else if("openin"===r[0]){if(e=Z._pool[r[1]].input)if(r[2]==e.name){if(e.open=!0,e.clients)for(i=0;i<e.clients.length;i++)e.clients[i]._resume()}else if(e.clients)for(i=0;i<e.clients.length;i++)e.clients[i]._crash()}else if("midi"===r[0]&&(e=Z._pool[r[1]].input)&&e.clients)for(i=0;i<e.clients.length;i++){var h=at(r.slice(3));e.clients[i]._emit(h)}}}),n._resume()):n._crash()}});try{document.dispatchEvent(new Event("jazz-midi"))}catch(t){}window.setTimeout(function(){t||n._crash()},0)}function Y(){this._pause();var t=this;setTimeout(function(){t._crash()},0)}function $(t){for(var e=[H,Y],n=function(t){var e=["extension","plugin","webmidi"];if(!t||!t.engine)return e;var n,i,o,r=t.engine instanceof Array?t.engine:[t.engine],s={},u=[],a=[];for(o=0;o<r.length;o++){var h=r[o].toString().toLowerCase();s[h]||(s[h]=!0,"none"===h&&(n=!0),"etc"===h&&(i=!0),i?a.push(h):u.push(h),y(e,h))}return(i||u.length||a.length)&&(n=!1),n?[]:u.concat(i?e:a)}(t),i=0;i<n.length;i++)"webmidi"==n[i]?(t&&!0===t.sysex&&e.push(K),t&&!0===t.sysex&&!0!==t.degrade||e.push(U)):"extension"==n[i]?e.push(X):"plugin"==n[i]&&e.push(Q);return e.push(tt),e}function tt(){Z._type="none",Z._sysex=!0,Z._refresh=function(){Z._outs=[],Z._ins=[]},Z._watch=function(){},Z._unwatch=function(){}}function et(){function n(){t&&(Z._refresh(),t=!1)}function i(e){t=!0,setTimeout(n,0)}var t;Z._inArr=[],Z._outArr=[],Z._inMap={},Z._outMap={},Z._outsW=[],Z._insW=[],Z._version=Z._main.version,Z._sysex=!0,_closeAll=function(){for(var t=0;t<this.clients.length;t++)this._close(this.clients[t])},Z._refresh=function(){var n,i;for(Z._outs=[],Z._ins=[],n=0;(i=Z._main.MidiOutInfo(n)).length;n++)Z._outs.push({type:Z._type,name:i[0],manufacturer:i[1],version:i[2]});for(n=0;(i=Z._main.MidiInInfo(n)).length;n++)Z._ins.push({type:Z._type,name:i[0],manufacturer:i[1],version:i[2]});var o=V(Z._insW,Z._outsW,Z._ins,Z._outs);if(o){for(e=0;e<o.inputs.removed.length;e++)impl=Z._inMap[o.inputs.removed[e].name],impl&&impl._closeAll();for(e=0;e<o.outputs.removed.length;e++)impl=Z._outMap[o.inputs.removed[e].name],impl&&impl._closeAll();Z._insW=Z._ins,Z._outsW=Z._outs,t&&G(o)}},Z._openOut=function(t,e){var n=Z._outMap[e];if(!n){Z._pool.length<=Z._outArr.length&&Z._pool.push(Z._newPlugin()),n={name:e,clients:[],info:{name:e,manufacturer:Z._allOuts[e].manufacturer,version:Z._allOuts[e].version,type:"MIDI-out",sysex:Z._sysex,engine:Z._type},_close:function(t){Z._closeOut(t)},_closeAll:_closeAll,_receive:function(t){this.plugin.MidiOutRaw(t.slice())}};var i=Z._pool[Z._outArr.length];n.plugin=i,Z._outArr.push(n),Z._outMap[e]=n}if(!n.open){var o=n.plugin.MidiOutOpen(e);if(o!==e)return o&&n.plugin.MidiOutClose(),void t._break();n.open=!0}t._orig._impl=n,g(n.clients,t._orig),t._info=n.info,t._receive=function(t){n._receive(t)},t._close=function(){n._close(this)}},Z._openIn=function(t,e){var n,i=Z._inMap[e];if(!i){Z._pool.length<=Z._inArr.length&&Z._pool.push(Z._newPlugin()),(i={name:e,clients:[],info:{name:e,manufacturer:Z._allIns[e].manufacturer,version:Z._allIns[e].version,type:"MIDI-in",sysex:Z._sysex,engine:Z._type},_close:function(t){Z._closeIn(t)},_closeAll:_closeAll,handle:function(t,e){for(var n=0;n<this.clients.length;n++){var i=at(e);this.clients[n]._emit(i)}}}).onmidi=(n=i,function(t,e){n.handle(t,e)});var o=Z._pool[Z._inArr.length];i.plugin=o,Z._inArr.push(i),Z._inMap[e]=i}if(!i.open){var r=i.plugin.MidiInOpen(e,i.onmidi);if(r!==e)return r&&i.plugin.MidiInClose(),void t._break();i.open=!0}t._orig._impl=i,g(i.clients,t._orig),t._info=i.info,t._close=function(){i._close(this)}},Z._closeOut=function(t){var e=t._impl;y(e.clients,t._orig),e.clients.length||(e.open=!1,e.plugin.MidiOutClose())},Z._closeIn=function(t){var e=t._impl;y(e.clients,t._orig),e.clients.length||(e.open=!1,e.plugin.MidiInClose())},Z._close=function(){for(var t=0;t<Z._inArr.length;t++)Z._inArr[t].open&&Z._inArr[t].plugin.MidiInClose();Z._unwatch()},Z._watch=function(){Z._main.OnConnectMidiIn(i),Z._main.OnConnectMidiOut(i),Z._main.OnDisconnectMidiIn(i),Z._main.OnDisconnectMidiOut(i)},Z._unwatch=function(){Z._main.OnConnectMidiIn(),Z._main.OnConnectMidiOut(),Z._main.OnDisconnectMidiIn(),Z._main.OnDisconnectMidiOut()}}function nt(t,n){var i;Z._type="webmidi",Z._version=43,Z._sysex=!!n,Z._access=t,Z._inMap={},Z._outMap={},Z._outsW=[],Z._insW=[],_closeAll=function(){for(var t=0;t<this.clients.length;t++)this._close(this.clients[t])},Z._refresh=function(){Z._outs=[],Z._ins=[],Z._access.outputs.forEach(function(t,e){Z._outs.push({type:Z._type,name:t.name,manufacturer:t.manufacturer,version:t.version})}),Z._access.inputs.forEach(function(t,e){Z._ins.push({type:Z._type,name:t.name,manufacturer:t.manufacturer,version:t.version})});var t=V(Z._insW,Z._outsW,Z._ins,Z._outs);if(t){for(e=0;e<t.inputs.removed.length;e++)impl=Z._inMap[t.inputs.removed[e].name],impl&&impl._closeAll();for(e=0;e<t.outputs.removed.length;e++)impl=Z._outMap[t.inputs.removed[e].name],impl&&impl._closeAll();Z._insW=Z._ins,Z._outsW=Z._outs,i&&G(t)}},Z._openOut=function(t,e){var n,i=Z._outMap[e];i||(i={name:e,clients:[],info:{name:e,manufacturer:Z._allOuts[e].manufacturer,version:Z._allOuts[e].version,type:"MIDI-out",sysex:Z._sysex,engine:Z._type},_close:function(t){Z._closeOut(t)},_closeAll:_closeAll,_receive:function(t){i.dev&&this.dev.send(t.slice())}}),Z._access.outputs.forEach(function(t,i){t.name===e&&(n=t)}),n?(i.dev=n,Z._outMap[e]=i,i.dev.open&&i.dev.open(),t._orig._impl=i,g(i.clients,t._orig),t._info=i.info,t._receive=function(t){i._receive(t)},t._close=function(){i._close(this)}):t._break()},Z._openIn=function(t,e){var n,i,o=Z._inMap[e];o||(o={name:e,clients:[],info:{name:e,manufacturer:Z._allIns[e].manufacturer,version:Z._allIns[e].version,type:"MIDI-in",sysex:Z._sysex,engine:Z._type},_close:function(t){Z._closeIn(t)},_closeAll:_closeAll,handle:function(t){for(var e=0;e<this.clients.length;e++){var n=at([].slice.call(t.data));this.clients[e]._emit(n)}}}),Z._access.inputs.forEach(function(t,i){t.name===e&&(n=t)}),n?(o.dev=n,o.dev.onmidimessage=(i=o,function(t){i.handle(t)}),Z._inMap[e]=o,o.dev.open&&o.dev.open(),t._orig._impl=o,g(o.clients,t._orig),t._info=o.info,t._close=function(){o._close(this)}):t._break()},Z._closeOut=function(t){var e=t._impl;y(e.clients,t._orig),e.clients.length||(e.dev&&e.dev.close&&e.dev.close(),e.dev=void 0)},Z._closeIn=function(t){var e=t._impl;y(e.clients,t._orig),e.clients.length||(e.dev&&e.dev.close&&e.dev.close(),e.dev=void 0)},Z._close=function(){},Z._watch=function(){Z._access.onstatechange=function(){i=!0,setTimeout(function(){i&&(Z._refresh(),i=!1)},0)}},Z._unwatch=function(){Z._access.onstatechange=void 0}}function ot(){var t=this instanceof ot?this:t=new ot;return ot.prototype.reset.apply(t,arguments),t}function rt(){29.97==this.type&&!this.second&&this.frame<2&&this.minute%10&&(this.frame=2)}function st(t){return[[24,25,29.97,30][t[7]>>1&3],(1&t[7])<<4|t[6],t[5]<<4|t[4],t[3]<<4|t[2],t[1]<<4|t[0]]}function ut(t){return t<10?"0"+t:t}function at(e){var n=this instanceof at?this:n=new at;if(e instanceof at?(n._from=e._from.slice(),n._mpe=e._mpe):n._from=[],!arguments.length)return n;var i=e instanceof Array?e:arguments;for(t=0;t<i.length;t++)o=i[t],1==t&&(n[0]>=128&&n[0]<=175&&(o=at.noteValue(o)),n[0]>=192&&n[0]<=207&&(o=at.programValue(o))),(o!=parseInt(o)||o<0||o>255)&&pt(i[t]),n.push(o);return n}function pt(t){throw RangeError("Bad MIDI value: "+t)}function ft(t){return(t!=parseInt(t)||t<0||t>15)&&pt(t),t}function lt(t,e){return(t!=parseInt(t)||t<0||t>127)&&pt(void 0===e?t:e),t}function _t(t){return(t!=parseInt(t)||t<0||t>16383)&&pt(t),127&t}function dt(t){return(t!=parseInt(t)||t<0||t>16383)&&pt(t),t>>7}function gt(t,e){var n,i;i=e,at[n=t]=function(){return new at(i.apply(0,arguments))},q.prototype[n]=function(){return this.send(i.apply(0,arguments)),this},T.prototype[t]=function(){return this.send(e.apply(0,[this._chan].concat(Array.prototype.slice.call(arguments)))),this},j.prototype[t]=function(){var t,n=Array.prototype.slice.call(arguments);n.length<e.length?n=[this._master].concat(n):(t=lt(at.noteValue(n[0],n[0])),n[0]=this._master);var i=e.apply(0,n);return i.mpe=t,this.send(i),this}}function bt(){var t=this instanceof bt?this:t=new bt;return t.reset(),arguments.length&&bt.prototype.setup.apply(t,arguments),t}function St(){if(!yt&&"undefined"!=typeof window){var t=window.AudioContext||window.webkitAudioContext;if(t){(yt=new t)&&!yt.createGain&&(yt.createGain=yt.createGainNode);var e=function(){if("running"!=yt.state){yt.resume();var t=yt.createOscillator(),n=yt.createGain();try{n.gain.value=0}catch(t){}n.gain.setTargetAtTime(0,yt.currentTime,.01),t.connect(n),n.connect(yt.destination),t.start||(t.start=t.noteOn),t.stop||(t.stop=t.noteOff),t.start(.1),t.stop(.11)}else document.removeEventListener("touchend",e),document.removeEventListener("mousedown",e),document.removeEventListener("keydown",e)};document.addEventListener("touchend",e),document.addEventListener("mousedown",e),document.addEventListener("keydown",e),e()}}}function xt(){}function Lt(){for(var t=new Array(64),e=0;e<64;e++)t[e]=Math.floor(16*Math.random()%16).toString(16).toUpperCase();return t.join("")}function kt(t,e){return e?(Et[t]||(Et[t]=Lt()),Et[t]):(Ct[t]||(Ct[t]=Lt()),Ct[t])}function Dt(){function e(e){return function(){Ot(new zt(e,t))}}function n(n){var i,o,r;for(i=0;i<n.inputs.added.length;i++)o=new Tt(n.inputs.added[i]),t.inputs.set(o.id,o),r=e(o),o.open().then(r,r);for(i=0;i<n.outputs.added.length;i++)o=new Ft(n.outputs.added[i]),t.outputs.set(o.id,o),r=e(o),o.open().then(r,r);for(i=0;i<n.inputs.removed.length;i++)(o=t.inputs.get(Et[n.inputs.removed[i].name])).close(),t.inputs.delete(o.id),Ot(new zt(o,t));for(i=0;i<n.outputs.removed.length;i++)(o=t.outputs.get(Ct[n.outputs.removed[i].name])).close(),t.outputs.delete(o.id),Ot(new zt(o,t))}this.sysexEnabled=!0,this.outputs=new qt,this.inputs=new qt;var t=this;Object.defineProperty(this,"onstatechange",{get:function(){return Ot},set:function(t){t instanceof Function?(Ot||it().onChange(n),Ot=t):Ot&&(it().onChange().disconnect(n),Ot=void 0)}})}function zt(t,e){this.bubbles=!1,this.cancelBubble=!1,this.cancelable=!1,this.currentTarget=e,this.defaultPrevented=!1,this.eventPhase=0,this.path=[],this.port=t,this.returnValue=!0,this.srcElement=e,this.target=e,this.timeStamp=h(),this.type="statechange"}function Ft(t){var e=this;this.type="output",this.name=t.name,this.manufacturer=t.manufacturer,this.version=t.version,this.id=kt(this.name,!1),this.state="disconnected",this.connection="closed",Object.defineProperty(this,"onstatechange",{get:function(){return At[e.name].onstatechange},set:function(t){Function,At[e.name].onstatechange=t}})}function Tt(t){var e=this;this.type="input",this.name=t.name,this.manufacturer=t.manufacturer,this.version=t.version,this.id=kt(this.name,!0),this.state="disconnected",this.connection="closed",Object.defineProperty(this,"onstatechange",{get:function(){return Bt[e.name].onstatechange},set:function(t){Function,Bt[e.name].onstatechange=t}})}var t,e,n,i,o,r="undefined"==typeof window?global:window,s="0.4.6",u=Date.now||function(){return(new Date).getTime()},a=u(),h="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return u()-a};c.prototype._exec=function(){for(;this._ready&&this._queue.length;){var t=this._queue.shift();this._orig._bad?this._orig._hope&&t[0]==d?(this._orig._hope=!1,t[0].apply(this,t[1])):(this._queue=[],this._orig._hope=!1):t[0]!=d&&t[0].apply(this,t[1])}},c.prototype._push=function(t,e){this._queue.push([t,e]),c.prototype._exec.apply(this)},c.prototype._slip=function(t,e){this._queue.unshift([t,e])},c.prototype._pause=function(){this._ready=!1},c.prototype._resume=function(){this._ready=!0,c.prototype._exec.apply(this)},c.prototype._break=function(t){this._orig._bad=!0,this._orig._hope=!0,t&&this._orig._err.push(t)},c.prototype._repair=function(){this._orig._bad=!1},c.prototype._crash=function(t){this._break(t),this._resume()},c.prototype.err=function(){return M(this._err)},c.prototype._image=function(){var t=function(){};t.prototype=this._orig;var e=new t;return e._ready=!1,e._queue=[],e},c.prototype.wait=function(t){if(!t)return this;var e=this._image();return this._push(p,[e,t]),e},c.prototype.and=function(t){return this._push(_,[t]),this},c.prototype.or=function(t){return this._push(d,[t]),this},c.prototype._info={},c.prototype.info=function(){var t=M(this._orig._info);return void 0===t.engine&&(t.engine="none"),void 0===t.sysex&&(t.sysex=!0),t},c.prototype.name=function(){return this.info().name},c.prototype.close=function(){var t=new c;return this._close&&this._push(this._close,[]),this._push(m,[t]),t},w.prototype=new c,w.prototype._info={name:"JZZ.js",ver:s,version:s};var b,S=[],O=[];w.prototype.refresh=function(){return this._push(C,[]),this},w.prototype.openMidiOut=function(t){var e=new q;return this._push(C,[]),this._push(B,[e,t]),e},w.prototype.openMidiIn=function(t){var e=new q;return this._push(C,[]),this._push(x,[e,t]),e},w.prototype.onChange=function(t){this._orig._watcher||(this._orig._watcher=new W);var e=this._orig._watcher._image();return this._push(P,[e,t]),e},w.prototype._close=function(){Z._close()},q.prototype=new c,q.prototype._filter=function(t){if(this._orig._mpe){var e,n=0;this._handles&&this._handles.length&&(n=this._handles.length,e=this._handles[0]),this._outs&&this._outs.length&&(n=this._outs.length,e=this._outs[0]),1!=n||e._mpe||(t=this._orig._mpe.filter(t))}return t},q.prototype._receive=function(t){this._emit(this._filter(t))},q.prototype.send=function(){return this._push(L,[at.apply(null,arguments)]),this},q.prototype.note=function(t,e,n,i){return this.noteOn(t,e,n),i&&this.wait(i).noteOff(t,e),this},q.prototype._emit=function(t){var e;for(e=0;e<this._handles.length;e++)this._handles[e].apply(this,[at(t)._stamp(this)]);for(e=0;e<this._outs.length;e++){var n=at(t);n._stamped(this._outs[e])||this._outs[e].send(n._stamp(this))}},q.prototype.emit=function(t){return this._push(k,[t]),this},q.prototype.connect=function(t){return this._push(D,[t]),this},q.prototype.disconnect=function(t){return this._push(z,[t]),this},q.prototype.ch=function(t){if(void 0===t)return this;if(t!=parseInt(t)||t<0||t>15)throw RangeError("Bad channel value: "+t+" (must be from 0 to 15)");var e=new T(this,t);return this._push(f,[e]),e},q.prototype.mpe=function(t,e){if(void 0===t&&void 0===e)return this;bt.validate(t,e);var n=e?new j(this,t,e):new T(this,t);return this._push(F,[t,e]),this._push(f,[n]),n},T.prototype=new q,T.prototype.channel=function(){return this._chan},T.prototype._receive=function(t){this._port._receive(t)},T.prototype.note=function(t,e,n){return this.noteOn(t,e),n&&this.wait(n).noteOff(t),this},j.prototype=new q,j.prototype.channel=function(){return this._master},j.prototype._receive=function(t){this._port._receive(t)},j.prototype.note=function(t,e,n){return this.noteOn(t,e),n&&this.wait(n).noteOff(t),this},W.prototype=new c,W.prototype.connect=function(t){return this._push(N,[t]),this},W.prototype.disconnect=function(t){return this._push(R,[t]),this};var Z={},J={_outs:[],_ins:[]},it=function(t){var e;return b||(e=t,St(),(b=new w)._options=e,b._push(v,[$(e)]),b.refresh(),b._push(function(){S.length||O.length||this._break()},[]),b._resume()),b};it.now=h,it.info=function(){return w.prototype.info()},it.Widget=function(t){var e=new q;if(t instanceof Object)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e._resume(),e},w.prototype.Widget=it.Widget,ot.prototype.reset=function(t){if(t instanceof ot)return this.setType(t.getType()),this.setHour(t.getHour()),this.setMinute(t.getMinute()),this.setSecond(t.getSecond()),this.setFrame(t.getFrame()),this.setQuarter(t.getQuarter()),this;var e=t instanceof Array?t:arguments;return this.setType(e[0]),this.setHour(e[1]),this.setMinute(e[2]),this.setSecond(e[3]),this.setFrame(e[4]),this.setQuarter(e[5]),this},ot.prototype.isFullFrame=function(){return 0==this.quarter||4==this.quarter},ot.prototype.getType=function(){return this.type},ot.prototype.getHour=function(){return this.hour},ot.prototype.getMinute=function(){return this.minute},ot.prototype.getSecond=function(){return this.second},ot.prototype.getFrame=function(){return this.frame},ot.prototype.getQuarter=function(){return this.quarter},ot.prototype.setType=function(t){if(void 0===t||24==t)this.type=24;else if(25==t)this.type=25;else if(29.97==t)this.type=29.97,rt.apply(this);else{if(30!=t)throw RangeError("Bad SMPTE frame rate: "+t);this.type=30}return this.frame>=this.type&&(this.frame=29.97==this.type?29:this.type-1),this},ot.prototype.setHour=function(t){if(void 0===t&&(t=0),t!=parseInt(t)||t<0||t>=24)throw RangeError("Bad SMPTE hours value: "+t);return this.hour=t,this},ot.prototype.setMinute=function(t){if(void 0===t&&(t=0),t!=parseInt(t)||t<0||t>=60)throw RangeError("Bad SMPTE minutes value: "+t);return this.minute=t,rt.apply(this),this},ot.prototype.setSecond=function(t){if(void 0===t&&(t=0),t!=parseInt(t)||t<0||t>=60)throw RangeError("Bad SMPTE seconds value: "+t);return this.second=t,rt.apply(this),this},ot.prototype.setFrame=function(t){if(void 0===t&&(t=0),t!=parseInt(t)||t<0||t>=this.type)throw RangeError("Bad SMPTE frame number: "+t);return this.frame=t,rt.apply(this),this},ot.prototype.setQuarter=function(t){if(void 0===t&&(t=0),t!=parseInt(t)||t<0||t>=8)throw RangeError("Bad SMPTE quarter frame: "+t);return this.quarter=t,this},ot.prototype.incrFrame=function(){return this.frame++,this.frame>=this.type&&(this.frame=0,++this.second>=60&&(this.second=0,++this.minute>=60&&(this.minute=0,this.hour=this.hour>=23?0:this.hour+1))),rt.apply(this),this},ot.prototype.decrFrame=function(){return!this.second&&2==this.frame&&29.97==this.type&&this.minute%10&&(this.frame=0),this.frame--,this.frame<0&&(this.frame=29.97==this.type?29:this.type-1,--this.second<0&&(this.second=59,--this.minute<0&&(this.minute=59,this.hour=this.hour?this.hour-1:23))),this},ot.prototype.incrQF=function(){return this.backwards=!1,this.quarter=this.quarter+1&7,0!=this.quarter&&4!=this.quarter||this.incrFrame(),this},ot.prototype.decrQF=function(){return this.backwards=!0,this.quarter=this.quarter+7&7,3!=this.quarter&&7!=this.quarter||this.decrFrame(),this},ot.prototype.read=function(t){if(t instanceof at||(t=at.apply(null,arguments)),240==t[0]&&127==t[1]&&1==t[3]&&1==t[4]&&247==t[9])return this.type=[24,25,29.97,30][t[5]>>5&3],this.hour=31&t[5],this.minute=t[6],this.second=t[7],this.frame=t[8],this.quarter=0,this._=void 0,this._b=void 0,this._f=void 0,!0;if(241==t[0]&&void 0!==t[1]){var e=t[1]>>4,n=15&t[1];return 0==e?7==this._&&(7==this._f&&(this.reset(st(this._a)),this.incrFrame()),this.incrFrame()):3==e?4==this._&&this.decrFrame():4==e?3==this._&&this.incrFrame():7==e&&0===this._&&(0===this._b&&(this.reset(st(this._a)),this.decrFrame()),this.decrFrame()),this._a||(this._a=[]),this._a[e]=n,this._f=this._f===e-1||0==e?e:void 0,this._b=this._b===e+1||7==e?e:void 0,this._=e,this.quarter=e,!0}return!1},ot.prototype.toString=function(){return[ut(this.hour),ut(this.minute),ut(this.second),ut(this.frame)].join(":")},it.SMPTE=ot,at.prototype=[],at.prototype.constructor=at;var ht={};at.noteValue=function(t){return void 0===t?void 0:ht[t.toString().toLowerCase()]},at.programValue=function(t){return t},at.freq=function(t,e){return void 0===e&&(e=440),e*Math.pow(2,(lt(at.noteValue(t),t)-69)/12)};var ct={c:0,d:2,e:4,f:5,g:7,a:9,b:11,h:11};for(n in ct)if(ct.hasOwnProperty(n))for(o=0;o<12&&!((i=ct[n]+12*o)>127);o++)ht[n+o]=i,i>0&&(ht[n+"b"+o]=i-1,ht[n+"bb"+o]=i-2),i<127&&(ht[n+"#"+o]=i+1,ht[n+"##"+o]=i+2);for(o=0;o<128;o++)ht[o]=o;var mt={noteOff:function(t,e,n){return void 0===n&&(n=64),[128+ft(t),lt(at.noteValue(e),e),lt(n)]},noteOn:function(t,e,n){return void 0===n&&(n=127),[144+ft(t),lt(at.noteValue(e),e),lt(n)]},aftertouch:function(t,e,n){return[160+ft(t),lt(at.noteValue(e),e),lt(n)]},control:function(t,e,n){return[176+ft(t),lt(e),lt(n)]},program:function(t,e){return[192+ft(t),lt(at.programValue(e),e)]},pressure:function(t,e){return[208+ft(t),lt(e)]},pitchBend:function(t,e){return[224+ft(t),_t(e),dt(e)]},bankMSB:function(t,e){return[176+ft(t),0,lt(e)]},bankLSB:function(t,e){return[176+ft(t),32,lt(e)]},modMSB:function(t,e){return[176+ft(t),1,lt(e)]},modLSB:function(t,e){return[176+ft(t),33,lt(e)]},breathMSB:function(t,e){return[176+ft(t),2,lt(e)]},breathLSB:function(t,e){return[176+ft(t),34,lt(e)]},footMSB:function(t,e){return[176+ft(t),4,lt(e)]},footLSB:function(t,e){return[176+ft(t),36,lt(e)]},portamentoMSB:function(t,e){return[176+ft(t),5,lt(e)]},portamentoLSB:function(t,e){return[176+ft(t),37,lt(e)]},volumeMSB:function(t,e){return[176+ft(t),7,lt(e)]},volumeLSB:function(t,e){return[176+ft(t),39,lt(e)]},balanceMSB:function(t,e){return[176+ft(t),8,lt(e)]},balanceLSB:function(t,e){return[176+ft(t),40,lt(e)]},panMSB:function(t,e){return[176+ft(t),10,lt(e)]},panLSB:function(t,e){return[176+ft(t),42,lt(e)]},expressionMSB:function(t,e){return[176+ft(t),11,lt(e)]},expressionLSB:function(t,e){return[176+ft(t),43,lt(e)]},damper:function(t,e){return[176+ft(t),64,e?127:0]},portamento:function(t,e){return[176+ft(t),65,e?127:0]},sostenuto:function(t,e){return[176+ft(t),66,e?127:0]},soft:function(t,e){return[176+ft(t),67,e?127:0]},allSoundOff:function(t){return[176+ft(t),120,0]},allNotesOff:function(t){return[176+ft(t),123,0]}},vt={mtc:function(t){return[241,function(t){var e;switch(!t.backwards&&t.quarter>=4?t.decrFrame():t.backwards&&t.quarter<4&&t.incrFrame(),t.quarter>>1){case 0:e=t.frame;break;case 1:e=t.second;break;case 2:e=t.minute;break;default:e=t.hour}
return 1&t.quarter?e>>=4:e&=15,7==t.quarter&&(25==t.type?e|=2:29.97==t.type?e|=4:30==t.type&&(e|=6)),!t.backwards&&t.quarter>=4?t.incrFrame():t.backwards&&t.quarter<4&&t.decrFrame(),e|t.quarter<<4}(t)]},songPosition:function(t){return[242,_t(t),dt(t)]},songSelect:function(t){return[243,lt(t)]},tune:function(){return[246]},clock:function(){return[248]},start:function(){return[250]},continue:function(){return[251]},stop:function(){return[252]},active:function(){return[254]},sxIdRequest:function(){return[240,126,127,6,1,247]},sxFullFrame:function(t){return[240,127,127,1,1,(e=t,25==e.type?32|e.hour:29.97==e.type?64|e.hour:30==e.type?96|e.hour:e.hour),t.getMinute(),t.getSecond(),t.getFrame(),247];var e},reset:function(){return[255]}};for(n in vt)vt.hasOwnProperty(n)&&gt(n,vt[n]);for(n in mt)mt.hasOwnProperty(n)&&gt(n,mt[n]);j.prototype.noteOn=function(t,e){var n=at.noteOn(this._master,t,e);return n._mpe=n[1],this.send(n),this},j.prototype.noteOff=function(t,e){var n=at.noteOff(this._master,t,e);return n._mpe=n[1],this.send(n),this},j.prototype.aftertouch=function(t,e){return this.send(at.aftertouch(this._master,t,e)),this};var yt,wt,Mt={a:10,b:11,c:12,d:13,e:14,f:15,A:10,B:11,C:12,D:13,E:14,F:15};for(n=0;n<16;n++)Mt[n]=n;at.prototype.getChannel=function(){var t=this[0];if(!(void 0===t||t<128||t>239))return 15&t},at.prototype.setChannel=function(t){var e=this[0];return void 0===e||e<128||e>239?this:(void 0!==(t=Mt[t])&&(this[0]=240&e|t),this)},at.prototype.getNote=function(){var t=this[0];if(!(void 0===t||t<128||t>175))return this[1]},at.prototype.setNote=function(t){var e=this[0];return void 0===e||e<128||e>175?this:(void 0!==(t=at.noteValue(t))&&(this[1]=t),this)},at.prototype.getVelocity=function(){var t=this[0];if(!(void 0===t||t<144||t>159))return this[2]},at.prototype.setVelocity=function(t){var e=this[0];return void 0===e||e<144||e>159?this:((t=parseInt(t))>=0&&t<128&&(this[2]=t),this)},at.prototype.getSysExChannel=function(){if(240==this[0])return this[2]},at.prototype.setSysExChannel=function(t){return 240==this[0]&&this.length>2&&(t=parseInt(t))>=0&&t<128&&(this[2]=t),this},at.prototype.isNoteOn=function(){var t=this[0];return!(void 0===t||t<144||t>159)&&this[2]>0},at.prototype.isNoteOff=function(){var t=this[0];return!(void 0===t||t<128||t>159)&&(t<144||0==this[2])},at.prototype.isSysEx=function(){return 240==this[0]},at.prototype.isFullSysEx=function(){return 240==this[0]&&247==this[this.length-1]},at.prototype.toString=function(){if(!this.length)return"empty";var t=function(t){for(var e=[],n=0;n<t.length;n++)e[n]=(t[n]<16?"0":"")+t[n].toString(16);return e.join(" ")}(this);if(this[0]<128)return t;var e={241:"MIDI Time Code",242:"Song Position",243:"Song Select",244:"Undefined",245:"Undefined",246:"Tune request",248:"Timing clock",249:"Undefined",250:"Start",251:"Continue",252:"Stop",253:"Undefined",254:"Active Sensing",255:"Reset"}[this[0]];if(e)return t+" -- "+e;var n=this[0]>>4;return(e={8:"Note Off",10:"Aftertouch",12:"Program Change",13:"Channel Aftertouch",14:"Pitch Wheel"}[n])?t+" -- "+e:9==n?t+" -- "+(this[2]?"Note On":"Note Off"):11!=n?t:((e={0:"Bank Select MSB",1:"Modulation Wheel MSB",2:"Breath Controller MSB",4:"Foot Controller MSB",5:"Portamento Time MSB",6:"Data Entry MSB",7:"Channel Volume MSB",8:"Balance MSB",10:"Pan MSB",11:"Expression Controller MSB",12:"Effect Control 1 MSB",13:"Effect Control 2 MSB",16:"General Purpose Controller 1 MSB",17:"General Purpose Controller 2 MSB",18:"General Purpose Controller 3 MSB",19:"General Purpose Controller 4 MSB",32:"Bank Select LSB",33:"Modulation Wheel LSB",34:"Breath Controller LSB",36:"Foot Controller LSB",37:"Portamento Time LSB",38:"Data Entry LSB",39:"Channel Volume LSB",40:"Balance LSB",42:"Pan LSB",43:"Expression Controller LSB",44:"Effect control 1 LSB",45:"Effect control 2 LSB",48:"General Purpose Controller 1 LSB",49:"General Purpose Controller 2 LSB",50:"General Purpose Controller 3 LSB",51:"General Purpose Controller 4 LSB",64:"Damper Pedal On/Off",65:"Portamento On/Off",66:"Sostenuto On/Off",67:"Soft Pedal On/Off",68:"Legato Footswitch",69:"Hold 2",70:"Sound Controller 1",71:"Sound Controller 2",72:"Sound Controller 3",73:"Sound Controller 4",74:"Sound Controller 5",75:"Sound Controller 6",76:"Sound Controller 7",77:"Sound Controller 8",78:"Sound Controller 9",79:"Sound Controller 10",80:"General Purpose Controller 5",81:"General Purpose Controller 6",82:"General Purpose Controller 7",83:"General Purpose Controller 8",84:"Portamento Control",88:"High Resolution Velocity Prefix",91:"Effects 1 Depth",92:"Effects 2 Depth",93:"Effects 3 Depth",94:"Effects 4 Depth",95:"Effects 5 Depth",96:"Data Increment",97:"Data Decrement",98:"Non-Registered Parameter Number LSB",99:"Non-Registered Parameter Number MSB",100:"Registered Parameter Number LSB",101:"Registered Parameter Number MSB",120:"All Sound Off",121:"Reset All Controllers",122:"Local Control On/Off",123:"All Notes Off",124:"Omni Mode Off",125:"Omni Mode On",126:"Mono Mode On",127:"Poly Mode On"}[this[1]])||(e="Undefined"),t+" -- "+e)},at.prototype._stamp=function(t){return this._from.push(t._orig?t._orig:t),this},at.prototype._unstamp=function(t){if(void 0===t)this._from=[];else{t._orig&&(t=t._orig);var e=this._from.indexOf(t);e>-1&&this._from.splice(e,1)}return this},at.prototype._stamped=function(t){t._orig&&(t=t._orig);for(var e=0;e<this._from.length;e++)if(this._from[e]==t)return!0;return!1},it.MIDI=at,bt.validate=function(t){var e=t instanceof Array?t:arguments;if(e[0]!=parseInt(e[0])||e[0]<0||e[0]>14)throw RangeError("Bad master channel value: "+e[0]);if(e[1]!=parseInt(e[1])||e[1]<0||e[0]+e[1]>15)throw RangeError("Bad zone size value: "+e[1])},bt.prototype.reset=function(){for(var t=0;t<16;t++)this[t]={band:0,master:t}},bt.prototype.setup=function(t,e){var n;bt.validate(t,e);var i=t+e;if((this[t].master!=t||this[t].band!=e)&&(e||this[t].band)){for(this[t].band?i<(n=t+this[t].band)&&(i=n):this[t].master==t-1?(n=t-1,i<(n+=this[n].band)&&(i=n),this[t-1]={band:0,master:t-1}):this[t].master!=t&&(n=this[t].master,i<(n+=this[n].band)&&(i=n),this[this[t].master].band=t-this[t].master-1),this[t].master=t,this[t].band=e,n=t+1;n<=t+e;n++)this[n].band&&i<n+this[n].band&&(i=n+this[n].band),this[n]={band:0,master:t};for(;n<=i;n++)this[n]={band:0,master:n}}},bt.prototype.filter=function(t){var e=t.getChannel();if(!this[e]||!this[this[e].master].band)return t;var n,i,o,r=this[e].master,s=this[r].band;if(void 0!==t._mpe){for(o=256,n=r+1;n<=r+s;n++)if(this[n].notes){for(o>this[n].notes.length&&(e=n,o=this[n].notes.length),i=0;i<this[n].notes.length;i++)if(this[n].notes[i]==t._mpe){e=n,o=-1;break}}else o>0&&(e=n,o=0);t.setChannel(e),t._mpe=void 0}return e==r?t:(t.isNoteOn()?(this[e].notes||(this[e].notes=[]),g(this[e].notes,t.getNote())):t.isNoteOff()&&this[e].notes&&y(this[e].notes,t.getNote()),t)},it.MPE=bt,it.lib={},it.lib.openMidiOut=function(t,e){var n=new q;return e._openOut(n,t),n},it.lib.openMidiIn=function(t,e){var n=new q;return e._openIn(n,t),n},it.lib.registerMidiOut=function(t,e){for(var n=e._info(t),i=0;i<J._outs.length;i++)if(J._outs[i].name==n.name)return!1;return n.engine=e,J._outs.push(n),b&&b._bad&&(b._repair(),b._resume()),!0},it.lib.registerMidiIn=function(t,e){for(var n=e._info(t),i=0;i<J._ins.length;i++)if(J._ins[i].name==n.name)return!1;return n.engine=e,J._ins.push(n),b&&b._bad&&(b._repair(),b._resume()),!0},it.lib.getAudioContext=function(){return St(),yt};var Ot,It=[],Ct={},Et={},At={},Bt={},Pt=r.Promise;"function"!=typeof Pt&&((Pt=function(t){this.executor=t}).prototype.then=function(t,e){"function"!=typeof t&&(t=function(){}),"function"!=typeof e&&(e=function(){}),this.executor(t,e)});var qt=r.Map;return"function"!=typeof qt&&((qt=function(){this.store={},this.keys=[]}).prototype.set=function(t,e){return void 0===this.store[t]&&this.keys.push(t),this.store[t]=e,this.size=this.keys.length,this},qt.prototype.get=function(t){return this.store[t]},qt.prototype.delete=function(t){delete this.store[t];var e=this.keys.indexOf(t);return e>-1&&this.keys.splice(e,1),this.size=this.keys.length,this},qt.prototype.forEach=function(t){var e,n=this.keys.length;for(e=0;e<n;e++)t(this.store[this.keys[e]])}),Dt.prototype.onstatechange=function(){},Ft.prototype.open=function(){var t=this;return new Pt(function(e,n){At[t.name]?e(t):(t._resolves||(t._resolves=[]),t._resolves.push(e),1==t._resolves.length&&it().openMidiOut(t.name).or(n).and(function(){At[t.name]=this,t.state="connected",t.connection="open";for(var n=0;n<t._resolves.length;n++)e(t._resolves[n]);delete t._resolves,t.onstatechange&&t.onstatechange(new zt(t,t))}))})},Ft.prototype.close=function(){var t=At[this.name];return t&&(t.close(),this.state="disconnected",this.connection="closed",this.onstatechange&&this.onstatechange(new zt(this,this)),At[this.name]=void 0),this},Ft.prototype.clear=function(){},Ft.prototype.send=function(t,e){var n=At[this.name];if(n){for(var i=[],o=0;o<t.length;o++){if(!(t[o]==Math.floor(t[o])&&t[o]>=0&&t[o]<=255))return;i.push(t[o])}e>h()?setTimeout(function(){n.send(i)},e-h()):n.send(i)}else{var r=this;r.open().then(function(){r.send(t,e)},xt)}},Tt.prototype.onmidimessage=function(){},Tt.prototype.open=function(){var t=this;return new Pt(function(e,n){Bt[t.name]?e(t):(t._resolves||(t._resolves=[]),t._resolves.push(e),1==t._resolves.length&&it().openMidiIn(t.name).or(n).and(function(){Bt[t.name]=this,t.state="connected",t.connection="open",this.connect(function(e){t.onmidimessage(new function(t,e){this.bubbles=!1,this.cancelBubble=!1,this.cancelable=!1,this.currentTarget=t,this.data=e,this.defaultPrevented=!1,this.eventPhase=0,this.path=[],this.receivedTime=h(),this.returnValue=!0,this.srcElement=t,this.target=t,this.timeStamp=this.receivedTime,this.type="midimessage"}(t,new Uint8Array(e)))});for(var n=0;n<t._resolves.length;n++)e(t._resolves[n]);delete t._resolves,t.onstatechange&&t.onstatechange(new zt(t,t))}))})},Tt.prototype.close=function(){var t=Bt[this.name];return t&&(t.close(),this.state="disconnected",this.connection="closed",this.onstatechange&&this.onstatechange(new zt(this,this)),Bt[this.name]=void 0),this.onmidimessage=Tt.prototype.onmidimessage,this},it.requestMIDIAccess=function(){function n(){wt=t;for(var e=0;e<It.length;e++)It[e](wt)}function i(){--e||n()}var t,e;return new Pt(function(o,r){wt?o(wt):(It.push(o),1==It.length&&(t=new Dt,it().or(n).and(function(){var n,o,r=this.info();for(e=r.inputs.length+r.outputs.length,n=0;n<r.outputs.length;n++)o=new Ft(r.outputs[n]),t.outputs.set(o.id,o),o.open().then(i,i);for(n=0;n<r.inputs.length;n++)o=new Tt(r.inputs[n]),t.inputs.set(o.id,o),o.open().then(i,i)})))})},"undefined"==typeof navigator||navigator.requestMIDIAccess||(navigator.requestMIDIAccess=it.requestMIDIAccess),it.close=function(){Z._close&&Z._close()},it});var saveAs=saveAs||"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(view){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var doc=view.document,get_URL=function(){return view.URL||view.webkitURL||view},URL=view.URL||view.webkitURL||view,save_link=doc.createElementNS("http://www.w3.org/1999/xhtml","a"),can_use_save_link=!view.externalHost&&"download"in save_link,webkit_req_fs=view.webkitRequestFileSystem,req_fs=view.requestFileSystem||webkit_req_fs||view.mozRequestFileSystem,throw_outside=function(ex){(view.setImmediate||view.setTimeout)(function(){throw ex},0)},fs_min_size=0,deletion_queue=[],process_deletion_queue=function(){for(var i=deletion_queue.length;i--;){var file=deletion_queue[i];"string"==typeof file?URL.revokeObjectURL(file):file.remove()}deletion_queue.length=0},dispatch=function(filesaver,event_types,event){event_types=[].concat(event_types);for(var i=event_types.length;i--;){var listener=filesaver["on"+event_types[i]];if("function"==typeof listener)try{listener.call(filesaver,event||filesaver)}catch(ex){throw_outside(ex)}}},FileSaver=function(blob,name){var object_url,target_view,slice,filesaver=this,type=blob.type,blob_changed=!1,get_object_url=function(){var object_url=get_URL().createObjectURL(blob);return deletion_queue.push(object_url),object_url},dispatch_all=function(){dispatch(filesaver,"writestart progress write writeend".split(" "))},fs_error=function(){!blob_changed&&object_url||(object_url=get_object_url()),target_view?target_view.location.href=object_url:window.open(object_url,"_blank"),filesaver.readyState=filesaver.DONE,dispatch_all()},abortable=function(func){return function(){if(filesaver.readyState!==filesaver.DONE)return func.apply(this,arguments)}},create_if_not_found={create:!0,exclusive:!1};if(filesaver.readyState=filesaver.INIT,name||(name="download"),can_use_save_link){object_url=get_object_url(),doc=view.document,save_link=doc.createElementNS("http://www.w3.org/1999/xhtml","a"),save_link.href=object_url,save_link.download=name;var event=doc.createEvent("MouseEvents");return event.initMouseEvent("click",!0,!1,view,0,0,0,0,0,!1,!1,!1,!1,0,null),save_link.dispatchEvent(event),filesaver.readyState=filesaver.DONE,void dispatch_all()}if(view.chrome&&type&&"application/octet-stream"!==type&&(slice=blob.slice||blob.webkitSlice,blob=slice.call(blob,0,blob.size,"application/octet-stream"),blob_changed=!0),webkit_req_fs&&"download"!==name&&(name+=".download"),("application/octet-stream"===type||webkit_req_fs)&&(target_view=view),!req_fs)return void fs_error();fs_min_size+=blob.size,req_fs(view.TEMPORARY,fs_min_size,abortable(function(fs){fs.root.getDirectory("saved",create_if_not_found,abortable(function(dir){var save=function(){dir.getFile(name,create_if_not_found,abortable(function(file){file.createWriter(abortable(function(writer){writer.onwriteend=function(event){target_view.location.href=file.toURL(),deletion_queue.push(file),filesaver.readyState=filesaver.DONE,dispatch(filesaver,"writeend",event)},writer.onerror=function(){var error=writer.error;error.code!==error.ABORT_ERR&&fs_error()},"writestart progress write abort".split(" ").forEach(function(event){writer["on"+event]=filesaver["on"+event]}),writer.write(blob),filesaver.abort=function(){writer.abort(),filesaver.readyState=filesaver.DONE},filesaver.readyState=filesaver.WRITING}),fs_error)}),fs_error)};dir.getFile(name,{create:!1},abortable(function(file){file.remove(),save()}),abortable(function(ex){ex.code===ex.NOT_FOUND_ERR?save():fs_error()}))}),fs_error)}),fs_error)},FS_proto=FileSaver.prototype,saveAs=function(blob,name){return new FileSaver(blob,name)};return FS_proto.abort=function(){var filesaver=this;filesaver.readyState=filesaver.DONE,dispatch(filesaver,"abort")},FS_proto.readyState=FS_proto.INIT=0,FS_proto.WRITING=1,FS_proto.DONE=2,FS_proto.error=FS_proto.onwritestart=FS_proto.onprogress=FS_proto.onwrite=FS_proto.onabort=FS_proto.onerror=FS_proto.onwriteend=null,view.addEventListener("unload",process_deletion_queue,!1),saveAs.unload=function(){process_deletion_queue(),view.removeEventListener("unload",process_deletion_queue,!1)},saveAs}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&null!==module?module.exports=saveAs:"undefined"!=typeof define&&null!==define&&null!=define.amd&&define([],function(){return saveAs}),function(){"use strict";var protectedScope,src,context,gainNode,compressor,os,browser,alert=window.alert,console=window.console,initMethods=[],webaudioUnlocked=!1,sampleIndex=0,compressorParams=["threshold","knee","ratio","reduction","attack","release"],ua=navigator.userAgent;if(ua.match(/(iPad|iPhone|iPod)/g)?os="ios":-1!==ua.indexOf("Android")?os="android":-1!==ua.indexOf("Linux")?os="linux":-1!==ua.indexOf("Macintosh")?os="osx":-1!==ua.indexOf("Windows")&&(os="windows"),-1!==ua.indexOf("Chrome")?(browser="chrome",-1!==ua.indexOf("OPR")?browser="opera":-1!==ua.indexOf("Chromium")&&(browser="chromium")):-1!==ua.indexOf("Safari")?browser="safari":-1!==ua.indexOf("Firefox")?browser="firefox":-1!==ua.indexOf("Trident")&&(browser="Internet Explorer"),"ios"===os&&-1!==ua.indexOf("CriOS")&&(browser="chrome"),console.log("heartbeat v0.0.3"),window.AudioContext)context=new window.AudioContext,void 0===context.createGainNode&&(context.createGainNode=context.createGain);else if(window.webkitAudioContext)context=new window.webkitAudioContext;else if(window.oAudioContext)context=new window.oAudioContext;else{if(!window.msAudioContext)return window.sequencer={browser:browser,os:os},alert("The WebAudio API hasn't been implemented in "+browser+", please use any other browser"),void(window.sequencer.ready=function(cb){cb()});context=new window.msAudioContext}src=context.createBufferSource(),src.start,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame,window.Blob=window.Blob||window.webkitBlob||window.mozBlob,compressor=context.createDynamicsCompressor(),compressor.connect(context.destination),gainNode=context.createGainNode(),gainNode.connect(context.destination),gainNode.gain.value=1,protectedScope={context:context,masterGainNode:gainNode,masterCompressor:compressor,useDelta:!1,timedTasks:{},scheduledTasks:{},repetitiveTasks:{},getSampleId:function(){return"S"+sampleIndex+++(new Date).getTime()},addInitMethod:function(method){initMethods.push(method)},callInitMethods:function(){var i,maxi=initMethods.length;for(i=0;i<maxi;i++)initMethods[i]()}},window.sequencer={name:"qambi",protectedScope:protectedScope,ui:{},ua:ua,os:os,browser:browser,legacy:!1,midi:!1,webmidi:!1,webaudio:!0,jazz:!1,ogg:!1,mp3:!1,record_audio:void 0!==navigator.getUserMedia,bitrate_mp3_encoding:128,util:{},debug:4,defaultInstrument:"sinewave",pitch:440,bufferTime:.35,autoAdjustBufferTime:!1,noteNameMode:"sharp",minimalSongLength:6e4,pauseOnBlur:!1,restartOnFocus:!0,defaultPPQ:960,overrulePPQ:!0,precision:3,midiInputs:{},midiOutputs:{},storage:{midi:{id:"midi"},audio:{id:"audio",recordings:{}},instruments:{id:"instruments"},samplepacks:{id:"samplepacks"},assetpacks:{id:"assetpacks"}},getAudioContext:function(){return context},getTime:function(){return context.currentTime},setMasterVolume:function(value){value=value<0?0:value>1?1:value,gainNode.gain.value=value},getMasterVolume:function(){return gainNode.gain.value},getCompressionReduction:function(){return compressor.reduction.value},enableMasterCompressor:function(flag){flag?(gainNode.disconnect(0),gainNode.connect(compressor),compressor.disconnect(0),compressor.connect(context.destination)):(compressor.disconnect(0),gainNode.disconnect(0),gainNode.connect(context.destination))},configureMasterCompressor:function(cfg){var i,param;for(i=compressorParams.length;i>=0;i--)param=compressorParams[i],void 0!==cfg[param]&&(compressor[param].value=cfg[param])},unlockWebAudio:function(){if(!0!==webaudioUnlocked){"function"==typeof context.resume&&context.resume();var src=context.createOscillator(),gainNode=context.createGainNode();gainNode.gain.value=0,src.connect(gainNode),gainNode.connect(context.destination),void 0!==src.noteOn&&(src.start=src.noteOn,src.stop=src.noteOff),src.start(0),src.stop(.001),webaudioUnlocked=!0}}},Object.defineProperty(sequencer,"ERROR",{value:1}),Object.defineProperty(sequencer,"WARN",{value:2}),Object.defineProperty(sequencer,"INFO",{value:3}),Object.defineProperty(sequencer,"LOG",{value:4})}(),function(){"use strict";function loadQueueLoop(index,onTaskQueueDone){function cbActionLoop(success){for(finishedTasks[task.id]=!0,i=callbacks.length-1;i>=0;i--)if(!1!==(callback=callbacks[i])&&void 0!==(taskIds=callback.taskIds)){for(performCallback=!0,j=taskIds.length-1;j>=0;j--)!0!==finishedTasks[taskIds[j]]&&(performCallback=!1);if(performCallback){var m=callback.method;callbacks[i]=!1,setTimeout(function(){m(success)},0)}}index++,loadQueueLoop(index,onTaskQueueDone)}var task,params,scope,i,j,callback,taskIds,performCallback;if(index===taskQueue.length){for(i=callbacks.length-1;i>=0;i--)if(!1!==(callback=callbacks[i])){var m=callback.method;setTimeout(function(){m()},0)}return finishedTasks={},taskQueue=[],callbacks=[],taskIndex=0,busy=!1,void(onTaskQueueDone&&(console.log("onTaskQueueDone"),onTaskQueueDone()))}task=taskQueue[index],scope=task.scope||null,params=task.params||[],"array"!==typeString(params)&&(params=[params]),params.push(cbActionLoop),task.method.apply(scope,params)}var loadLoop,findItem,storeItem,deleteItem,typeString,getArguments,isEmptyObject,objectForEach,storage,updateInstruments,findItemsInFolder,sequencer=window.sequencer,console=window.console,busy=!1,taskIndex=0,finishedTasks={},taskQueue=[],callbacks=[];sequencer.removeMidiFile=function(path){var item,i,folder,items=[];for("MidiFile"===path.className?(item=path,path=item.localPath):item=findItem(path,storage.midi),"MidiFile"===item.className?items.push(item):(folder=item,objectForEach(folder,function(item){"MidiFile"===item.className&&items.push(item)})),i=items.length-1;i>=0;i--)item=items[i],deleteItem(item.localPath,storage.midi)},sequencer.removeInstrument=function(path,unloadSamples){var item,i,folder,mapping,samplePath,items=[];if("InstrumentConfig"===path.className?(item=path,path=item.localPath):item=findItem(path,storage.instruments),"InstrumentConfig"===item.className)items.push(item);else{folder=item;for(i in folder)folder.hasOwnProperty(i)&&(item=folder[i],"InstrumentConfig"===item.className&&items.push(item))}for(i=items.length-1;i>=0;i--)item=items[i],mapping=item.mapping,samplePath=item.sample_path,!0===unloadSamples&&(objectForEach(mapping,function(value){deleteItem(samplePath+"/"+value.n,storage.audio)}),deleteItem(samplePath,storage.samplepacks)),deleteItem(item.localPath,storage.instruments);updateInstruments()},sequencer.removeSamplePack=function(path){var item,i,samples,sample,s,folder,items=[];for("SamplePack"===path.className?(item=path,path=item.localPath):item=findItem(path,storage.samplepacks),"SamplePack"===item.className?items.push(item):(folder=item,objectForEach(folder,function(item){"SamplePack"===item.className&&items.push(item)})),i=items.length-1;i>=0;i--){for(item=items[i],samples=item.samples,s=samples.length-1;s>=0;s--)sample=samples[s],deleteItem(sample.folder+"/"+sample.id,storage.audio);item.reset(),deleteItem(item.localPath,storage.samplepacks)}updateInstruments()},sequencer.removeAssetPack=function(path){var item,folder;"AssetPack"===path.className?(item=path,path=item.localPath):item=findItem(path,storage.assetpacks),"AssetPack"===item.className?item.unload():(folder=item,objectForEach(folder,function(item){"AssetPack"===item.className&&item.unload()}))},sequencer.startTaskQueue=function(cb){!0!==busy&&(busy=!0,loadQueueLoop(0,cb))},sequencer.addTask=function(task,callback,callbackAfterAllTasksAreDone){return task.id="task"+taskIndex++,taskQueue.push(task),void 0!==callback&&(!0===callbackAfterAllTasksAreDone?sequencer.addCallbackAfterTask(callback):sequencer.addCallbackAfterTask(callback,[task.id])),task.id},sequencer.addCallbackAfterTask=function(callback,taskIds){callbacks.push({method:callback,taskIds:taskIds})},sequencer.getInstrument=function(path,exact_match){return findItem(path,storage.instruments,exact_match)},sequencer.getMidiFile=function(path,exact_match){return findItem(path,storage.midi,exact_match)},sequencer.getSamplePack=function(path,exact_match){return findItem(path,storage.samplepacks,exact_match)},sequencer.getSample=function(path,exact_match){return findItem(path,storage.audio,exact_match)},sequencer.getAssetPack=function(path,exact_match){return findItem(path,storage.assetpacks,exact_match)},sequencer.getSamplePacks=function(path,include_subfolders){return findItemsInFolder(path,storage.samplepacks,include_subfolders)},sequencer.getAssetPacks=function(path,include_subfolders){return findItemsInFolder(path,storage.assetpacks,include_subfolders)},sequencer.getSamples=function(path,include_subfolders){return findItemsInFolder(path,storage.audio,include_subfolders)},sequencer.getInstruments=function(path,include_subfolders){return findItemsInFolder(path,storage.instruments,include_subfolders)},sequencer.getMidiFiles=function(path,include_subfolders){return findItemsInFolder(path,storage.midi,include_subfolders)},sequencer.protectedScope.addInitMethod(function(){storage=sequencer.storage,loadLoop=sequencer.protectedScope.loadLoop,findItem=sequencer.protectedScope.findItem,storeItem=sequencer.protectedScope.storeItem,deleteItem=sequencer.protectedScope.deleteItem,typeString=sequencer.protectedScope.typeString,getArguments=sequencer.protectedScope.getArguments,isEmptyObject=sequencer.protectedScope.isEmptyObject,objectForEach=sequencer.protectedScope.objectForEach,updateInstruments=sequencer.protectedScope.updateInstruments,findItemsInFolder=sequencer.protectedScope.findItemsInFolder})}(),function(){"use strict";function cleanup(assetpack,callback){callback(!1)}function store(assetpack){var occupied=findItem(assetpack.localPath,sequencer.storage.assetpacks,!0),action=assetpack.action;return occupied&&"AssetPack"===occupied.className&&"overwrite"!==action?(sequencer.debug>=2&&console.warn("there is already an AssetPack at",assetpack.localPath),!0):(storeItem(assetpack,assetpack.localPath,sequencer.storage.assetpacks),!1)}function load(pack,callback){void 0!==pack.url?ajax({url:pack.url,responseType:"json",onError:function(e){cleanup(pack,callback)},onSuccess:function(data,fileSize){if(null===data)return void callback(!1);pack.loaded=!0,void 0!==data.name&&void 0===pack.name&&(pack.name=data.name),void 0!==data.folder&&void 0===pack.folder&&(pack.folder=data.folder),void 0===pack.name&&(pack.name=parseUrl(pack.url).name),pack.localPath=void 0!==pack.folder?pack.folder+"/"+pack.name:pack.name,pack.filesize=fileSize,data.instruments&&(pack.instruments=pack.instruments.concat(data.instruments)),data.samplepacks&&(pack.samplepacks=pack.samplepacks.concat(data.samplepacks)),data.midifiles&&(pack.midifiles=pack.midifiles.concat(data.midifiles)),loadLoop(pack,callback)}}):(pack.localPath=void 0!==pack.folder?pack.folder+"/"+pack.name:pack.name,loadLoop(pack,callback))}function loadLoop(assetpack,callback){var i,assets,asset,loaded=store(assetpack),localPath=assetpack.localPath;if(!0===loaded)return assetpack=findItem(localPath,sequencer.storage.assetpacks,!0),void callback(assetpack);if(void 0!==assetpack.url){var tmp,p,packs=sequencer.storage.assetpacks,double=null;for(p in packs)if(tmp=packs[p],"AssetPack"===tmp.className&&tmp.id!==assetpack.id&&tmp.url===assetpack.url){double=tmp;break}if(null!==double)return localPath=assetpack.localPath,removeAssetPack(localPath),assetpack=null,assetpack=findItem(double.localPath,sequencer.storage.assetpacks,!0),void callback(assetpack)}for(assets=assetpack.midifiles,i=assets.length-1;i>=0;i--)asset=assets[i],asset.pack=assetpack,sequencer.addMidiFile(asset);for(assets=assetpack.instruments,i=assets.length-1;i>=0;i--)asset=assets[i],asset.pack=assetpack,sequencer.addInstrument(asset);for(assets=assetpack.samplepacks,i=assets.length-1;i>=0;i--)asset=assets[i],asset.pack=assetpack,sequencer.addSamplePack(asset);callback(assetpack)}var storage,ajax,round,parseUrl,findItem,storeItem,deleteItem,typeString,objectForEach,removeMidiFile,removeAssetPack,removeInstrument,removeSamplePack,AssetPack,sequencer=window.sequencer,console=window.console,index=0;AssetPack=function(config){this.id="AP"+index+++(new Date).getTime(),this.name=this.id,this.className="AssetPack",this.loaded=!1,this.midifiles=config.midifiles||[],this.samplepacks=config.samplepacks||[],this.instruments=config.instruments||[],this.url=config.url;var pack=this;objectForEach(config,function(val,key){pack[key]=val})},AssetPack.prototype.unload=function(){var i,assets,asset;for(assets=this.midifiles,i=assets.length-1;i>=0;i--)asset=assets[i],removeMidiFile(asset.folder+"/"+asset.name);for(assets=this.instruments,i=assets.length-1;i>=0;i--)asset=assets[i],removeInstrument(asset.folder+"/"+asset.name);for(assets=this.samplepacks,i=assets.length-1;i>=0;i--)asset=assets[i],removeSamplePack(asset.folder+"/"+asset.name);deleteItem(this.localPath,storage.assetpacks)},sequencer.addAssetPack=function(config,callback){var json,name,folder,type=typeString(config);if("object"!==type)return sequencer.debug>=2&&console.warn("can't create an AssetPack with this data",config),!1;if(void 0===callback&&(callback=function(){}),config.json){if(json=config.json,name=config.name,folder=config.folder,"string"===typeString(json))try{json=JSON.parse(json)}catch(e){return sequencer.debug>=2&&console.warn("can't create an AssetPack with this data",config),!1}if(void 0===json.instruments&&void 0===json.midifiles&&void 0===json.samplepacks)return sequencer.debug>=2&&console.warn("can't create an AssetPack with this data",config),!1;config={midifiles:json.midifiles,instruments:json.instruments,samplepacks:json.samplepacks,name:void 0===name?json.name:name,folder:void 0===folder?json.folder:folder}}sequencer.addTask({type:"load asset pack",method:load,params:new AssetPack(config)},function(assetpack){config=null,callback(assetpack)},!0),sequencer.startTaskQueue()},sequencer.protectedScope.addInitMethod(function(){ajax=sequencer.protectedScope.ajax,round=sequencer.protectedScope.round,parseUrl=sequencer.protectedScope.parseUrl,findItem=sequencer.protectedScope.findItem,storeItem=sequencer.protectedScope.storeItem,deleteItem=sequencer.protectedScope.deleteItem,typeString=sequencer.protectedScope.typeString,objectForEach=sequencer.protectedScope.objectForEach,storage=sequencer.storage,removeMidiFile=sequencer.removeMidiFile,removeInstrument=sequencer.removeInstrument,removeSamplePack=sequencer.removeSamplePack,removeAssetPack=sequencer.removeAssetPack})}(),function(){"use strict";function encodeAudio(audioBuffer,type,bitrate,callback){if("mp3"===type){var interleavedSamples=getInterleavedSamples(audioBuffer);bitrate=bitrate||sequencer.bitrate_mp3_encoding,void 0===mp3Encoder&&(mp3Encoder=createWorker(),mp3Encoder.onmessage=function(e){"data"===e.data.cmd&&callback({blob:new Blob([new Uint8Array(e.data.buf)],{type:"audio/mp3"}),base64:base64EncArr(e.data.buf),dataUrl:"data:audio/mp3;base64,"+encode64(e.data.buf)})}),mp3Encoder.postMessage({cmd:"init",config:{mode:3,channels:1,samplerate:context.sampleRate,bitrate:bitrate}}),mp3Encoder.postMessage({cmd:"encode",buf:interleavedSamples}),mp3Encoder.postMessage({cmd:"finish"})}else"ogg"===type?(sequencer.debug>=sequencer.WARN&&console.warn("support for ogg is not yet implemented"),callback(!1)):(sequencer.debug>=sequencer.WARN&&console.warn("unsupported type",type),callback(!1))}function getInterleavedSamples(audioBuffer){if(1===audioBuffer.numberOfChannels)return audioBuffer.getChannelData(0);if(2===audioBuffer.numberOfChannels){var i,left=audioBuffer.getChannelData(0),right=audioBuffer.getChannelData(1),numFrames=left.length,interleaved=new Float32Array(numFrames),index=0;for(i=0;i<numFrames;i++)interleaved[index++]=left[i],interleaved[index++]=right[i];return interleaved}}function cleanUp(){void 0!==mp3Encoder&&mp3Encoder.terminate(),void 0!==oggEncoder&&oggEncoder.terminate()}function encoder(){importScripts("https://raw.githubusercontent.com/kobigurk/libmp3lame-js/master/dist/libmp3lame.min.js");var mp3codec,mp3data;self.onmessage=function(e){switch(e.data.cmd){case"init":e.data.config||(e.data.config={}),mp3codec=Lame.init(),Lame.set_mode(mp3codec,e.data.config.mode||Lame.JOINT_STEREO),Lame.set_num_channels(mp3codec,e.data.config.channels||2),Lame.set_num_samples(mp3codec,e.data.config.samples||-1),Lame.set_in_samplerate(mp3codec,e.data.config.samplerate||44100),Lame.set_out_samplerate(mp3codec,e.data.config.samplerate||44100),Lame.set_bitrate(mp3codec,e.data.config.bitrate||128),Lame.init_params(mp3codec);break;case"encode":mp3data=Lame.encode_buffer_ieee_float(mp3codec,e.data.buf,e.data.buf),self.postMessage({cmd:"data",buf:mp3data.data});break;case"finish":mp3data=Lame.encode_flush(mp3codec),
self.postMessage({cmd:"end",buf:mp3data.data}),Lame.close(mp3codec),mp3codec=null}}}function createWorker(){var blob=new Blob(["(",encoder.toString(),")()"],{type:"application/javascript"});return new Worker(URL.createObjectURL(blob))}var self,importScripts,Lame,encode64,base64EncArr,context,oggEncoder,mp3Encoder,sequencer=window.sequencer,console=window.console;sequencer.encodeAudio=encodeAudio,sequencer.protectedScope.cleanupAudioEncoder=cleanUp,sequencer.protectedScope.addInitMethod(function(){encode64=sequencer.util.encode64,base64EncArr=sequencer.util.base64EncArr,context=sequencer.protectedScope.context})}(),function(){"use strict";var typeString,AudioEvent,console=window.console,sequencer=window.sequencer,slice=Array.prototype.slice;AudioEvent=function(config){if(void 0!==config){if(void 0===config.ticks?this.ticks=0:this.ticks=config.ticks,this.buffer=config.buffer,this.sampleId=config.sampleId,this.path=config.path,void 0===this.buffer&&void 0===this.path)return void(sequencer.debug>=sequencer.WARN&&console.warn("please provide an AudioBuffer or a path to a sample in the sequencer.storage object"));if(void 0!==this.buffer&&"audiobuffer"!==typeString(this.buffer))return void(sequencer.debug>=sequencer.WARN&&console.warn("buffer has to be an AudioBuffer"));if(void 0!==this.path){if("string"!==typeString(this.path))return void(sequencer.debug>=sequencer.WARN&&console.warn("path has to be a String"));if(this.sampleId=this.path,this.sampleId=this.sampleId.replace(/^\//,""),this.sampleId=this.sampleId.replace(/\/$/,""),this.sampleId=this.sampleId.split("/"),this.sampleId=this.sampleId[this.sampleId.length-1],this.buffer=sequencer.getSample(this.path),!1===this.buffer)return void(sequencer.debug>=sequencer.WARN&&console.warn("no sample found at",this.path));this.buffer=sequencer.getSample(this.path)}this.durationTicks=config.durationTicks,this.durationMillis=config.durationMillis,void 0===this.durationTicks&&void 0===this.durationMillis&&(this.duration=this.buffer.duration,this.durationMillis=1e3*this.duration),this.muted=!1,void 0===config.velocity?this.velocity=127:this.velocity=config.velocity,this.sampleOffsetTicks=config.sampleOffsetTicks,this.sampleOffsetMillis=config.sampleOffsetMillis,void 0===this.sampleOffsetMillis&&void 0===this.sampleOffsetTicks?(this.sampleOffsetTicks=0,this.sampleOffsetMillis=0,this.sampleOffset=0):void 0!==this.sampleOffsetMillis&&(this.sampleOffset=this.sampleOffsetMillis/1e3),this.latencyCompensation=config.latencyCompensation,void 0===this.latencyCompensation&&(this.latencyCompensation=0),this.playheadOffset=0,this.className="AudioEvent",this.time=0,this.type="audio",this.id="A0"+(new Date).getTime()}},AudioEvent.prototype.update=function(){var pos;void 0===this.duration?(pos=this.song.getPosition("ticks",this.ticks+this.durationTicks),this.durationMillis=pos.millis-this.millis,this.duration=this.durationMillis/1e3):void 0===this.durationTicks&&(pos=this.song.getPosition("millis",this.millis+this.durationMillis),this.durationTicks=pos.ticks-this.ticks),void 0===this.sampleOffset?(pos=this.song.getPosition("ticks",this.ticks+this.sampleOffsetTicks),this.sampleOffsetMillis=pos.millis-this.millis,this.sampleOffset=this.sampleOffsetMillis/1e3):void 0===this.sampleOffsetTicks&&(pos=this.song.getPosition("millis",this.millis+this.sampleOffsetMillis),this.sampleOffsetTicks=pos.ticks-this.ticks),this.endTicks=this.ticks+this.durationTicks,this.endMillis=this.millis+this.durationMillis},AudioEvent.prototype.stopSample=function(seconds){this.track.audio.stopSample(this,seconds)},AudioEvent.prototype.setSampleOffset=function(type,value){"millis"===type?(this.sampleOffsetMillis=value,this.sampleOffset=value/1e3,this.durationTicks=void 0,void 0!==this.song&&this.update()):"ticks"===type?(this.sampleOffsetTicks=value,this.sampleOffset=void 0,this.sampleOffsetMillis=void 0,void 0!==this.song&&this.update()):sequencer.debug>=sequencer.WARN&&console.warn('you have to provide a type "ticks" or "millis" and a value')},AudioEvent.prototype.setDuration=function(type,value){"millis"===type?(this.durationMillis=value,this.duration=value/1e3,this.durationTicks=void 0,void 0!==this.song&&this.update()):"ticks"===type?(this.durationTicks=value,this.duration=void 0,this.durationMillis=void 0,void 0!==this.song&&this.update()):sequencer.debug>=sequencer.WARN&&console.warn('you have to provide a type "ticks" or "millis" and a value')},AudioEvent.prototype.clone=AudioEvent.prototype.copy=function(){var property,event=new AudioEvent;for(property in this)this.hasOwnProperty(property)&&("id"!==property&&"eventNumber"!==property&&(event[property]=this[property]),event.song=void 0,event.track=void 0,event.trackId=void 0,event.part=void 0,event.partId=void 0);return event},AudioEvent.prototype.reset=function(fromPart,fromTrack,fromSong){fromPart=void 0===fromPart,fromTrack=void 0===fromTrack,fromSong=void 0===fromSong,fromPart&&(this.part=void 0,this.partId=void 0),fromTrack&&(this.track=void 0,this.trackId=void 0,this.channel=0),fromSong&&(this.song=void 0)},AudioEvent.prototype.move=function(ticks){if(isNaN(ticks))return void(sequencer.debug>=1&&console.error("please provide a number"));this.ticks+=parseInt(ticks,10),void 0!==this.song&&this.update(),"new"!==this.state&&(this.state="changed"),void 0!==this.part&&(this.part.needsUpdate=!0)},AudioEvent.prototype.moveTo=function(){var position=slice.call(arguments);"ticks"===position[0]&&!1===isNaN(position[1])?this.ticks=parseInt(position[1],10):void 0===this.song?sequencer.debug>=1&&console.error("The audio event has not been added to a song yet; you can only move to ticks values"):(position=this.song.getPosition(position),!1===position?sequencer.debug>=1&&console.error("wrong position data"):this.ticks=position.ticks),void 0!==this.song&&this.update(),"new"!==this.state&&(this.state="changed"),void 0!==this.part&&(this.part.needsUpdate=!0)},sequencer.createAudioEvent=function(config){return"AudioEvent"===config.className?config.clone():new AudioEvent(config)},sequencer.protectedScope.addInitMethod(function(){typeString=sequencer.protectedScope.typeString})}(),function(){"use strict";function AudioRecorder(track){this.track=track,this.song=track.song,this.audioEvents={},this.callback=null,this.worker=createWorker(),this.waveformConfig=track.waveformConfig||waveformConfig;var scope=this;this.worker.onmessage=function(e){encodeAudioBuffer(scope,e.data.wavArrayBuffer,e.data.interleavedSamples,e.data.id)}}function encodeAudioBuffer(scope,wavArrayBuffer,interleavedSamples,type){context.decodeAudioData(wavArrayBuffer,function(audioBuffer){var base64=encode64(wavArrayBuffer),recording={id:scope.recordId,audioBuffer:audioBuffer,wavArrayBuffer:wavArrayBuffer,wav:{blob:new Blob([new Uint8Array(wavArrayBuffer)],{type:"audio/wav"}),base64:base64,dataUrl:"data:audio/wav;base64,"+base64},waveform:{}};recording.interleavedSamples="new"===type?interleavedSamples:sequencer.storage.audio.recordings[scope.recordId].interleavedSamples,getWaveformData(audioBuffer,scope.waveformConfig,function(data){recording.waveform={dataUrls:data},sequencer.storage.audio.recordings[scope.recordId]=recording,null!==scope.callback&&(scope.callback(recording),scope.callback=null)})},function(){sequencer.debug>=sequencer.WARN&&console.warn("no valid audiodata")})}function record(callback){navigator.getUserMedia({audio:!0},function(stream){microphoneAccessGranted=!0,localMediaStream=stream,callback()},function(error){sequencer.debug>=sequencer.WARN&&console.log(error),microphoneAccessGranted=!1,callback()})}var context,encode64,dispatchEvent,createWorker,getWaveformData,localMediaStream,millisPerSample,bufferMillis,sequencer=window.sequencer,console=window.console,microphoneAccessGranted=null,waveformConfig={height:200,width:800,sampleStep:1,color:"#71DE71",bgcolor:"#000"};AudioRecorder.prototype.prepare=function(recordId,callback){var scope=this;this.recordId=recordId,null===microphoneAccessGranted?record(function(){callback(microphoneAccessGranted),void 0!==localMediaStream&&scope.start()}):(callback(microphoneAccessGranted),void 0!==localMediaStream&&this.start())},AudioRecorder.prototype.start=function(){var scope=this,song=this.track.song;scope.worker.postMessage({command:"init",sampleRate:context.sampleRate}),this.scriptProcessor=context.createScriptProcessor(8192,1,1),this.scriptProcessor.onaudioprocess=function(e){1===e.inputBuffer.numberOfChannels?scope.worker.postMessage({command:"record_mono",buffer:e.inputBuffer.getChannelData(0)}):scope.worker.postMessage({command:"record_stereo",buffer:[e.inputBuffer.getChannelData(0),e.inputBuffer.getChannelData(1)]}),!1===song.recording&&!1===song.precounting&&scope.createAudio()},this.sourceNode=context.createMediaStreamSource(localMediaStream),this.sourceNode.connect(this.scriptProcessor),this.scriptProcessor.connect(context.destination)},AudioRecorder.prototype.stop=function(callback){if(this.stopRecordingTimestamp=1e3*context.currentTime,this.timestamp=window.performance.now(),void 0===this.sourceNode)return void callback();this.callback=callback},AudioRecorder.prototype.createAudio=function(){this.sourceNode.disconnect(this.scriptProcessor),this.scriptProcessor.disconnect(context.destination),this.scriptProcessor.onaudioprocess=null,this.sourceNode=null,this.scriptProcessors=null;var bufferIndexStart=parseInt((this.song.metronome.precountDurationInMillis+this.song.audioRecordingLatency)/millisPerSample);this.worker.postMessage({command:"get_wavfile",bufferIndexStart:bufferIndexStart,bufferIndexEnd:-1})},AudioRecorder.prototype.setAudioRecordingLatency=function(recordId,value,callback){var bufferIndexStart=parseInt(value/millisPerSample);this.callback=callback,this.worker.postMessage({command:"update_wavfile",samples:sequencer.storage.audio.recordings[recordId].interleavedSamples,bufferIndexStart:bufferIndexStart,bufferIndexEnd:-1})},AudioRecorder.prototype.cleanup=function(){if(void 0===localMediaStream)return void this.worker.terminate();this.scriptProcessor.disconnect(),this.scriptProcessor.onaudioprocess=null,this.sourceNode.disconnect(),this.scriptProcessor=null,this.sourceNode=null,this.worker.terminate()},sequencer.protectedScope.createAudioRecorder=function(track){return!1!==sequencer.record_audio&&new AudioRecorder(track)},sequencer.protectedScope.addInitMethod(function(){encode64=sequencer.util.encode64,context=sequencer.protectedScope.context,getWaveformData=sequencer.getWaveformData,createWorker=sequencer.protectedScope.createAudioRecorderWorker,millisPerSample=1/context.sampleRate*1e3,dispatchEvent=sequencer.protectedScope.songDispatchEvent,bufferMillis=8192*millisPerSample})}(),function(){"use strict";function createWorker(){function getWavFile(){var dataview,i,result,index=0;if(1===numberOfChannels?interleavedSamples=mergeBuffers(recBuffersLeft,numFrames):2===numberOfChannels&&(interleavedSamples=toInterleavedBuffer(mergeBuffers(recBuffersLeft,numFrames),mergeBuffers(recBuffersRight,numFrames))),bufferIndexEnd>0||bufferIndexStart>0){for(-1===bufferIndexEnd&&(bufferIndexEnd=interleavedSamples.length),result=new Float32Array(bufferIndexEnd-bufferIndexStart+1),i=bufferIndexStart;i<bufferIndexEnd;i++)result[index++]=interleavedSamples[i];interleavedSamples=result}return dataview=encodeWAV(interleavedSamples),dataview.buffer}function updateWavFile(){var dataview,i,result,index=0;for(-1===bufferIndexEnd&&(bufferIndexEnd=interleavedSamples.length),result=new Float32Array(bufferIndexEnd-bufferIndexStart+1),i=bufferIndexStart;i<bufferIndexEnd;i++)result[index++]=interleavedSamples[i];return dataview=encodeWAV(result),dataview.buffer}function mergeBuffers(recBuffers,numFrames){for(var result=new Float32Array(numFrames),offset=0,i=0,maxi=recBuffers.length;i<maxi;i++)result.set(recBuffers[i],offset),offset+=recBuffers[i].length;return result}function toInterleavedBuffer(inputL,inputR){for(var length=inputL.length+inputR.length,result=new Float32Array(length),index=0,inputIndex=0;index<length;)result[index++]=inputL[inputIndex],result[index++]=inputR[inputIndex],inputIndex++;return result}function toPlanarBuffer(inputL,inputR){for(var length=inputL.length,result=new Float32Array(2*length),index=0,inputIndex=0;index<length;)result[index++]=inputL[inputIndex++];for(index=0;index<length;)result[index++]=inputR[inputIndex++];return result}function floatTo16BitPCM(output,offset,input){for(var i=0;i<input.length;i++,offset+=2){var s=Math.max(-1,Math.min(1,input[i]));output.setInt16(offset,s<0?32768*s:32767*s,!0)}}function writeString(view,offset,string){for(var i=0;i<string.length;i++)view.setUint8(offset+i,string.charCodeAt(i))}function encodeWAV(samples){var buffer=new ArrayBuffer(44+2*samples.length),view=new DataView(buffer);return writeString(view,0,"RIFF"),view.setUint32(4,36+2*samples.length,!0),writeString(view,8,"WAVE"),writeString(view,12,"fmt "),view.setUint32(16,16,!0),view.setUint16(20,1,!0),view.setUint16(22,numberOfChannels,!0),view.setUint32(24,sampleRate,!0),view.setUint32(28,sampleRate*numberOfChannels*2,!0),view.setUint16(32,2*numberOfChannels,!0),view.setUint16(34,16,!0),writeString(view,36,"data"),view.setUint32(40,2*samples.length,!0),floatTo16BitPCM(view,44,samples),view}function getWavFile2(){var dataview,i,resultLeft,mergedBuffersLeft,mergedBuffersRight,index=0;if(1===numberOfChannels?mergedBuffersLeft=mergeBuffers(recBuffersLeft,numFrames):2===numberOfChannels&&(mergedBuffersLeft=mergeBuffers(recBuffersLeft,numFrames),mergedBuffersRight=mergeBuffers(recBuffersRight,numFrames)),bufferIndexEnd>0||bufferIndexStart>0)for(-1===bufferIndexEnd&&(bufferIndexEnd=mergedBuffersLeft.length),resultLeft=new Float32Array(bufferIndexEnd-bufferIndexStart+1),2===numberOfChannels&&new Float32Array(bufferIndexEnd-bufferIndexStart+1),i=bufferIndexStart;i<bufferIndexEnd;i++)resultLeft[index]=mergedBuffersLeft[i],2===numberOfChannels&&mergedBuffersRight[i],index++;if(1===numberOfChannels)for(planarSamples=mergedBuffersLeft,interleavedSamples=new Float32Array(numFrames),i=0;i<numFrames;i++)interleavedSamples[i]=planarSamples[i];else 2===numberOfChannels&&(planarSamples=toPlanarBuffer(mergedBuffersLeft,mergedBuffersRight),interleavedSamples=toInterleavedBuffer(mergedBuffersLeft,mergedBuffersRight));return dataview=encodeWAV(interleavedSamples),{planarSamples:planarSamples.buffer,interleavedSamples:interleavedSamples.buffer,wavArrayBuffer:dataview.buffer}}var data,bufferIndexStart,bufferIndexEnd,planarSamples,interleavedSamples,numFrames,recBuffersLeft,recBuffersRight,sampleRate,numberOfChannels;self.onmessage=function(e){switch(e.data.command){case"init":sampleRate=e.data.sampleRate,numFrames=0,recBuffersLeft=[],recBuffersRight=[];break;case"record_mono":numberOfChannels=1,recBuffersLeft.push(e.data.buffer),numFrames+=e.data.buffer.length;break;case"record_stereo":numberOfChannels=2,recBuffersLeft.push(e.data.buffer[0]),recBuffersRight.push(e.data.buffer[1]),numFrames+=e.data.buffer[0].length;break;case"get_wavfile":bufferIndexStart=e.data.bufferIndexStart,bufferIndexEnd=e.data.bufferIndexEnd,data={id:"new",wavArrayBuffer:getWavFile(),interleavedSamples:interleavedSamples},self.postMessage(data,[data.wavArrayBuffer,data.interleavedSamples.buffer]);break;case"get_wavfile2":bufferIndexStart=e.data.bufferIndexStart,bufferIndexEnd=e.data.bufferIndexEnd,data=getWavFile2(),data.id="new",self.postMessage(data,[data.planarSamples,data.interleavedSamples,data.wavArrayBuffer]);break;case"update_wavfile":bufferIndexStart=e.data.bufferIndexStart,bufferIndexEnd=e.data.bufferIndexEnd,interleavedSamples=e.data.samples,data={id:"update",wavArrayBuffer:updateWavFile()},self.postMessage(data,[data.wavArrayBuffer])}}}var sequencer=window.sequencer;window.console;sequencer.protectedScope.createAudioRecorderWorker=function(){var blobURL=URL.createObjectURL(new Blob(["(",createWorker.toString(),")()"],{type:"application/javascript"}));return new Worker(blobURL)}}(),function(){"use strict";var typeString,createAudioRecorder,unscheduleCallback,AudioTrack,sequencer=(window.console,window.sequencer);Array.prototype.slice;AudioTrack=function(track){this.track=track,this.className="AudioTrack",this.scheduledSamples={},this.recorder=createAudioRecorder(track)},unscheduleCallback=function(sample){delete this.scheduledSamples[sample.id],sample=null},AudioTrack.prototype.setAudioRecordingLatency=function(recordId,value,callback){this.recorder.setAudioRecordingLatency(recordId,value,callback)},AudioTrack.prototype.processEvent=function(audioEvent){var sample=sequencer.createSample({buffer:audioEvent.buffer,track:audioEvent.track});audioEvent.sample=sample,audioEvent.offset=audioEvent.sampleOffset+audioEvent.playheadOffset,audioEvent.playheadOffset=0,sample.start(audioEvent),this.scheduledSamples[sample.id]=sample},AudioTrack.prototype.stopSample=function(audioEvent,seconds){void 0!==audioEvent.sample&&audioEvent.sample.stop(seconds,unscheduleCallback.bind(this))},AudioTrack.prototype.allNotesOff=function(){var sampleId,sample,scheduledSamples=this.scheduledSamples;for(sampleId in scheduledSamples)scheduledSamples.hasOwnProperty(sampleId)&&(sample=scheduledSamples[sampleId])&&sample.unschedule(0,unscheduleCallback.bind(this));this.scheduledSamples={}},AudioTrack.prototype.prepareForRecording=function(recordId,callback){if(!1===this.recorder)return!1;this.recorder.prepare(recordId,callback)},AudioTrack.prototype.stopRecording=function(callback){this.recorder.stop(function(recording){callback(recording)})},sequencer.protectedScope.createAudioTrack=function(track){return new AudioTrack(track)},sequencer.protectedScope.addInitMethod(function(){typeString=sequencer.protectedScope.typeString,createAudioRecorder=sequencer.protectedScope.createAudioRecorder})}(),function(){"use strict";function Effect(config){this.id="FX"+id+++(new Date).getTime(),this.type=config.type,this.buffer=config.buffer,this.config=config,this.bypass=!1,this.amount=0,this.output=context.createGainNode(),this.wetGain=context.createGainNode(),this.dryGain=context.createGainNode(),this.output.gain.value=1,this.wetGain.gain.value=this.amount,this.dryGain.gain.value=1-this.amount}var context,createClass,getSample,Reverb,Panner,Panner2,Delay,BiQuadFilter,Compressor,sequencer=window.sequencer,console=window.console,id=0;Effect.prototype.setInput=function(input){input.connect(this.dryGain),this.dryGain.connect(this.output),input.connect(this.node),this.node.connect(this.wetGain),this.wetGain.connect(this.output)},Effect.prototype.setAmount=function(value){this.amount=value<0?0:value>1?1:value,this.wetGain.gain.value=this.amount,this.dryGain.gain.value=1-this.amount},Effect.prototype.copy=function(){switch(this.type){case"reverb":return new Reverb(this.config);case"panner":return new Panner(this.config);case"panner2":return new Panner2(this.config);case"delay":return new Delay(this.config);case"compressor":return new Compressor(this.config)}},sequencer.createReverb=function(id){var buffer=getSample(id);return!1===buffer?(console.warn("no reverb with id",id,"loaded"),!1):new Reverb({type:"reverb",buffer:buffer})},sequencer.createPanner=function(config){return config=config||{},config.type="panner",new Panner(config)},sequencer.createPanner2=function(config){return config=config||{},config.type="panner2",new Panner2(config)},sequencer.createDelay=function(config){return config=config||{},config.type="delay",new Delay(config)},sequencer.createCompressor=function(config){return config=config||{},config.type="compressor",new Compressor(config)},sequencer.createBiQuadFilter=function(config){return config=config||{},config.type="biquadfilter",new BiQuadFilter(config)},sequencer.protectedScope.addInitMethod(function(){context=sequencer.protectedScope.context,createClass=sequencer.protectedScope.createClass,getSample=sequencer.getSample,Reverb=createClass(Effect,function(config){this.node=context.createConvolver(),this.node.buffer=config.buffer}),Panner=createClass(Effect,function(config){this.node=context.createPanner(),this.node.panningModel="equalpower",this.node.setPosition(1e-17,1e-17,1e-17)}),Panner2=createClass(Effect,function(config){this.node=context.createPanner(),this.node.panningModel="HRTF",this.node.setPosition(1e-17,1e-17,1e-17)}),Delay=createClass(Effect,function(config){this.node=context.createDelay(),this.node.delayTime.value=.3}),Compressor=createClass(Effect,function(config){this.node=context.createDynamicsCompressor()}),BiQuadFilter=createClass(Effect,function(config){this.node=context.createBiquadFilter(),this.node.type=0,this.node.Q.value=4,this.node.frequency.value=1600}),Panner.prototype.setPosition=function(value){var x=value,y=0,z=1-Math.abs(x);x=0===x?1e-17:x,y=0===y?1e-17:y,z=0===z?1e-17:z,this.node.setPosition(x,y,z)},Panner2.prototype.setPosition=function(value){var x,y,z,xDeg=parseInt(value),zDeg=xDeg+90;zDeg>90&&(zDeg=180-zDeg),x=Math.sin(xDeg*(Math.PI/180)),y=0,z=Math.sin(zDeg*(Math.PI/180)),x=0===x?1e-17:x,y=0===y?1e-17:y,z=0===z?1e-17:z,this.node.setPosition(x,y,z)},Delay.prototype.setTime=function(value){this.node.delayTime.value=value}})}(),function(){"use strict";var getStats,createNote=sequencer.createNote,findEvent=sequencer.findEvent,round=sequencer.protectedScope.round,getEvents=sequencer.protectedScope.getEvents,typeString=sequencer.protectedScope.typeString,supportedOperators="max min avg all",supportedProperties="data1 data2 velocity noteNumber noteName frequency";getStats=function(){var property,operator,events,searchPattern,patternLength,i,maxi,event,propValue,minNoteName,maxNoteName,args=Array.prototype.slice.call(arguments),numArgs=args.length,min=128,max=-1,sum=0,avg=0,useNoteName=!1;if(events=getEvents(args[0]),0===events.length)return-1;if(searchPattern=args[1],"string"!==typeString(searchPattern))return console.error("please provide a search string like for instance get('velocity max bar >= 1 < 8')"),-1;if(numArgs>2&&console.warn("ignoring invalid arguments, please consult documentation"),searchPattern=searchPattern.split(" "),patternLength=searchPattern.length,property=searchPattern[0],operator=searchPattern[1],-1===supportedProperties.indexOf(property))return console.error("you can't use 'min', 'max' or 'avg'","on the property",property),-1;if(-1===supportedOperators.indexOf(operator))return console.error(operator,"is not a valid operator"),-1;for(patternLength>2&&(6===patternLength&&console.warn("ignoring cruft found in search string, please consult documentation"),searchPattern.shift(),searchPattern.shift(),events=findEvent(events,searchPattern.join(" "))),"noteName"===property&&(property="noteNumber",useNoteName=!0),i=0,maxi=events.length;i<maxi;i++)event=events[i],propValue=event[property],propValue>max&&(max=propValue,maxNoteName=event.noteName),propValue<min&&(min=propValue,minNoteName=event.noteName),void 0!==propValue&&(sum+=propValue);return avg=sum/maxi,useNoteName&&(avg=round(avg),avg=createNote(avg).name,min=minNoteName,max=maxNoteName),"max"===operator?max:"min"===operator?min:"avg"===operator?avg:"all"===operator?{min:min,max:max,avg:avg}:void 0},sequencer.getStats=getStats,sequencer.protectedScope.addInitMethod(function(){createNote=sequencer.createNote,findEvent=sequencer.findEvent,round=sequencer.protectedScope.round,getEvents=sequencer.protectedScope.getEvents,typeString=sequencer.protectedScope.typeString})}(),function(){"use strict";var createNote,typeString,createMidiNote,midiEventNumberByName,patterns,operators,findEvent,findNote,getEvents,checkValue,createPattern,checkOperators,checkCondition,checkCondition2,inverseOperator,removeMutualEvents,removeDoubleEvents,performSearch,properties={barsbeats:["bar","beat","sixteenth","tick"],time:["hour","minute","second","millisecond"]},logicalOperators="OR AND NOT XOR",logicalOperatorsRegex=new RegExp(" "+logicalOperators.replace(/\s+/g," | ")+" "),supportedProperties={bar:1,beat:1,sixteenth:1,tick:1,ticks:1,barsbeats:1,musical_time:1,hour:1,minute:1,second:1,millisecond:1,millis:1,time:1,linear_time:1,id:1,type:1,data1:1,data2:1,velocity:1,noteNumber:1,frequency:1,noteName:1};findEvent=function(){var i,maxi,searchString,tmp,operator,pattern,patternIndex,operatorIndex,events,results,lastResult,subResult1,args=Array.prototype.slice.call(arguments);if(events=getEvents(args[0]),results=[],0===events.length)return console.warn("findEvent: no events"),results;if("string"!==typeString(args[1]))return console.error("please provide a search string like for instance findEvent('beat = 2 AND velocity > 60 < 100');"),results;for(searchString=args[1],tmp=searchString.split(" "),maxi=tmp.length,operators=[],i=0;i<maxi;i++)operator=tmp[i],logicalOperatorsRegex.test(" "+operator+" ")&&operators.push(operator);for(tmp=searchString.split(logicalOperatorsRegex),maxi=tmp.length,patterns=[],i=0;i<maxi;i++)createPattern(tmp[i].split(" "));for(maxi=patterns.length,patternIndex=0,operatorIndex=-1,i=0;i<maxi;i++)pattern=patterns[patternIndex++],operator=operators[operatorIndex++],"AND"===operator?results=performSearch(results,pattern):"NOT"===operator?results=performSearch(results,pattern,!0):"XOR"===operator?(subResult1=performSearch(events,pattern),results=removeMutualEvents(results,subResult1)):(lastResult=performSearch(events,pattern),results=results.concat(lastResult)),pattern,operator;return removeDoubleEvents(results)},removeMutualEvents=function(resultSet1,resultSet2){var i,j,event,eventId,addEvent,maxi=resultSet1.length,maxj=resultSet2.length,result=[];for(i=0;i<maxi;i++){for(addEvent=!0,event=resultSet1[i],eventId=event.id,j=0;j<maxj;j++)if(resultSet2[j].id===eventId){addEvent=!1;break}addEvent&&result.push(event)}for(j=0;j<maxj;j++){for(addEvent=!0,event=resultSet2[j],eventId=event.id,i=0;i<maxi;i++)if(resultSet1[i].id===eventId){addEvent=!1;break}addEvent&&result.push(event)}return result},removeDoubleEvents=function(events){var i,event,eventId,lastId,maxi=events.length,result=[];for(events.sort(function(a,b){return a.eventNumber-b.eventNumber}),i=0;i<maxi;i++)event=events[i],eventId=event.id,eventId!==lastId&&result.push(event),lastId=eventId;return result},performSearch=function(events,pattern,inverse){var event,i,searchResult=[],property=pattern.property,operator1=pattern.operator1,operator2=pattern.operator2,value1=pattern.value1,value2=pattern.value2,numEvents=events.length;for(inverse=inverse||!1,inverse&&(operator1=inverseOperator(operator1),operator2=inverseOperator(operator2)),i=0;i<numEvents;i++)event=events[i],checkCondition(property,event[property],operator1,value1,operator2,value2)&&searchResult.push(event);return searchResult},checkCondition=function(property,propValue,operator1,value1,operator2,value2){var result=!1,isString=!1;if(void 0===propValue)return result;switch(property){case"noteName":if("="===operator1)return 3===value1.length&&4===propValue.length?result=0===propValue.indexOf(value1):4===value1.length&&5===propValue.length&&(result=0===propValue.indexOf(value1)),result;break;case"type":"number"!==typeString(value1)&&isNaN(value1)&&(value1=midiEventNumberByName(value1))}switch("string"===typeString(propValue)?("string"!==typeString(value1)&&(value1="'"+value1+"'"),value2&&"string"!==typeString(value2)&&(value2="'"+value2+"'"),isString=!0):"number"===typeString(propValue)&&("number"!==typeString(value1)&&(value1=parseInt(value1)),value2&&"number"!==typeString(value2)&&(value2=parseInt(value2))),operator1){case"=":case"==":case"===":result=propValue===value1;break;case"*=":result=-1!==propValue.indexOf(value1);break;case"^=":result=0===propValue.indexOf(value1);break;case"$=":result=propValue.indexOf(value1)===propValue.length-value1.length;break;case"%=":result=!isString&&propValue%value1==0;break;case"!*=":result=!(-1!==propValue.indexOf(value1));break;case"!^=":result=!(0===propValue.indexOf(value1));break;case"!$=":result=!(propValue.indexOf(value1)===propValue.length-value1.length);break;case"!%=":result=!!isString||!(propValue%value1==0);break;case"!=":case"!==":result=isString?-1===propValue.indexOf(value1):propValue!==value1;break;case">":result=operator2?checkCondition2(propValue,operator1,value1,operator2,value2):propValue>value1;break;case">=":result=operator2?checkCondition2(propValue,operator1,value1,operator2,value2):propValue>=value1;break;case"<":result=operator2?checkCondition2(propValue,operator1,value1,operator2,value2):propValue<value1;break;case"<=":result=operator2?checkCondition2(propValue,operator1,value1,operator2,value2):propValue<=value1;break;default:console.warn("eval is evil!")}return result},checkCondition2=function(propValue,operator1,value1,operator2,value2){var result=!1;switch(operator1){case">":switch(operator2){case"<":result=propValue>value1&&propValue<value2;break;case"<=":result=propValue>value1&&propValue<=value2}break;case">=":switch(operator2){case"<":result=propValue>=value1&&propValue<value2;break;case"<=":result=propValue>=value1&&propValue<=value2}break;case"<":switch(operator2){case">":result=propValue<value1||propValue>value2;break;case">=":result=propValue<value1||propValue>=value2}break;case"<=":switch(operator2){case">":result=propValue<=value1||propValue>value2;break;case">=":result=propValue<=value1||propValue>=value2}}return result},getEvents=function(obj){var events=[];return"array"===typeString(obj)?events=obj:void 0===obj.className?console.warn(obj):"Track"===obj.className||"Part"===obj.className?events=obj.events:"Song"===obj.className&&(events=obj.eventsMidiTime),events},createPattern=function(args){var i,pattern={property:args[0],operator1:args[1],value1:args[2],operator2:args[3],value2:args[4]},property=args[0],operator1=args[1],value1=args[2],operator2=args[3],value2=args[4];if(1!==supportedProperties[property])return console.error(property,"is not a supported property"),!1;if(pattern=checkOperators(pattern),"barsbeats"===property||"time"===property){for(value1=checkValue(value1,property),i=0;i<4;i++)pattern={},pattern.property=properties[property][i],pattern.operator1=operator1,pattern.value1=value1[i],patterns.push(pattern),operators.push("AND");if(operators.pop(),value2){for(value2=checkValue(value2,property),i=0;i<4;i++)pattern={},pattern.property=properties[property][i],pattern.operator2=operator2,pattern.value2=value2[i],patterns.push(pattern),operators.push("AND");operators.pop()}}else patterns.push(pattern)},checkValue=function(value,type){switch(value=value.replace(/(\[|\])/g,""),"array"!==typeString(value)&&("barsbeats"===type?value=-1===value.indexOf(",")?[value,1,1,0]:value.split(","):"time"===type&&(value=-1===value.indexOf(",")?[0,value,0,0]:value.split(","))),value.length){case 1:"barsbeats"===type?value.push(1,1,0):"time"===type&&value.push(0,0,0);break;case 2:"barsbeats"===type?value.push(1,0):"time"===type&&value.push(0,0);break;case 3:value.push(0)}return value},checkOperators=function(pattern){var operator1=pattern.operator1,operator2=pattern.operator2,check=function(operator){return"<"===operator||">"===operator||"<="===operator||">="===operator},check2=function(operator){return"="===operator||"=="===operator||"==="===operator};return"noteName"===pattern.property&&(check(operator1)||check2(operator1))&&(pattern.property="noteNumber",pattern.value1=createNote(pattern.value1).number),"noteName"===pattern.property&&(check(operator2)||check2(operator2))&&(pattern.property="noteNumber",pattern.value2=createNote(pattern.value2).number),check(operator1)&&!check(operator2)&&(delete pattern.operator2,delete pattern.value2),pattern},inverseOperator=function(operator){var inversedOperator;switch(operator){case"=":case"==":case"===":inversedOperator="!==";break;case"!=":case"!==":inversedOperator="===";break;case"<":inversedOperator=">=";break;case">":inversedOperator="<=";break;case"<=":inversedOperator=">";break;case">=":inversedOperator="<";break;case"*=":case"^=":case"&=":case"%=":inversedOperator="!"+operator;break;default:inversedOperator=operator}return inversedOperator},findNote=function(){
var i,event,noteOnEvent,tmp,results=findEvent.apply(this,arguments),numEvents=results.length,noteOnEvents={},resultsFiltered=[];for(i=0;i<numEvents;i++)event=results[i],event.type===sequencer.NOTE_ON?(void 0===noteOnEvents[event.noteNumber]&&(noteOnEvents[event.noteNumber]=[]),noteOnEvents[event.noteNumber].push(event)):event.type===sequencer.NOTE_OFF&&(tmp=noteOnEvents[event.noteNumber],tmp&&(noteOnEvent=tmp.shift(),resultsFiltered.push(createMidiNote(noteOnEvent,event))),0===tmp.length&&delete noteOnEvents[event.noteNumber]);return resultsFiltered.sort(function(a,b){return a.sortIndex-b.sortIndex}),resultsFiltered},sequencer.findEvent=findEvent,sequencer.findNote=findNote,sequencer.protectedScope.getEvents=getEvents,sequencer.protectedScope.addInitMethod(function(){createNote=sequencer.createNote,typeString=sequencer.protectedScope.typeString,createMidiNote=sequencer.createMidiNote,midiEventNumberByName=sequencer.midiEventNumberByName})}(),function(){"use strict";function unscheduleCallback(sample){null}function loop(data,i,maxi,events){var arg;for(i=0;i<maxi;i++)void 0!==(arg=data[i])&&("MidiNote"===arg.className?events.push(arg.noteOn):"array"===typeString(arg)&&loop(arg,0,arg.length))}function createAutoPanner(time){return{getValue:function(time){return Math.sin(2*time*Math.PI)}}}var context,storage,timedTasks,repetitiveTasks,findItem,storeItem,typeString,pathToArray,isEmptyObject,objectForEach,createSample,createReverb,dispatchEvent,remap,round,getEqualPowerCurve,transpose,Instrument,SimpleSynth,sequencer=window.sequencer,console=window.console,debug=sequencer.debug;Instrument=function(config){this.className="Instrument",this.config=config,this.scheduledEvents={},this.scheduledSamples={},this.sustainPedalDown=!1,this.sustainPedalSamples={},this.sampleDataByNoteNumber={},this.sampleData=[],this.info=config.info||config.instrument_info,this.author=config.author||config.instrument_author,this.license=config.license||config.instrument_license,this.pack=config.pack,this.parse()},Instrument.prototype.reset=function(){var instrument=sequencer.getInstrument(this.config.localPath);!1!==sequencer.getSamplePack(this.config.sample_path)&&!1!==instrument||(this.scheduledEvents={},this.scheduledSamples={},this.sustainPedalSamples={},this.sampleDataByNoteNumber={},this.sampleData=[],this.update&&delete repetitiveTasks[this.updateTaskId],!1===instrument&&this.track.setInstrument())},Instrument.prototype.parse=function(){function parseSampleData(data){var tmp,n;if(data.n)buffer=audioFolder[data.n];else for(names=[noteNumber,noteName,noteName.toLowerCase()],n=2;n>=0;n--)if(void 0!==(buffer=audioFolder[names[n]])){mapping[id]={n:names[n]};break}if(void 0===buffer)return sequencer.debug&&console.log("no buffer found for "+id+" ("+me.name+")"),void(sampleConfig=!1);sampleConfig={noteNumber:noteNumber,buffer:buffer,bufferId:data.n,autopan:me.autopan},!0===config.sustain&&(sampleConfig.sustain=!0,update=!0),void 0!==data.s?(sampleConfig.sustain_start=data.s[0],sampleConfig.sustain_end=data.s[1],sampleConfig.sustain=!0,update=!0):!0===config.sustain&&(tmp=samplePack.samplesById[data.n].sustain,void 0!==tmp?(sampleConfig.sustain_start=tmp[0],sampleConfig.sustain_end=tmp[1]):sampleConfig.sustain=!1),void 0!==config.release_duration&&(sampleConfig.release_duration=config.release_duration,sampleConfig.release_envelope=config.release_envelope||me.releaseEnvelope,sampleConfig.release=!0,update=!0),void 0!==data.r&&("array"===typeString(data.r)?(sampleConfig.release_duration=data.r[0],sampleConfig.release_envelope=data.r[1]||me.releaseEnvelope):isNaN(data.r)||(sampleConfig.release_duration=data.r,sampleConfig.release_envelope=me.releaseEnvelope),sampleConfig.release=!0,update=!0),void 0!==data.p&&(sampleConfig.panPosition=data.p,sampleConfig.panning=!0)}var i,maxi,v,v1,v2,length,octave,note,noteName,noteNumber,pathArray,buffer,names,id,data,subdata,update,sampleConfig,samplePack,audioFolder,config=this.config,noteNameMode=void 0===config.notename_mode?sequencer.noteNameMode:config.notename_mode,mapping=config.mapping,me=this;if(void 0===config.name)return console.error("instruments must have a name",config),!1;if(void 0===mapping)return console.error("instruments must have a mapping to samples",config),!1;for(this.name=config.name,this.folder=config.folder||"",this.autopan=config.autopan||!1,this.singlePitch=config.single_pitch||!1,this.samplePath=config.sample_path||this.name,this.keyScalingRelease=config.keyscaling_release,this.keyScalingPanning=config.keyscaling_panning,this.keyRange=config.keyrange||config.key_range,pathArray=this.samplePath.split("/"),samplePack=storage.samplepacks,i=0,maxi=pathArray.length;i<maxi;i++){if(void 0===samplePack)return void(sequencer.debug&&console.log("sample pack not found",pathArray.join("/")));samplePack=samplePack[pathArray[i]]}audioFolder=storage.audio;try{for(i=0,maxi=pathArray.length;i<maxi;i++)audioFolder=audioFolder[pathArray[i]]}catch(e){return void(sequencer.debug&&console.log('sample pack "'+pathArray[i]+'" is not loaded'))}if(void 0===audioFolder)return void(sequencer.debug&&console.log("sample pack not found",pathArray.join("/")));if("array"===typeString(mapping))for(this.keyRange=mapping,mapping={},i=this.keyRange[0];i<=this.keyRange[1];i++)mapping[i]="";void 0===this.keyRange?(this.lowestNote=128,this.highestNote=-1):(this.lowestNote=this.keyRange[0],this.highestNote=this.keyRange[1],this.numNotes=this.highestNote-this.lowestNote),void 0!==config.release_duration?this.releaseDuration=config.release_duration:this.releaseDuration=0,this.releaseEnvelope=config.release_envelope||"equal power",this.autopan&&(this.autoPanner=createAutoPanner()),this.samplepack=samplePack;for(id in mapping)if(mapping.hasOwnProperty(id))if(data=mapping[id],isNaN(id)?(length=id.length,octave=id.substring(length-1),note=id.substring(0,length-1),noteName=id,noteNumber=sequencer.getNoteNumber(note,octave)):(noteName=sequencer.getNoteNameFromNoteNumber(id,noteNameMode),noteName=noteName.join(""),noteNumber=id),noteNumber=parseInt(noteNumber,10),void 0===this.keyRange&&(this.lowestNote=noteNumber<this.lowestNote?noteNumber:this.lowestNote,this.highestNote=noteNumber>this.highestNote?noteNumber:this.highestNote),"array"===typeString(data))for(this.multiLayered=!0,i=0,maxi=data.length;i<maxi;i++){for(subdata=data[i],parseSampleData(subdata),void 0===this.sampleDataByNoteNumber[noteNumber]&&(this.sampleDataByNoteNumber[noteNumber]=[]),v1=subdata.v[0],v2=subdata.v[1],v=v1;v<=v2;v++)this.sampleDataByNoteNumber[noteNumber][v]=sampleConfig;this.sampleData.push(sampleConfig)}else parseSampleData(data),this.sampleDataByNoteNumber[noteNumber]=sampleConfig,this.sampleData.push(sampleConfig);if(void 0===this.keyRange&&(this.numNotes=this.highestNote-this.lowestNote,this.keyRange=[this.lowestNote,this.highestNote]),this.config.mapping=mapping,this.singlePitch)for(i=127;i>=0;i--)this.sampleData[i]=sampleConfig,this.sampleDataByNoteNumber[i]=sampleConfig;update&&(this.updateTaskId="update_"+this.name+"_"+(new Date).getTime(),repetitiveTasks[this.updateTaskId]=function(){me.autopan?me.update(this.autoPanner.getValue()):me.update()})},Instrument.prototype.getInfoAsHTML=function(){var html="",instrumentInfo="",samplepackInfo="",sp=this.samplepack;return void 0!==this.info&&(instrumentInfo+="<tr><td>info</td><td>"+this.info+"</td></tr>"),void 0!==this.author&&(instrumentInfo+="<tr><td>author</td><td>"+this.author+"</td></tr>"),void 0!==this.license&&(instrumentInfo+="<tr><td>license</td><td>"+this.license+"</td></tr>"),instrumentInfo+="<tr><td>keyrange</td><td>"+this.lowestNote+"("+sequencer.getFullNoteName(this.lowestNote)+")",instrumentInfo+=" - "+this.highestNote+"("+sequencer.getFullNoteName(this.highestNote)+")</td></tr>",""!==instrumentInfo&&(instrumentInfo='<table><th colspan="2">instrument</th>'+instrumentInfo+"</table>",html+=instrumentInfo),void 0===sp?html:(void 0!==sp.info&&(samplepackInfo+="<tr><td>info</td><td>"+sp.info+"</td></tr>"),void 0!==sp.author&&(samplepackInfo+="<tr><td>author</td><td>"+sp.author+"</td></tr>"),void 0!==sp.license&&(samplepackInfo+="<tr><td>license</td><td>"+sp.license+"</td></tr>"),void 0!==sp.compression&&(samplepackInfo+="<tr><td>compression</td><td>"+sp.compression+"</td></tr>"),void 0!==sp.filesize&&(samplepackInfo+="<tr><td>filesize</td><td>"+round(sp.filesize/1024/1024,2)+" MiB</td></tr>"),""!==samplepackInfo&&(samplepackInfo='<table><th colspan="2">samplepack</th>'+samplepackInfo+"</table>",html+=samplepackInfo),html)},Instrument.prototype.getInfo=function(){var info={instrument:{},samplepack:{}};return void 0!==this.info&&(info.instrument.info=this.info),void 0!==this.author&&(info.instrument.author=this.author),void 0!==this.license&&(info.instrument.license=this.license),void 0!==this.keyrange&&(info.instrument.keyrange=this.keyrange),void 0!==this.info&&(info.samplepack.info=this.info),void 0!==this.author&&(info.samplepack.author=this.author),void 0!==this.license&&(info.samplepack.license=this.license),void 0!==this.compression&&(info.samplepack.compression=this.compression),void 0!==this.filesize&&(info.samplepack.filesize=round(this.samplepack.filesize/1024/1024,2)),info},Instrument.prototype.createSample=function(event){var noteNumber=event.noteNumber,velocity=event.velocity,data=this.sampleDataByNoteNumber[noteNumber];return"array"===typeString(data)&&(data=data[velocity]),void 0===data||!1===data?{start:function(){console.warn("no audio data loaded for",noteNumber)},stop:function(){},update:function(){},addData:function(){},unschedule:function(){}}:(data.track=event.track,createSample(data))},Instrument.prototype.setKeyScalingPanning=function(start,end){var i,data,panStep,currentPan,numSamples=this.sampleData.length;if(!1===start)for(i=0;i<numSamples;i++)data=this.sampleData[i],data.panning=!1;if(!1===isNaN(start)&&!1===isNaN(end))for(panStep=(end-start)/this.numNotes,currentPan=start,i=0;i<numSamples;i++)data=this.sampleData[i],data.panning=!0,data.panPosition=currentPan,currentPan+=panStep},Instrument.prototype.setRelease=function(millis,envelope){if(void 0!==millis){this.releaseEnvelope=envelope||this.releaseEnvelope,this.keyScalingRelease=void 0;var i,data,numSamples=this.sampleData.length;for(i=0;i<numSamples;i++)data=this.sampleData[i],data.release=!0,data.release_duration=millis,data.release_envelope=this.releaseEnvelope;this.releaseDuration=millis}},Instrument.prototype.setKeyScalingRelease=function(start,end,envelope){var i,data,releaseStep,currentRelease,numSamples=this.sampleData.length;if(this.releaseEnvelope=envelope||this.releaseEnvelope,!1===isNaN(start)&&!1===isNaN(end))for(this.keyScalingRelease=[start,end],this.releaseDuration=0,releaseStep=(end-start)/this.numNotes,currentRelease=start,i=0;i<numSamples;i++)data=this.sampleData[i],data.release_duration=currentRelease,data.release_envelope=currentRelease,currentRelease+=releaseStep},Instrument.prototype.transpose=function(semitones,cb1,cb2){function loop(num,samples){var data;cb2&&cb2("transposing sample "+(num+1)+" of "+numSamples),num<numSamples?(data=samples[num],setTimeout(function(){transpose(data.buffer,semitones,function(transposedBuffer){data.buffer=transposedBuffer,loop(++num,samples)})},10)):cb1&&(console.log("ready"),cb1())}if(void 0===transpose)return void console.log("transpose is still experimental");var numSamples=this.sampleData.length;loop(0,this.sampleData)},Instrument.prototype.processEvent=function(midiEvent){var data1,data2,track,output,type=midiEvent.type;void 0===midiEvent.time&&(midiEvent.time=0),128===type||144===type?128===type?(!0===this.sustainPedalDown&&(midiEvent.sustainPedalDown=!0),this.stopNote(midiEvent)):this.playNote(midiEvent):176===midiEvent.type&&(data1=midiEvent.data1,data2=midiEvent.data2,64===data1?127===data2?(this.sustainPedalDown=!0,dispatchEvent(this.track.song,"sustain_pedal","down")):0===data2&&(this.sustainPedalDown=!1,dispatchEvent(this.track.song,"sustain_pedal","up"),this.stopSustain(midiEvent.time)):10===data1?(track=this.track,track.setPanning(remap(data2,0,127,-1,1))):7===data1&&(track=this.track,output=track.output,output.gain.setValueAtTime(data2/127,midiEvent.time)))},Instrument.prototype.stopSustain=function(seconds){var midiNote,scheduledSamples=this.scheduledSamples,sustainPedalSamples=this.sustainPedalSamples;objectForEach(sustainPedalSamples,function(sample){void 0!==sample&&(midiNote=sample.midiNote,midiNote.noteOn.sustainPedalDown=void 0,midiNote.noteOff.sustainPedalDown=void 0,sample.stop(seconds,function(sample){scheduledSamples[sample.sourceId]=null,delete scheduledSamples[sample.sourceId]}))}),this.sustainPedalSamples={}},Instrument.prototype.playNote=function(midiEvent){var sample,sourceId;if(!midiEvent.midiNote)return void(sequencer.debug&&console.warn("playNote() no midi note"));sourceId=midiEvent.midiNote.id,sample=this.scheduledSamples[sourceId],void 0!==sample&&sample.unschedule(0),sample=this.createSample(midiEvent),sample.addData({midiNote:midiEvent.midiNote,noteName:midiEvent.midiNote.note.fullName,sourceId:sourceId}),this.scheduledSamples[sourceId]=sample,sample.start(midiEvent)},Instrument.prototype.stopNote=function(midiEvent){if(void 0===midiEvent.midiNote)return void(sequencer.debug&&console.warn("stopNote() no midi note",midiEvent.ticks,midiEvent.noteNumber));var sourceId=midiEvent.midiNote.id,sample=this.scheduledSamples[sourceId],scheduledSamples=this.scheduledSamples,sustainPedalSamples=this.sustainPedalSamples;if(!0===midiEvent.sustainPedalDown)return void(sustainPedalSamples[sourceId]=sample);void 0!==sample&&sample.stop(midiEvent.time,function(){scheduledSamples[sourceId]=null,delete scheduledSamples[sourceId]})},Instrument.prototype.hasScheduledSamples=function(){return isEmptyObject(this.scheduledSamples)},Instrument.prototype.reschedule=function(song){var id,note,sample,min=song.millis,max=min+1e3*sequencer.bufferTime,scheduledSamples=this.scheduledSamples;for(id in scheduledSamples)if(scheduledSamples.hasOwnProperty(id))if(sample=scheduledSamples[id],void 0===(note=sample.midiNote)||"removed"===note.state)sample.unschedule(0,unscheduleCallback),delete scheduledSamples[id];else{if(note.noteOn.millis>=min&&note.noteOff.millis<max&&sample.noteName===note.fullName)continue;delete scheduledSamples[id],sample.unschedule(null,unscheduleCallback)}},Instrument.prototype.unschedule=function(){var i,e,id,sample,args=Array.prototype.slice.call(arguments),events=[];for(loop(args,0,args.length,events),i=events.length-1;i>=0;i--)e=events[i],void 0!==e.midiNote?(id=e.midiNote.id,void 0!==(sample=this.scheduledSamples[id])&&(sample.unschedule(0,unscheduleCallback),delete this.scheduledSamples[id])):"MidiEvent"===e.className&&(id=e.id,delete timedTasks["event_"+id],delete this.scheduledEvents[id])},Instrument.prototype.allNotesOff=function(){var sample,sampleId,scheduledSamples=this.scheduledSamples;if(this.stopSustain(0),this.sustainPedalDown=!1,void 0!==scheduledSamples&&!0!==isEmptyObject(scheduledSamples)){for(sampleId in scheduledSamples)scheduledSamples.hasOwnProperty(sampleId)&&(sample=scheduledSamples[sampleId])&&sample.unschedule(0,unscheduleCallback);this.scheduledSamples={},objectForEach(this.scheduledEvents,function(event,eventId){delete timedTasks["event_"+eventId]}),this.scheduledEvents={}}},Instrument.prototype.allNotesOffPart=function(partId){var sample,sampleId,scheduledSamples=this.scheduledSamples;if(this.stopSustain(0),this.sustainPedalDown=!1,void 0!==scheduledSamples&&!0!==isEmptyObject(scheduledSamples)){for(sampleId in scheduledSamples)scheduledSamples.hasOwnProperty(sampleId)&&(sample=scheduledSamples[sampleId])&&sample.unschedule(0,unscheduleCallback);this.scheduledSamples={},objectForEach(this.scheduledEvents,function(event,eventId){delete timedTasks["event_"+eventId]}),this.scheduledEvents={}}},Instrument.prototype.update=function(value){var sampleId,sample;for(sampleId in this.scheduledSamples)this.scheduledSamples.hasOwnProperty(sampleId)&&(sample=this.scheduledSamples[sampleId])&&sample.update(value)},sequencer.createInstrument=function(arg){var config,instrument,type=typeString(arg);return"object"===type?("Instrument"===arg.className?instrument=arg:"InstrumentConfig"===arg.className&&(instrument="sinewave"===arg.name?new SimpleSynth(arg):new Instrument(arg)),instrument):("string"===type&&(config=findItem(arg,storage.instruments)),!1===config||"InstrumentConfig"!==config.className?(debug>=2&&console.info("can not create instrument from",arg),!1):instrument="sinewave"===config.name?new SimpleSynth(config):new Instrument(config))},sequencer.protectedScope.addInitMethod(function(){var protectedScope=sequencer.protectedScope;storage=sequencer.storage,createSample=sequencer.createSample,createReverb=sequencer.createReverb,dispatchEvent=sequencer.protectedScope.songDispatchEvent,context=protectedScope.context,timedTasks=protectedScope.timedTasks,repetitiveTasks=protectedScope.repetitiveTasks,objectForEach=protectedScope.objectForEach,isEmptyObject=protectedScope.isEmptyObject,findItem=protectedScope.findItem,storeItem=protectedScope.storeItem,typeString=protectedScope.typeString,pathToArray=protectedScope.pathToArray,transpose=protectedScope.transpose,SimpleSynth=protectedScope.createClass(Instrument),remap=sequencer.util.remap,round=sequencer.util.round,getEqualPowerCurve=sequencer.util.getEqualPowerCurve,SimpleSynth.prototype.parse=function(){var me=this,config=this.config;this.name="SineWave",this.waveForm=config.wave_form||"sine",this.autopan=config.autopan||!1,this.folder=config.folder||"heartbeat",this.releaseDuration=config.release_duration||1500,this.autopan&&(this.autoPanner=createAutoPanner()),repetitiveTasks["update_"+this.name+"_"+(new Date).getTime()]=function(){me.autopan?me.update(Math.sin(2*context.currentTime*Math.PI)):me.update()}},SimpleSynth.prototype.createSample=function(event){var data={oscillator:!0,track:event.track,event:event,autopan:this.autopan,wave_form:this.waveForm,release_envelope:"equal power",release_duration:this.releaseDuration};return createSample(data)},sequencer.createSimpleSynth=function(config){return config=config||{},new SimpleSynth(config)}})}(),function(){"use strict";var repetitiveTasks,typeString,createSample,round,parseSamples,createAutoPanner,createSimpleSynth,Instrument,sequencer=window.sequencer,console=window.console;sequencer.debug;Instrument=function(config){this.className="Instrument",this.id="I0"+(new Date).getTime(),this.config=config,this.scheduledEvents={},this.scheduledSamples={},this.sustainPedalDown=!1,this.sustainPedalSamples={},this.sampleDataByNoteNumber={},this.sampleData=[],this.info=config.info||{},void 0!==this.info.samples&&void 0!==this.info.sample.filesize&&(this.info.samples.filesize=round(this.samplepack.filesize/1024/1024,2))},Instrument.prototype.reset=function(){},Instrument.prototype.parse=function(){function createSampleConfig(data){if(data.n&&(buffer=me.samples[data.n]),void 0===buffer)return sequencer.debug&&console.log("no buffer found for "+id+" ("+me.name+")"),void(sampleConfig=!1);sampleConfig={noteNumber:noteNumber,buffer:buffer,autopan:me.autopan},!0===config.sustain&&(sampleConfig.sustain=!0,update=!0),void 0!==data.s&&(sampleConfig.sustain_start=data.s[0],sampleConfig.sustain_end=data.s[1],sampleConfig.sustain=!0,update=!0),void 0!==config.release_duration&&(sampleConfig.release_duration=config.release_duration,sampleConfig.release_envelope=config.release_envelope||me.releaseEnvelope,sampleConfig.release=!0,update=!0),void 0!==data.r&&("array"===typeString(data.r)?(sampleConfig.release_duration=data.r[0],sampleConfig.release_envelope=data.r[1]||me.releaseEnvelope):isNaN(data.r)||(sampleConfig.release_duration=data.r,sampleConfig.release_envelope=me.releaseEnvelope),sampleConfig.release=!0,update=!0),void 0!==data.p&&(sampleConfig.panPosition=data.p,sampleConfig.panning=!0)}var i,maxi,v,v1,v2,length,octave,note,noteName,noteNumber,buffer,id,data,subdata,update,sampleConfig,config=this.config,noteNameMode=void 0===config.notename_mode?sequencer.noteNameMode:config.notename_mode,me=this;if(this.name=config.name||this.id,this.autopan=config.autopan||!1,this.singlePitch=config.single_pitch||!1,this.keyScalingRelease=config.keyscaling_release,this.keyScalingPanning=config.keyscaling_panning,this.keyRange=config.keyrange||config.key_range,this.mapping=config.mapping,void 0===this.keyRange?(this.lowestNote=128,this.highestNote=-1):(this.lowestNote=this.keyRange[0],this.highestNote=this.keyRange[1],this.numNotes=this.highestNote-this.lowestNote),void 0!==config.release_duration?this.releaseDuration=config.release_duration:this.releaseDuration=0,this.releaseEnvelope=config.release_envelope||"equal power",this.autopan&&(this.autoPanner=createAutoPanner()),void 0===this.mapping){this.mapping={};for(id in this.samples)this.samples.hasOwnProperty(id)&&(this.mapping[id]={n:id})}for(id in this.mapping)if(this.mapping.hasOwnProperty(id))if(data=this.mapping[id],isNaN(id)?(length=id.length,octave=id.substring(length-1),note=id.substring(0,length-1),noteName=id,noteNumber=sequencer.getNoteNumber(note,octave)):(noteName=sequencer.getNoteNameFromNoteNumber(id,noteNameMode),noteName=noteName.join(""),noteNumber=id),noteNumber=parseInt(noteNumber,10),void 0===this.keyRange&&(this.lowestNote=noteNumber<this.lowestNote?noteNumber:this.lowestNote,this.highestNote=noteNumber>this.highestNote?noteNumber:this.highestNote),"string"===typeString(data))buffer=this.samples[data];else if("array"===typeString(data))for(this.multiLayered=!0,i=0,maxi=data.length;i<maxi;i++){for(subdata=data[i],createSampleConfig(subdata),void 0===this.sampleDataByNoteNumber[noteNumber]&&(this.sampleDataByNoteNumber[noteNumber]=[]),v1=subdata.v[0],v2=subdata.v[1],v=v1;v<=v2;v++)this.sampleDataByNoteNumber[noteNumber][v]=sampleConfig;this.sampleData.push(sampleConfig)}else createSampleConfig(data),this.sampleDataByNoteNumber[noteNumber]=sampleConfig,this.sampleData.push(sampleConfig);if(void 0===this.keyRange&&(this.numNotes=this.highestNote-this.lowestNote,this.keyRange=[this.lowestNote,this.highestNote]),this.singlePitch)for(i=127;i>=0;i--)this.sampleData[i]=sampleConfig,this.sampleDataByNoteNumber[i]=sampleConfig;update&&(this.updateTaskId="update_"+this.name+"_"+(new Date).getTime(),repetitiveTasks[this.updateTaskId]=function(){me.autopan?me.update(this.autoPanner.getValue()):me.update()})},Instrument.prototype.getInfoAsHTML=function(){var html="",instrumentHtml="",samplepackHtml="",instrumentInfo={},samplesInfo={};return void 0!==this.info&&(samplesInfo=this.info.samples,instrumentInfo=this.info.instrument),void 0!==instrumentInfo.descriptiom&&(instrumentHtml+="<tr><td>info</td><td>"+instrumentInfo.description+"</td></tr>"),void 0!==instrumentInfo.author&&(instrumentHtml+="<tr><td>author</td><td>"+instrumentInfo.author+"</td></tr>"),void 0!==instrumentInfo.license&&(instrumentHtml+="<tr><td>license</td><td>"+instrumentInfo.license+"</td></tr>"),instrumentHtml+="<tr><td>keyrange</td><td>"+this.lowestNote+"("+sequencer.getFullNoteName(this.lowestNote)+")",instrumentHtml+=" - "+this.highestNote+"("+sequencer.getFullNoteName(this.highestNote)+")</td></tr>",""!==instrumentHtml&&(instrumentHtml='<table><th colspan="2">instrument</th>'+instrumentHtml+"</table>",html+=instrumentHtml),void 0!==samplesInfo.description&&(samplepackHtml+="<tr><td>info</td><td>"+samplesInfo.description+"</td></tr>"),void 0!==samplesInfo.author&&(samplepackHtml+="<tr><td>author</td><td>"+samplesInfo.author+"</td></tr>"),void 0!==samplesInfo.license&&(samplepackHtml+="<tr><td>license</td><td>"+samplesInfo.license+"</td></tr>"),void 0!==samplesInfo.compression&&(samplepackHtml+="<tr><td>compression</td><td>"+samplesInfo.compression+"</td></tr>"),void 0!==samplesInfo.filesize&&(samplepackHtml+="<tr><td>filesize</td><td>"+samplesInfo.filesize+" MiB</td></tr>"),""!==samplepackHtml&&(samplepackHtml='<table><th colspan="2">samplepack</th>'+samplepackHtml+"</table>",html+=samplepackHtml),html},Instrument.prototype.createSample=function(event){var noteNumber=event.noteNumber,velocity=event.velocity,data=this.sampleDataByNoteNumber[noteNumber];return"array"===typeString(data)&&(data=data[velocity]),void 0===data||!1===data?{start:function(){console.warn("no audio data loaded for",noteNumber)},stop:function(){},update:function(){},addData:function(){},unschedule:function(){}}:(data.track=event.track,createSample(data))},sequencer.createInstrument2=function(config){function executor(resolve,reject){var instrument;void 0===config.samples&&reject("instruments must have samples",config),instrument="sinewave"===config.name?createSimpleSynth(config):new Instrument(config),parseSamples(config.samples).then(function(samples){config.samples=null,instrument.samples=samples,instrument.parse(),resolve(instrument)},function(e){reject(e)})}return new Promise(executor)},sequencer.protectedScope.addInitMethod(function(){var protectedScope=sequencer.protectedScope;createSample=sequencer.createSample,repetitiveTasks=protectedScope.repetitiveTasks,typeString=protectedScope.typeString,round=sequencer.util.round,createSimpleSynth=sequencer.createSimpleSynth,parseSamples=sequencer.util.parseSamples,["createAutoPanner","setKeyScalingPanning","setKeyScalingRelease","setRelease","transposeSamples","processEvent","stopSustain","playNote","stopNote","allNotesOff","allNotesOffPart","update","hasScheduledSamples","reschedule","unschedule"].forEach(function(name){var m=protectedScope[name];Instrument.prototype[name]=function(){m.apply(this,arguments)}})})}(),function(){"use strict";function cleanup(instrument,callback){callback&&callback(!1)}function store(instrument){var occupied=findItem(instrument.localPath,sequencer.storage.instruments,!0),action=instrument.action;occupied&&"InstrumentConfig"===occupied.className&&"overwrite"!==action?sequencer.debug>=2&&(console.warn("there is already an Instrument at",instrument.localPath),cleanup(instrument)):storeItem(instrument,instrument.localPath,sequencer.storage.instruments)}function load(instrument,callback){if(void 0===instrument.url)return instrument.localPath=void 0!==instrument.folder?instrument.folder+"/"+instrument.name:instrument.name,void callback();ajax({url:instrument.url,responseType:"json",onError:function(){cleanup(instrument,callback)},onSuccess:function(data){if(null===data)return void callback(!1);void 0!==data.name&&void 0===instrument.name&&(instrument.name=data.name),void 0!==data.folder&&void 0===instrument.folder&&(instrument.folder=data.folder),void 0===instrument.name&&(instrument.name=parseUrl(instrument.url).name),instrument.localPath=void 0!==instrument.folder?instrument.folder+"/"+instrument.name:instrument.name,objectForEach(data,function(val,key){"name"!==key&&"folder"!==key&&(instrument[key]=val)}),callback()}})}var ajax,parseUrl,findItem,storeItem,typeString,objectForEach,InstrumentConfig,sequencer=window.sequencer,console=window.console,index=0;InstrumentConfig=function(config){this.id="IC"+index+++(new Date).getTime(),this.className="InstrumentConfig";var instrument=this;objectForEach(config,function(val,key){instrument[key]=val})},sequencer.addInstrument=function(config,callback,callbackAfterAllTasksAreDone){var instrument,json,name,folder,type=typeString(config);if("object"!==type)return sequencer.debug>=2&&console.warn("can't add an Instrument with this data",config),!1;if(config.json){if(json=config.json,name=config.name,folder=config.folder,"string"===typeString(json))try{json=JSON.parse(json)}catch(e){return sequencer.debug>=2&&console.warn("can't add an Instrument with this data",config),!1}if(void 0===json.mapping)return sequencer.debug>=2&&console.warn("can't add an Instrument with this data",config),!1;config={mapping:json.mapping,name:void 0===name?json.name:name,folder:void 0===folder?json.folder:folder}}instrument=new InstrumentConfig(config),sequencer.addTask({type:"load instrument config",method:load,params:instrument},function(value){store(instrument),callback&&callback(instrument)},callbackAfterAllTasksAreDone),sequencer.startTaskQueue()},sequencer.protectedScope.addInitMethod(function(){ajax=sequencer.protectedScope.ajax,findItem=sequencer.protectedScope.findItem,parseUrl=sequencer.protectedScope.parseUrl,storeItem=sequencer.protectedScope.storeItem,typeString=sequencer.protectedScope.typeString,objectForEach=sequencer.protectedScope.objectForEach})}(),function(){"use strict";function unscheduleCallback(sample){null}function loop(data,i,maxi,events){var arg;for(i=0;i<maxi;i++)void 0!==(arg=data[i])&&("MidiNote"===arg.className?events.push(arg.noteOn):"array"===typeString(arg)&&loop(arg,0,arg.length))}function createAutoPanner(time){return{getValue:function(time){return Math.sin(2*time*Math.PI)}}}var typeString,remap,timedTasks,createReverb,objectForEach,isEmptyObject,transpose,getEqualPowerCurve,dispatchEvent,setKeyScalingPanning,setKeyScalingRelease,setRelease,transposeSamples,processEvent,stopSustain,playNote,stopNote,allNotesOff,allNotesOffPart,update,hasScheduledSamples,reschedule,unschedule,sequencer=window.sequencer,console=window.console;setKeyScalingPanning=function(start,end){var i,data,panStep,currentPan,numSamples=this.sampleData.length;if(!1===start)for(i=0;i<numSamples;i++)data=this.sampleData[i],data.panning=!1;if(!1===isNaN(start)&&!1===isNaN(end))for(panStep=(end-start)/this.numNotes,currentPan=start,i=0;i<numSamples;i++)data=this.sampleData[i],data.panning=!0,data.panPosition=currentPan,currentPan+=panStep},setRelease=function(millis,envelope){if(void 0!==millis){this.releaseEnvelope=envelope||this.releaseEnvelope,this.keyScalingRelease=void 0;var i,data,numSamples=this.sampleData.length;for(i=0;i<numSamples;i++)data=this.sampleData[i],data.release=!0,data.release_duration=millis,data.release_envelope=this.releaseEnvelope;this.releaseDuration=millis}},setKeyScalingRelease=function(start,end,envelope){var i,data,releaseStep,currentRelease,numSamples=this.sampleData.length;if(this.releaseEnvelope=envelope||this.releaseEnvelope,!1===isNaN(start)&&!1===isNaN(end))for(this.keyScalingRelease=[start,end],this.releaseDuration=0,releaseStep=(end-start)/this.numNotes,currentRelease=start,i=0;i<numSamples;i++)data=this.sampleData[i],data.release_duration=currentRelease,data.release_envelope=currentRelease,currentRelease+=releaseStep},transposeSamples=function(semitones,cb1,cb2){function loop(num,samples){var data;cb2&&cb2("transposing sample "+(num+1)+" of "+numSamples),num<numSamples?(data=samples[num],setTimeout(function(){transpose(data.buffer,semitones,function(transposedBuffer){data.buffer=transposedBuffer,loop(++num,samples)})},10)):cb1&&(console.log("ready"),cb1())}if(void 0===transpose)return void console.log("transpose is still experimental");var numSamples=this.sampleData.length;loop(0,this.sampleData)},processEvent=function(midiEvent){var data1,data2,track,output,type=midiEvent.type;void 0===midiEvent.time&&(midiEvent.time=0),128===type||144===type?128===type?(!0===this.sustainPedalDown&&(midiEvent.sustainPedalDown=!0),this.stopNote(midiEvent)):this.playNote(midiEvent):176===type&&(data1=midiEvent.data1,data2=midiEvent.data2,64===data1?127===data2?(this.sustainPedalDown=!0,dispatchEvent(this.track.song,"sustain_pedal","down")):0===data2&&(this.sustainPedalDown=!1,dispatchEvent(this.track.song,"sustain_pedal","up"),this.stopSustain(midiEvent.time)):10===data1?(track=this.track,track.setPanning(remap(data2,0,127,-1,1))):7===data1&&(track=this.track,output=track.output,output.gain.setValueAtTime(data2/127,midiEvent.time)))},stopSustain=function(seconds){var midiNote,scheduledSamples=this.scheduledSamples,sustainPedalSamples=this.sustainPedalSamples;objectForEach(sustainPedalSamples,function(sample){void 0!==sample&&(midiNote=sample.midiNote,midiNote.noteOn.sustainPedalDown=void 0,midiNote.noteOff.sustainPedalDown=void 0,sample.stop(seconds,function(sample){scheduledSamples[sample.sourceId]=null,delete scheduledSamples[sample.sourceId]}))}),this.sustainPedalSamples={}},playNote=function(midiEvent){
var sample,sourceId;if(!midiEvent.midiNote)return void(sequencer.debug&&console.warn("playNote() no midi note"));sourceId=midiEvent.midiNote.id,sample=this.scheduledSamples[sourceId],void 0!==sample&&sample.unschedule(0),sample=this.createSample(midiEvent),sample.addData({midiNote:midiEvent.midiNote,noteName:midiEvent.midiNote.note.fullName,sourceId:sourceId}),this.scheduledSamples[sourceId]=sample,sample.start(midiEvent)},stopNote=function(midiEvent){if(void 0===midiEvent.midiNote)return void(sequencer.debug&&console.warn("stopNote() no midi note"));var sourceId=midiEvent.midiNote.id,sample=this.scheduledSamples[sourceId],scheduledSamples=this.scheduledSamples,sustainPedalSamples=this.sustainPedalSamples;if(!0===midiEvent.sustainPedalDown)return void(sustainPedalSamples[sourceId]=sample);void 0!==sample&&sample.stop(midiEvent.time,function(){scheduledSamples[sourceId]=null,delete scheduledSamples[sourceId]})},hasScheduledSamples=function(){return isEmptyObject(this.scheduledSamples)},reschedule=function(song){var id,note,sample,min=song.millis,max=min+1e3*sequencer.bufferTime,scheduledSamples=this.scheduledSamples;for(id in scheduledSamples)if(scheduledSamples.hasOwnProperty(id))if(sample=scheduledSamples[id],void 0===(note=sample.midiNote)||"removed"===note.state)sample.unschedule(0,unscheduleCallback),delete scheduledSamples[id];else{if(note.noteOn.millis>=min&&note.noteOff.millis<max&&sample.noteName===note.fullName)continue;delete scheduledSamples[id],sample.unschedule(null,unscheduleCallback)}},unschedule=function(){var i,e,id,sample,args=Array.prototype.slice.call(arguments),events=[];for(loop(args,0,args.length,events),i=events.length-1;i>=0;i--)e=events[i],void 0!==e.midiNote?(id=e.midiNote.id,void 0!==(sample=this.scheduledSamples[id])&&(sample.unschedule(0,unscheduleCallback),delete this.scheduledSamples[id])):"MidiEvent"===e.className&&(id=e.id,delete timedTasks["event_"+id],delete this.scheduledEvents[id])},allNotesOff=function(){var sample,sampleId,scheduledSamples=this.scheduledSamples;if(this.stopSustain(0),this.sustainPedalDown=!1,void 0!==scheduledSamples&&!0!==isEmptyObject(scheduledSamples)){for(sampleId in scheduledSamples)scheduledSamples.hasOwnProperty(sampleId)&&(sample=scheduledSamples[sampleId])&&sample.unschedule(0,unscheduleCallback);this.scheduledSamples={},objectForEach(this.scheduledEvents,function(event,eventId){delete timedTasks["event_"+eventId]}),this.scheduledEvents={}}},allNotesOffPart=function(partId){var sample,sampleId,scheduledSamples=this.scheduledSamples;if(this.stopSustain(0),this.sustainPedalDown=!1,void 0!==scheduledSamples&&!0!==isEmptyObject(scheduledSamples)){for(sampleId in scheduledSamples)scheduledSamples.hasOwnProperty(sampleId)&&(sample=scheduledSamples[sampleId])&&sample.unschedule(0,unscheduleCallback);this.scheduledSamples={},objectForEach(this.scheduledEvents,function(event,eventId){delete timedTasks["event_"+eventId]}),this.scheduledEvents={}}},update=function(value){var sampleId,sample;for(sampleId in this.scheduledSamples)this.scheduledSamples.hasOwnProperty(sampleId)&&(sample=this.scheduledSamples[sampleId])&&sample.update(value)},sequencer.protectedScope.createAutoPanner=createAutoPanner,sequencer.protectedScope.setKeyScalingPanning=setKeyScalingPanning,sequencer.protectedScope.setKeyScalingRelease=setKeyScalingRelease,sequencer.protectedScope.setRelease=setRelease,sequencer.protectedScope.transposeSamples=transposeSamples,sequencer.protectedScope.processEvent=processEvent,sequencer.protectedScope.stopSustain=stopSustain,sequencer.protectedScope.playNote=playNote,sequencer.protectedScope.stopNote=stopNote,sequencer.protectedScope.allNotesOff=allNotesOff,sequencer.protectedScope.allNotesOffPart=allNotesOffPart,sequencer.protectedScope.update=update,sequencer.protectedScope.hasScheduledSamples=hasScheduledSamples,sequencer.protectedScope.reschedule=reschedule,sequencer.protectedScope.unschedule=unschedule,sequencer.protectedScope.addInitMethod(function(){typeString=sequencer.protectedScope.typeString,timedTasks=sequencer.protectedScope.timedTasks,createReverb=sequencer.createReverb,objectForEach=sequencer.protectedScope.objectForEach,isEmptyObject=sequencer.protectedScope.isEmptyObject,transpose=sequencer.protectedScope.transpose,getEqualPowerCurve=sequencer.util.getEqualPowerCurve,remap=sequencer.util.remap,dispatchEvent=sequencer.protectedScope.songDispatchEvent})}(),function(){"use strict";var KeyEditor,createIteratorFactory,getPosition,createPlayhead,getScaffoldingBars,typeString,objectToArray,arrayToObject,debug,round,floor,createNote,setPageData,checkNextPage,checkScrollPosition,dispatchEvent,sequencer=window.sequencer,console=window.console,requestAnimationFrame=window.requestAnimationFrame,updateDataKeys="newEvents newNotes newParts changedEvents changedNotes changedParts removedEvents removedNotes removedParts".split(" "),ceil=Math.ceil;KeyEditor=function(song,config){this.song=song,this.song.keyEditor=this,this.playhead=createPlayhead(this.song,"barsbeats ticks millis","keyeditor"),this.numBars=song.bars,this.newNumBars=this.numBars,this.eventListeners={},this.interrupt=!1,this.iteratorFactory=createIteratorFactory(this.song,this),this.verticalLine=this.iteratorFactory.createVerticalLineIterator(this),this.horizontalLine=this.iteratorFactory.createHorizontalLineIterator(this),this.eventIterator=this.iteratorFactory.createEventIterator(this),this.noteIterator=this.iteratorFactory.createNoteIterator(this),this.partIterator=this.iteratorFactory.createPartIterator(this),this.exactFitVertical=config.exactFitVertical||!1,this.exactFitHorizontal=config.exactFitHorizontal||!1,this.activeEvents=[],this.activeNotes=[],this.activeParts=[],this.newEvents=[],this.newNotes=[],this.newParts=[],this.changedEvents=[],this.changedNotes=[],this.changedParts=[],this.removedEvents=[],this.removedNotes=[],this.removedParts=[],this.recordedNotesObj={},this.recordedEventsObj={},this.snapshot={activeEvents:this.activeEvents,activeNotes:this.activeNotes,activeParts:this.activeParts,newEvents:this.newEvents,newNotes:this.newNotes,newParts:this.newParts,changedEvents:this.changedEvents,changedNotes:this.changedNotes,changedParts:this.changedParts,removedEvents:this.removedEvents,removedNotes:this.removedNotes,removedParts:this.removedParts},config.paginate?(this.paginate=!0,this.pageNo=0,this.barsPerPage=config.barsPerPage,this.pageWidth=config.pageWidth,this.pageHeight=config.pageHeight,this.width=this.pageWidth,this.lowestNote=config.lowestNote||song.lowestNote,this.highestNote=config.highestNote||song.highestNote,this.pitchRange=this.highestNote-this.lowestNote,this.exactFitVertical?(this.pitchHeight=this.height/this.pitchRange,this.height=this.pageHeight):(this.pitchHeight=config.pitchHeight||10,this.height=this.pitchHeight*this.pitchRange),setPageData(this,0),checkNextPage(this)):(this.setStartPosition(config.startPosition||1),this.setEndPosition(config.endPosition||song.bars+1),this.numTicks=this.endTicks-this.startTicks,config.width?(this.width=config.width,this.tickWidth=this.width/this.numTicks):config.tickWidth?(this.tickWidth=config.tickWidth,this.width=this.numTicks*this.tickWidth,this.exactFitHorizontal=!1):config.barsPerPage&&config.viewportWidth?(this.barsPerPage=config.barsPerPage,this.viewportWidth=config.viewportWidth,this.tickWidth=this.viewportWidth/(this.startPosition.ticksPerBar*this.barsPerPage),this.width=this.numTicks*this.tickWidth,this.scrollX=0,this.scrollPosition=0,this.viewportTicks=this.viewportWidth/this.tickWidth,this.maxScrollPosition=ceil(this.width/this.viewportWidth),this.scrollLimit=this.viewportWidth/this.tickWidth,checkScrollPosition(this),this.exactFitHorizontal=!1):config.viewportWidth?(this.viewportWidth=this.width=config.viewportWidth,this.tickWidth=this.viewportWidth/this.numTicks,this.exactFitHorizontal=!0):(this.tickWidth=.1,this.width=this.numTicks*this.tickWidth,this.exactFitHorizontal=!1),this.lowestNote=config.lowestNote||song.lowestNote,this.highestNote=config.highestNote||song.highestNote,this.pitchRange=config.pitchRange||this.highestNote-this.lowestNote+1,config.height?(this.height=config.height,this.pitchHeight=this.height/this.pitchRange):config.pitchHeight?(this.pitchHeight=config.pitchHeight,this.height=this.pitchRange*this.pitchHeight,this.exactFitVertical=!1):config.viewportHeight?(this.viewportHeight=this.height=config.viewportHeight,this.pitchHeight=this.viewportHeight/this.pitchRange,this.exactFitVertical=!0):(this.pitchHeight=10,this.height=this.pitchRange*this.pitchHeight,this.exactFitVertical=!1)),this.scrollX=0,this.scrollY=0,this.currentPage=1,this.numPages=ceil(this.width/this.viewportWidth),this.snapValueX=void 0===config.snapX?0:config.snapX,this.snapValueY=void 0===config.snapY?"chromatic":config.snapY,this.setSnapX(this.snapValueX),this.setSnapY(this.snapValueY)},KeyEditor.prototype.setBarsPerPage=function(bbp){this.interrupt=!0;var tmp=round(this.scrollX/(this.viewportWidth/this.barsPerPage));this.barsPerPage=bbp,this.tickWidth=this.viewportWidth/(this.startPosition.ticksPerBar*this.barsPerPage),this.viewportTicks=this.viewportWidth/this.tickWidth,this.width=this.numTicks*this.tickWidth,this.verticalLine.reset(),this.horizontalLine.reset(),this.eventIterator.reset(),this.partIterator.reset(),this.scrollLimit=this.viewportWidth/this.tickWidth,this.maxScrollPosition=ceil(this.width/this.viewportWidth),this.snapWidth=this.tickWidth*this.snapTicks,this.numPages=ceil(this.numBars/this.barsPerPage),this.currentPage=floor(this.song.ticks/(this.barsPerPage*this.song.ticksPerBar))+1,dispatchEvent(this,"scale",{}),this.song.playing?this.scrollPosition=floor(this.song.ticks/this.viewportTicks):(this.scrollPosition=this.viewportWidth/this.barsPerPage*tmp/this.viewportWidth,dispatchEvent(this,"scroll",{x:this.scrollPosition*this.viewportWidth})),this.interrupt=!1},KeyEditor.prototype.setViewport=function(w,h){var draw=!1;this.barsPerPage&&w!==this.viewportWidth?(this.viewportWidth=w,this.tickWidth=this.viewportWidth/(this.startPosition.ticksPerBar*this.barsPerPage),this.viewportTicks=this.viewportWidth/this.tickWidth,this.width=this.numTicks*this.tickWidth,draw=!0):!0===this.exactFitHorizontal&&w!==this.width&&(this.viewportWidth=this.width=w,this.tickWidth=this.width/this.numTicks,draw=!0),!0===this.exactFitVertical&&h!==this.height&&(this.viewportHeight=this.height=h,this.pitchHeight=this.height/this.pitchRange,draw=!0),draw&&(this.verticalLine.reset(),this.horizontalLine.reset(),this.eventIterator.reset(),this.noteIterator.reset(),this.partIterator.reset(),dispatchEvent(this,"draw",{}))},KeyEditor.prototype.updateSong=function(data){this.iteratorFactory.updateSong();var key,j,arr,tmp,i=0;for(i=updateDataKeys.length-1;i>=0;i--)switch(key=updateDataKeys[i]){case"newNotes":case"changedNotes":for(arr=data[key],j=arr.length-1;j>=0;j--)tmp=arr[j],tmp.bbox=this.getNoteRect(tmp);break;case"newParts":case"changedParts":for(arr=data[key],j=arr.length-1;j>=0;j--)tmp=arr[j],tmp.bbox=this.getPartRect(tmp)}this.newNumBars=data.numBars,this.newEvents=this.newEvents.concat(data.newEvents),this.changedEvents=this.changedEvents.concat(data.changedEvents),this.removedEvents=this.removedEvents.concat(data.removedEvents),this.removedEventsObj=arrayToObject(this.removedEvents,"id"),this.newNotes=this.newNotes.concat(data.newNotes),this.changedNotes=this.changedNotes.concat(data.changedNotes),this.removedNotes=this.removedNotes.concat(data.removedNotes),this.removedNotesObj=arrayToObject(this.removedNotes,"id"),this.newParts=this.newParts.concat(data.newParts),this.changedParts=this.changedParts.concat(data.changedParts),this.removedParts=this.removedParts.concat(data.removedParts),this.removedPartsObj=arrayToObject(this.removedParts,"id")},KeyEditor.prototype.setStartPosition=function(pos){"array"!==typeString(pos)&&(pos=["barsandbeats",pos,1,1,0]),this.startPosition=getPosition(this.song,pos),this.startTicks=this.startPosition.ticks,this.startMillis=this.startPosition.millis},KeyEditor.prototype.setEndPosition=function(pos){"array"!==typeString(pos)&&(pos=["barsandbeats",pos,1,1,0]),this.endPosition=getPosition(this.song,pos),this.endTicks=this.endPosition.ticks,this.endMillis=this.endPosition.millis},KeyEditor.prototype.addEventListener=function(id,cb){var tmp,eventId,ids=id.split(" "),editor=this;ids.forEach(function(id){tmp=editor.eventListeners[id],void 0===tmp&&(editor.eventListeners[id]=[],tmp=editor.eventListeners[id]),eventId=id+"-"+tmp.length,tmp.push(cb)})},KeyEditor.prototype.nextPage=function(){setPageData(this,this.startBar+this.barsPerPage),dispatchEvent(this,"pagechange",{pageNo:this.pageNo,lastPage:this.lastPage})},KeyEditor.prototype.prevPage=function(){setPageData(this,this.startBar-this.barsPerPage),dispatchEvent(this,"pagechange",{pageNo:this.pageNo,lastPage:this.lastPage})},KeyEditor.prototype.gotoPage=function(n){console.warn("ooops, not implemented yet!")},KeyEditor.prototype.scroll=function(action){var x,tmp=round(this.scrollX/(this.viewportWidth/this.barsPerPage));switch(this.scrollPosition=this.viewportWidth/this.barsPerPage*tmp/this.viewportWidth,action){case">":this.scrollPosition+=1,this.scrollPosition=this.scrollPosition>this.maxScrollPosition?this.maxScrollPosition:this.scrollPosition;break;case">>":this.scrollPosition=this.maxScrollPosition;break;case"<":this.scrollPosition-=1,this.scrollPosition=this.scrollPosition<0?0:this.scrollPosition;break;case"<<":this.scrollPosition=0;break;default:if(isNaN(action))return;this.scrollPosition=parseInt(action)}x=this.scrollPosition*this.viewportWidth,this.scrollLimit=(x+this.viewportWidth)/this.tickWidth,this.currentPage=ceil(x/this.viewportWidth)+1,0===this.currentPage?this.currentPage=1:this.currentPage>this.maxScrollPosition&&(this.currentPage=this.maxScrollPosition),dispatchEvent(this,"scroll",{x:x})},KeyEditor.prototype.updateScroll=function(scrollX,scrollY){this.scrollX=scrollX,this.scrollY=scrollY,this.scrollLimit=(scrollX+this.viewportWidth)/this.tickWidth},KeyEditor.prototype.getEventRect=function(event){var x=this.ticksToX(event.ticks-this.startTicks,!1),y=this.pitchToY(event.number),w=2*this.tickWidth,h=this.pitchHeight;return{x:x,y:y,width:w,height:h,top:y,left:x,bottom:y+h,right:x+w}},KeyEditor.prototype.getNoteRect=function(note){var start,end,diff,x=this.ticksToX(note.ticks-this.startTicks,!1),y=this.pitchToY(note.number),w=note.durationTicks*this.tickWidth,h=this.pitchHeight;if(note.endless&&(w=(this.song.ticks-note.noteOn.ticks)*this.tickWidth),this.paginate){if(start=note.ticks,end=note.noteOff.ticks,!(start<this.startTicks))return!1;diff=this.startTicks-start,start=start+diff-this.startTicks,x=start*this.tickWidth,end=end>this.endTicks?this.endTicks:end,w=(end-this.startTicks)*this.tickWidth}return{x:x,y:y,width:w,height:h,top:y,left:x,bottom:y+h,right:x+w}},KeyEditor.prototype.getPartRect=function(part){var stats=part.getStats("noteNumber all"),bbox={top:this.pitchToY(stats.max),bottom:this.pitchToY(stats.min)+this.pitchHeight,left:this.ticksToX(part.start.ticks-this.startTicks,!1),right:this.ticksToX(part.end.ticks-this.startTicks,!1)};return bbox.x=bbox.left,bbox.y=bbox.top,bbox.width=bbox.right-bbox.left,bbox.height=bbox.bottom-bbox.top,part.bbox=bbox,part.stats=stats,bbox},KeyEditor.prototype.getBBox=function(arg){var type,data;if("string"===typeString(arg))switch(arg.substring(0,1)){case"E":if(type="event",144!==event.type||void 0===event.endEvent)return void console.error("argument not supported, please check documentation");data=this.song.findEvent("id = "+arg);break;case"P":type="part",data=this.song.getPart(arg);break;case"T":type="track";break;default:return void console.error("argument not supported, please check documentation")}else switch(arg.className){case"AudioEvent":type="audio";break;case"MidiEvent":type="event";break;case"Part":type="part";break;case"Track":type="track";break;default:return void console.error("argument not supported, please check documentation")}if(void 0===data)return void console.error(arg,"could not be found");switch(type){case"event":return this.getNoteRect(data);case"part":return this.getPartRect(data)}},KeyEditor.prototype.startMoveNote=function(note,x,y){if("MidiNote"!==note.className)return void(sequencer.debug>=sequencer.WARN&&console.warn(note,"is not a MidiNote"));this.selectedNote=note,this.gripX=x-this.selectedNote.bbox.x},KeyEditor.prototype.stopMoveNote=function(){this.selectedNote=void 0},KeyEditor.prototype.moveNote=function(x,y){if(void 0!==this.selectedNote){var newPitch=this.yToPitch(y).number,oldPitch=this.selectedNote.pitch,newTicks=this.xToTicks(x-this.gripX),oldTicks=this.selectedNote.ticks,part=this.selectedNote.part,update=!1;newPitch!==oldPitch&&(part.transposeNote(this.selectedNote,newPitch-oldPitch),update=!0),newTicks!==oldTicks&&(part.moveNote(this.selectedNote,newTicks-oldTicks),update=!0),!0===update&&this.song.update()}},KeyEditor.prototype.startMovePart=function(part,x,y){if("Part"!==part.className)return void(sequencer.debug>=sequencer.WARN&&console.warn(part,"is not a Part"));this.selectedPart=part,this.selectedPart.pitch=this.yToPitch(y).number,this.gripX=x-this.selectedPart.bbox.x},KeyEditor.prototype.stopMovePart=function(){this.selectedPart=void 0},KeyEditor.prototype.movePart=function(x,y){if(void 0!==this.selectedPart){var newPitch=this.yToPitch(y).number,oldPitch=this.selectedPart.pitch,newTicks=this.xToTicks(x-this.gripX),oldTicks=this.selectedPart.ticks,update=!1;newPitch!==oldPitch&&(this.selectedPart.track.transposePart(this.selectedPart,newPitch-oldPitch),this.selectedPart.pitch=newPitch,update=!0),newTicks!==oldTicks&&(this.selectedPart.track.movePart(this.selectedPart,newTicks-oldTicks),update=!0),!0===update&&this.song.update()}},KeyEditor.prototype.getTicksAt=KeyEditor.prototype.xToTicks=function(x,snap){var ticks=(x+this.scrollX)/this.width*this.numTicks;return!1!==snap&&0!==this.snapTicks&&(ticks=round(ticks/this.snapTicks)*this.snapTicks),ticks},KeyEditor.prototype.getPitchAt=KeyEditor.prototype.yToPitch=function(y){var note=this.highestNote-round((y+this.scrollY)/this.height*this.pitchRange);return note=createNote(note)},KeyEditor.prototype.getXAt=KeyEditor.prototype.ticksToX=function(ticks,snap){var x=(ticks-this.startTicks)*this.tickWidth;return!1!==snap&&0!==this.snapWidth&&(x=round(x/this.snapWidth)*this.snapWidth),x},KeyEditor.prototype.getYAt=KeyEditor.prototype.pitchToY=function(noteNumber){return this.height-(noteNumber-this.lowestNote+1)*this.pitchHeight},KeyEditor.prototype.getPositionAt=function(x){var ticks=this.getTicksAt(x);return this.playhead.set("ticks",ticks,!1),this.playhead.get()},KeyEditor.prototype.getPlayheadX=function(compensateForScroll){var x=this.song.ticks/this.song.durationTicks*this.width;return x=!0===compensateForScroll?x-this.scrollX:x},KeyEditor.prototype.setPlayheadToX=function(x){var ticks=this.xToTicks(x,!1);this.song.setPlayhead("ticks",ticks)},KeyEditor.prototype.getPlayheadPosition=function(compensateForScroll){var x=this.song.ticks/this.song.durationTicks*this.width;return x=!0===compensateForScroll?x-this.scrollX:x},KeyEditor.prototype.setPlayheadPosition=function(type,value){var ticks;switch(type){case"x":ticks=this.xToTicks(value,!1);break;case"ticks":ticks=value;break;case"millis":ticks=this.playhead.set("millis",value).ticks;break;case"barsbeats":case"barsandbeats":ticks=getPosition(this.song,["barsbeats",value]).ticks}this.song.setPlayhead("ticks",ticks)},KeyEditor.prototype.getEventAt=function(x,y){this.getSongPosition(x),this.getPitchAt(y)},KeyEditor.prototype.getEventsInRect=function(x,y,w,h){this.getSongPosition(x),this.getSongPosition(x+w),this.getPitchAt(y+h),this.getPitchAt(y)},KeyEditor.prototype.getNoteAt=function(x,y){this.getSongPosition(x),this.getPitchAt(y)},KeyEditor.prototype.getNotesInRect=function(x,y,w,h){this.getSongPosition(x),this.getSongPosition(x+w),this.getPitchAt(y+h),this.getPitchAt(y)},KeyEditor.prototype.snap=function(x,y){return{x:this.snapX(x),y:this.snapY(y)}},KeyEditor.prototype.snapX=function(x){return round((x+this.scrollX)/this.snapWidth)*this.snapWidth},KeyEditor.prototype.snapY=function(y){return round((y+this.scrollY)/this.snapHeight)*this.snapHeight},KeyEditor.prototype.setSnapX=function(snapX){if(void 0!==snapX){var beatLength=4/this.song.denominator;"off"===snapX?this.snapTicks=0:"tick"===snapX?this.snapTicks=1:"beat"===snapX?this.snapTicks=this.song.ppq*beatLength:"bar"===snapX?this.snapTicks=this.song.ppq*this.song.nominator*beatLength:isNaN(snapX)&&-1!==snapX.indexOf("ticks")?(this.snapTicks=snapX.replace(/ticks/,""),isNaN(this.snapTicks)?this.snapTicks=this.song.ppq/4:this.snapTicks=parseInt(this.snapTicks)):isNaN(snapX)||0===snapX?(snapX=0,this.snapTicks=0):(snapX=parseInt(snapX),this.snapTicks=4/snapX*this.song.ppq),this.snapValueX=snapX,this.snapWidth=this.tickWidth*this.snapTicks}},KeyEditor.prototype.setSnapY=function(snapY){void 0!==snapY&&(this.snapValueY=snapY,this.snapHeight=this.pitchHeight)},KeyEditor.prototype.removeNote=function(note){note.part.removeEvents(note.noteOn,note.noteOff),this.song.update()},KeyEditor.prototype.removePart=function(part){part.track.removePart(part),this.song.update()},KeyEditor.prototype.prepareForRecording=function(){this.recordedEventsObj={},this.recordedNotesObj={}},KeyEditor.prototype.getSnapshot=function(){var activeEventsObj,activeNotesObj,activePartsObj,recordedNotesSong,recordedEventsSong,s,i,tmp,length,startBar,endBar,nonActiveEvents=[],nonActiveNotes=[],nonActiveParts=[],prevActiveEvents=[].concat(this.activeEvents),prevActiveNotes=[].concat(this.activeNotes),prevActiveParts=[].concat(this.activeParts),recordedEvents=[],recordedNotes=[],recordingNotes=[];this.activeEvents=[],this.activeNotes=[],this.activeParts=[],this.activeStateChangedEvents=[],this.activeStateChangedNotes=[],this.activeStateChangedParts=[],this.newNumBars!==this.numBars&&(startBar=this.numBars,endBar=this.song.lastBar+1,this.endPosition=getPosition(this.song,["barsbeats",endBar,1,1,0,!0]),this.verticalLine.reset(getPosition(this.song,["barsbeats",startBar,1,1,0,!0]),this.endPosition),this.numBars=this.song.bars,this.endTicks=this.endPosition.ticks,this.numTicks=this.song.durationTicks,this.width=this.numTicks*this.tickWidth,this.maxScrollPosition=ceil(this.width/this.viewportWidth),this.numPages=ceil(this.numBars/this.barsPerPage)),activeEventsObj=this.song.activeEvents;for(i in activeEventsObj)activeEventsObj.hasOwnProperty(i)&&(tmp=activeEventsObj[i],this.activeEvents.push(tmp),!0!==tmp.active&&(tmp.active=!0,this.activeStateChangedEvents.push(tmp)));activeNotesObj=this.song.activeNotes;for(i in activeNotesObj)activeNotesObj.hasOwnProperty(i)&&(tmp=activeNotesObj[i],this.activeNotes.push(tmp),!0!==tmp.active&&(tmp.active=!0,this.activeStateChangedNotes.push(tmp)));activePartsObj=this.song.activeParts;for(i in activePartsObj)activePartsObj.hasOwnProperty(i)&&(tmp=activePartsObj[i],this.activeParts.push(tmp),!0!==tmp.active&&(tmp.active=!0,this.activeStateChangedParts.push(tmp)));if(recordedEventsSong=this.song.recordedEvents)for(length=recordedEventsSong.length,i=0;i<length;i++)tmp=recordedEventsSong[i],void 0===this.recordedEventsObj[tmp.id]&&(tmp.bbox=this.getEventRect(tmp),recordedEvents.push(tmp),this.recordedEventsObj[tmp.id]=tmp);if(recordedNotesSong=this.song.recordedNotes)for(length=recordedNotesSong.length,i=0;i<length;i++)tmp=recordedNotesSong[i],void 0===this.recordedNotesObj[tmp.id]?(this.recordedNotesObj[tmp.id]=tmp,tmp.bbox=this.getNoteRect(tmp),recordedNotes.push(tmp)):!0===tmp.endless?(tmp.bbox=this.getNoteRect(tmp),recordingNotes.push(tmp)):!1===tmp.endless&&(tmp.bbox=this.getNoteRect(tmp),recordingNotes.push(tmp),tmp.endless=void 0);for(i=prevActiveEvents.length-1;i>=0;i--)tmp=prevActiveEvents[i],void 0!==tmp?void 0===activeEventsObj[tmp.id]&&(nonActiveEvents.push(tmp),!1!==tmp.active&&(tmp.active=!1,this.activeStateChangedEvents.push(tmp))):console.warn("event is undefined");for(i=prevActiveNotes.length-1;i>=0;i--)tmp=prevActiveNotes[i],void 0!==tmp?void 0===activeNotesObj[tmp.id]&&(nonActiveNotes.push(tmp),!1!==tmp.active&&(tmp.active=!1,this.activeStateChangedNotes.push(tmp))):console.warn("note is undefined");for(i=prevActiveParts.length-1;i>=0;i--)tmp=prevActiveParts[i],void 0!==tmp?void 0===activePartsObj[tmp.id]&&(nonActiveParts.push(tmp),!1!==tmp.active&&(tmp.active=!1,this.activeStateChangedParts.push(tmp))):console.warn("part is undefined");return this.song.playing&&(this.currentPage=floor(this.song.ticks/(this.barsPerPage*this.song.ticksPerBar))+1),s={events:{active:this.activeEvents,inActive:this.nonActiveEvents,recorded:recordedEvents,new:this.newEvents,changed:this.changedEvents,removed:this.removedEvents,stateChanged:this.activeStateChangedEvents},notes:{active:this.activeNotes,inActive:nonActiveNotes,recorded:recordedNotes,recording:recordingNotes,new:this.newNotes,changed:this.changedNotes,removed:this.removedNotes,stateChanged:this.activeStateChangedNotes},parts:{active:this.activeParts,inActive:nonActiveParts,new:this.newParts,changed:this.changedParts,removed:this.removedParts,stateChanged:this.activeStateChangedParts},hasNewBars:startBar!==endBar,newWidth:this.width,pageNo:this.currentPage,lastPage:this.numPages},this.newEvents=[],this.changedEvents=[],this.removedEvents=[],this.newNotes=[],this.changedNotes=[],this.removedNotes=[],this.newParts=[],this.changedParts=[],this.removedParts=[],s},setPageData=function(editor,startBar){editor.numTicks=0,editor.startBar=startBar>0?startBar:0,editor.startBar=editor.startBar>editor.numBars-editor.barsPerPage?editor.numBars-editor.barsPerPage:editor.startBar,editor.endBar=startBar+editor.barsPerPage,editor.endBar=editor.endBar>editor.numBars?editor.numBars:editor.endBar,editor.endBar=editor.endBar<editor.barsPerPage?editor.barsPerPage:editor.endBar,console.log(startBar,editor.startBar,editor.endBar,editor.numBars,editor.numBars-editor.barsPerPage);var i;for(i=editor.startBar;i<editor.endBar;i++)editor.numTicks+=editor.bars[i].ticksPerBar;editor.tickWidth=editor.pageWidth/editor.numTicks,editor.startPosition=editor.bars[editor.startBar],editor.endPosition=editor.bars[editor.endBar],editor.startTicks=editor.startPosition.ticks,editor.endTicks=editor.endPosition.ticks,editor.verticalLine.reset(),editor.horizontalLine.reset(),editor.eventIterator.reset()},checkNextPage=function(editor){editor.song.playing()&&editor.song.ticks>=editor.endTicks&&editor.nextPage(),requestAnimationFrame(function(){checkNextPage(editor)})},checkScrollPosition=function(editor){if(editor.song.playing&&!1===editor.interrupt)if(editor.song.ticks>=editor.scrollLimit)dispatchEvent(editor,"scroll",{x:editor.scrollX+editor.viewportWidth}),editor.scrollLimit+=editor.viewportWidth/editor.tickWidth;else{var x=floor(editor.song.ticks/editor.viewportTicks)*editor.viewportTicks*editor.tickWidth;editor.scrollX!==x&&dispatchEvent(editor,"scroll",{x:x})}requestAnimationFrame(function(){checkScrollPosition(editor)})},dispatchEvent=function(editor,id,data){var listeners=editor.eventListeners[id];listeners&&listeners.forEach(function(cb){cb(data)})},sequencer.createKeyEditor=function(song,config){return new KeyEditor(song,config)},sequencer.protectedScope.addInitMethod(function(){getPosition=sequencer.protectedScope.getPosition,createPlayhead=sequencer.protectedScope.createPlayhead,createNote=sequencer.createNote,debug=sequencer.debug,floor=sequencer.protectedScope.floor,round=sequencer.protectedScope.round,typeString=sequencer.protectedScope.typeString,objectToArray=sequencer.protectedScope.objectToArray,arrayToObject=sequencer.protectedScope.arrayToObject,getScaffoldingBars=sequencer.protectedScope.getScaffoldingBars,createIteratorFactory=sequencer.protectedScope.createKeyEditorIteratorFactory})}(),function(){"use strict";function Factory(song,editor){this.song=song,this.editor=editor,this.position=createPlayhead(this.song,"all","iterators"),this.updateSong()}var createPlayhead,createNote,sequencer=window.sequencer;Factory.prototype.updateSong=function(){this.events=this.song.events,this.numEvents=this.events.length,this.notes=this.song.notes,this.numNotes=this.notes.length,this.parts=this.song.parts,this.numParts=this.parts.length,this.position.updateSong()},Factory.prototype.createVerticalLineIterator=function(){var lineType,tickWidth,offset,type,ticks,endTicks,bar,beat,sixteenth,nominator,numSixteenth,startPosition,endPosition,data,next,hasNext,reset,getData,setType,numTicks={},editor=this.editor,position=this.position;return getData=function(){data=position.update("ticks",ticks),numTicks.bar=data.ticksPerBar,numTicks.beat=data.ticksPerBeat,numTicks.sixteenth=data.ticksPerSixteenth,nominator=data.nominator,numSixteenth=data.numSixteenth},next=function(t){switch(t&&(type=t,tickWidth<.02?type="bar":tickWidth<.042&&(type="beat")),type){case"sixteenth":lineType="sixteenth",sixteenth++,sixteenth>numSixteenth&&(lineType="beat",sixteenth=1,++beat>nominator&&(lineType="bar",beat=1,bar++));break;case"beat":lineType="beat",sixteenth=1,beat++,beat>nominator&&(lineType="bar",beat=1,bar++);break;case"bar":lineType="bar",sixteenth=1,beat=1,bar++}return ticks+=numTicks[type],getData(),!(ticks>endTicks)&&{x:ticks*tickWidth-offset,bar:bar,beat:beat,sixteenth:sixteenth,type:lineType,position:data}},hasNext=function(t){var diffTicks=endTicks-ticks,result=!1;switch(t&&(type=t,tickWidth<.02?type="bar":tickWidth<.042&&(type="beat")),type){case"bar":case"beat":case"sixteenth":result=diffTicks>=numTicks[type]}return result},reset=function(start,end){startPosition=start||editor.startPosition,endPosition=end||editor.endPosition,ticks=startPosition.ticks,bar=startPosition.bar,beat=startPosition.beat,sixteenth=startPosition.sixteenth,endTicks=endPosition.ticks,tickWidth=editor.tickWidth,offset=0,position.set("ticks",ticks),tickWidth<.02?type="bar":tickWidth<.042&&(type="beat"),getData()},setType=function(t){type=t,tickWidth<.02?type="bar":tickWidth<.042&&(type="beat")},{next:next,reset:reset,hasNext:hasNext,setType:setType}},Factory.prototype.createHorizontalLineIterator=function(){var index,pitch,range,pitchHeight,next,hasNext,reset,data={},editor=this.editor;return next=function(type){return data={note:createNote(pitch),y:index*pitchHeight},pitch--,index++,data},hasNext=function(type){var result=!1;switch(type){case"chromatic":result=index<range}return result},reset=function(){index=0,pitch=editor.highestNote,range=editor.pitchRange,pitchHeight=editor.pitchHeight},{next:next,reset:reset,hasNext:hasNext}},Factory.prototype.createEventIterator=function(){var startTicks,endTicks,hasNextCalled,index,nextEvent,next,hasNext,reset,setTypes,editor=this.editor,position=this.position,events=this.events,numEvents=this.numEvents,types="";return hasNext=function(t){return types=t||types,hasNextCalled=!0,++index!==numEvents&&(nextEvent=events[index],""===types&&nextEvent.ticks<=endTicks)},next=function(t){return types=t||types,hasNextCalled||hasNext(types),hasNextCalled=!1,nextEvent},reset=function(){startTicks=editor.startTicks,endTicks=editor.endTicks,hasNextCalled=!1,!0===editor.paginate&&!0===sequencer.isPlaying()||(index=position.get().eventIndex-2)},setTypes=function(){Array.prototype.slice.call(arguments).forEach(function(type){types+=type+" "})},{next:next,reset:reset,hasNext:hasNext,setTypes:setTypes}},Factory.prototype.createNoteIterator=function(){var startTicks,endTicks,hasNextCalled,index,newNote,nextNote,next,hasNext,reset,editor=this.editor,song=this.song,notes=this.notes,numNotes=this.numNotes,types="";return hasNext=function(t){if(types=t||types,hasNextCalled=!0,++index===this.numNotes)return!1;for(newNote=!1;index<numNotes&&(nextNote=notes[index],!(nextNote.ticks>=endTicks));index++)if(editor.paginate){if(nextNote.ticks<startTicks&&nextNote.noteOff.ticks>startTicks?newNote=!0:nextNote.ticks<endTicks&&(newNote=!0),newNote)break}else if(newNote=nextNote.ticks<=endTicks)break;return newNote},next=function(t){return types=t||types,hasNextCalled||hasNext(types),hasNextCalled=!1,
nextNote.bbox=editor.getNoteRect(nextNote),nextNote},reset=function(){var note;if(startTicks=editor.startTicks,endTicks=editor.endTicks,notes=song.notes,numNotes=song.numNotes,hasNextCalled=!1,!0!==editor.paginate||!0!==sequencer.isPlaying()){for(index=0;index<numNotes&&(note=notes[index],!(note.ticks>=startTicks));index++);index--}},{next:next,reset:reset,hasNext:hasNext}},Factory.prototype.createPartIterator=function(){var index,max,part,next,hasNext,reset,editor=this.editor,song=this.song,parts=this.parts;return next=function(type){return part=parts[index++],part.bbox=editor.getPartRect(part),part},hasNext=function(type){return index<max},reset=function(){parts=song.parts,max=song.numParts,index=0},{next:next,reset:reset,hasNext:hasNext}},sequencer.protectedScope.createKeyEditorIteratorFactory=function(song,editor){return new Factory(song,editor)},sequencer.protectedScope.addInitMethod(function(){createNote=sequencer.createNote,createPlayhead=sequencer.protectedScope.createPlayhead})}(),function(){"use strict";function checkNumber(value){return isNaN(value)?(sequencer.debug&&console.log("please provide a number"),!1):value<0||value>127?(sequencer.debug&&console.log("please provide a number between 0 and 127"),!1):value}function createEvents(metronome,startBar,endBar,id){var i,j,data,velocity,noteLength,noteNumber,beatsPerBar,ticksPerBeat,noteOn,noteOff,ticks=0,events=[],song=metronome.song;for(i=startBar;i<=endBar;i++)for(data=getPosition(song,["barsbeats",i]),beatsPerBar=data.nominator,ticksPerBeat=data.ticksPerBeat,j=0;j<beatsPerBar;j++)noteNumber=0===j?metronome.noteNumberAccented:metronome.noteNumberNonAccented,noteLength=0===j?metronome.noteLengthAccented:metronome.noteLengthNonAccented,velocity=0===j?metronome.velocityAccented:metronome.velocityNonAccented,noteOn=sequencer.createMidiEvent(ticks,144,noteNumber,velocity),noteOff=sequencer.createMidiEvent(ticks+noteLength,128,noteNumber,0),"precount"===id&&(noteOn.part={id:"precount"},noteOn.track=metronome.track,noteOff.part={id:"precount"},noteOff.track=metronome.track),createMidiNote(noteOn,noteOff),events.push(noteOn,noteOff),ticks+=ticksPerBeat;return events}var context,findItem,getPosition,objectForEach,createMidiNote,parseEvents,parseMetronomeEvents,Metronome,sequencer=window.sequencer,console=window.console,methodMap={volume:"setVolume",instrument:"setInstrument",noteNumberAccentedTick:"setNoteNumberAccentedTick",noteNumberNonAccentedTick:"setNoteNumberNonAccentedTick",velocityAccentedTick:"setVelocityAccentedTick",velocityNonAccentedTick:"setVelocityNonAccentedTick",noteLengthAccentedTick:"setNoteLengthAccentedTick",noteLengthNonAccentedTick:"setNoteLengthNonAccentedTick"};Metronome=function(song){this.song=song,this.track=sequencer.createTrack(this.song.id+"_metronome","metronome"),this.part=sequencer.createPart(),this.track.addPart(this.part),this.track.connect(this.song.gainNode),this.events=[],this.precountEvents=[],this.noteNumberAccented=61,this.noteNumberNonAccented=60,this.volume=1,this.velocityNonAccented=100,this.velocityAccented=100,this.noteLengthNonAccented=song.ppq/4,this.noteLengthAccented=song.ppq/4,this.track.setInstrument("heartbeat/metronome"),this.precountDurationInMillis=0,this.bars=0},Metronome.prototype.init=function(id,startBar,endBar){id=void 0===id?"init":id,this.part.numEvents>0&&this.part.removeEvents(this.part.events),this.events=createEvents(this,startBar,endBar,id),this.numEvents=this.events.length,this.part.addEvents(this.events),this.bars=this.song.bars,parseMetronomeEvents(this.song,this.events)},Metronome.prototype.update=function(startBar,endBar){0===startBar&&(startBar=1),void 0!==startBar&&void 0!==endBar?this.init("update",startBar,endBar):this.init("update",1,this.song.bars)},Metronome.prototype.updateConfig=function(){this.init("configure",1,this.bars),this.allNotesOff(),this.song.scheduler.updateSong()},Metronome.prototype.configure=function(config){var me=this;objectForEach(config,function(value,key){me[methodMap[key]](value)}),this.updateConfig()},Metronome.prototype.setInstrument=function(instrument){"Instrument"!==instrument.className&&(instrument=sequencer.createInstrument(instrument)),!1!==instrument?this.track.setInstrument(instrument):this.track.setInstrument("heartbeat/metronome"),this.updateConfig()},Metronome.prototype.setNoteLengthAccentedTick=function(value){isNaN(value)&&sequencer.debug>=2&&console.warn("please provide a number"),this.noteLengthAccented=value,this.updateConfig()},Metronome.prototype.setNoteLengthNonAccentedTick=function(value){isNaN(value)&&sequencer.debug>=2&&console.warn("please provide a number"),this.noteLengthNonAccented=value,this.updateConfig()},Metronome.prototype.setVelocityAccentedTick=function(value){value=checkNumber(value),!1!==value?this.velocityAccented=value:sequencer.debug>=2&&console.warn("please provide a number"),this.updateConfig()},Metronome.prototype.setVelocityNonAccentedTick=function(value){value=checkNumber(value),!1!==value?this.velocityNonAccented=value:sequencer.debug>=2&&console.warn("please provide a number"),this.updateConfig()},Metronome.prototype.setNoteNumberAccentedTick=function(value){value=checkNumber(value),!1!==value?this.noteNumberAccented=value:sequencer.debug>=2&&console.warn("please provide a number"),this.updateConfig()},Metronome.prototype.setNoteNumberNonAccentedTick=function(value){value=checkNumber(value),!1!==value?this.noteNumberNonAccented=value:sequencer.debug>=2&&console.warn("please provide a number"),this.updateConfig()},Metronome.prototype.reset=function(){this.volume=1,this.track.setInstrument("heartbeat/metronome"),this.noteNumberAccented=61,this.noteNumberNonAccented=60,this.velocityAccented=100,this.velocityNonAccented=100,this.noteLengthAccented=this.song.ppq/4,this.noteLengthNonAccented=this.song.ppq/4},Metronome.prototype.allNotesOff=function(){this.track.instrument&&this.track.instrument.allNotesOff()},Metronome.prototype.createPrecountEvents=function(precount){if(!(precount<=0)){var endPos=this.song.getPosition("barsbeats",this.song.bar+precount);this.index=0,this.millis=0,this.startMillis=this.song.millis,this.precountDurationInMillis=endPos.millis-this.startMillis,this.precountEvents=createEvents(this,this.song.bar,endPos.bar-1,"precount"),parseEvents(this.song,this.precountEvents)}},Metronome.prototype.getPrecountEvents=function(maxtime){var i,event,events=this.precountEvents,maxi=events.length,result=[];for(i=this.index;i<maxi&&(event=events[i],event.millis<maxtime);i++)event.time=this.startTime+event.millis,result.push(event),this.index++;return result},Metronome.prototype.setVolume=function(value){this.track.setVolume(value)},sequencer.protectedScope.createMetronome=function(song){return new Metronome(song)},sequencer.protectedScope.addInitMethod(function(){context=sequencer.protectedScope.context,findItem=sequencer.protectedScope.findItem,getPosition=sequencer.protectedScope.getPosition,createMidiNote=sequencer.createMidiNote,objectForEach=sequencer.util.objectForEach,parseEvents=sequencer.protectedScope.parseEvents,parseMetronomeEvents=sequencer.protectedScope.parseMetronomeEvents})}(),function(){"use strict";var createNote,typeString,MidiEvent,sequencer=window.sequencer,console=window.console,slice=Array.prototype.slice,midiEventId=0;MidiEvent=function(args){var data,note;if(this.className="MidiEvent",this.id="M"+midiEventId+(new Date).getTime(),this.eventNumber=midiEventId,this.channel="any",this.time=0,this.muted=!1,midiEventId++,args){if("midimessageevent"===typeString(args[0]))return void console.log("midimessageevent");if("array"===typeString(args[0]))data=args[0];else{if("number"!==typeString(args[0])||"number"!==typeString(args[1]))return sequencer.debug>=1&&console.error("wrong number of arguments, please consult documentation"),!1;data=[args[0],args[1]],args.length>=3&&"number"===typeString(args[2])&&data.push(args[2]),4===args.length&&"number"===typeString(args[3])&&data.push(args[3]),5===args.length&&"number"===typeString(args[4])&&data.push(args[4])}switch(this.ticks=data[0],this.status=data[1],this.type=16*(this.status>>4),this.type>=128?(this.command=this.type,this.channel=1+(15&this.status)):(this.type=this.status,this.channel=data[4]||"any"),this.sortIndex=this.type+this.ticks,this.type){case 0:break;case 128:this.data1=data[2],note=createNote(this.data1),this.note=note,this.noteName=note.fullName,this.noteNumber=note.number,this.octave=note.octave,this.frequency=note.frequency,this.data2=0,this.velocity=this.data2;break;case 144:this.data1=data[2],this.data2=data[3],0===this.data2&&(this.type=128),note=createNote(this.data1),this.note=note,this.noteName=note.fullName,this.noteNumber=note.number,this.octave=note.octave,this.frequency=note.frequency,this.velocity=this.data2;break;case 81:this.bpm=data[2];break;case 88:this.nominator=data[2],this.denominator=data[3];break;case 176:this.data1=data[2],this.data2=data[3],this.controllerType=data[2],this.controllerValue=data[3];break;case 192:this.data1=data[2],this.programNumber=data[2];break;case 208:case 224:this.data1=data[2],this.data2=data[3];break;case 47:break;default:console.warn("not a recognized type of midi event!")}}},MidiEvent.prototype.clone=MidiEvent.prototype.copy=function(){var property,event=new MidiEvent;for(property in this)this.hasOwnProperty(property)&&("id"!==property&&"eventNumber"!==property&&"midiNote"!==property&&(event[property]=this[property]),event.song=void 0,event.track=void 0,event.trackId=void 0,event.part=void 0,event.partId=void 0);return event},MidiEvent.prototype.transpose=function(semi){if(128!==this.type&&144!==this.type)return void(sequencer.debug>=1&&console.error("you can only transpose note on and note off events"));if("array"===typeString(semi)){var type=semi[0];"hertz"===type||"semi"!==type&&"semitone"!==type||(semi=semi[1])}else if(!0===isNaN(semi))return void(sequencer.debug>=1&&console.error("please provide a number"));var tmp=this.data1+parseInt(semi,10);tmp<0?tmp=0:tmp>127&&(tmp=127),this.data1=tmp;var note=createNote(this.data1);this.note=note,this.noteName=note.fullName,this.noteNumber=note.number,this.octave=note.octave,this.frequency=note.frequency,void 0!==this.midiNote&&(this.midiNote.pitch=this.data1),"new"!==this.state&&(this.state="changed"),void 0!==this.part&&(this.part.needsUpdate=!0)},MidiEvent.prototype.setPitch=function(pitch){if(128!==this.type&&144!==this.type)return void(sequencer.debug>=1&&console.error("you can only set the pitch of note on and note off events"));if("array"===typeString(pitch)){var type=pitch[0];"hertz"===type||"semi"!==type&&"semitone"!==type||(pitch=pitch[1])}else if(!0===isNaN(pitch))return void(sequencer.debug>=1&&console.error("please provide a number"));this.data1=parseInt(pitch,10);var note=createNote(this.data1);this.note=note,this.noteName=note.fullName,this.noteNumber=note.number,this.octave=note.octave,this.frequency=note.frequency,void 0!==this.midiNote&&(this.midiNote.pitch=this.data1),"new"!==this.state&&(this.state="changed"),void 0!==this.part&&(this.part.needsUpdate=!0)},MidiEvent.prototype.move=function(ticks){if(isNaN(ticks))return void(sequencer.debug>=1&&console.error("please provide a number"));this.ticks+=parseInt(ticks,10),"new"!==this.state&&(this.state="changed"),void 0!==this.part&&(this.part.needsUpdate=!0)},MidiEvent.prototype.moveTo=function(){var position=slice.call(arguments);"ticks"===position[0]&&!1===isNaN(position[1])?this.ticks=parseInt(position[1],10):void 0===this.song?sequencer.debug>=1&&console.error("The midi event has not been added to a song yet; you can only move to ticks values"):(position=this.song.getPosition(position),!1===position?sequencer.debug>=1&&console.error("wrong position data"):this.ticks=position.ticks),"new"!==this.state&&(this.state="changed"),void 0!==this.part&&(this.part.needsUpdate=!0)},MidiEvent.prototype.reset=function(fromPart,fromTrack,fromSong){fromPart=void 0===fromPart,fromTrack=void 0===fromTrack,fromSong=void 0===fromSong,fromPart&&(this.part=void 0,this.partId=void 0),fromTrack&&(this.track=void 0,this.trackId=void 0,this.channel=0),fromSong&&(this.song=void 0)},MidiEvent.prototype.update=function(){},sequencer.createMidiEvent=function(){var args=slice.call(arguments);return"MidiEvent"===args[0].className?args[0].copy():new MidiEvent(args)},sequencer.protectedScope.addInitMethod(function(){createNote=sequencer.createNote,typeString=sequencer.protectedScope.typeString})}(),function(){"use strict";function numberByName(name){var no=!1;return name=name.replace(/_/g," "),!1!==(no=lowerCaseToNumber[name]||!1)?no:(name=name.replace(/\s/g,"_"),no=upperCaseToNumber[name]||!1,!1===no&&!0===sequencer.debug&&console.warn(name,"is not a valid (or supported) midi event name, please consult documentation"),no)}function nameByNumber(no,upperOrLower){var name=!1;return"lower"===(upperOrLower=upperOrLower||"upper")?(name=numberToLowerCase[no]||!1,!1===name&&!0===sequencer.debug&&console.warn(no,"is not a valid (or supported) midi event number, please consult documentation"),name):(name=numberToUpperCase[no]||!1,!1===name&&!0===sequencer.debug&&console.warn(no,"is not a valid (or supported) midi event number, please consult documentation"),name)}function checkEventType(type){return isNaN(type)?numberByName(type):nameByNumber(type)}var lowerCaseToNumber={"note off":128,"note on":144,"poly pressure":160,"control change":176,"program change":192,"channel pressure":208,"pitch bend":224,tempo:81,"time signature":88,"end of track":47},upperCaseToNumber={NOTE_OFF:128,NOTE_ON:144,POLY_PRESSURE:160,CONTROL_CHANGE:176,PROGRAM_CHANGE:192,CHANNEL_PRESSURE:208,PITCH_BEND:224,TEMPO:81,TIME_SIGNATURE:88,END_OF_TRACK:47},numberToLowerCase={128:"note off",144:"note on",160:"poly pressure",176:"control change",192:"program change",208:"channel pressure",224:"pitch bend",81:"tempo",88:"time signature",47:"end of track"},numberToUpperCase={128:"NOTE_OFF",144:"NOTE_ON",160:"POLY_PRESSURE",176:"CONTROL_CHANGE",192:"PROGRAM_CHANGE",208:"CHANNEL_PRESSURE",224:"PITCH_BEND",81:"TEMPO",88:"TIME_SIGNATURE",47:"END_OF_TRACK"};Object.defineProperty(sequencer,"DUMMY_EVENT",{value:0}),Object.defineProperty(sequencer,"MIDI_NOTE",{value:112}),Object.defineProperty(sequencer,"NOTE_OFF",{value:128}),Object.defineProperty(sequencer,"NOTE_ON",{value:144}),Object.defineProperty(sequencer,"POLY_PRESSURE",{value:160}),Object.defineProperty(sequencer,"CONTROL_CHANGE",{value:176}),Object.defineProperty(sequencer,"PROGRAM_CHANGE",{value:192}),Object.defineProperty(sequencer,"CHANNEL_PRESSURE",{value:208}),Object.defineProperty(sequencer,"PITCH_BEND",{value:224}),Object.defineProperty(sequencer,"SYSTEM_EXCLUSIVE",{value:240}),Object.defineProperty(sequencer,"MIDI_TIMECODE",{value:241}),Object.defineProperty(sequencer,"SONG_POSITION",{value:242}),Object.defineProperty(sequencer,"SONG_SELECT",{value:243}),Object.defineProperty(sequencer,"TUNE_REQUEST",{value:246}),Object.defineProperty(sequencer,"EOX",{value:247}),Object.defineProperty(sequencer,"TIMING_CLOCK",{value:248}),Object.defineProperty(sequencer,"START",{value:250}),Object.defineProperty(sequencer,"CONTINUE",{value:251}),Object.defineProperty(sequencer,"STOP",{value:252}),Object.defineProperty(sequencer,"ACTIVE_SENSING",{value:254}),Object.defineProperty(sequencer,"SYSTEM_RESET",{value:255}),Object.defineProperty(sequencer,"TEMPO",{value:81}),Object.defineProperty(sequencer,"TIME_SIGNATURE",{value:88}),Object.defineProperty(sequencer,"END_OF_TRACK",{value:47}),sequencer.checkEventType=checkEventType,sequencer.midiEventNameByNumber=nameByNumber,sequencer.midiEventNumberByName=numberByName}(),function(){"use strict";function cleanup(midifile,callback){callback&&callback(!1)}function parse(midifile,buffer,callback){var data,i,j,numEvents,part,track,numTracks,events,event,ticks,tmpTicks,channel,parsed,timeEvents,bpm,ppqFactor,type,lastType,numNoteOn,numNoteOff,numOther;for(buffer=new Uint8Array(buffer),data=parseMidiFile(buffer),midifile.base64="",midifile.numTracks=0,i=0,numTracks=data.tracks.length,!0===sequencer.overrulePPQ&&!1===isNaN(sequencer.defaultPPQ)&&sequencer.defaultPPQ>0?(ppqFactor=sequencer.defaultPPQ/data.header.ticksPerBeat,midifile.ppq=sequencer.defaultPPQ):(ppqFactor=1,midifile.ppq=data.header.ticksPerBeat),timeEvents=[],midifile.tracks=[];i<numTracks;){for(events=data.tracks[i],numEvents=events.length,ticks=0,tmpTicks=0,channel=-1,part=createPart(),track=createTrack(),parsed=[],j=0,numNoteOn=0,numNoteOff=0,numOther=0,{},{},j=0;j<numEvents;j++){switch(event=events[j],tmpTicks+=event.deltaTime*ppqFactor,-1===channel&&void 0!==event.channel&&(channel=event.channel,track.channel=channel),type=event.subtype,"noteOn"===type?numNoteOn++:"noteOff"===type?numNoteOff++:numOther++,event.subtype){case"trackName":track.name=event.text;break;case"instrumentName":event.text&&(track.instrumentName=event.text);break;case"noteOn":parsed.push(createMidiEvent(tmpTicks,144,event.noteNumber,event.velocity));break;case"noteOff":parsed.push(createMidiEvent(tmpTicks,128,event.noteNumber,event.velocity));break;case"endOfTrack":break;case"setTempo":bpm=6e7/event.microsecondsPerBeat,tmpTicks===ticks&&lastType===type&&(sequencer.debug>=3&&console.info("tempo events on the same tick",j,tmpTicks,bpm),timeEvents.pop()),void 0===midifile.bpm&&(midifile.bpm=bpm),timeEvents.push(createMidiEvent(tmpTicks,81,bpm));break;case"timeSignature":tmpTicks===ticks&&lastType===type&&(sequencer.debug>=3&&console.info("time signature events on the same tick",j,tmpTicks,event.numerator,event.denominator),timeEvents.pop()),void 0===midifile.nominator&&(midifile.nominator=event.numerator,midifile.denominator=event.denominator),timeEvents.push(createMidiEvent(tmpTicks,88,event.numerator,event.denominator));break;case"controller":parsed.push(createMidiEvent(tmpTicks,176,event.controllerType,event.value));break;case"programChange":parsed.push(createMidiEvent(tmpTicks,192,event.programNumber));break;case"channelAftertouch":parsed.push(createMidiEvent(tmpTicks,208,event.amount));break;case"pitchBend":parsed.push(createMidiEvent(tmpTicks,224,event.value))}lastType=type,ticks=tmpTicks}parsed.length>0&&(track.addPart(part),part.addEvents(parsed),midifile.tracks.push(track),midifile.numTracks++),i++}midifile.timeEvents=timeEvents,midifile.autoSize=!0,midifile.loaded=!0,callback(midifile)}function load(midifile,callback){return void 0!==midifile.base64?void parse(midifile,base64ToBinary(midifile.base64),callback):void 0!==midifile.arraybuffer?void parse(midifile,midifile.arraybuffer,callback):void ajax({url:midifile.url,responseType:midifile.responseType,onError:function(){cleanup(midifile,callback)},onSuccess:function(data){if("json"===midifile.responseType){if(null===data)return void callback(!1);if(void 0===data.base64)return cleanup(midifile,callback),void(sequencer.debug&&console.warn("no base64 data"));void 0!==data.name&&void 0===midifile.name&&(midifile.name=data.name),void 0!==data.folder&&void 0===midifile.folder&&(midifile.folder=data.folder),void 0===midifile.name&&(midifile.name=parseUrl(midifile.url).name),midifile.localPath=void 0!==midifile.folder?midifile.folder+"/"+midifile.name:midifile.name,parse(midifile,base64ToBinary(data.base64),callback)}else void 0===midifile.name&&(midifile.name=parseUrl(midifile.url).name),midifile.localPath=void 0!==midifile.folder?midifile.folder+"/"+midifile.name:midifile.name,parse(midifile,data,callback)}})}function store(midifile){var occupied=findItem(midifile.localPath,sequencer.storage.midi,!0),action=midifile.action;occupied&&"MidiFile"===occupied.className&&"overwrite"!==action?sequencer.debug>=2&&(console.warn("there is already a midifile at",midifile.localPath),cleanup(midifile)):storeItem(midifile,midifile.localPath,sequencer.storage.midi)}function MidiFile2(config){function executor(resolve,reject){reader.addEventListener("loadend",function(){parse({},reader.result,function(midifile){resolve(midifile)})}),reader.addEventListener("error",function(e){reject(e)}),void 0!==config.blob?reader.readAsArrayBuffer(config.blob):void 0!==config.arraybuffer?parse({},config.arraybuffer,function(midifile){resolve(midifile)}):void 0!==config.base64&&parse({},base64ToBinary(config.base64),function(midifile){resolve(midifile)})}var reader=new FileReader;this._promise=new Promise(executor)}var parseUrl,base64ToBinary,typeString,ajax,findItem,storeItem,deleteItem,parseMidiFile,createTrack,createPart,createMidiEvent,MidiFile,sequencer=window.sequencer,console=window.console,index=0;MidiFile=function(config){this.id="MF"+index+++(new Date).getTime(),this.className="MidiFile",this.url=config.url,this.json=config.json,this.base64=config.base64,this.arraybuffer=config.arraybuffer,this.name=config.name,this.folder=config.folder,void 0!==this.url?this.responseType=this.url.indexOf(".json")===this.url.lastIndexOf(".")?"json":"arraybuffer":void 0===this.name&&void 0===this.folder?(this.name=this.id,this.localPath=this.id):this.localPath=void 0!==this.folder?this.folder+"/"+this.name:this.name},sequencer.addMidiFile=function(config,callback){var midifile,json,name,folder,type=typeString(config);if("object"!==type)return sequencer.debug>=2&&console.warn("can't create a MidiFile with this data",config),!1;if(config.json){if(json=config.json,name=config.name,folder=config.folder,"string"===typeString(json))try{json=JSON.parse(json)}catch(e){return sequencer.debug>=2&&console.warn("can't create a MidiFile with this data",config),!1}if(void 0===json.base64)return sequencer.debug>=2&&console.warn("can't create a MidiFile with this data",config),!1;config={base64:json.base64,name:void 0===name?json.name:name,folder:void 0===folder?json.folder:folder}}midifile=new MidiFile(config),sequencer.addTask({type:"load midifile",method:load,params:midifile},function(){store(midifile),callback&&callback(midifile)}),sequencer.startTaskQueue()},sequencer.createMidiFile=function(config){return new MidiFile2(config)._promise},sequencer.protectedScope.addInitMethod(function(){ajax=sequencer.protectedScope.ajax,findItem=sequencer.protectedScope.findItem,storeItem=sequencer.protectedScope.storeItem,deleteItem=sequencer.protectedScope.deleteItem,parseUrl=sequencer.protectedScope.parseUrl,typeString=sequencer.protectedScope.typeString,parseMidiFile=sequencer.protectedScope.parseMidiFile,base64ToBinary=sequencer.protectedScope.base64ToBinary,createPart=sequencer.createPart,createTrack=sequencer.createTrack,createMidiEvent=sequencer.createMidiEvent})}(),function(){"use strict";var MidiNote,createMidiEvent,typeString,sequencer=window.sequencer,console=window.console,midiNoteId=0;MidiNote=function(args){var on,off,startTicks,endTicks,noteNumber,velocity,numArgs=args.length;if(1===numArgs){if(void 0===(on=args[0]))return void console.error("please provide at least a note on event");this.noteOn=on}else if(2===numArgs){if(on=args[0],off=args[1],void 0===on)return void console.error("please provide at least a note on event");if("MidiEvent"===on.className&&off&"MidiEvent"===off.className){if(on.ticks>=off.ticks)return void console.error("MidiNote has wrong duration");this.noteOn=on,this.noteOff=off}}else{if(4!==numArgs)return void console.error("wrong number of arguments, please consult documentation");if(startTicks=args[0],endTicks=args[1],noteNumber=args[2],velocity=args[3],startTicks&&endTicks&&startTicks>=endTicks)return void console.error("MidiNote has wrong duration");if(noteNumber<0||noteNumber>127)return void console.error("MidiNote has wrong note number");if(velocity<0||velocity>127)return void console.error("MidiNote has wrong velocity");on=createMidiEvent(startTicks,sequencer.NOTE_ON,noteNumber,velocity),off&&(off=createMidiEvent(endTicks,sequencer.NOTE_OFF,noteNumber,0))}on.midiNote=this,this.noteOn=on,void 0===off?this.endless=!0:(off.midiNote=this,this.endless=!1,this.noteOff=off,this.durationTicks=off.ticks-on.ticks,this.durationMillis=off.millis-on.millis),this.note=on.note,this.number=on.noteNumber,this.ticks=on.ticks,this.pitch=on.data1,this.velocity=on.velocity,this.id="N"+midiNoteId+(new Date).getTime(),this.name=on.noteName,this.className="MidiNote",this.type=sequencer.MIDI_NOTE,midiNoteId++},MidiNote.prototype.addNoteOff=function(off){void 0!==this.noteOff&&(console.log(off.ticks,off.noteNumber,this.id,"override note off event"),this.noteOff.midiNote=void 0);var on=this.noteOn;off.midiNote=this,this.endless=!1,this.noteOff=off,this.durationTicks=off.ticks-on.ticks,this.durationMillis=off.millis-on.millis,this.endless=!1},MidiNote.prototype.setPitch=function(pitch){pitch<0||pitch>127||(this.noteOn.setPitch(pitch),!1===this.endless&&this.noteOff.setPitch(pitch),this.number=this.noteOn.noteNumber,this.name=this.noteOn.noteName,this.pitch=pitch)},MidiNote.prototype.mute=function(flag){this.mute=void 0!==flag?flag:!this.mute},sequencer.protectedScope.addInitMethod(function(){createMidiEvent=sequencer.createMidiEvent,typeString=sequencer.protectedScope.typeString}),sequencer.createMidiNote=function(){return new MidiNote(Array.prototype.slice.call(arguments))}}(),function(){"use strict";function readChunk(stream){var id=stream.read(4,!0),length=stream.readInt32();return{id:id,length:length,data:stream.read(length,!1)}}function readEvent(stream){var event={};event.deltaTime=stream.readVarInt();var length,eventTypeByte=stream.readInt8();if(240==(240&eventTypeByte)){if(255==eventTypeByte){event.type="meta";var subtypeByte=stream.readInt8();switch(length=stream.readVarInt(),subtypeByte){case 0:if(event.subtype="sequenceNumber",2!==length)throw"Expected length for sequenceNumber event is 2, got "+length;return event.number=stream.readInt16(),event;case 1:return event.subtype="text",event.text=stream.read(length),event;case 2:return event.subtype="copyrightNotice",event.text=stream.read(length),event;case 3:return event.subtype="trackName",event.text=stream.read(length),trackName=event.text,event;case 4:return event.subtype="instrumentName",event.text=stream.read(length),instrumentName=event.text,event;case 5:return event.subtype="lyrics",event.text=stream.read(length),event;case 6:return event.subtype="marker",event.text=stream.read(length),event;case 7:return event.subtype="cuePoint",event.text=stream.read(length),event;case 32:if(event.subtype="midiChannelPrefix",1!==length)throw"Expected length for midiChannelPrefix event is 1, got "+length;return event.channel=stream.readInt8(),event;case 47:if(event.subtype="endOfTrack",0!==length)throw"Expected length for endOfTrack event is 0, got "+length;return event;case 81:if(event.subtype="setTempo",3!==length)throw"Expected length for setTempo event is 3, got "+length;return event.microsecondsPerBeat=(stream.readInt8()<<16)+(stream.readInt8()<<8)+stream.readInt8(),event;case 84:if(event.subtype="smpteOffset",5!==length)throw"Expected length for smpteOffset event is 5, got "+length;var hourByte=stream.readInt8();return event.frameRate={0:24,32:25,64:29,96:30}[96&hourByte],event.hour=31&hourByte,event.min=stream.readInt8(),event.sec=stream.readInt8(),event.frame=stream.readInt8(),event.subframe=stream.readInt8(),event;case 88:if(event.subtype="timeSignature",4!==length)throw"Expected length for timeSignature event is 4, got "+length;return event.numerator=stream.readInt8(),event.denominator=Math.pow(2,stream.readInt8()),event.metronome=stream.readInt8(),event.thirtyseconds=stream.readInt8(),event;case 89:if(event.subtype="keySignature",2!==length)throw"Expected length for keySignature event is 2, got "+length;return event.key=stream.readInt8(!0),event.scale=stream.readInt8(),event;case 127:return event.subtype="sequencerSpecific",event.data=stream.read(length),event;default:return event.subtype="unknown",event.data=stream.read(length),event}return event.data=stream.read(length),event}if(240==eventTypeByte)return event.type="sysEx",length=stream.readVarInt(),event.data=stream.read(length),event;if(247==eventTypeByte)return event.type="dividedSysEx",length=stream.readVarInt(),event.data=stream.read(length),event;throw"Unrecognised MIDI event type byte: "+eventTypeByte}var param1;0==(128&eventTypeByte)?(param1=eventTypeByte,eventTypeByte=lastEventTypeByte):(param1=stream.readInt8(),lastEventTypeByte=eventTypeByte);var eventType=eventTypeByte>>4;switch(event.channel=15&eventTypeByte,event.type="channel",eventType){case 8:return event.subtype="noteOff",event.noteNumber=param1,event.velocity=stream.readInt8(),event;case 9:return event.noteNumber=param1,event.velocity=stream.readInt8(),0===event.velocity?event.subtype="noteOff":event.subtype="noteOn",event;case 10:return event.subtype="noteAftertouch",event.noteNumber=param1,event.amount=stream.readInt8(),event;case 11:return event.subtype="controller",event.controllerType=param1,event.value=stream.readInt8(),event;case 12:return event.subtype="programChange",event.programNumber=param1,event;case 13:return event.subtype="channelAftertouch",event.amount=param1,event;case 14:return event.subtype="pitchBend",event.value=param1+(stream.readInt8()<<7),event;default:return event.value=stream.readInt8(),event.subtype="unknown",event}}function parseStream(stream){var formatType,trackCount,timeDivision,ticksPerBeat,i,trackChunk,trackStream,headerChunk,headerStream,tracks=[],trackNames=[];if(headerChunk=readChunk(stream),"MThd"!==headerChunk.id||6!==headerChunk.length)throw"Bad .mid file - header not found";if(headerStream=createStream(headerChunk.data),formatType=headerStream.readInt16(),trackCount=headerStream.readInt16(),32768&(timeDivision=headerStream.readInt16()))throw"Expressing time division in SMTPE frames is not supported yet";ticksPerBeat=timeDivision;var header={formatType:formatType,trackCount:trackCount,ticksPerBeat:ticksPerBeat};for(i=0;i<trackCount;i++){if(tracks[i]=[],trackNames[i]=trackName,trackChunk=readChunk(stream),"MTrk"!==trackChunk.id)throw"Unexpected chunk - expected MTrk, got "+trackChunk.id;for(trackStream=createStream(trackChunk.data);!trackStream.eof();){var event=readEvent(trackStream);tracks[i].push(event)}}return{header:header,tracks:tracks,trackNames:trackNames}}var lastEventTypeByte,trackName,instrumentName,createStream,sequencer=window.sequencer;window.console;sequencer.protectedScope.parseMidiFile=function(buffer){return parseStream(createStream(buffer))},sequencer.protectedScope.addInitMethod(function(){createStream=sequencer.protectedScope.createStream})}(),function(){"use strict";function createStream(buffer){function read(length,toString){var result,i;if(toString=void 0===toString||toString){for(result="",i=0;i<length;i++,position++)result+=fcc(buffer[position]);return result}for(result=[],i=0;i<length;i++,position++)result.push(buffer[position]);return result}function readInt32(){var result=(buffer[position]<<24)+(buffer[position+1]<<16)+(buffer[position+2]<<8)+buffer[position+3];return position+=4,result}function readInt16(){var result=(buffer[position]<<8)+buffer[position+1];return position+=2,result}function readInt8(signed){var result=buffer[position];return signed&&result>127&&(result-=256),position+=1,result}function eof(){return position>=buffer.length}function readVarInt(){for(var result=0;;){var b=readInt8();if(!(128&b))return result+b;result+=127&b,result<<=7}}var position=0;return{eof:eof,read:read,readInt32:readInt32,readInt16:readInt16,readInt8:readInt8,readVarInt:readVarInt}}var sequencer=window.sequencer,fcc=(window.console,String.fromCharCode);sequencer.protectedScope.createStream=createStream}(),function(){"use strict";function initMidi(cb){if(!0===midiInitialized)return void cb();midiInitialized=!0,void 0!==navigator.requestMIDIAccess?navigator.requestMIDIAccess().then(function(midi){void 0!==midi._jazzInstances?(sequencer.jazz=midi._jazzInstances[0]._Jazz.version,sequencer.midi=!0):(sequencer.webmidi=!0,sequencer.midi=!0),midiAccess=midi,midiAccess.onstatechange=getDevices,getDevices(),cb()},function(e){console.log("MIDI could not be initialized:",e),cb()
}):("chrome"===sequencer.browser?console.log("Web MIDI API not enabled"):console.log("Web MIDI API not supported"),cb())}function getDevices(e){var inputs,outputs;midiInputsOrder=[],midiOutputsOrder=[],inputs=midiAccess.inputs,inputs.forEach(function(input){midiInputsOrder.push({name:input.name,id:input.id}),sequencer.midiInputs[input.id]=input}),midiInputsOrder.sort(function(a,b){var nameA=a.name.toLowerCase(),nameB=b.name.toLowerCase();return nameA<nameB?-1:nameA>nameB?1:0}),sequencer.numMidiInputs=midiInputsOrder.length,outputs=midiAccess.outputs,outputs.forEach(function(output){midiOutputsOrder.push({name:output.name,id:output.id}),sequencer.midiOutputs[output.id]=output}),midiOutputsOrder.sort(function(a,b){var nameA=a.name.toLowerCase(),nameB=b.name.toLowerCase();return nameA<nameB?-1:nameA>nameB?1:0}),sequencer.numMidiOutputs=midiOutputsOrder.length}function initMidiSong(song){songMidiEventListener=function(e){handleMidiMessageSong(e,song,this)},objectForEach(sequencer.midiInputs,function(port){port.onmidimessage=songMidiEventListener,song.midiInputs[port.id]=port}),objectForEach(sequencer.midiOutputs,function(port){song.midiOutputs[port.id]=port}),song.numMidiInputs=sequencer.numMidiInputs,song.numMidiOutputs=sequencer.numMidiOutputs}function setMidiInputSong(id,flag,song){var i,track,input=sequencer.midiInputs[id],tracks=song.tracks,maxi=song.numTracks-1;if(flag=void 0===flag||flag,void 0===input)return void(!0===sequencer.debug&&console.log("no midi input with id",id,"found"));for(!1===flag?(delete song.midiInputs[id],input.onmidimessage=null,song.numMidiInputs--):void 0!==input&&(song.midiInputs[id]=input,input.onmidimessage=songMidiEventListener,song.numMidiInputs++),i=maxi;i>=0;i--)track=tracks[i],track.setMidiInput(id,flag)}function setMidiOutputSong(id,flag,song){var i,track,time,output=sequencer.midiOutputs[id],tracks=song.tracks,maxi=song.numTracks-1;if(flag=void 0===flag||flag,void 0===output)return void(!0===sequencer.debug&&console.log("no midi output with id",id,"found"));for(!1===flag?(delete song.midiOutputs[id],song.numMidiOutputs--,time=song.scheduler.lastEventTime+100,output.send([176,123,0],time),output.send([176,121,0],time)):void 0!==output&&(song.midiOutputs[id]=output,song.numMidiOutputs++),i=maxi;i>=0;i--)track=tracks[i],track.setMidiOutput(id,flag)}function handleMidiMessageSong(midiMessageEvent,song,input){var i,track,midiEvent,listeners,data=midiMessageEvent.data,tracks=song.tracks,numTracks=song.numTracks;for(midiEvent=createMidiEvent(song.ticks,data[0],data[1],data[2]),i=0;i<numTracks;i++)track=tracks[i],!0===track.monitor&&void 0!==track.midiInputs[input.id]&&handleMidiMessageTrack(midiEvent,track,input);void 0!==(listeners=song.midiEventListeners[midiEvent.type])&&objectForEach(listeners,function(listener){listener(midiEvent,input)})}function handleMidiMessageTrack(midiEvent,track,input){var note,listeners,channel,song=track.song;if(midiEvent.recordMillis=1e3*context.currentTime,midiEvent.state="recorded",144===midiEvent.type)note=createMidiNote(midiEvent),track.recordingNotes[midiEvent.data1]=note;else if(128===midiEvent.type){if(void 0===(note=track.recordingNotes[midiEvent.data1]))return;note.addNoteOff(midiEvent),delete track.recordingNotes[midiEvent.data1]}(song.prerolling||song.recording)&&"midi"===track.recordEnabled?(144===midiEvent.type&&track.song.recordedNotes.push(note),track.recordPart.addEvent(midiEvent),track.song.recordedEvents.push(midiEvent)):track.enableRetrospectiveRecording&&track.retrospectiveRecording.push(midiEvent),listeners=track.midiEventListeners[midiEvent.type],void 0!==listeners&&objectForEach(listeners,function(listener){listener(midiEvent,input)}),channel=track.channel,"any"!==channel&&void 0!==channel&&!0!==isNaN(channel)||(channel=0),objectForEach(track.midiOutputs,function(output){128!==midiEvent.type&&144!==midiEvent.type&&176!==midiEvent.type||output.send([midiEvent.type,midiEvent.data1,midiEvent.data2])}),!1===track.routeToMidiOut&&(midiEvent.track=track,track.instrument.processEvent(midiEvent))}function addMidiEventListener(args,obj){args=slice.call(args);var listener,loop,id=midiEventListenerId++,types={},ids=[];return loop=function(args,i,maxi){for(i=0;i<maxi;i++){var arg=args[i],type=typeString(arg);"array"===type?loop(arg,0,arg.length):"function"===type?listener=arg:!1===isNaN(arg)?(arg=parseInt(arg,10),!1!==sequencer.checkEventType(arg)&&(types[arg]=arg)):"string"===type&&!1!==sequencer.checkEventType(arg)&&(arg=sequencer.midiEventNumberByName(arg),types[arg]=arg)}},loop(args,0,args.length),objectForEach(types,function(type){void 0===obj.midiEventListeners[type]&&(obj.midiEventListeners[type]={}),obj.midiEventListeners[type][id]=listener,ids.push(type+"_"+id)}),1===ids.length?ids[0]:ids}function removeMidiEventListener(id,obj){var type;id=id.split("_"),type=id[0],id=id[1],delete obj.midiEventListeners[type][id]}function removeMidiEventListeners(){}function getMidiPortsAsDropdown(config,obj){var option,ports,select=document.createElement("select"),type=config.type,id=config.id||type,div=config.div,firstOption=config.firstOption;return"input"!==type&&"output"!==type?void console.log('please set type to "input" or "output"'):(void 0===firstOption&&(firstOption="input"===type?"choose MIDI in":"choose MIDI out"),select.id=id,ports="input"===type?obj.midiInputs:obj.midiOutputs,!1!==firstOption&&(option=document.createElement("option"),option.value=-1,option.innerHTML=firstOption,select.appendChild(option)),objectForEach(ports,function(port){option=document.createElement("option"),option.value=port.id,option.innerHTML=port.name,select.appendChild(option)}),div&&div.appendChild(select),select)}function getMidiInputs(cb,obj){var i,maxi;if(obj===sequencer)for(i=0,maxi=midiInputsOrder.length;i<maxi;i++)cb(obj.midiInputs[midiInputsOrder[i].id],i);else objectForEach(obj.midiInputs,function(port){cb(port,i)})}function getMidiOutputs(cb,obj){var i,maxi;if(obj===sequencer)for(i=0,maxi=midiOutputsOrder.length;i<maxi;i++)cb(obj.midiOutputs[midiOutputsOrder[i].id],i);else objectForEach(obj.midiOutputs,function(port,i){cb(port,i)})}var context,typeString,objectForEach,createMidiNote,createMidiEvent,songMidiEventListener,midiAccess,midiInputsOrder,midiOutputsOrder,sequencer=window.sequencer,console=window.console,slice=Array.prototype.slice,midiInitialized=!1,midiEventListenerId=0;sequencer.getMidiPortsAsDropdown=function(){getMidiPortsAsDropdown(sequencer)},sequencer.getMidiInputsAsDropdown=function(config){return config=config||{type:"input"},getMidiPortsAsDropdown(config,sequencer)},sequencer.getMidiOutputsAsDropdown=function(config){return config=config||{type:"output"},getMidiPortsAsDropdown(config,sequencer)},sequencer.getMidiInputs=function(cb){getMidiInputs(cb,sequencer)},sequencer.getMidiOutputs=function(cb){getMidiOutputs(cb,sequencer)},sequencer.protectedScope.addInitMethod(function(){context=sequencer.protectedScope.context,createMidiNote=sequencer.createMidiNote,createMidiEvent=sequencer.createMidiEvent,typeString=sequencer.protectedScope.typeString,objectForEach=sequencer.protectedScope.objectForEach}),sequencer.protectedScope.initMidi=initMidi,sequencer.protectedScope.initMidiSong=initMidiSong,sequencer.protectedScope.getMidiInputs=getMidiInputs,sequencer.protectedScope.getMidiOutputs=getMidiOutputs,sequencer.protectedScope.setMidiInputSong=setMidiInputSong,sequencer.protectedScope.setMidiOutputSong=setMidiOutputSong,sequencer.protectedScope.addMidiEventListener=addMidiEventListener,sequencer.protectedScope.getMidiPortsAsDropdown=getMidiPortsAsDropdown,sequencer.protectedScope.removeMidiEventListener=removeMidiEventListener,sequencer.protectedScope.removeMidiEventListeners=removeMidiEventListeners,sequencer.protectedScope.handleMidiMessageTrack=handleMidiMessageTrack}(),function(){"use strict";function write(song){var i,maxi,track,midiFile,arrayBuffer,uintArray,byteArray=[].concat(HDR_CHUNKID,HDR_CHUNK_SIZE,HDR_TYPE1),tracks=song.tracks,numTracks=song.tracks.length+1;for(byteArray=byteArray.concat(str2Bytes(numTracks.toString(16),2),HDR_PPQ),byteArray=byteArray.concat(trackToBytes(song.timeEvents,song.durationTicks,"tempo")),i=0,maxi=tracks.length;i<maxi;i++)track=tracks[i],byteArray=byteArray.concat(trackToBytes(track.events,song.durationTicks,track.name,track.instrumentId));for(maxi=byteArray.length,arrayBuffer=new ArrayBuffer(maxi),uintArray=new Uint8Array(arrayBuffer),i=0;i<maxi;i++)uintArray[i]=byteArray[i];midiFile=new Blob([uintArray],{type:"application/x-midi",endings:"transparent"}),saveAs(midiFile,song.name)}function trackToBytes(events,lastEventTicks,trackName,instrumentName){var lengthBytes,i,maxi,event,status,trackLength,ticks=0,delta=0,trackBytes=[];for(trackName&&(trackBytes.push(0),trackBytes.push(255),trackBytes.push(3),trackBytes=trackBytes.concat(convertToVLQ(trackName.length)),trackBytes=trackBytes.concat(stringToNumArray(trackName))),instrumentName&&(trackBytes.push(0),trackBytes.push(255),trackBytes.push(4),trackBytes=trackBytes.concat(convertToVLQ(instrumentName.length)),trackBytes=trackBytes.concat(stringToNumArray(instrumentName))),i=0,maxi=events.length;i<maxi;i++){if(event=events[i],delta=event.ticks-ticks,delta=convertToVLQ(delta),trackBytes=trackBytes.concat(delta),128===event.type||144===event.type)status=event.type+event.channel,trackBytes.push(status),trackBytes.push(event.noteNumber),trackBytes.push(event.velocity);else if(81===event.type){trackBytes.push(255),trackBytes.push(81),trackBytes.push(3);var microSeconds=Math.round(6e7/event.bpm);trackBytes=trackBytes.concat(str2Bytes(microSeconds.toString(16),3))}else if(88===event.type){var denom=event.denominator;2===denom?denom=1:4===denom?denom=2:8===denom?denom=3:16===denom?denom=4:32===denom&&(denom=5),trackBytes.push(255),trackBytes.push(88),trackBytes.push(4),trackBytes.push(event.nominator),trackBytes.push(denom),trackBytes.push(PPQ/event.nominator),trackBytes.push(8)}ticks=event.ticks}return delta=lastEventTicks-ticks,delta=convertToVLQ(delta),trackBytes=trackBytes.concat(delta),trackBytes.push(255),trackBytes.push(47),trackBytes.push(0),trackLength=trackBytes.length,lengthBytes=str2Bytes(trackLength.toString(16),4),[].concat(TRK_CHUNKID,lengthBytes,trackBytes)}function str2Bytes(str,finalBytes){if(finalBytes)for(;str.length/2<finalBytes;)str="0"+str;for(var bytes=[],i=str.length-1;i>=0;i-=2){var chars=0===i?str[i]:str[i-1]+str[i];bytes.unshift(parseInt(chars,16))}return bytes}function convertToVLQ(ticks){for(var buffer=127&ticks;ticks>>=7;)buffer<<=8,buffer|=127&ticks|128;for(var bList=[];;){if(bList.push(255&buffer),!(128&buffer))break;buffer>>=8}return bList}function stringToNumArray(str){return AP.map.call(str,function(char){return char.charCodeAt(0)})}var sequencer=window.sequencer,AP=(window.console,Array.prototype),PPQ=sequencer.defaultPPQ,HDR_CHUNKID=["M".charCodeAt(0),"T".charCodeAt(0),"h".charCodeAt(0),"d".charCodeAt(0)],HDR_CHUNK_SIZE=[0,0,0,6],HDR_TYPE1=[0,1],HDR_PPQ=str2Bytes(PPQ.toString(16),2),TRK_CHUNKID=["M".charCodeAt(0),"T".charCodeAt(0),"r".charCodeAt(0),"k".charCodeAt(0)];sequencer.protectedScope.saveToMidiFile=write,sequencer.saveSongAsMidiFile=write}(),function(){"use strict";function load(url,cb,returnAsXML){void 0!==url&&void 0!==cb||sequencer.debug>=sequencer.WARN&&console.warn("please provide an url and a callback method"),ajax({url:url+"?"+(new Date).getTime(),method:"GET",onError:function(){cb(!1)},onSuccess:function(response){cb(!0===returnAsXML?response:parse(response))},responseType:"xml"})}function parse(xml){var parser=new DOMParser,xmlDoc=parser.parseFromString(xml,"application/xml"),type=xmlDoc.firstChild.nextSibling.nodeName;return nsResolver=xmlDoc.createNSResolver(null===xmlDoc.ownerDocument?xmlDoc.documentElement:xmlDoc.ownerDocument.documentElement),"score-partwise"===type?parsePartWise(xmlDoc):"score-timewise"===type?parseTimeWise(xmlDoc):(console.log("unknown type",type),!1)}function parsePartWise(xmlDoc){for(var partNode,measureIterator,measureNode,noteIterator,noteNode,tieStart,tieStop,tieIterator,tieNode,events,track,part,noteOn,noteOff,name,id,tmp1,tmp2,step,alter,octave,voice,noteDuration,noteName,noteNumber,velocity,rest,chord,divisions,numerator,denominator,ticks,partIterator=xmlDoc.evaluate("//score-part",xmlDoc,nsResolver,XPathResult.ANY_TYPE,null),tracks=[],timeEvents=[],tiedNotes={},ppq=sequencer.defaultPPQ;null!==(partNode=partIterator.iterateNext());){for(id=xmlDoc.evaluate("@id",partNode,nsResolver,XPathResult.STRING_TYPE,null).stringValue,name=xmlDoc.evaluate("part-name",partNode,nsResolver,XPathResult.STRING_TYPE,null).stringValue,velocity=xmlDoc.evaluate("midi-instrument/volume",partNode,nsResolver,XPathResult.NUMBER_TYPE,null).numberValue,velocity=parseInt(velocity/100*127),ticks=0,track=sequencer.createTrack(name),part=sequencer.createPart(),track.addPart(part),tracks.push(track),events=[],measureIterator=xmlDoc.evaluate('//part[@id="'+id+'"]/measure',partNode,nsResolver,XPathResult.ANY_TYPE,null);null!==(measureNode=measureIterator.iterateNext());)for(xmlDoc.evaluate("@number",measureNode,nsResolver,XPathResult.NUMBER_TYPE,null).numberValue,tmp1=xmlDoc.evaluate("attributes/divisions",measureNode,nsResolver,XPathResult.NUMBER_TYPE,null).numberValue,isNaN(tmp1)||(divisions=tmp1),tmp1=xmlDoc.evaluate("attributes/time/beats",measureNode,nsResolver,XPathResult.NUMBER_TYPE,null).numberValue,tmp2=xmlDoc.evaluate("attributes/time/beat-type",measureNode,nsResolver,XPathResult.NUMBER_TYPE,null).numberValue,isNaN(tmp1)||(numerator=tmp1,denominator=tmp2,timeEvents.push(sequencer.createMidiEvent(ticks,sequencer.TIME_SIGNATURE,numerator,denominator))),noteIterator=xmlDoc.evaluate("*[self::note or self::backup or self::forward]",measureNode,nsResolver,XPathResult.ANY_TYPE,null);null!==(noteNode=noteIterator.iterateNext());){for(tieStart=!1,tieStop=!1,tieIterator=xmlDoc.evaluate("tie",noteNode,nsResolver,XPathResult.ANY_TYPE,null);null!==(tieNode=tieIterator.iterateNext());)tmp1=xmlDoc.evaluate("@type",tieNode,nsResolver,XPathResult.STRING_TYPE,null).stringValue,"start"===tmp1?tieStart=!0:"stop"===tmp1&&(tieStop=!0);if(rest=xmlDoc.evaluate("rest",noteNode,nsResolver,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,chord=xmlDoc.evaluate("chord",noteNode,nsResolver,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,null!==rest)noteDuration=xmlDoc.evaluate("duration",noteNode,nsResolver,XPathResult.NUMBER_TYPE,null).numberValue,ticks+=noteDuration/divisions*ppq;else if("note"===noteNode.nodeName){if(step=xmlDoc.evaluate("pitch/step",noteNode,nsResolver,XPathResult.STRING_TYPE,null).stringValue,alter=xmlDoc.evaluate("pitch/alter",noteNode,nsResolver,XPathResult.NUMBER_TYPE,null).numberValue,voice=xmlDoc.evaluate("voice",noteNode,nsResolver,XPathResult.NUMBER_TYPE,null).numberValue,octave=xmlDoc.evaluate("pitch/octave",noteNode,nsResolver,XPathResult.NUMBER_TYPE,null).numberValue,noteDuration=xmlDoc.evaluate("duration",noteNode,nsResolver,XPathResult.NUMBER_TYPE,null).numberValue,xmlDoc.evaluate("type",noteNode,nsResolver,XPathResult.STRING_TYPE,null).stringValue,noteName=step,""!==step){if(!isNaN(alter))switch(alter){case-2:noteName+="bb";break;case-1:noteName+="b";break;case 1:noteName+="#";break;case 2:noteName+="##"}noteNumber=getNoteNumber(noteName,octave),noteOn=sequencer.createMidiEvent(ticks,sequencer.NOTE_ON,noteNumber,velocity),ticks+=noteDuration/divisions*ppq,noteOff=sequencer.createMidiEvent(ticks,sequencer.NOTE_OFF,noteNumber,0),null!==chord&&(ticks-=noteDuration/divisions*ppq),!1===tieStart&&!1===tieStop?events.push(noteOn,noteOff):!0===tieStart&&!1===tieStop?(tiedNotes[voice+"-"+noteNumber]=noteOff,events.push(noteOn,noteOff)):!0===tieStart&&!0===tieStop?tiedNotes[voice+"-"+noteNumber].ticks+=noteDuration/divisions*ppq:!1===tieStart&&!0===tieStop&&(tiedNotes[voice+"-"+noteNumber].ticks+=noteDuration/divisions*ppq,delete tiedNotes[voice+"-"+noteNumber])}}else"backup"===noteNode.nodeName?(noteDuration=xmlDoc.evaluate("duration",noteNode,nsResolver,XPathResult.NUMBER_TYPE,null).numberValue,ticks-=noteDuration/divisions*ppq):"forward"===noteNode.nodeName&&(noteDuration=xmlDoc.evaluate("duration",noteNode,nsResolver,XPathResult.NUMBER_TYPE,null).numberValue,ticks+=noteDuration/divisions*ppq)}part.addEvents(events)}return sequencer.createSong({bpm:110,tracks:tracks[0],timeEvents:timeEvents,useMetronome:!1})}function parseTimeWise(xmlDoc){return xmlDoc}var ajax,typeString,getNoteNumber,nsResolver,sequencer=window.sequencer,console=window.console;sequencer.loadMusicXML=load,sequencer.parseMusicXML=parse,sequencer.protectedScope.addInitMethod(function(){ajax=sequencer.protectedScope.ajax,typeString=sequencer.protectedScope.typeString,getNoteNumber=sequencer.getNoteNumber})}(),function(){"use strict";var typeString,noteNames,getNoteNumber,getNoteName,checkNoteName,getFrequency,createNote,isNoteMode,isBlackKey,pow=Math.pow;noteNames={sharp:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],flat:["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],"enharmonic-sharp":["B#","C#","C##","D#","D##","E#","F#","F##","G#","G##","A#","A##"],"enharmonic-flat":["Dbb","Db","Ebb","Eb","Fb","Gbb","Gb","Abb","Ab","Bbb","Bb","Cb"]},createNote=function(){var data,octave,noteName,noteNumber,noteNameMode,frequency,args=Array.prototype.slice.call(arguments),numArgs=args.length,warn=!1,error=!1,arg0=args[0],arg1=args[1],arg2=args[2];return 1!==numArgs||isNaN(arg0)?1===numArgs&&"string"===typeString(arg0)?(data=checkNoteName(arg0),data?(noteName=data[0],octave=data[1],noteNumber=getNoteNumber(noteName,octave),noteNumber?(noteNumber<0||noteNumber>127)&&(error="please provide a note between C0 and G10"):error=arg0+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave"):error=arg0+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave"):2!==numArgs||"string"!==typeString(arg0)||isNaN(arg1)?2===numArgs&&"string"===typeString(arg0)&&"string"===typeString(arg1)?(data=checkNoteName(arg0),data?(noteNameMode=isNoteMode(arg1),noteNameMode||(noteNameMode=sequencer.noteNameMode,warn=arg1+" is not a valid note name mode, using "+noteNameMode),noteName=data[0],octave=data[1],noteNumber=getNoteNumber(noteName,octave),noteNumber?(noteNumber<0||noteNumber>127)&&(error="please provide a note between C0 and G10"):error=noteName+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave",noteName=getNoteName(noteNumber,noteNameMode)[0]):error=arg0+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave"):2===numArgs&&"number"===typeString(arg0)&&"string"===typeString(arg1)?arg0<0||arg0>127?error="please provide a note number >= 0 and <= 127":(noteNameMode=isNoteMode(arg1),noteNameMode||(noteNameMode=sequencer.noteNameMode,warn=arg1+" is not a valid note name mode, using "+noteNameMode),noteNumber=arg0,data=getNoteName(noteNumber,noteNameMode),noteName=data[0],octave=data[1],noteName=getNoteName(noteNumber,noteNameMode)[0]):3!==numArgs||"string"!==typeString(arg0)||isNaN(arg1)||"string"!==typeString(arg2)?error="wrong arguments, please consult documentation":(data=checkNoteName(arg0,arg1),data?(noteNameMode=isNoteMode(arg2),noteNameMode||(noteNameMode=sequencer.noteNameMode,warn=arg2+" is not a valid note name mode, using "+noteNameMode),noteName=data[0],octave=data[1],noteNumber=getNoteNumber(noteName,octave),noteNumber?(noteNumber<0||noteNumber>127)&&(error="please provide a note between C0 and G10"):error=noteName+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave",noteName=getNoteName(noteNumber,noteNameMode)[0]):error=arg0+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave"):(data=checkNoteName(arg0,arg1),data?(noteName=data[0],octave=data[1],noteNumber=getNoteNumber(noteName,octave),noteNumber?(noteNumber<0||noteNumber>127)&&(error="please provide a note between C0 and G10"):error=noteName+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb"):error=arg0+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb"):arg0<0||arg0>127?error="please provide a note number >= 0 and <= 127":(noteNumber=arg0,data=getNoteName(noteNumber),noteName=data[0],octave=data[1]),error?(console.error(error),!1):(warn&&console.warn(warn),frequency=getFrequency(noteNumber),{name:noteName,octave:octave,fullName:noteName+octave,number:noteNumber,frequency:frequency,blackKey:isBlackKey(noteNumber)})},getNoteName=function(number,mode){mode=mode||sequencer.noteNameMode;var octave=Math.floor(number/12-1);return[noteNames[mode][number%12],octave]},getNoteNumber=function(name,octave,mode){var key,index,i,maxi;for(key in noteNames)if(noteNames.hasOwnProperty(key))for(mode=noteNames[key],i=0,maxi=mode.length;i<maxi;i+=1)if(mode[i]===name){index=i;break}return-1!==index&&index+12+12*octave},getFrequency=function(number){return sequencer.pitch*pow(2,(number-69)/12)},checkNoteName=function(){var length,i,char,name,octave,args=Array.prototype.slice.call(arguments),numArgs=args.length,arg0=args[0],arg1=args[1];if(1===numArgs&&"string"===typeString(arg0)){for(length=arg0.length,name="",octave="",i=0;i<length;i++)char=arg0[i],isNaN(char)&&"-"!==char?name+=char:octave+=char;""===octave&&(octave=0)}else{if(2!==numArgs||"string"!==typeString(arg0)||isNaN(arg1))return!1;name=arg0,octave=arg1}return octave=parseInt(octave,10),name=name.substring(0,1).toUpperCase()+name.substring(1),[name,octave]},isNoteMode=function(mode){var result=!1;switch(mode){case"sharp":case"flat":case"enharmonic-sharp":case"enharmonic-flat":result=mode}return result},isBlackKey=function(noteNumber){var black;switch(!0){case noteNumber%12==1:case noteNumber%12==3:case noteNumber%12==6:case noteNumber%12==8:case noteNumber%12==10:black=!0;break;default:black=!1}return black},sequencer.getNoteNumber=function(){var note=createNote.apply(this,arguments);return!!note&&note.number},sequencer.getNoteName=function(){var note=createNote.apply(this,arguments);return!!note&&note.name},sequencer.getNoteNameFromNoteNumber=function(number,mode){return getNoteName(number,mode)},sequencer.getNoteOctave=function(){var note=createNote.apply(this,arguments);return!!note&&note.octave},sequencer.getFullNoteName=function(){var note=createNote.apply(this,arguments);return!!note&&note.fullName},sequencer.getFrequency=function(){var note=createNote.apply(this,arguments);return!!note&&note.frequency},sequencer.isBlackKey=function(){var note=createNote.apply(this,arguments);return!!note&&note.blackKey},Object.defineProperty(sequencer,"SHARP",{value:"sharp"}),Object.defineProperty(sequencer,"FLAT",{value:"flat"}),Object.defineProperty(sequencer,"ENHARMONIC_SHARP",{value:"enharmonic-sharp"}),Object.defineProperty(sequencer,"ENHARMONIC_FLAT",{value:"enharmonic-flat"}),sequencer.createNote=createNote,sequencer.protectedScope.addInitMethod(function(){typeString=sequencer.protectedScope.typeString})}(),function(){"use strict";function parse(song,events){var event,numEvents,diffTicks,i,lastEventTick=0;for(numEvents=events.length,events.sort(function(a,b){return a.sortIndex-b.sortIndex}),getDataFromEvent(song.timeEvents[0]),i=0;i<numEvents;i++){for(event=events[i],diffTicks=event.ticks-lastEventTick,tick+=diffTicks;tick>=ticksPerSixteenth;)for(sixteenth++,tick-=ticksPerSixteenth;sixteenth>numSixteenth;)for(sixteenth-=numSixteenth,beat++;beat>nominator;)beat-=nominator,bar++;switch(event.type){case 81:bpm=event.bpm,millis=event.millis,millisPerTick=event.millisPerTick,secondsPerTick=event.secondsPerTick;break;case 88:factor=event.factor,nominator=event.nominator,denominator=event.denominator,numSixteenth=event.numSixteenth,ticksPerBar=event.ticksPerBar,ticksPerBeat=event.ticksPerBeat,ticksPerSixteenth=event.ticksPerSixteenth,millis=event.millis;break;default:millis+=diffTicks*millisPerTick,updateEvent(event)}lastEventTick=event.ticks}song.lastEventTmp=event}function getDataFromEvent(event){bpm=event.bpm,factor=event.factor,nominator=event.nominator,denominator=event.denominator,ticksPerBar=event.ticksPerBar,ticksPerBeat=event.ticksPerBeat,ticksPerSixteenth=event.ticksPerSixteenth,numSixteenth=event.numSixteenth,millisPerTick=event.millisPerTick,secondsPerTick=event.secondsPerTick,millis=event.millis,bar=event.bar,beat=event.beat,sixteenth=event.sixteenth,tick=event.tick}function updateEvent(event){var timeData,tickAsString;timeData=sequencer.getNiceTime(millis),event.bpm=bpm,event.factor=factor,event.nominator=nominator,event.denominator=denominator,event.ticksPerBar=ticksPerBar,event.ticksPerBeat=ticksPerBeat,event.ticksPerSixteenth=ticksPerSixteenth,event.numSixteenth=numSixteenth,event.millisPerTick=millisPerTick,event.secondsPerTick=secondsPerTick,event.millis=round(millis*precision)/precision,event.hour=timeData.hour,event.minute=timeData.minute,event.second=timeData.second,event.millisecond=timeData.millisecond,event.timeAsString=timeData.timeAsString,event.timeAsArray=timeData.timeAsArray,event.bar=bar,event.beat=beat,event.sixteenth=sixteenth,event.tick=tick,tickAsString=0===tick?"000":tick<10?"00"+tick:tick<100?"0"+tick:tick,event.barsAsString=bar+":"+beat+":"+sixteenth+":"+tickAsString,event.barsAsArray=[bar,beat,sixteenth,tick],event.state="clean",event.update()}var factor,nominator,denominator,bar,beat,sixteenth,tick,ticksPerBar,ticksPerBeat,ticksPerSixteenth,numSixteenth,millisPerTick,secondsPerTick,millis,bpm,sequencer=window.sequencer,round=(window.console,Math.round),precision=Math.pow(10,sequencer.precision);sequencer.protectedScope.parseEvents=parse,sequencer.protectedScope.addInitMethod(function(){})}(),function(){"use strict";function setTickDuration(){secondsPerTick=1/playbackSpeed*60/bpm/ppq,millisPerTick=1e3*secondsPerTick}function setTicksPerBeat(){factor=4/denominator,numSixteenth=4*factor,ticksPerBeat=ppq*factor,ticksPerBar=ticksPerBeat*nominator,ticksPerSixteenth=ppq/4}function parse(song){var diffTicks,event,type,i=0;if(void 0===song)return timeEvents=[],void console.log("reset",timeEvents);for(reset(song),setTickDuration(),setTicksPerBeat(),timeEvents.sort(function(a,b){return a.ticks-b.ticks}),i=0;i<numTimeEvents;i++){for(event=timeEvents[i],event.song=song,diffTicks=event.ticks-ticks,tick+=diffTicks,ticks=event.ticks,type=event.type,millis+=diffTicks*millisPerTick;tick>=ticksPerSixteenth;)for(sixteenth++,tick-=ticksPerSixteenth;sixteenth>numSixteenth;)for(sixteenth-=numSixteenth,beat++;beat>nominator;)beat-=nominator,bar++;switch(type){case 81:bpm=event.bpm,setTickDuration();break;case 88:nominator=event.nominator,denominator=event.denominator,setTicksPerBeat();break;default:continue}updateEvent(event)}song.lastEventTmp=event}function reset(song){playbackSpeed=song.playbackSpeed,timeEvents=song.timeEvents,numTimeEvents=timeEvents.length,ppq=song.ppq,bpm=song.bpm,nominator=song.nominator,denominator=song.denominator,index=0,bar=1,beat=1,sixteenth=1,tick=0,ticks=0,millis=0}function updateEvent(event){event.bpm=bpm,event.nominator=nominator,event.denominator=denominator,event.ticksPerBar=ticksPerBar,event.ticksPerBeat=ticksPerBeat,event.ticksPerSixteenth=ticksPerSixteenth,event.factor=factor,event.numSixteenth=numSixteenth,event.secondsPerTick=secondsPerTick,event.millisPerTick=millisPerTick,event.ticks=ticks,event.millis=millis,event.seconds=millis/1e3,event.bar=bar,event.beat=beat,event.sixteenth=sixteenth,event.tick=tick;var tickAsString=0===tick?"000":tick<10?"00"+tick:tick<100?"0"+tick:tick;event.barsAsString=bar+":"+beat+":"+sixteenth+":"+tickAsString,event.barsAsArray=[bar,beat,sixteenth,tick];var timeData=sequencer.getNiceTime(millis);event.hour=timeData.hour,event.minute=timeData.minute,event.second=timeData.second,event.millisecond=timeData.millisecond,event.timeAsString=timeData.timeAsString,event.timeAsArray=timeData.timeAsArray}var createMidiEvent,ppq,bpm,factor,nominator,denominator,playbackSpeed,bar,beat,sixteenth,tick,ticks,millis,millisPerTick,secondsPerTick,ticksPerBeat,ticksPerBar,ticksPerSixteenth,numSixteenth,timeEvents,numTimeEvents,index,sequencer=window.sequencer,console=window.console;sequencer.protectedScope.parseTimeEvents=parse,sequencer.protectedScope.addInitMethod(function(){createMidiEvent=sequencer.createMidiEvent})}(),function(){"use strict";var createMidiNote,createMidiEvent,copyName,typeString,findEvent,findNote,getStats,getEvent,addEvents,moveEvents,removeEvents,transposeEvents,getEventsAndConfig,reverseByPitch,reverseByTicks,Part,sequencer=window.sequencer,console=window.console,partId=0;Part=function(name){this.className="Part",this.id="P"+partId+++(new Date).getTime(),this.partIndex=partId,this.name=name||this.id,this.events=[],this.eventsById={},this.numEvents=0,this.notes=[],this.notesById={},this.numNotes=0,this.dirtyEvents={},this.dirtyNotes={},this.song=void 0,this.autoSize="right",this.ticks=0,this.millis=0,this.start={ticks:this.ticks,millis:this.millis},this.end={ticks:0,millis:0},this.duration={ticks:0,millis:0},this.startPosition=void 0,this.endPosition=void 0,this.needsUpdate=!1,this.state="clean",this.mute=!1,this.solo=!1,this.keepWhenEmpty=!0},getEventsAndConfig=function(args,part){args=Array.prototype.slice.call(args);var maxi,e,arg,j=0,i=0,arg0=args[0],events=[],config=[];if("array"===typeString(arg0)){for(i=arg0.length-1;i>=0;i--)arg=arg0[i],(e=getEvent(arg,part))&&events.push(e);j=0===events.length?0:1}for(maxi=args.length,i=j;i<maxi;i++)arg=args[i],e=getEvent(arg,part),e?events.push(e):config.push(arg);return 0===events.length?(sequencer.debug&&console.warn("no events added",part.name),!1):(1===config.length&&"array"===typeString(config[0])&&(config=config[0]),{events:events,config:config})},getEvent=function(data,part){var event=!1;return data?"MidiEvent"===data.className||"AudioEvent"===data.className?event=data:"array"===typeString(data)&&4===data.length?event=createMidiEvent(data):"string"===typeString(data)?event=part.eventsById[data]:!1===isNaN(data)&&(event=part.events[data]):event=!1,event},addEvents=function(args,part,relative){if(!1!==args){var i,e,newEvents=args.events,ticks=part.ticks,maxi=newEvents.length,track=part.track,eventsById=part.eventsById;for(i=0;i<maxi;i++)e=newEvents[i],e.type===sequencer.END_OF_TRACK||"MidiEvent"!==e.className&&"AudioEvent"!==e.className||("AudioEvent"===e.className&&!0!==part.hasAudioEvents&&(part.hasAudioEvents=!0),void 0!==e.part&&(e=e.clone()),e.part=part,e.partId=part.id,relative&&(ticks+=e.ticks,e.ticks=ticks),e.track=track,e.trackId=track?track.id:void 0,e.song=void 0,void 0!==track&&(e.song=track.song),"recorded"!==e.state&&(e.state="new"),eventsById[e.id]=e);"new"!==part.state&&(part.state="changed"),part.needsUpdate=!0}},transposeEvents=function(args,part){if(!1!==args){var i,e,events=args.events,semi=args.config[0];for(i=events.length-1;i>=0;i--)e=events[i],e.transpose(semi);"new"!==part.state&&void 0!==part.track&&(part.state="changed",part.track.needsUpdate=!0)}},moveEvents=function(args,part){if(!1!==args){var i,e,newTicks,events=args.events,ticks=args.config[0];if(isNaN(ticks))return void console.warn("Part.moveEvent(s) -> please provide a number");for(i=events.length-1;i>=0;i--)e=events[i],newTicks=e.ticks+ticks,newTicks<0&&(newTicks=0),e.ticks=newTicks,"new"!==e.state&&(e.state="changed");part.needsUpdate=!0,"new"!==part.state&&part.track&&(part.state="changed",part.track.needsUpdate=!0)}},removeEvents=function(tobeRemoved,part){var i,event,removed=[];for(i=tobeRemoved.length-1;i>=0;i--)!1!==(event=getEvent(tobeRemoved[i],part))&&(event.part===part?(event.state="removed",event.reset(),
removed.push(event)):console.warn("can't remove: this event belongs to part",event.part.id));return void 0!==part.track&&(part.track.needsUpdate=!0),part.needsUpdate=!0,removed},reverseByPitch=function(part){var on,off,i,note,notes=part.notes,min=part.lowestNote,max=part.highestNote;for(i=notes.length-1;i>=0;i--)note=notes[i],note.setPitch(min+(max-note.number)),on=note.noteOn,off=note.noteOff,on.state="changed",off.state="changed",note.state="changed";part.needsUpdate=!0,"new"!==part.state&&part.track&&(part.state="changed",part.track.needsUpdate=!0)},reverseByTicks=function(part,durationTicks){var note,on,off,onTicks,offTicks,i,notes=part.notes;for(durationTicks=durationTicks||part.duration.ticks,i=notes.length-1;i>=0;i--)note=notes[i],on=note.noteOn,off=note.noteOff,onTicks=durationTicks-off.ticks,offTicks=durationTicks-on.ticks,on.ticks=onTicks,off.ticks=offTicks,note.ticks=onTicks,on.state="changed",off.state="changed",note.state="changed";part.needsUpdate=!0,"new"!==part.state&&part.track&&(part.state="changed",part.track.needsUpdate=!0)},Part.prototype.addEvent=Part.prototype.addEvents=function(){var args=getEventsAndConfig(arguments,this);addEvents(args,this,!1)},Part.prototype.addEventsRelative=function(){var args=getEventsAndConfig(arguments,this);addEvents(args,this,!0)},Part.prototype.removeEvent=Part.prototype.removeEvents=function(){var args=getEventsAndConfig(arguments,this);return!1!==args&&removeEvents(args.events,this)},Part.prototype.moveEvent=Part.prototype.moveEvents=function(){var args=getEventsAndConfig(arguments,this);moveEvents(args,this)},Part.prototype.moveAllEvents=function(ticks){moveEvents({events:this.events,config:[ticks]},this)},Part.prototype.moveNote=function(note,ticks){moveEvents({events:[note.noteOn,note.noteOff],config:[ticks]},this)},Part.prototype.transposeEvents=function(){var args=getEventsAndConfig(arguments,this);transposeEvents(args,this)},Part.prototype.transposeAllEvents=function(semi){transposeEvents({events:this.events,config:[semi]},this)},Part.prototype.transposeNote=function(note,semi){transposeEvents({events:[note.noteOn,note.noteOff],config:[semi]},this)},Part.prototype.reverseByTicks=function(duration){this.needsUpdate&&this.update(),reverseByTicks(this,duration)},Part.prototype.reverseByPitch=function(){this.needsUpdate&&this.update(),reverseByPitch(this)},Part.prototype.findEvents=function(pattern){return findEvent(this,pattern)},Part.prototype.findNotes=function(pattern){return findNote(this,pattern)},Part.prototype.getStats=function(pattern){return getStats(this,pattern)},Part.prototype.getIndex=function(){var parts,part,i;if(this.track)for(parts=this.track.parts,i=this.track.numParts-1;i>=0;i--)if(part=parts[i],part.id===this.id)return i;return-1},Part.prototype.copy=function(){var copy,id,event,part=new Part(copyName(this.name)),partTicks=this.ticks,eventsById=this.eventsById,copies=[];part.song=void 0,part.track=void 0,part.trackId=void 0;for(id in eventsById)eventsById.hasOwnProperty(id)&&(event=eventsById[id],copy=event.copy(),copy.ticks=copy.ticks-partTicks,copies.push(copy));return part.addEvents(copies),part},Part.prototype.setSolo=function(flag){void 0===flag&&(flag=!this.solo),this.mute=!1,this.solo=flag,this.allNotesOff(),this.track&&this.track.setPartSolo(this,flag)},Part.prototype.allNotesOff=function(){void 0!==this.track&&this.track.instrument.allNotesOffPart(this.id)},Part.prototype.reset=function(fromTrack,fromSong){var id,event,eventsById=this.eventsById;fromSong&&(this.song=void 0),fromTrack&&(this.track=void 0),this.trackId=void 0,this.start.millis=void 0,this.end.millis=void 0;for(id in eventsById)eventsById.hasOwnProperty(id)&&(event=eventsById[id],event.ticks-=this.ticks,event.reset(!1,fromTrack,fromSong));this.ticks=0,this.needsUpdate=!0},Part.prototype.update=function(){var i,maxi,id,event,noteNumber,note,firstEvent,lastEvent,stats,notes=[],part=this,partId=this.id,track=this.track,trackId=this.track?this.track.id:void 0;this.events=[];for(id in this.eventsById)this.eventsById.hasOwnProperty(id)&&(event=this.eventsById[id],"clean"!==event.state&&(this.dirtyEvents[event.id]=event),"removed"!==event.state&&this.events.push(event));for(this.events.sort(function(a,b){return a.sortIndex-b.sortIndex}),i=0,maxi=this.notes.length;i<maxi;i++)note=this.notes[i],"removed"===note.noteOn.state||void 0!==note.noteOff&&"removed"===note.noteOff.state?(note.state="removed",this.dirtyNotes[note.id]=note,delete this.notesById[note.id]):("changed"===note.noteOn.state||void 0!==note.noteOff&&"changed"===note.noteOff.state)&&(note.state="changed",this.dirtyNotes[note.id]=note);for(i=0,maxi=this.events.length;i<maxi;i++)if(event=this.events[i],noteNumber=event.noteNumber,event.type===sequencer.NOTE_ON)void 0===event.midiNote&&(note=createMidiNote(event),note.part=part,note.partId=partId,note.track=track,note.trackId=trackId,note.state="new",this.notesById[note.id]=note,this.dirtyNotes[note.id]=note,void 0===notes[noteNumber]&&(notes[noteNumber]=[]),notes[noteNumber].push(note));else if(event.type===sequencer.NOTE_OFF)if(void 0===event.midiNote){if(void 0===notes[noteNumber])continue;var l=notes[noteNumber].length-1;if(note=notes[noteNumber][l],void 0!==note.noteOff&&note.durationTicks>0)continue;if(null===note)continue;if(void 0===note.noteOn)continue;"new"!==note.state&&(note.state="changed"),this.dirtyNotes[note.id]=note,note.addNoteOff(event)}else void 0===this.notesById[event.midiNote.id]&&(note=event.midiNote,note.part=part,note.partId=partId,note.track=track,note.trackId=trackId,this.notesById[note.id]=note);this.notes=[],notes=null;for(id in this.notesById)this.notesById.hasOwnProperty(id)&&(note=this.notesById[id],this.notes.push(note));if(this.notes.sort(function(a,b){return a.ticks-b.ticks}),this.numEvents=this.events.length,this.numNotes=this.notes.length,firstEvent=this.events[0],lastEvent=this.events[this.numEvents-1],firstEvent)switch(firstEvent.ticks<this.ticks&&(this.autoSize="both"),this.autoSize){case"right":this.start.ticks=this.ticks,this.end.ticks=lastEvent.ticks,this.duration.ticks=lastEvent.ticks-this.start.ticks;break;case"both":this.start.ticks=firstEvent.ticks,this.end.ticks=lastEvent.ticks,this.duration.ticks=lastEvent.ticks-firstEvent.ticks}else this.start.ticks=this.ticks,this.end.ticks=this.ticks+100,this.duration.ticks=100;stats=this.getStats("noteNumber all"),this.lowestNote=stats.min,this.highestNote=stats.max,this.ticks=this.start.ticks,"clean"===this.state&&(this.state="changed"),this.needsUpdate=!1},sequencer.createPart=function(){return new Part},sequencer.protectedScope.addInitMethod(function(){createMidiNote=sequencer.createMidiNote,createMidiEvent=sequencer.createMidiEvent,copyName=sequencer.protectedScope.copyName,typeString=sequencer.protectedScope.typeString,findEvent=sequencer.findEvent,findNote=sequencer.findNote,getStats=sequencer.getStats})}(),function(){"use strict";var debug,Playhead,getPosition2,objectForEach,sequencer=window.sequencer,console=window.console,instanceId=0;Playhead=function(song,type,name,data){this.id="POS"+instanceId+++(new Date).getTime(),this.song=song,this.type=type||"",this.name=name||this.id,this.data=data||{},this.lastEvent=void 0,this.activeParts=[],this.activeNotes=[],this.activeEvents=[]},Playhead.prototype.set=function(u,v){return this.unit=u,this.currentValue=v,this.eventIndex=0,this.noteIndex=0,this.partIndex=0,this.calculate(),this.data},Playhead.prototype.get=function(){return this.data},Playhead.prototype.update=function(u,diff){return 0===diff?this.data:(this.unit=u,this.currentValue+=diff,this.calculate(),this.data)},Playhead.prototype.updateSong=function(){this.events=this.song.eventsMidiTime,this.numEvents=this.events.length,this.notes=this.song.notes,this.numNotes=this.song.numNotes,this.parts=this.song.parts,this.numParts=this.song.numParts,this.set("millis",this.song.millis||0)},Playhead.prototype.setType=function(t){this.type=t,this.set(this.unit,this.currentValue)},Playhead.prototype.addType=function(t){this.type+=" "+t,this.set(this.unit,this.currentValue)},Playhead.prototype.removeType=function(t){var arr=this.type.split(" ");this.type="",arr.forEach(function(type){type!==t&&(this.type+=t+" ")}),this.type.trim(),this.set(this.currentValue)},Playhead.prototype.calculate=function(){var i,event,note,part,position,newParts=[],stillActiveNotes=[],stillActiveEvents=[],collectedParts=[],collectedNotes=[],collectedEvents=[];for(i=this.eventIndex;i<this.numEvents&&(event=this.events[i],event[this.unit]<=this.currentValue);i++)event.type!==sequencer.MIDI_NOTE&&event.type!==sequencer.DUMMY_EVENT&&collectedEvents.push(event),this.lastEvent=event,this.eventIndex++;if(void 0===this.lastEvent&&(this.lastEvent=this.song.timeEvents[0]),position=getPosition2(this.song,this.unit,this.currentValue,"all",this.lastEvent),this.data.eventIndex=this.eventIndex,this.data.millis=position.millis,this.data.ticks=position.ticks,-1!==this.type.indexOf("all")){var data=this.data;objectForEach(position,function(value,key){data[key]=value})}else-1!==this.type.indexOf("barsbeats")?(this.data.bar=position.bar,this.data.beat=position.beat,this.data.sixteenth=position.sixteenth,this.data.tick=position.tick,this.data.barsAsString=position.barsAsString,this.data.ticksPerBar=position.ticksPerBar,this.data.ticksPerBeat=position.ticksPerBeat,this.data.ticksPerSixteenth=position.ticksPerSixteenth,this.data.numSixteenth=position.numSixteenth):-1!==this.type.indexOf("time")?(this.data.hour=position.hour,this.data.minute=position.minute,this.data.second=position.second,this.data.millisecond=position.millisecond,this.data.timeAsString=position.timeAsString):-1!==this.type.indexOf("percentage")&&(this.data.percentage=position.percentage);if(-1!==this.type.indexOf("events")||-1!==this.type.indexOf("all")){for(this.collectedEvents=collectedEvents,i=this.activeEvents.length-1;i>=0;i--)event=this.activeEvents[i],81!==event.type&&88!==event.type&&0!==event.state.indexOf("removed")&&void 0!==this.song.eventsById[event.id]&&event[this.unit]<=this.currentValue&&event[this.unit]>this.currentValue-10&&stillActiveEvents.push(event);for(this.activeEvents=[].concat(stillActiveEvents),i=collectedEvents.length-1;i>=0;i--)event=collectedEvents[i],event[this.unit]>this.currentValue-10&&this.activeEvents.push(event);for(this.song.activeEvents={},i=this.activeEvents.length-1;i>=0;i--)event=this.activeEvents[i],this.song.activeEvents[event.id]=event}if(-1!==this.type.indexOf("notes")||-1!==this.type.indexOf("all")){for(i=this.noteIndex;i<this.numNotes&&(note=this.notes[i],note.noteOn[this.unit]<=this.currentValue);i++)collectedNotes.push(note),this.noteIndex++;for(i=this.activeNotes.length-1;i>=0;i--)note=this.activeNotes[i],0!==note.noteOn.state.indexOf("removed")&&void 0!==this.song.notesById[note.id]&&(void 0!==note.noteOff?note.noteOn[this.unit]<=this.currentValue&&note.noteOff[this.unit]>this.currentValue&&stillActiveNotes.push(note):sequencer.debug&&console.warn("note with id",note.id,"has no noteOff event",note.noteOn.track.name));for(this.activeNotes=[].concat(stillActiveNotes),i=collectedNotes.length-1;i>=0;i--)note=collectedNotes[i],void 0!==note.noteOff?note.noteOff[this.unit]>this.currentValue&&this.activeNotes.push(note):sequencer.debug&&console.warn("note with id",note.id,"has no noteOff event",note.noteOn.track.name);for(this.song.activeNotes={},i=this.activeNotes.length-1;i>=0;i--)note=this.activeNotes[i],this.song.activeNotes[note.id]=note}if(-1!==this.type.indexOf("parts")||-1!==this.type.indexOf("all")){for(i=this.partIndex;i<this.numParts&&(part=this.parts[i],part.start[this.unit]<=this.currentValue);i++)collectedParts.push(part),this.partIndex++;for(i=this.activeParts.length-1;i>=0;i--)part=this.activeParts[i],part.start[this.unit]<=this.currentValue&&part.end[this.unit]>this.currentValue&&newParts.push(part);for(this.activeParts=[].concat(newParts),i=collectedParts.length-1;i>=0;i--)part=collectedParts[i],part.end[this.unit]>this.currentValue&&this.activeParts.push(part);for(this.song.activeParts={},i=this.activeParts.length-1;i>=0;i--)part=this.activeParts[i],this.song.activeParts[part.id]=part}!0===this.busy&&(this.busy=!1)},sequencer.protectedScope.createPlayhead=function(song,type,name,data){return new Playhead(song,type,name,data)},sequencer.protectedScope.addInitMethod(function(){getPosition2=sequencer.protectedScope.getPosition2,objectForEach=sequencer.protectedScope.objectForEach,debug=sequencer.debug})}(),function(){"use strict";function getTimeEvent(song,unit,target){var i,event,timeEvents=song.timeEvents;for(i=timeEvents.length-1;i>=0;i--)if(event=timeEvents[i],event[unit]<=target)return index=i,event}function getPosition2(song,unit,target,type,event){return"millis"===unit?fromMillis(song,target,event):"ticks"===unit&&fromTicks(song,target,event),"all"===type&&calculateBarsAndBeats(),getPositionData(song)}var round,floor,typeString,bpm,nominator,denominator,ticksPerBeat,ticksPerBar,ticksPerSixteenth,millisPerTick,secondsPerTick,numSixteenth,ticks,millis,diffTicks,diffMillis,bar,beat,sixteenth,tick,type,index,millisToTicks,ticksToMillis,barsToMillis,barsToTicks,ticksToBars,millisToBars,checkBarsAndBeats,getDataFromEvent,getPositionData,calculateBarsAndBeats,getPosition,checkPosition,fromMillis,fromTicks,fromBars,sequencer=window.sequencer,console=window.console,supportedTypes="barsandbeats barsbeats time millis ticks perc percentage",supportedReturnTypes="barsandbeats barsbeats time millis ticks all",returnType="all",beyondEndOfSong=!0;millisToTicks=function(song,targetMillis,beos){return beyondEndOfSong=void 0===beos,fromMillis(song,targetMillis),ticks},ticksToMillis=function(song,targetTicks,beos){return beyondEndOfSong=void 0===beos,fromTicks(song,targetTicks),millis},barsToMillis=function(song,position,beos){return position=["barsbeats"].concat(position),getPosition(song,position,"millis",beos),millis},barsToTicks=function(song,position,beos){return position=["barsbeats"].concat(position),getPosition(song,position,"ticks",beos),ticks},ticksToBars=function(song,ticks,beos){return beyondEndOfSong=void 0===beos,fromTicks(song,ticks),calculateBarsAndBeats(),returnType="barsandbeats",getPositionData()},millisToBars=function(song,millis,beos){return beyondEndOfSong=void 0===beos,fromMillis(song,millis),calculateBarsAndBeats(),returnType="barsandbeats",getPositionData()},fromMillis=function(song,targetMillis,event){var lastEvent=song.lastEvent;return!1===beyondEndOfSong&&targetMillis>lastEvent.millis&&(targetMillis=lastEvent.millis),void 0===event&&(event=getTimeEvent(song,"millis",targetMillis)),getDataFromEvent(event),event.millis===targetMillis?(diffMillis=0,diffTicks=0):(diffMillis=targetMillis-event.millis,diffTicks=diffMillis/millisPerTick),millis+=diffMillis,ticks+=diffTicks},fromTicks=function(song,targetTicks,event){var lastEvent=song.lastEvent;return!1===beyondEndOfSong&&targetTicks>lastEvent.ticks&&(targetTicks=lastEvent.ticks),void 0===event&&(event=getTimeEvent(song,"ticks",targetTicks)),getDataFromEvent(event),event.ticks===targetTicks?(diffTicks=0,diffMillis=0):(diffTicks=targetTicks-ticks,diffMillis=diffTicks*millisPerTick),ticks+=diffTicks,millis+=diffMillis},fromBars=function(song,targetBar,targetBeat,targetSixteenth,targetTick,event){var diffBars,diffBeats,diffSixteenth,diffTick,i=0,lastEvent=song.lastEvent;for(!1===beyondEndOfSong&&targetBar>lastEvent.bar&&(targetBar=lastEvent.bar),targetBar=checkBarsAndBeats(targetBar),targetBeat=checkBarsAndBeats(targetBeat),targetSixteenth=checkBarsAndBeats(targetSixteenth),targetTick=checkBarsAndBeats(targetTick,!0),void 0===event&&(event=getTimeEvent(song,"bar",targetBar)),getDataFromEvent(event);targetTick>=ticksPerSixteenth;)targetSixteenth++,targetTick-=ticksPerSixteenth;for(;targetSixteenth>numSixteenth;)targetBeat++,targetSixteenth-=numSixteenth;for(;targetBeat>nominator;)targetBar++,targetBeat-=nominator;for(event=getTimeEvent(song,"bar",targetBar),i=index;i>=0;i--)if(event=song.timeEvents[i],event.bar<=targetBar){getDataFromEvent(event);break}diffTick=targetTick-tick,diffSixteenth=targetSixteenth-sixteenth,diffBeats=targetBeat-beat,diffBars=targetBar-bar,diffMillis=diffBars*ticksPerBar*millisPerTick,diffMillis+=diffBeats*ticksPerBeat*millisPerTick,diffMillis+=diffSixteenth*ticksPerSixteenth*millisPerTick,diffMillis+=diffTick*millisPerTick,diffTicks=diffMillis/millisPerTick,bar=targetBar,beat=targetBeat,sixteenth=targetSixteenth,tick=targetTick,millis+=diffMillis,ticks+=diffTicks},calculateBarsAndBeats=function(){for(var tmp=round(diffTicks);tmp>=ticksPerSixteenth;)for(sixteenth++,tmp-=ticksPerSixteenth;sixteenth>numSixteenth;)for(sixteenth-=numSixteenth,beat++;beat>nominator;)beat-=nominator,bar++;tick=round(tmp)},getDataFromEvent=function(event){bpm=event.bpm,nominator=event.nominator,denominator=event.denominator,ticksPerBar=event.ticksPerBar,ticksPerBeat=event.ticksPerBeat,ticksPerSixteenth=event.ticksPerSixteenth,numSixteenth=event.numSixteenth,millisPerTick=event.millisPerTick,secondsPerTick=event.secondsPerTick,bar=event.bar,beat=event.beat,sixteenth=event.sixteenth,tick=event.tick,ticks=event.ticks,millis=event.millis},getPositionData=function(song){var timeData,tickAsString,positionData={};switch(returnType){case"millis":positionData.millis=round(1e3*millis)/1e3,positionData.millisRounded=round(millis);break;case"ticks":positionData.ticks=round(ticks);break;case"barsbeats":case"barsandbeats":positionData.bar=bar,positionData.beat=beat,positionData.sixteenth=sixteenth,positionData.tick=tick,tickAsString=0===tick?"000":tick<10?"00"+tick:tick<100?"0"+tick:tick,positionData.barsAsString=bar+":"+beat+":"+sixteenth+":"+tickAsString;break;case"time":timeData=sequencer.getNiceTime(millis),positionData.hour=timeData.hour,positionData.minute=timeData.minute,positionData.second=timeData.second,positionData.millisecond=timeData.millisecond,positionData.timeAsString=timeData.timeAsString;break;case"all":positionData.millis=round(1e3*millis)/1e3,positionData.millisRounded=round(millis),positionData.ticks=round(ticks),positionData.bar=bar,positionData.beat=beat,positionData.sixteenth=sixteenth,positionData.tick=tick,tickAsString=0===tick?"000":tick<10?"00"+tick:tick<100?"0"+tick:tick,positionData.barsAsString=bar+":"+beat+":"+sixteenth+":"+tickAsString,timeData=sequencer.getNiceTime(millis),positionData.hour=timeData.hour,positionData.minute=timeData.minute,positionData.second=timeData.second,positionData.millisecond=timeData.millisecond,positionData.timeAsString=timeData.timeAsString,positionData.bpm=round(bpm*song.playbackSpeed,3),positionData.nominator=nominator,positionData.denominator=denominator,positionData.ticksPerBar=ticksPerBar,positionData.ticksPerBeat=ticksPerBeat,positionData.ticksPerSixteenth=ticksPerSixteenth,positionData.numSixteenth=numSixteenth,positionData.millisPerTick=millisPerTick,positionData.secondsPerTick=secondsPerTick,positionData.percentage=ticks/song.durationTicks}return positionData},checkBarsAndBeats=function(value,isTick){return value=isNaN(value)?isTick?0:1:value,value=round(value),value=isTick?value<0?0:value:value<1?1:value},checkPosition=function(args){if(returnType="all",beyondEndOfSong=!0,"array"===typeString(args)){var position,i,a,positionLength,numArgs=args.length;if(type=args[0],"array"===typeString(args[0])&&(args=args[0],type=args[0],numArgs=args.length),position=[type],-1!==supportedTypes.indexOf(type)){for(i=1;i<numArgs;i++)if(!0===(a=args[i])||!1===a)beyondEndOfSong=a;else if(isNaN(a)){if(-1===supportedReturnTypes.indexOf(a))return!1;returnType=a}else position.push(a);return(2===(positionLength=position.length)||3===positionLength||5===positionLength)&&position}}return!1},getPosition=function(song,args){var millis,tmp,snap,position=checkPosition(args);if(!1===position)return console.error("wrong position data"),!1;switch(type){case"barsbeats":case"barsandbeats":return fromBars(song,position[1],position[2],position[3],position[4]),getPositionData(song);case"time":return millis=0,tmp=position[1]||0,millis+=60*tmp*60*1e3,tmp=position[2]||0,millis+=60*tmp*1e3,tmp=position[3]||0,millis+=1e3*tmp,tmp=position[4]||0,millis+=tmp,fromMillis(song,millis),calculateBarsAndBeats(),getPositionData(song);case"millis":return fromMillis(song,position[1]),calculateBarsAndBeats(),getPositionData(song);case"ticks":return fromTicks(song,position[1]),calculateBarsAndBeats(),getPositionData(song);case"perc":case"percentage":return snap=position[2],ticks=position[1]*song.durationTicks,void 0!==snap&&(ticks=floor(ticks/snap)*snap),fromTicks(song,ticks),calculateBarsAndBeats(),tmp=getPositionData(song)}return!1},sequencer.protectedScope.getPosition=getPosition,sequencer.protectedScope.getPosition2=getPosition2,sequencer.protectedScope.checkPosition=checkPosition,sequencer.protectedScope.millisToTicks=millisToTicks,sequencer.protectedScope.ticksToMillis=ticksToMillis,sequencer.protectedScope.ticksToBars=ticksToBars,sequencer.protectedScope.millisToBars=millisToBars,sequencer.protectedScope.barsToTicks=barsToTicks,sequencer.protectedScope.barsToMillis=barsToMillis,sequencer.protectedScope.addInitMethod(function(){round=sequencer.protectedScope.round,floor=sequencer.protectedScope.floor,typeString=sequencer.protectedScope.typeString})}(),function(){"use strict";var context,timedTasks,legacy,typeString,getSampleId,createPanner,getEqualPowerCurve,stopSample,fadeOut,SampleSynth,SampleRelease,SampleSustainRelease,SampleReleasePanning,SampleSustainReleasePanning,sequencer=window.sequencer,console=window.console,Sample=function(config){this.id=getSampleId(),this.output=context.createGainNode(),this.output.connect(config.track.input),this.buffer=config.buffer,this.buffer&&(this.duration=this.buffer.duration),this.noteNumber=config.noteNumber,this.stopCallback=function(){},this.track=config.track};stopSample=function(sample,time){sample.source.onended=function(){sample.stopCallback(sample)},time=time||0;try{sample.source.stop(time)}catch(e){console.log(e)}},fadeOut=function(sample){var values,i,maxi,now=context.currentTime;if(sample.release_duration>0)try{switch(sample.releaseEnvelope){case"linear":sample.output.gain.linearRampToValueAtTime(sample.volume,now),sample.output.gain.linearRampToValueAtTime(0,now+sample.releaseDuration);break;case"equal power":values=getEqualPowerCurve(100,"fadeOut",sample.volume),sample.output.gain.setValueCurveAtTime(values,now,sample.releaseDuration);break;case"array":for(maxi=sample.releaseEnvelopeArray.length,values=new Float32Array(maxi),i=0;i<maxi;i++)values[i]=sample.releaseEnvelopeArray[i]*sample.volume;sample.output.gain.setValueCurveAtTime(values,now,sample.releaseDuration)}}catch(e){console.error(sample.id,e)}},Sample.prototype.addData=function(obj){this.sourceId=obj.sourceId,this.noteName=obj.noteName,this.midiNote=obj.midiNote},Sample.prototype.createSource=function(){this.source=context.createBufferSource(),this.source.buffer=this.buffer},Sample.prototype.route=function(){this.source.connect(this.output)},Sample.prototype.start=function(event){if(void 0!==this.source)return void console.error("this should never happen");this.volume=event.velocity/127,this.output.gain.value=this.volume,this.createSource(),this.phase="decay",this.route(),!0===legacy&&(this.source.start=this.source.noteOn,this.source.stop=this.source.noteOff);try{this.source.start(event.time,event.offset||0,event.duration||this.duration)}catch(e){console.warn(e)}},Sample.prototype.stop=function(seconds,cb){if(void 0===this.source)return void(sequencer.debug&&console.log("Sample.stop() source is undefined"));0!==seconds&&void 0!==seconds||(seconds=sequencer.getTime()),this.stopCallback=cb||function(){},this.release?(this.source.loop=!1,this.startReleasePhase=seconds,this.stopTime=seconds+this.releaseDuration):stopSample(this,seconds)},Sample.prototype.unschedule=function(when,cb){var now=context.currentTime,sample=this,fadeOut=null===when?100:when;this.source.onended=void 0;try{this.output.gain.cancelScheduledValues(0),this.output.gain.linearRampToValueAtTime(0,now+fadeOut/1e3),timedTasks["unschedule_"+this.id]={time:now+fadeOut/1e3,execute:function(){if(!sample)return void console.log("sample is gone");sample.panner&&sample.panner.node.disconnect(0),void 0!==sample.source&&(sample.source.disconnect(0),sample.source=void 0),cb&&cb(sample)}}}catch(e){console.log(e)}},Sample.prototype.update=function(value){var doLog="Sonata # 3"===this.track.name&&this.track.song.bar>=6&&this.track.song.bar<=10;this.autopan&&this.panner.setPosition(value),void 0!==this.startReleasePhase&&context.currentTime>=this.startReleasePhase&&"decay"===this.phase?(!0===doLog&&console.log(this.phase,"-> release",this.releaseDuration),this.phase="release",fadeOut(this)):void 0!==this.stopTime&&context.currentTime>=this.stopTime&&"release"===this.phase&&(!0===doLog&&console.log(this.phase,"-> stopped",this.stopTime,context.currentTime),this.phase="stopped",stopSample(this))},sequencer.createSample=function(config){return config.oscillator?new SampleSynth(config):config.sustain&&config.release&&config.panning?new SampleSustainReleasePanning(config):config.release&&config.panning?new SampleReleasePanning(config):config.release&&config.sustain?new SampleSustainRelease(config):config.release?new SampleRelease(config):new Sample(config)},sequencer.protectedScope.addInitMethod(function(){var createClass=sequencer.protectedScope.createClass;context=sequencer.protectedScope.context,timedTasks=sequencer.protectedScope.timedTasks,getEqualPowerCurve=sequencer.util.getEqualPowerCurve,legacy=sequencer.legacy,getSampleId=sequencer.protectedScope.getSampleId,typeString=sequencer.protectedScope.typeString,createPanner=sequencer.createPanner,SampleRelease=createClass(Sample,function(config){this.release=!0,this.releaseDuration=config.release_duration/1e3,this.releaseEnvelope=config.release_envelope}),SampleSustainRelease=createClass(Sample,function(config){this.release=!0,this.sustainStart=config.sustain_start/1e3,this.sustainEnd=config.sustain_end/1e3,this.releaseDuration=config.release_duration/1e3,this.releaseEnvelope=config.release_envelope,void 0===this.releaseEnvelope?this.releaseEnvelope="equal power":"array"===typeString(this.releaseEnvelope)&&(this.releaseEnvelopeArray=config.release_envelope_array,this.releaseEnvelope="array")}),SampleSustainRelease.prototype.route=function(){this.source.loop=!0,this.source.loopStart=this.sustainStart,this.source.loopEnd=this.sustainEnd,this.source.connect(this.output)},SampleReleasePanning=createClass(Sample,function(config){this.release=!0,this.releaseDuration=config.release_duration/1e3,this.releaseEnvelope=config.release_envelope,void 0===this.releaseEnvelope?this.releaseEnvelope="equal power":"array"===typeString(this.releaseEnvelope)&&(this.releaseEnvelopeArray=config.release_envelope_array,this.releaseEnvelope="array"),this.panPosition=config.panPosition}),SampleReleasePanning.prototype.route=function(){this.panner=createPanner(),this.panner.setPosition(this.panPosition||0),this.source.connect(this.panner.node),this.panner.node.connect(this.output)},SampleSustainReleasePanning=createClass(Sample,function(config){this.release=!0,this.sustainStart=config.sustain_start/1e3,this.sustainEnd=config.sustain_end/1e3,this.releaseDuration=config.release_duration/1e3,this.releaseEnvelope=config.release_envelope,void 0===this.releaseEnvelope?this.releaseEnvelope="equal power":"array"===typeString(this.releaseEnvelope)&&(this.releaseEnvelopeArray=config.release_envelope_array,this.releaseEnvelope="array"),this.panPosition=config.panPosition}),SampleSustainReleasePanning.prototype.route=function(){this.source.loop=!0,this.source.loopStart=this.sustainStart,this.source.loopEnd=this.sustainEnd,this.panner=createPanner(),this.panner.setPosition(this.panPosition||0),this.source.connect(this.panner.node),this.panner.node.connect(this.output)},SampleSynth=createClass(Sample,function(config){this.release=!0,this.panPosition=0,this.autopan=config.autopan||!1,this.frequency=config.event.frequency,this.waveForm=config.wave_form||0,this.releaseDuration=config.release_duration/1e3||1.5,this.releaseEnvelope=config.release_envelope||"equal power"}),SampleSynth.prototype.createSource=function(){this.source=context.createOscillator(),this.source.type=this.waveForm,this.source.frequency.value=this.frequency},SampleSynth.prototype.route=function(){this.volume*=.3,this.output.gain.value=this.volume,this.autopan?(this.panner=createPanner(),this.panner.setPosition(0),this.source.connect(this.panner.node),this.panner.node.connect(this.output)):this.source.connect(this.output)}})}(),function(){"use strict";function parse(samplepack,config){var i,url,path,name,ext,slash,dot,data,remotePath,sampleData,extension,mapping=config.mapping;samplepack.samples=[],samplepack.samplesById={},remotePath=config.remote_path,remotePath=void 0!==remotePath&&remotePath;for(i in mapping)mapping.hasOwnProperty(i)&&(sampleData={id:i,folder:samplepack.folder+"/"+samplepack.name},!1!==remotePath?(url=mapping[i],0===url.indexOf("http://")||0===url.indexOf("https://")?sampleData.url=url:(name=url,slash=url.lastIndexOf("/"),-1!==slash&&(name=url.substring(slash+1)),path=url.substring(0,slash),dot=url.lastIndexOf("."),extension=config.extension,-1!==dot&&(ext=url.substring(dot+1),ext.length>=3&&ext.length<=4&&(extension=ext,name=url.substring(slash,dot))),url=remotePath+"/"+path+"/"+name+"."+extension,url=url.replace(/\/{2,}/g,"/"),url=url.replace(/^\//,""),url=url.replace(/$\//,""),sampleData.url=url)):(data=mapping[i],void 0!==data.d?(sampleData.base64=mapping[i].d,void 0!==data.s&&(sampleData.sustain=data.s),void 0!==data.r&&(sampleData.release=data.r)):sampleData.base64=mapping[i],samplepack.samplesById[i]=sampleData),samplepack.samples.push(sampleData))}function loadLoop(pack,callback){loadSamples(pack.samples,function(buffer){},function(){pack.loaded=!0,pack.parseTime=parseTime,sequencer.debug>=2&&console.info("parsing",pack.name,"took",1e3*parseTime,"ms"),callback&&callback(!0)})}function cleanup(samplepack,callback){samplepack.reset(),samplepack=void 0,callback(!1)}function store(samplepack){var i,samples,sample,occupied=findItem(samplepack.localPath,sequencer.storage.samplepacks,!0),action=samplepack.action;if(occupied&&"SamplePack"===occupied.className)if("overwrite"===action)for(samples=occupied.samples,i=samples.length-1;i>=0;i--)sample=samples[i],deleteItem(sample.name+"/"+sample.folder,sequencer.storage.audio);else{if("append"!==action)return sequencer.debug>=2&&console.warn("there is already a samplepack at",samplepack.localPath),!1;for(samples=occupied.samples,i=samples.length-1;i>=0;i--)samplepack.samples.push(samples[i])}return storeItem(samplepack,samplepack.localPath,sequencer.storage.samplepacks),!0}function load(pack,callback){!0!==pack.hasMapping?ajax({url:pack.url,responseType:"json",onError:function(){cleanup(pack,callback)},onSuccess:function(data){return null===data?void callback(!1):void 0===data.mapping?(sequencer.debug>=2&&console.warn("can't create a SamplePack with this data",data),void cleanup(pack,callback)):(void 0!==data.name&&void 0===pack.name&&(pack.name=data.name),void 0!==data.folder&&void 0===pack.folder&&(pack.folder=data.folder),void 0===pack.name&&(pack.name=parseUrl(pack.url).name),pack.action=data.action,pack.localPath=void 0!==pack.folder?pack.folder+"/"+pack.name:pack.name,void(!0===store(pack)?(parse(pack,data),loadLoop(pack,callback)):callback(!1)))}}):!0===store(pack)?loadLoop(pack,callback):callback(!1)}function loadSamples(samples,callback1,callback2){function loaded(buffer){storeItem(buffer,folder+"/"+sampleId,storage.audio),callback1&&callback1(buffer),i++,i<numSamples?(sample=samples[i],loadSample(sample,loaded)):callback2()}var i=0,numSamples=samples.length,sample=samples[i];loadSample(sample,loaded)}function loadSample(data,callback){var sample,url=data.url,base64=data.base64;sampleId=data.id,folder=data.folder,sample=findItem(folder+"/"+sampleId,storage.audio,!0),
!1!==sample?callback(sample):base64?("TWAAAP"!==base64?(sample=base64ToBinary(base64),parseAudioData(sample,callback)):callback(sample),data.base64=""):url?ajax({url:url,responseType:"arraybuffer",onError:function(){callback()},onSuccess:function(buffer){parseAudioData(buffer,callback)}}):console.error("could not load sample",folder+"/"+sampleId)}function parseAudioData(audiodata,callback){var ts=sequencer.getTime();if(null!==audiodata)try{context.decodeAudioData(audiodata,function(buffer){parseTime+=sequencer.getTime()-ts,callback(buffer)},function(e){console.log("error decoding audiodata",sampleId,e),callback()})}catch(e){console.log(sampleId,e),callback()}}var ajax,findItem,storeItem,deleteItem,typeString,parseUrl,base64ToBinary,context,storage,parseTime,folder,sampleId,SamplePack,sequencer=window.sequencer,console=window.console,index=0;SamplePack=function(config){this.id="SP"+index+++(new Date).getTime(),this.className="SamplePack",this.loaded=!1,this.loadTime=0,this.parseTime=parseTime=0,this.url=config.url,this.name=config.name,this.folder=config.folder,this.info=config.info||config.samplepack_info,this.author=config.author||config.samplepack_author,this.license=config.license||config.samplepack_license,this.compression=config.compression||config.samplepack_compression,void 0===this.compression&&void 0!==config.compression_type&&(this.compression=config.compression_type+" "+config.compression_level),this.pack=config.pack,this.filesize=config.filesize,void 0===this.filesize&&void 0!==this.pack&&(this.filesize=this.pack.filesize),config.mapping?(void 0===this.name&&void 0===this.folder?(this.name=this.id,this.localPath=this.id):this.localPath=void 0!==this.folder?this.folder+"/"+this.name:this.name,this.hasMapping=!0,this.action=config.action,parse(this,config)):config.url&&(this.url=config.url)},SamplePack.prototype.reset=function(){this.samples=[]},sequencer.addSamplePack=function(config,callback,callbackAfterAllTasksAreDone){var samplepack,json,name,folder,type=typeString(config);if(callbackAfterAllTasksAreDone=void 0!==callbackAfterAllTasksAreDone&&callbackAfterAllTasksAreDone,"object"!==type)return sequencer.debug>=2&&console.warn("can't create a SamplePack with this data",config),!1;if(config.json){if(json=config.json,name=config.name,folder=config.folder,"string"===typeString(json))try{json=JSON.parse(json)}catch(e){return sequencer.debug>=2&&console.warn("can't create a SamplePack with this data",config),!1}if(void 0===json.mapping)return sequencer.debug>=2&&console.warn("can't create a SamplePack with this data",config),!1;config={mapping:json.mapping,name:void 0===name?json.name:name,folder:void 0===folder?json.folder:folder}}samplepack=new SamplePack(config),sequencer.addTask({type:"load sample pack",method:load,params:samplepack},function(value){callback&&(!1===value?(samplepack=null,callback(null)):callback(samplepack))},callbackAfterAllTasksAreDone),sequencer.startTaskQueue()},sequencer.protectedScope.addInitMethod(function(){storage=sequencer.storage,ajax=sequencer.protectedScope.ajax,context=sequencer.protectedScope.context,findItem=sequencer.protectedScope.findItem,parseUrl=sequencer.protectedScope.parseUrl,storeItem=sequencer.protectedScope.storeItem,deleteItem=sequencer.protectedScope.deleteItem,typeString=sequencer.protectedScope.typeString,base64ToBinary=sequencer.protectedScope.base64ToBinary})}(),function(){"use strict";function loop(data,i,maxi,events){var arg;for(i=0;i<maxi;i++)void 0!==(arg=data[i])&&("MidiEvent"===arg.className?events.push(arg):"MidiNote"===arg.className?events.push(arg.noteOn):"array"===typeString(arg)&&loop(arg,0,arg.length))}var typeString,objectForEach,Scheduler,sequencer=window.sequencer;window.console;Scheduler=function(song){this.song=song,this.looped=!1,this.notes={},this.audioEvents={}},Scheduler.prototype.updateSong=function(){this.events=this.song.eventsMidiAudioMetronome,this.numEvents=this.events.length,this.index=0,this.maxtime=0,this.notes={},this.audioEvents=this.song.audioEvents,this.numAudioEvents=this.audioEvents.length,this.scheduledAudioEvents={},this.looped=!1,this.setIndex(this.song.millis)},Scheduler.prototype.setIndex=function(millis){var i;for(i=0;i<this.numEvents;i++)if(this.events[i].millis>=millis){this.index=i;break}this.beyondLoop=!1,millis>this.song.loopEnd&&(this.beyondLoop=!0),this.scheduledAudioEvents={}},Scheduler.prototype.getDanglingAudioEvents=function(millis,events){var i,event,num=0;for(i=0;i<this.numAudioEvents;i++)event=this.audioEvents[i],event.millis<millis&&event.endMillis>millis?(event.playheadOffset=millis-event.millis,event.time=this.startTime+event.millis-this.songStartMillis+event.playheadOffset,event.playheadOffset/=1e3,this.scheduledAudioEvents[event.id]=event,events.push(event),num++):event.playheadOffset=0;return events},Scheduler.prototype.getEvents=function(){var i,event,note,noteOn,noteOff,endMillis,endTicks,diff,buffertime,audioEvent,events=[];if(buffertime=1e3*sequencer.bufferTime,!0===this.song.doLoop&&this.song.loopDuration<buffertime&&(this.maxtime=this.songMillis+this.song.loopDuration-1),!0===this.song.doLoop)if(this.maxtime>=this.song.loopEnd&&!1===this.beyondLoop){if(diff=this.maxtime-this.song.loopEnd,this.maxtime=this.song.loopStart+diff,!1===this.looped){for(this.looped=!0,i=this.index;i<this.numEvents&&(event=this.events[i],event.millis<this.song.loopEnd);i++)event.time=this.startTime+event.millis-this.songStartMillis,events.push(event),this.index++;endTicks=this.song.loopEndTicks-1,endMillis=this.song.getPosition("ticks",endTicks).millis;for(i in this.notes)if(this.notes.hasOwnProperty(i)){if(note=this.notes[i],noteOn=note.noteOn,noteOff=note.noteOff,noteOff.millis<=this.song.loopEnd)continue;event=sequencer.createMidiEvent(endTicks,128,noteOn.data1,0),event.millis=endMillis,event.part=noteOn.part,event.track=noteOn.track,event.midiNote=noteOn.midiNote,event.time=this.startTime+event.millis-this.songStartMillis,events.push(event)}for(i in this.scheduledAudioEvents)this.scheduledAudioEvents.hasOwnProperty(i)&&(audioEvent=this.scheduledAudioEvents[i],audioEvent.endMillis>this.song.loopEnd&&(audioEvent.stopSample(this.song.loopEnd/1e3),delete this.scheduledAudioEvents[i]));this.notes={},this.setIndex(this.song.loopStart),this.song.startTime+=this.song.loopDuration,this.startTime=this.song.startTime,this.getDanglingAudioEvents(this.song.loopStart,events)}}else this.looped=!1;for(!0===this.firstRun&&(this.getDanglingAudioEvents(this.song.millis,events),this.firstRun=!1),i=this.index;i<this.numEvents&&(event=this.events[i],event.millis<this.maxtime);i++)event.time=this.startTime+event.millis-this.songStartMillis,144===event.type||128===event.type?void 0!==event.midiNote&&void 0!==event.midiNote.noteOff&&(144===event.type?this.notes[event.midiNote.id]=event.midiNote:128===event.type&&delete this.notes[event.midiNote.id],events.push(event)):"audio"===event.type?(void 0!==this.scheduledAudioEvents[event.id]&&(audioEvent=this.scheduledAudioEvents[event.id],void 0!==audioEvent.sample&&void 0!==audioEvent.sample.source&&audioEvent.stopSample(0)),this.scheduledAudioEvents[event.id]=event,event.time=event.time+1e3*event.playheadOffset,events.push(event)):events.push(event),this.index++;return events},Scheduler.prototype.update=function(){var i,event,numEvents,events,track,channel;for(this.prevMaxtime=this.maxtime,!0===this.song.precounting?(this.songMillis=this.song.metronome.millis,this.maxtime=this.songMillis+1e3*sequencer.bufferTime,events=[].concat(this.song.metronome.getPrecountEvents(this.maxtime)),this.maxtime>this.song.metronome.endMillis&&(this.songMillis=0,this.maxtime=this.song.millis+1e3*sequencer.bufferTime,this.startTime=this.song.startTime,this.startTime2=this.song.startTime2,this.songStartMillis=this.song.startMillis,events=this.getEvents())):(this.songMillis=this.song.millis,this.maxtime=this.songMillis+1e3*sequencer.bufferTime,this.startTime=this.song.startTime,this.startTime2=this.song.startTime2,this.songStartMillis=this.song.startMillis,events=this.getEvents()),numEvents=events.length,i=0;i<numEvents;i++)event=events[i],void 0===(track=event.track)||!0===event.mute||!0===event.part.mute||!0===event.track.mute||"metronome"===event.track.type&&!1===this.song.useMetronome||(event.time+=track.audioLatency,"audio"===event.type?(event.time/=1e3,track.audio.processEvent(event)):!1===track.routeToMidiOut?(event.time/=1e3,track.instrument.processEvent(event)):(channel=track.channel,"any"!==channel&&void 0!==channel&&!0!==isNaN(channel)||(channel=0),objectForEach(track.midiOutputs,function(midiOutput){128===event.type||144===event.type||176===event.type?midiOutput.send([event.type+channel,event.data1,event.data2],event.time):192!==event.type&&224!==event.type||midiOutput.send([event.type+channel,event.data1],event.time)}),this.lastEventTime=event.time))},Scheduler.prototype.unschedule=function(){var i,e,track,instrument,args=Array.prototype.slice.call(arguments),events=[];for(loop(args,0,args.length,events),i=events.length-1;i>=0;i--)e=events[i],track=e.track,(instrument=track.instrument)&&instrument.unscheduleEvent(e)},Scheduler.prototype.reschedule=function(){var i,track,numTracks=this.song.numTracks,tracks=this.song.tracks;for(i=0;i<numTracks;i++)track=tracks[i],track.instrument.reschedule(this.song)},sequencer.protectedScope.addInitMethod(function(){typeString=sequencer.protectedScope.typeString,objectForEach=sequencer.protectedScope.objectForEach}),sequencer.protectedScope.createScheduler=function(song){return new Scheduler(song)}}(),function(){"use strict";function addSong(song){activeSongs[song.id]=song}function removeProperties(obj){var i;for(i in obj)obj.hasOwnProperty(i)&&(obj[i]=null)}var typeString,isEmptyObject,objectToArray,objectForEach,createMidiEvent,context,timedTasks,scheduledTasks,repetitiveTasks,masterGainNode,parseTimeEvents,heartbeat,lastTimeStamp,events,sequencer=window.sequencer,console=window.console,slice=Array.prototype.slice,r=0,processEventTracks={},pausedSongs=[],activeSongs={},snapshots={};sequencer.getSongs=function(){return activeSongs},sequencer.deleteSong=function(song){if(void 0!==song&&null!==song&&"Song"===song.className){song.stop(),song.disconnect(masterGainNode),delete activeSongs[song.id];var i,track,j,part,k,note,event;for(i=song.eventsMidiAudioMetronome.length-1;i>=0;i--)event=song.eventsMidiAudioMetronome[i],removeProperties(event);for(i=song.timeEvents.length-1;i>=0;i--)event=song.timeEvents[i];for(i=song.numTracks-1;i>=0;i--){for(track=song.tracks[i],void 0!==track.audio&&track.audio.recorder.cleanup(),j=track.numParts-1;j>=0;j--){for(part=track.parts[j],k=part.numNotes-1;k>=0;k--)note=part.notes[k],removeProperties(note);removeProperties(part),part=null}removeProperties(track),track=null}return removeProperties(song),song=null,null}},sequencer.getSnapshot=function(song,id){if(void 0===song)return void console.error("song is undefined");id=id||song.id;var prevActiveEvents,prevActiveNotes,prevActiveParts,e,n,p,i,snapshot=snapshots[id],activeEvents=song.activeEvents,activeNotes=song.activeNotes,activeParts=song.activeParts,nonActiveEvents=[],nonActiveNotes=[],nonActiveParts=[];if(void 0!==snapshot){for(prevActiveEvents=snapshot.activeEvents,prevActiveNotes=snapshot.activeNotes,prevActiveParts=snapshot.activeParts,i=prevActiveEvents.length-1;i>=0;i--)e=prevActiveEvents[i],void 0===activeEvents[e.id]&&void 0!==song.eventsLib[e.id]&&nonActiveEvents.push(e);for(i=prevActiveNotes.length-1;i>=0;i--)n=prevActiveNotes[i],void 0===activeNotes[n.id]&&void 0!==song.notesLib[n.id]&&nonActiveNotes.push(n);for(i=prevActiveParts.length-1;i>=0;i--)p=prevActiveParts[i],void 0===activeParts[p.id]&&nonActiveParts.push(p)}return snapshot={activeEvents:objectToArray(activeEvents),activeNotes:objectToArray(activeNotes),activeParts:objectToArray(activeParts),nonActiveEvents:nonActiveEvents,nonActiveNotes:nonActiveNotes,nonActiveParts:nonActiveParts},snapshots[id]=snapshot,snapshot},heartbeat=function(timestamp){var i,diff,task,now=sequencer.getTime();for(i in timedTasks)timedTasks.hasOwnProperty(i)&&(task=timedTasks[i],task.time>=now&&(task.execute(),task=null,delete timedTasks[i]));for(i in scheduledTasks)scheduledTasks.hasOwnProperty(i)&&scheduledTasks[i]();for(i in repetitiveTasks)repetitiveTasks.hasOwnProperty(i)&&repetitiveTasks[i]();r>=10?(diff=(timestamp-lastTimeStamp)/1e3,sequencer.diff=diff,diff>sequencer.bufferTime&&!0===sequencer.autoAdjustBufferTime&&(sequencer.debug&&console.log("adjusted buffertime:"+sequencer.bufferTime+" -> "+diff),sequencer.bufferTime=diff)):r++,lastTimeStamp=timestamp,scheduledTasks={},window.requestAnimationFrame(heartbeat)},sequencer.processEvent=sequencer.processEvents=function(){var loop,arg,i,maxi,contextTime,event,midiEvent,type,instrument,part,track,secondsPerTick,args=slice.call(arguments),bpm=60;for(events=[],loop=function(data,i,maxi){for(i=0;i<maxi;i++)arg=data[i],type=typeString(arg),void 0!==arg&&("midimessageevent"===type?(data=arg.data,midiEvent=createMidiEvent(0,data[0],data[1],data[2]),events.push(midiEvent)):"MidiEvent"===arg.className?events.push(arg):"array"===type?loop(arg,0,arg.length):"string"===type?instrument=arg:!1===isNaN(arg)&&(bpm=arg))},loop(args,0,args.length),part=sequencer.createPart(),track=sequencer.createTrack(),track.setInstrument(instrument),void 0===processEventTracks[track.instrumentId]?(processEventTracks[track.instrumentId]=track,track.addPart(part),track.connect(context.destination)):(track=processEventTracks[track.instrumentId],part=track.parts[0]),part.addEvents(events),track.update(),maxi=events.length,contextTime=sequencer.getTime(),secondsPerTick=60/bpm/sequencer.defaultPPQ,i=0;i<maxi;i++)event=events[i],event.time=contextTime+event.ticks*secondsPerTick+.002,track.instrument.processEvent(event)},sequencer.stopProcessEvent=sequencer.stopProcessEvents=function(){objectForEach(processEventTracks,function(track){track.instrument.allNotesOff(),track=void 0}),processEventTracks={}},sequencer.play=function(){var i,arg,loop,song,track,part,bpm,nominator,denominator,instrument,args=slice.call(arguments),events=[],parts=[],tracks=[],songs=[],timeEvents=[],store=!1;for(loop=function(data,i,maxi,indentation){for(i=0;i<maxi;i++)void 0!==(arg=data[i])&&("string"===typeString(arg)?instrument=arg:"Song"===arg.className?(void 0===bpm&&(bpm=arg.bpm,nominator=arg.nominator,denominator=arg.denominator),songs.push(arg)):"Track"===arg.className?(void 0===bpm&&void 0!==(song=arg.song)&&(bpm=song.bpm,nominator=song.nominator,denominator=song.denominator),tracks.push(arg)):"Part"===arg.className?(void 0===bpm&&void 0!==(song=arg.song)&&(bpm=song.bpm,nominator=song.nominator,denominator=song.denominator),parts.push(arg)):"MidiEvent"===arg.className||"AudioEvent"===arg.className?(void 0===bpm&&void 0!==(part=arg.part)&&void 0!==(song=part.song)&&(bpm=song.bpm,nominator=song.nominator,denominator=song.denominator),81===arg.type||88===arg.type?timeEvents.push(arg):events.push(arg)):"array"===typeString(arg)?loop(arg,0,arg.length,"    "):!0===arg||!1===arg?store=arg:0===arg.indexOf("S")&&(song=activeSongs[arg])&&song.play())},loop(args,0,args.length,"  "),i=songs.length-1;i>=0;i--)song=songs[i],tracks=tracks.concat(song.tracks),timeEvents=timeEvents.concat(song.timeEvents);return parts.length>0&&(track=sequencer.createTrack(),track.instrument=instrument,track.addParts(parts),tracks.push(track)),events.length>0&&(track=sequencer.createTrack(),track.instrument=instrument,part=sequencer.createPart(),part.addEvents(events),track.addPart(part),tracks.push(track)),song=sequencer.createSong({bpm:bpm||120,nominator:nominator||4,denominator:denominator||4,timeEvents:timeEvents,tracks:tracks}),addSong(song),song.play(),song},sequencer.setAnimationFrameType=function(type,interval){switch(type=type||"default",type=type.toLowerCase(),interval=interval||15,type){case"settimeout":window.requestAnimationFrame=function(cb){setTimeout(cb,interval)};break;default:window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.requestAnimationFrame}},sequencer.protectedScope.updateInstruments=function(){var i,j,tracks,track,song;for(i in activeSongs)if(activeSongs.hasOwnProperty(i))for(song=activeSongs[i],tracks=song.tracks,j=tracks.length-1;j>=0;j--)track=tracks[j],track.instrument.reset()},sequencer.allNotesOff=function(){objectForEach(activeSongs,function(song){song.allNotesOff()})},window.onblur=function(){!1!==sequencer.pauseOnBlur&&(sequencer.allNotesOff(),pausedSongs=[],objectForEach(activeSongs,function(song){!0===song.playing&&(sequencer.debug&&console.log("pause song",song.id),pausedSongs.push(song),song.pause())}))},window.onfocus=function(){if(!1!==sequencer.pauseOnBlur){var song,millis,i,maxi=pausedSongs.length;for(i=0;i<maxi;i++)song=pausedSongs[i],millis=song.millis,song.stop(),song.setPlayhead("millis",millis),sequencer.restartOnFocus&&song.play();pausedSongs=[]}},sequencer.protectedScope.addSong=addSong,sequencer.protectedScope.addInitMethod(function(){objectToArray=sequencer.protectedScope.objectToArray,isEmptyObject=sequencer.protectedScope.isEmptyObject,isEmptyObject=sequencer.protectedScope.isEmptyObject,objectForEach=sequencer.protectedScope.objectForEach,timedTasks=sequencer.protectedScope.timedTasks,scheduledTasks=sequencer.protectedScope.scheduledTasks,repetitiveTasks=sequencer.protectedScope.repetitiveTasks,typeString=sequencer.protectedScope.typeString,context=sequencer.protectedScope.context,createMidiEvent=sequencer.createMidiEvent,masterGainNode=sequencer.protectedScope.masterGainNode,parseTimeEvents=sequencer.protectedScope.parseTimeEvents,heartbeat()})}(),function(){"use strict";var createMidiEvent,createPlayhead,createFollowEvent,createScheduler,createMetronome,followEvent,masterGainNode,context,timedTasks,repetitiveTasks,initMidi,addMidiEventListener,removeMidiEventListener,setMidiInput,setMidiOutput,getMidiInputs,getMidiOutputs,getMidiPortsAsDropdown,getPosition,millisToTicks,ticksToMillis,ticksToBars,millisToBars,barsToTicks,barsToMillis,addEventListener,removeEventListener,dispatchEvent,update,checkDuration,addMetronomeEvents,gridToSong,noteToGrid,eventToGrid,positionToGrid,typeString,removeFromArray,removeFromArray2,getNoteLengthName,getStats,findEvent,findNote,objectForEach,addSong,_removeTracks,pulse,getArguments,getTrack,addTracks,getPart,getParts,getTimeEvents,setRecordingStatus,_getRecordingPerTrack,createGrid,Song,sequencer=window.sequencer,console=window.console,slice=Array.prototype.slice,songIndex=0;Song=function(config){config=config||{},this.id="S"+songIndex+++(new Date).getTime(),this.name=config.name||this.id,this.className="Song",addSong(this),this.midiInputs={},this.midiOutputs={},initMidi(this),this.bpm=config.bpm||120,this.ppq=config.ppq||sequencer.defaultPPQ,this.bars=config.bars||30,this.lastBar=this.bars,this.lowestNote=config.lowestNote||0,this.highestNote=config.highestNote||127,this.pitchRange=this.highestNote-this.lowestNote+1,this.nominator=config.nominator||4,this.denominator=config.denominator||4,this.factor=4/this.denominator,this.ticksPerBeat=this.ppq*this.factor,this.ticksPerBar=this.ticksPerBeat*this.nominator,this.millisPerTick=6e4/this.bpm/this.ppq,this.quantizeValue=config.quantizeValue||"8",this.fixedLengthValue=config.fixedLengthValue||!1,this.positionType=config.positionType||"all",this.useMetronome=config.useMetronome,this.autoSize=void 0===config.autoSize||!0===config.autoSize,this.playbackSpeed=1,this.defaultInstrument=config.defaultInstrument||sequencer.defaultInstrument,this.recordId=-1,this.autoQuantize=!1,this.loop=config.loop||!1,this.doLoop=!1,this.illegalLoop=!0,this.loopStart=0,this.loopEnd=0,this.loopDuration=0,this.audioRecordingLatency=0,!0!==this.useMetronome&&!1!==this.useMetronome&&(this.useMetronome=!1),this.grid=void 0,config.timeEvents&&config.timeEvents.length>0?(this.timeEvents=[].concat(config.timeEvents),this.tempoEvent=getTimeEvents(sequencer.TEMPO,this)[0],this.timeSignatureEvent=getTimeEvents(sequencer.TIME_SIGNATURE,this)[0],void 0===this.tempoEvent?(this.tempoEvent=createMidiEvent(0,sequencer.TEMPO,this.bpm),this.timeEvents.unshift(this.tempoEvent)):this.bpm=this.tempoEvent.bpm,void 0===this.timeSignatureEvent?(this.timeSignatureEvent=createMidiEvent(0,sequencer.TIME_SIGNATURE,this.nominator,this.denominator),this.timeEvents.unshift(this.timeSignatureEvent)):(this.nominator=this.timeSignatureEvent.nominator,this.denominator=this.timeSignatureEvent.denominator)):(this.tempoEvent=createMidiEvent(0,sequencer.TEMPO,this.bpm),this.timeSignatureEvent=createMidiEvent(0,sequencer.TIME_SIGNATURE,this.nominator,this.denominator),this.timeEvents=[this.tempoEvent,this.timeSignatureEvent]),void 0!==config.timeEvents&&void 0!==config.bpm&&this.bpm!==config.bpm&&this.setTempo(config.bpm,!1),void 0===config.timeEvents||void 0===config.nominator&&void 0===config.denominator||this.nominator===config.nominator&&this.denominator===config.denominator||this.setTimeSignature(config.nominator||this.nominator,config.denominator||this.denominator,!1),this.tracks=[],this.parts=[],this.notes=[],this.events=[],this.allEvents=[],this.tracksById={},this.tracksByName={},this.partsById={},this.notesById={},this.eventsById={},this.activeEvents=null,this.activeNotes=null,this.activeParts=null,this.recordedNotes=[],this.recordedEvents=[],this.recordingNotes={},this.numTracks=0,this.numParts=0,this.numNotes=0,this.numEvents=0,this.instruments=[],this.playing=!1,this.paused=!1,this.stopped=!0,this.recording=!1,this.prerolling=!1,this.precounting=!1,this.preroll=!0,this.precount=0,this.listeners={},this.playhead=createPlayhead(this,this.positionType,this.id,this),this.playheadRecording=createPlayhead(this,"all",this.id+"_recording"),this.scheduler=createScheduler(this),this.followEvent=createFollowEvent(this),this.volume=1,this.gainNode=context.createGainNode(),this.gainNode.gain.value=this.volume,this.metronome=createMetronome(this,dispatchEvent),this.connect(),"MidiFile"===config.className&&!1===config.loaded&&sequencer.debug&&console.warn("midifile",config.name,"has not yet been loaded!"),config.tracks&&this.addTracks(config.tracks),config.parts&&this.addParts(config.parts),config.events&&this.addEvents(config.events),config.events||config.parts||config.tracks?(void 0===config.bars&&(this.lastBar=0),this.lastEvent=createMidiEvent([this.lastBar,sequencer.END_OF_TRACK])):this.lastEvent=createMidiEvent([this.bars*this.ticksPerBar,sequencer.END_OF_TRACK]),this.update(!0),this.numTimeEvents=this.timeEvents.length,this.playhead.set("ticks",0),this.midiEventListeners={}},getPart=function(data,song){var part=!1;return void 0===data?part=!1:"Part"===part.className?part=data:"string"===typeString(data)?part=song.partsById[data]:!1===isNaN(data)&&(part=song.parts[data]),part},getTrack=function(data,song){var track=!1;return void 0===data?track=!1:"Track"===data.className?track=data:"string"===typeString(data)?void 0===(track=song.tracksById[data])&&(track=song.tracksByName[data]):!1===isNaN(data)&&(track=song.tracks[data]),void 0===track&&(track=!1),track},addTracks=function(newTracks,song){var i,track,tracksById=song.tracksById,tracksByName=song.tracksByName,addedIds=[];for(i=newTracks.length-1;i>=0;i--)!1!==(track=getTrack(newTracks[i]))&&(void 0!==track.song&&null!==track.song&&(track=track.copy()),track.song=song,track.instrument.song=song,track.quantizeValue=song.quantizeValue,track.connect(song.gainNode),track.state="new",track.needsUpdate=!0,tracksById[track.id]=track,tracksByName[track.name]=track,addedIds.push(track.id),objectForEach(track.partsById,function(part){part.state="new"}));return addedIds},_removeTracks=function(tobeRemoved){var i,track,removed=[];for(i=tobeRemoved.length-1;i>=0;i--)!1!==(track=getTrack(tobeRemoved[i]))&&(void 0===track.song||track.song===this?(track.state="removed",track.disconnect(this.gainNode),track.reset(),delete this.tracksById[track.id],delete this.tracksByName[track.name],removed.push(track)):console.warn("can't remove: this track belongs to song",track.song.id));return removed},getParts=function(args){var part,i,result=[];for(i=args.length-1;i>=0;i--)(part=getPart(args[i],this))&&result.push(part);return result},getTimeEvents=function(type,song){var events=[];return song.timeEvents.forEach(function(event){event.type===type&&events.push(event)}),events},pulse=function(song){var now=1e3*sequencer.getTime(),diff=now-song.timeStamp,millis=song.millis+diff;if(song.diff=diff,song.timeStamp=now,!0===song.precounting)return song.metronome.millis+=diff,void song.scheduler.update(diff);song.prevMillis=song.millis,song.doLoop&&song.scheduler.looped&&millis>=song.loopEnd?(song.followEvent.resetAllListeners(),song.playhead.set("millis",song.loopStart+(millis-song.loopEnd)),song.followEvent.update(),song.scheduler.update(),dispatchEvent(song,"loop")):millis>=song.durationMillis?(song.playhead.update("millis",song.durationMillis-song.millis),song.followEvent.update(),song.pause(),song.endOfSong=!0,dispatchEvent(song,"end")):(song.playhead.update("millis",diff),song.followEvent.update(),song.scheduler.update()),song.jump=!1},Song.prototype.remove=function(){console.warn("Song.remove() is deprecated, please use sequencer.deleteSong()"),sequencer.deleteSong(this)},Song.prototype.play=function(){sequencer.unlockWebAudio();var song,playstart;if(this.playing)return void this.pause();this.scheduler.firstRun=!0,this.doLoop=!1===this.illegalLoop&&!0===this.loop,this.endOfSong&&(this.followEvent.resetAllListeners(),this.playhead.set("millis",0),this.scheduler.setIndex(0)),this.timeStamp=1e3*sequencer.getTime(),this.startTime=this.timeStamp;try{this.startTime2=window.performance.now()}catch(e){sequencer.debug&&console.log("window.performance.now() not supported")}this.precounting&&(this.metronome.startTime=this.startTime,this.metronome.startTime2=this.startTime2,this.startTime+=this.metronome.precountDurationInMillis,this.startTime2+=this.metronome.precountDurationInMillis,song=this,playstart=this.startTime/1e3,repetitiveTasks.playAfterPrecount=function(){sequencer.getTime()>=playstart&&(song.precounting=!1,song.prerolling=!1,song.recording=!0,song.playing=!0,dispatchEvent(song,"record_start"),dispatchEvent(song,"play"),repetitiveTasks.playAfterPrecount=void 0,delete repetitiveTasks.playAfterPrecount)}),this.startMillis=this.millis,song=this,song.playhead.update("millis",0),song.followEvent.update(),repetitiveTasks[this.id]=function(){pulse(song)},this.paused=!1,this.stopped=!1,this.endOfSong=!1,!0!==this.precounting&&(this.playing=!0,dispatchEvent(this,"play"))},Song.prototype.pause=function(){return!0===this.recording||!0===this.precounting?void this.stop():this.stopped||this.paused?void this.play():(delete repetitiveTasks[this.id],this.allNotesOff(),this.playing=!1,this.paused=!0,void dispatchEvent(this,"pause"))},Song.prototype.stop=function(){if(this.stopped)return this.followEvent.resetAllListeners(),this.playhead.set("millis",0),void this.scheduler.setIndex(0);!0!==this.recording&&!0!==this.precounting||this.stopRecording(),delete repetitiveTasks[this.id],objectForEach(timedTasks,function(task,id){0!==id.indexOf("unschedule_")&&0!==id.indexOf("event_")||(null,delete timedTasks[id])}),this.allNotesOff(),this.playing=!1,this.paused=!1,this.stopped=!0,this.endOfSong=!1,this.followEvent.resetAllListeners(),this.playhead.set("millis",0),this.scheduler.setIndex(0),dispatchEvent(this,"stop")},Song.prototype.adjustLatencyForAllRecordings=function(value){this.audioRecordingLatency=value,this.tracks.forEach(function(track){track.setAudioRecordingLatency(value)})},Song.prototype.setAudioRecordingLatency=function(recordId,value,callback){var i,event,sampleId;for(i=this.audioEvents.length-1;i>=0&&(event=this.audioEvents[i],void 0===(sampleId=event.sampleId)||recordId!==sampleId);i--);event.track.setAudioRecordingLatency(recordId,value,callback)},Song.prototype.startRecording=Song.prototype.record=function(precount){if(!0===this.recording||!0===this.precounting)return void this.stop();var i,track,userFeedback=!1,audioRecording=!1,self=this;for(this.metronome.precountDurationInMillis=0,this.playing?(this.precount=0,this.recordStartMillis=this.millis):void 0===precount?(this.precount=0,this.recordStartMillis=this.millis):(this.setPlayhead("barsbeats",this.bar),this.metronome.createPrecountEvents(precount),this.precount=precount,this.recordStartMillis=this.millis-this.metronome.precountDurationInMillis),this.recordTimestampTicks=this.ticks,this.recordId="REC"+(new Date).getTime(),this.recordedNotes=[],this.recordedEvents=[],this.recordingNotes={},this.recordingAudio=!1,void 0!==this.keyEditor&&this.keyEditor.prepareForRecording(this.recordId),i=this.numTracks-1;i>=0;i--)track=this.tracks[i],"audio"===track.recordEnabled&&(this.recordingAudio=!0),"audio"===track.recordEnabled?(audioRecording=!0,track.prepareForRecording(this.recordId,function(){!1===userFeedback&&(userFeedback=!0,setRecordingStatus.call(self))})):track.prepareForRecording(this.recordId);return!1===audioRecording&&setRecordingStatus.call(this),this.recordId},setRecordingStatus=function(){this.recordTimestamp=1e3*context.currentTime,!1===this.playing?(this.precount>0?(this.precounting=!0,this.prerolling=this.preroll,this.prerolling?dispatchEvent(this,"record_preroll"):dispatchEvent(this,"record_precount")):(this.recording=!0,dispatchEvent(this,"record_start")),this.play()):(this.recording=!0,this.precounting=!1,dispatchEvent(this,"record_start"))},_getRecordingPerTrack=function(index,recordingHistory,callback){var track,scope=this;index<this.numTracks?(track=this.tracks[index],track.stopRecording(this.recordId,function(events){void 0!==events&&(recordingHistory[track.name]=events),index++,_getRecordingPerTrack.call(scope,index,recordingHistory,callback)})):callback(recordingHistory)},Song.prototype.stopRecording=function(){if(!1!==this.recording){this.recording=!1,this.prerolling=!1,this.precounting=!1,delete repetitiveTasks.playAfterPrecount;var scope=this;return _getRecordingPerTrack.call(this,0,{},function(history){scope.update(),dispatchEvent(scope,"recorded_events",history)}),this.update(),dispatchEvent(this,"record_stop"),this.recordId}},Song.prototype.undoRecording=function(history){var i,tracksByName;if(void 0===history)for(i=this.numTracks-1;i>=0;i--)this.tracks[i].undoRecording(this.recordId);else tracksByName=this.tracksByName,objectForEach(history,function(events,name){tracksByName[name].undoRecording(events)})},Song.prototype.getAudioRecordingData=function(recordId){var i,event,sampleId;for(i=this.audioEvents.length-1;i>=0&&(event=this.audioEvents[i],void 0===(sampleId=event.sampleId)||recordId!==sampleId);i--);return void 0!==event&&event.track.getAudioRecordingData(recordId)},Song.prototype.quantize=function(){var i,track,arg,type,value,args=slice.call(arguments),numArgs=args.length,historyObject={};for(i=0;i<numArgs;i++)arg=args[i],type=typeString(arg),"string"===type||"number"===type?value=arg:"object"===type&&(historyObject=arg);for(i=this.numTracks-1;i>=0;i--)track=this.tracks[i],void 0===value&&(value=track.quantizeValue),sequencer.quantize(track.events,value,this.ppq,historyObject);return historyObject},Song.prototype.undoQuantize=function(history){if(void 0===history)return void(sequencer.debug>=2&&console.warn("please pass a quantize history object"));var i,track;for(i=this.numTracks-1;i>=0;i--)track=this.tracks[i],track.undoQuantize(history)},Song.prototype.quantizeRecording=function(value){var i,track;for(i=this.numTracks-1;i>=0;i--)track=this.tracks[i],track.recordId===this.recordId&&track.quantizeRecording(value)},Song.prototype.setLeftLocator=function(){var pos=getPosition(this,slice.call(arguments));void 0!==pos&&(this.loopStartPosition=pos,this.loopStart=pos.millis,this.loopStartTicks=pos.ticks),this.illegalLoop=this.loopStart>=this.loopEnd,this.doLoop=!1===this.illegalLoop&&!0===this.loop,this.loopDuration=!0===this.illegalLoop?0:this.loopEnd-this.loopStart},Song.prototype.setRightLocator=function(){
var pos=getPosition(this,slice.call(arguments));this.illegalLoop;void 0!==pos&&(this.loopEndPosition=pos,this.loopEnd=pos.millis,this.loopEndTicks=pos.ticks),this.illegalLoop=this.loopEnd<=this.loopStart,this.doLoop=!1===this.illegalLoop&&!0===this.loop,this.loopDuration=!0===this.illegalLoop?0:this.loopEnd-this.loopStart},Song.prototype.setLoop=function(flag){if(void 0===flag)this.loop=!this.loop;else{if(!0!==flag&&!1!==flag)return void(sequencer.debug>=1&&console.error('pass "true", "false" or no value'));this.loop=flag}this.doLoop=!1===this.illegalLoop&&!0===this.loop},Song.prototype.setPlayhead=function(){this.jump=!0,this.scheduler.looped=!1,this.scheduler.firstRun=!0,this.timeStamp=1e3*sequencer.getTime(),this.startTime=this.timeStamp;try{this.startTime2=window.performance.now()}catch(e){sequencer.debug&&console.log("window.performance.now() not supported")}this.playing&&this.allNotesOff();var pos=getPosition(this,slice.call(arguments)),millis=pos.millis;this.startMillis=millis,this.playhead.set("millis",millis),this.scheduler.setIndex(millis)},Song.prototype.addEventListener=function(){return addEventListener.apply(this,arguments)},Song.prototype.removeEventListener=function(){removeEventListener.apply(this,arguments)},Song.prototype.addEvent=Song.prototype.addEvents=function(){var track,part;return track=this.tracks[0],void 0===track&&(track=sequencer.createTrack(),this.addTrack(track)),track.needsUpdate&&track.update(),part=track.parts[0],void 0===part&&(part=sequencer.createPart(),track.addPart(part)),part.addEvents.apply(part,arguments),this},Song.prototype.addPart=Song.prototype.addParts=function(){var track=this.tracks[0];return void 0===track&&(track=sequencer.createTrack(),this.addTrack(track)),track.addParts.apply(track,arguments),this},Song.prototype.addTrack=function(){var args=getArguments(arguments),arg0=args[0],numArgs=args.length;return("array"===typeString(arg0)||numArgs>1)&&(console.warn("please use addTracks() if you want to get more that one tracks"),args=[arg0]),addTracks(args,this)[0]},Song.prototype.addTracks=function(){return addTracks(getArguments(arguments),this)},Song.prototype.getTrack=function(arg){return getTrack(arg,this)},Song.prototype.getTracks=function(){var track,i,args=getArguments(arguments),result=[];for(i=args.length-1;i>=0;i--)(track=getTrack(args[i],this))&&result.push(track);return result},Song.prototype.getPart=function(){var args=getArguments(arguments);return args.length>1&&console.warn("please use getParts() if you want to get more that one part"),getParts.call(this,args)[0]},Song.prototype.getParts=function(){var args=getArguments(arguments);return getParts.call(this,args)},Song.prototype.removeTrack=function(){var args=getArguments(arguments);return args.length>1&&console.warn("please use removeTracks() if you want to remove more that one tracks"),_removeTracks.call(this,args)[0]},Song.prototype.removeTracks=function(){return _removeTracks.call(this,getArguments(arguments))},Song.prototype.setPlaybackSpeed=function(speed){if(speed<.01||speed>100)return void console.error("playback speed has to be > 0.01 and < 100");var startLoop,endLoop,newPos,ticks=this.ticks;this.playbackSpeed=speed,this.update(!0),void 0!==this.loopStartTicks&&(startLoop=this.getPosition("ticks",this.loopStartTicks),this.loopStart=startLoop.millis,this.loopStartTicks=startLoop.ticks),void 0!==this.loopEndTicks&&(endLoop=this.getPosition("ticks",this.loopEndTicks),this.loopEnd=endLoop.millis,this.loopEndTicks=endLoop.ticks),newPos=this.getPosition("ticks",ticks),this.setPlayhead("ticks",newPos.ticks)},Song.prototype.gridToSong=function(x,y,width,height){return gridToSong(this,x,y,width,height)},Song.prototype.noteToGrid=function(note,height){return noteToGrid(note,height,this)},Song.prototype.eventToGrid=function(event,width,height){return eventToGrid(event,width,height,this)},Song.prototype.positionToGrid=function(position,width){return positionToGrid(position,width,this)},Song.prototype.getPosition=function(){return getPosition(this,slice.call(arguments))},Song.prototype.ticksToMillis=function(ticks,beyondEndOfSong){return ticksToMillis(this,ticks,beyondEndOfSong)},Song.prototype.millisToTicks=function(millis,beyondEndOfSong){return millisToTicks(this,millis,beyondEndOfSong)},Song.prototype.ticksToBars=function(ticks,beyondEndOfSong){return ticksToBars(this,ticks,beyondEndOfSong)},Song.prototype.millisToBars=function(millis,beyondEndOfSong){return millisToBars(this,millis,beyondEndOfSong)},Song.prototype.barsToTicks=function(){return barsToTicks(this,slice.call(arguments))},Song.prototype.barsToMillis=function(){return barsToMillis(this,slice.call(arguments))},Song.prototype.findEvent=Song.prototype.findEvents=function(pattern){return findEvent(this,pattern)},Song.prototype.findNote=Song.prototype.findNotes=function(pattern){return findNote(this,pattern)},Song.prototype.getStats=function(pattern){return getStats(this,pattern)},Song.prototype.createGrid=function(config){return void 0===this.grid?this.grid=createGrid(this,config):this.grid.update(config),this.grid},Song.prototype.update=function(updateTimeEvents){update(this,updateTimeEvents)},Song.prototype.updateGrid=function(config){return this.grid.update(config),this.grid},Song.prototype.updateTempoEvent=function(event,bpm){if(event.type!==sequencer.TEMPO)return void(sequencer.debug>=4&&console.error("this is not a tempo event"));if(event.song!==this)return void(sequencer.debug>=4&&console.error("this event has not been added to this song yet"));var ticks=this.ticks;this.percentage;event.bpm=bpm,this.update(!0),this.updatePlayheadAndLocators(ticks)},Song.prototype.updateTimeSignatureEvent=function(event,nominator,denominator){if(event.type!==sequencer.TIME_SIGNATURE)return void(sequencer.debug>=4&&console.error("this is not a time signature event"));if(event.song!==this)return void(sequencer.debug>=4&&console.error("this event has not been added to this song yet"));var ticks=this.ticks;this.percentage;event.nominator=nominator||event.nominator,event.denominator=denominator||event.denominator,this.update(!0),this.updatePlayheadAndLocators(ticks)},Song.prototype.getTempoEvents=function(){return getTimeEvents(sequencer.TEMPO,this)},Song.prototype.getTimeSignatureEvents=function(){return getTimeEvents(sequencer.TIME_SIGNATURE,this)},Song.prototype.updatePlayheadAndLocators=function(ticks){var newStartPos,newEndPos,newPos,startPos=this.loopStartPosition,endPos=this.loopEndPosition;void 0!==startPos&&(newStartPos=this.getPosition("ticks",startPos.ticks),this.loopStart=newStartPos.millis,this.loopStartTicks=newStartPos.ticks,this.loopStartPosition=newStartPos),void 0!==endPos&&(newEndPos=this.getPosition("ticks",endPos.ticks),newEndPos.ticks>this.durationTicks&&(newEndPos=this.getPosition("ticks",this.bars)),this.loopEnd=newEndPos.millis,this.loopEndTicks=newEndPos.ticks,this.loopEndPosition=newEndPos),newPos=this.getPosition("ticks",ticks),this.doLoop&&newPos.ticks>this.durationTicks?this.setPlayhead("ticks",0):this.setPlayhead("ticks",newPos.ticks),this.loopDuration=!0===this.illegalLoop?0:this.loopEnd-this.loopStart},Song.prototype.setTempo=function(bpm,update){var i,event,timeEvents=getTimeEvents(sequencer.TEMPO,this),ticks=this.ticks,ratio=(this.percentage,bpm/timeEvents[0].bpm);for(i=timeEvents.length-1;i>=0;i--)event=timeEvents[i],event.bpm=ratio*event.bpm;this.bpm=bpm,!1!==update&&(this.update(!0),this.updatePlayheadAndLocators(ticks))},Song.prototype.setTimeSignature=function(nominator,denominator,update){var i,event,timeEvents=getTimeEvents(sequencer.TIME_SIGNATURE,this),ticks=(this.percentage,this.ticks);for(i=timeEvents.length-1;i>=0;i--)event=timeEvents[i],event.nominator=nominator,event.denominator=denominator;this.nominator=nominator,this.denominator=denominator,!1!==update&&(this.update(!0),this.updatePlayheadAndLocators(ticks))},Song.prototype.resetTempo=function(bpm){var firstTempoEvent=getTimeEvents(sequencer.TEMPO,this)[0],timeEvents=this.timeEvents;firstTempoEvent.bpm=bpm,timeEvents=removeFromArray2(timeEvents,function(event){return 81===event.type}),this.numTimeEvents=timeEvents.length,this.update(!0)},Song.prototype.resetTimeSignature=function(nominator,denominator){var firstTimeSignatureEvent=getTimeEvents(sequencer.TIME_SIGNATURE,this)[0],timeEvents=this.timeEvents,ticks=this.ticks;firstTimeSignatureEvent.nominator=nominator,firstTimeSignatureEvent.denominator=denominator,timeEvents=removeFromArray2(timeEvents,function(event){return 88===event.type}),this.numTimeEvents=timeEvents.length,this.update(!0),this.updatePlayheadAndLocators(ticks)},Song.prototype.addTimeEvent=Song.prototype.addTimeEvents=function(){var i,event,position,events=getArguments(arguments),ticks=this.ticks;for(i=events.length-1;i>=0;i--)event=events[i],"MidiEvent"===event.className&&(event.type===sequencer.TEMPO?this.timeEvents.push(event):event.type===sequencer.TIME_SIGNATURE&&(position=this.getPosition("ticks",event.ticks),position=position.beat>position.nominator/2?this.getPosition("barsbeats",position.bar+1):this.getPosition("barsbeats",position.bar),event.ticks=position.ticks,this.timeEvents.push(event)));this.numTimeEvents=this.timeEvents.length,this.update(!0),this.updatePlayheadAndLocators(ticks)},Song.prototype.removeTimeEvent=Song.prototype.removeTimeEvents=function(){var i,event,tmp=getArguments(arguments),maxi=tmp.length,ticks=this.ticks,events=[];for(i=0;i<maxi;i++)(event=tmp[i])!==this.tempoEvent&&event!==this.timeSignatureEvent&&events.push(event);this.timeEvents=removeFromArray(events,this.timeEvents),this.numTimeEvents=this.timeEvents.length,this.update(!0),this.updatePlayheadAndLocators(ticks)},Song.prototype.removeDoubleTimeEvents=function(){var i,event,ticks,type,events=[],eventsByTicks={81:{},88:{}};for(i=this.timeEvents.length-1;i>=0;i--)event=this.timeEvents[i],void 0===eventsByTicks[event.type][event.ticks]&&(type=event.type,ticks=event.ticks,eventsByTicks[type][ticks]=event,0===ticks&&(81===type?this.tempoEvent=event:88===type&&(this.timeSignatureEvent=event)));objectForEach(eventsByTicks[81],function(event){events.push(event)}),objectForEach(eventsByTicks[88],function(event){events.push(event)}),this.timeEvents=events,this.update(!0)},Song.prototype.setPitchRange=function(min,max){var me=this;me.lowestNote=min,me.highestNote=max,me.numNotes=me.pitchRange=me.highestNote-me.lowestNote+1},Song.prototype.trim=function(){checkDuration(this,!0)},Song.prototype.setDurationInBars=function(bars){var me=this,removedEvents=me.findEvent("bar > "+bars),removedParts=[],changedTracks=[],changedParts=[],dirtyTracks={},dirtyParts={};return removedEvents.forEach(function(event){var trackId=event.trackId,partId=event.partId;void 0===dirtyTracks[trackId]&&(dirtyTracks[trackId]=[]),dirtyTracks[trackId].push(event),void 0===dirtyParts[partId]&&(dirtyParts[partId]=event.part)}),objectForEach(dirtyTracks,function(events,trackId){var track=me.getTrack(trackId);track.removeEvents(events),changedTracks.push(track)}),objectForEach(dirtyParts,function(part,partId){0===part.events.length?(part.track.removePart(part),removedParts.push(part)):changedParts.push(part)}),me.bars=bars,me.lastBar=bars,{removedEvents:removedEvents,removedParts:removedParts,changedTracks:changedTracks,changedParts:changedParts}},Song.prototype.addEffect=function(){},Song.prototype.removeEffect=function(){},Song.prototype.setVolume=function(){function loop(data,i,maxi){for(i=0;i<maxi;i++){var arg=data[i],type=typeString(arg);"array"===type?loop(arg,0,arg.length):"number"===type?value=arg:"Track"===arg.className&&tracks.push(arg)}}var value,i,args=slice.call(arguments),numArgs=args.length,tracks=[];if(1===numArgs){if(value=args[0],isNaN(value))return void console.warn("please pass a number");this.volume=value<0?0:value>1?1:value,this.gainNode.gain.value=this.volume}else for(loop(args,0,numArgs),i=tracks.length-1;i>=0;i--)tracks[i].setVolume(value)},Song.prototype.getVolume=function(){return this.gainNode.gain.value},Song.prototype.connect=function(){this.gainNode.connect(masterGainNode)},Song.prototype.disconnect=function(){this.gainNode.disconnect(masterGainNode)},Song.prototype.getMidiInputs=function(cb){getMidiInputs(cb,this)},Song.prototype.getMidiOutputs=function(cb){getMidiOutputs(cb,this)},Song.prototype.setTrackSolo=function(soloTrack,flag){var i,track;for(i=this.numTracks-1;i>=0;i--)track=this.tracks[i],!0===flag?track.mute=track===soloTrack?!flag:flag:!1===flag&&(track.mute=!1),track.solo=track===soloTrack&&flag},Song.prototype.muteAllTracks=function(flag){var i,track;for(i=this.numTracks-1;i>=0;i--)track=this.tracks[i],track.mute=flag},Song.prototype.setMetronomeVolume=function(value){this.metronome.setVolume(value)},Song.prototype.configureMetronome=function(config){this.metronome.configure(config)},Song.prototype.resetMetronome=function(){this.metronome.reset()},Song.prototype.setPrecount=function(value){this.precount=value},Song.prototype.allNotesOff=function(){objectForEach(this.tracks,function(track){track.allNotesOff()}),this.metronome.allNotesOff(),this.resetExternalMidiDevices()},Song.prototype.resetExternalMidiDevices=function(){var time=this.scheduler.lastEventTime+100;isNaN(time)&&(time=100),objectForEach(this.midiOutputs,function(output){output.send([176,123,0],time),output.send([176,121,0],time)})},Song.prototype.addMidiEventListener=function(){return addMidiEventListener(arguments,this)},Song.prototype.removeMidiEventListener=function(id){removeMidiEventListener(id,this)},Song.prototype.removeMidiEventListeners=function(){removeMidiEventListener(arguments,this)},Song.prototype.getMidiInputsAsDropdown=function(config){return config=config||{type:"input"},getMidiPortsAsDropdown(config,this)},Song.prototype.getMidiOutputsAsDropdown=function(config){return config=config||{type:"output"},getMidiPortsAsDropdown(config,this)},Song.prototype.setMidiInput=function(id,flag){setMidiInput(id,flag,this)},Song.prototype.setMidiOutput=function(id,flag){setMidiOutput(id,flag,this)},Song.prototype.getNoteLengthName=function(ticks){return getNoteLengthName(this,ticks)},sequencer.createSong=function(config){return new Song(config)},sequencer.protectedScope.addInitMethod(function(){context=sequencer.protectedScope.context,timedTasks=sequencer.protectedScope.timedTasks,repetitiveTasks=sequencer.protectedScope.repetitiveTasks,masterGainNode=sequencer.protectedScope.masterGainNode,createMidiEvent=sequencer.createMidiEvent,createGrid=sequencer.protectedScope.createGrid,initMidi=sequencer.protectedScope.initMidiSong,setMidiInput=sequencer.protectedScope.setMidiInputSong,setMidiOutput=sequencer.protectedScope.setMidiOutputSong,getMidiInputs=sequencer.protectedScope.getMidiInputs,getMidiOutputs=sequencer.protectedScope.getMidiOutputs,addMidiEventListener=sequencer.protectedScope.addMidiEventListener,getMidiPortsAsDropdown=sequencer.protectedScope.getMidiPortsAsDropdown,removeMidiEventListener=sequencer.protectedScope.removeMidiEventListener,getPosition=sequencer.protectedScope.getPosition,millisToTicks=sequencer.protectedScope.millisToTicks,ticksToMillis=sequencer.protectedScope.ticksToMillis,ticksToBars=sequencer.protectedScope.ticksToBars,millisToBars=sequencer.protectedScope.millisToBars,barsToTicks=sequencer.protectedScope.barsToTicks,barsToMillis=sequencer.protectedScope.barsToMillis,typeString=sequencer.protectedScope.typeString,removeFromArray=sequencer.protectedScope.removeFromArray,removeFromArray2=sequencer.protectedScope.removeFromArray2,findEvent=sequencer.findEvent,findNote=sequencer.findNote,getStats=sequencer.getStats,gridToSong=sequencer.gridToSong,noteToGrid=sequencer.noteToGrid,eventToGrid=sequencer.eventToGrid,positionToGrid=sequencer.positionToGrid,getArguments=sequencer.protectedScope.getArguments,objectForEach=sequencer.protectedScope.objectForEach,getNoteLengthName=sequencer.protectedScope.getNoteLengthName,update=sequencer.protectedScope.update,checkDuration=sequencer.protectedScope.checkDuration,addMetronomeEvents=sequencer.protectedScope.addMetronomeEvents,followEvent=sequencer.protectedScope.followEvent,createPlayhead=sequencer.protectedScope.createPlayhead,createScheduler=sequencer.protectedScope.createScheduler,createFollowEvent=sequencer.protectedScope.createFollowEvent,createMetronome=sequencer.protectedScope.createMetronome,addEventListener=sequencer.protectedScope.songAddEventListener,removeEventListener=sequencer.protectedScope.songRemoveEventListener,dispatchEvent=sequencer.protectedScope.songDispatchEvent,addSong=sequencer.protectedScope.addSong})}(),function(){"use strict";var typeString,addEventListener,removeEventListener,dispatchEvent,sequencer=window.sequencer,console=window.console,slice=Array.prototype.slice,listenerIndex=0;dispatchEvent=function(){var i,tmp,listener,args=slice.call(arguments),numArgs=args.length,song=args[0],type=args[1],params=[];if(numArgs>2)for(i=2;i<numArgs;)params.push(args[i]),i++;if(params.push(song),void 0!==(tmp=song.listeners[type])&&void 0!==tmp.length)for(i=tmp.length-1;i>=0;i--)listener=tmp[i],listener.callback.apply(null,params)},addEventListener=function(){var listenerId,args=slice.call(arguments),type=args[0];switch(type){case"play":case"stop":case"pause":case"end":case"record_start":case"record_stop":case"record_precount":case"record_preroll":case"recorded_events":case"latency_adjusted":case"loop_off":case"loop_on":case"loop":case"sustain_pedal":return void 0===this.listeners[type]&&(this.listeners[type]=[]),listenerId=type+"_"+listenerIndex++,this.listeners[type].push({id:listenerId,callback:args[1]}),listenerId;case"note":case"event":case"position":return this.followEvent.addEventListener(type,args[1],args[2]);default:console.log(type,"is not a supported event")}},removeEventListener=function(){var tmp,type,id,i,listener,args=slice.call(arguments),arg0=args[0],callback=args[1],filteredListeners=[];if(-1!==arg0.indexOf("_")?(tmp=arg0.split("_"),type=tmp[0],id=arg0):type=arg0,"array"===typeString(type))return this.followEvent.removeEventListener(args);switch(type){case"play":case"stop":case"pause":case"end":case"record_start":case"record_stop":case"record_precount":case"record_preroll":case"recorded_events":case"latency_adjusted":case"loop_off":case"loop_on":case"loop":case"sustain_pedal":if((tmp=this.listeners[type])&&tmp.length>0){for(i=tmp.length-1;i>=0;i--)listener=tmp[i],void 0!==id?listener.id!==id&&filteredListeners.push(listener):void 0!==callback&&listener.callback!==callback&&filteredListeners.push(listener);this.listeners[type]=[].concat(filteredListeners)}break;case"note":case"event":case"position":return this.followEvent.removeEventListener(args);default:console.error("unsupported event")}},sequencer.protectedScope.songAddEventListener=addEventListener,sequencer.protectedScope.songRemoveEventListener=removeEventListener,sequencer.protectedScope.songDispatchEvent=dispatchEvent,sequencer.protectedScope.addInitMethod(function(){typeString=sequencer.protectedScope.typeString})}(),function(){"use strict";var findEvent,typeString,getPosition,midiEventNameByNumber,midiEventNumberByName,getEvents,checkOperatorConflict,FollowEvent,sequencer=window.sequencer,console=window.console,listenerIndex=0,supportedTimeEvents={bar:1,beat:1,sixteenth:1,tick:0,ticks:1,barsbeats:1,barsandbeats:1,hour:1,minute:1,second:1,millisecond:0,millis:1,time:1},supportedOperators="= == === > >= < <= != !== %=";new RegExp(" "+supportedOperators.replace(/\s+/g," | ")+" ");FollowEvent=function(song){this.song=song,this.allListenersById={},this.allListenersByType={},this.searchPatterns=[],this.eventListenersBySearchstring={},this.positionListenersBySearchstring={},this.allListenersByType={event:{instance:{},searchstring:{}},position:{ticks:[],repetitive:{},conditional_simple:{},conditional_complex:{}}}},FollowEvent.prototype.updateSong=function(){var i,j,e,eventId,events,tmp,data,listeners,listener,listenerId,listenerIds=[];listeners=this.allListenersByType.event.instance;for(eventId in listeners)if(listeners.hasOwnProperty(eventId)&&void 0===this.song.eventsById[eventId]){for(listenerIds=listeners[eventId],i=listenerIds.length-1;i>=0;i--)listenerId=listenerIds[i],delete this.allListenersById[listenerId];delete this.allListenersByType.event.instance[eventId]}listeners=this.allListenersByType.event.searchstring,listenerIds=[];for(eventId in listeners)listeners.hasOwnProperty(eventId)&&(listenerIds=listenerIds.concat(listeners[eventId]));for(i=listenerIds.length-1;i>=0;i--)delete this.allListenersById[listenerIds[i]];for(this.allListenersByType.event.searchstring={},tmp=this.allListenersByType.event.searchstring,i=this.searchPatterns.length-1;i>=0;i--)for(data=this.searchPatterns[i],events=findEvent(this.song,data.searchstring),"note"===tmp.type&&(events=findEvent(events,"type = NOTE_ON OR type = NOTE_OFF")),j=events.length-1;j>=0;j--)e=events[j],listenerId="event_"+listenerIndex++,listener={id:listenerId,event:e,type:data.type,subtype:data.subtype,callback:data.callback},this.allListenersById[listenerId]=listener,void 0===tmp[e.id]&&(tmp[e.id]=[]),tmp[e.id].push(listenerId)},FollowEvent.prototype.update=function(){var i,numEvents,event,position=this.song,ticks=position.ticks,events=[];for(events=this.song.playhead.collectedEvents,numEvents=events.length,i=0;i<numEvents;i++)event=events[i],this.callEventListeners(event.id,event);this.callListenersPositionTicks(ticks),position.bar!==this.bar&&(this.bar=position.bar,this.callListenersPositionRepetitive("bar"),this.callListenersPositionConditionalSimple("bar",this.bar),this.callListenersPositionConditionalComplex("bar",this.bar)),position.beat!==this.beat&&(this.beat=position.beat,this.callListenersPositionRepetitive("beat"),this.callListenersPositionConditionalSimple("beat",this.beat),this.callListenersPositionConditionalComplex("beat",this.beat)),position.sixteenth!==this.sixteenth&&(this.sixteenth=position.sixteenth,this.callListenersPositionRepetitive("sixteenth"),this.callListenersPositionConditionalSimple("sixteenth",this.sixteenth),this.callListenersPositionConditionalComplex("sixteenth",this.sixteenth)),position.hour!==this.hour&&(this.hour=position.hour,this.callListenersPositionRepetitive("hour"),this.callListenersPositionConditionalSimple("hour",this.hour),this.callListenersPositionConditionalComplex("hour",this.hour)),position.minute!==this.minute&&(this.minute=position.minute,this.callListenersPositionRepetitive("minute"),this.callListenersPositionConditionalSimple("minute",this.minute),this.callListenersPositionConditionalComplex("minute",this.minute)),position.second!==this.second&&(this.second=position.second,this.callListenersPositionRepetitive("second"),this.callListenersPositionConditionalSimple("second",this.second),this.callListenersPositionConditionalComplex("second",this.second))},FollowEvent.prototype.callEventListeners=function(eventId,event){var i,id,tmp,listener,listenerIds=[];for(tmp=this.allListenersByType.event.instance,tmp[eventId]&&(listenerIds=listenerIds.concat(tmp[eventId])),tmp=this.allListenersByType.event.searchstring,tmp[eventId]&&(listenerIds=listenerIds.concat(tmp[eventId])),listenerIds.length,i=listenerIds.length-1;i>=0;i--)id=listenerIds[i],listener=this.allListenersById[id],!0!==listener.called&&(listener.called=!0,listener.callback(event))},FollowEvent.prototype.callListenersPositionRepetitive=function(positionType){var listener,listenerIds=this.allListenersByType.position.repetitive[positionType],me=this;listenerIds&&listenerIds.forEach(function(id){listener=me.allListenersById[id],listener.callback(listener.searchstring)})},FollowEvent.prototype.callListenersPositionConditionalSimple=function(positionType,value){var listener,data,operator,call=!1,listenerIds=this.allListenersByType.position.conditional_simple[positionType],me=this;listenerIds&&listenerIds.forEach(function(id){switch(listener=me.allListenersById[id],data=listener.data,operator=listener.operator){case">":call=value>data;break;case"<":call=value<data;break;case"%=":call=value%data==0;break;case"!=":case"!==":call=value!==data;break;case"===":call=value===data}!0===call&&listener.callback(listener.searchstring)})},FollowEvent.prototype.callListenersPositionConditionalComplex=function(positionType,value){var listener,value1,value2,operator1,operator2,listenerIds=this.allListenersByType.position.conditional_complex[positionType],me=this;listenerIds&&listenerIds.forEach(function(id){listener=me.allListenersById[id],value1=listener.value1,value2=listener.value2,operator1=listener.operator1,operator2=listener.operator2,"<"===operator1?(value<value1||value>value2)&&listener.callback(listener.searchstring):">"===operator1&&value>value1&&value<value2&&listener.callback(listener.searchstring)})},FollowEvent.prototype.callListenersPositionTicks=function(ticks){var i,listener,tmp=this.allListenersByType.position.ticks,maxi=tmp.length;for(i=0;i<maxi;i++)listener=this.allListenersById[tmp[i]],ticks>=listener.ticks&&!listener.called&&(listener.callback(listener.searchstring),listener.called=!0)},FollowEvent.prototype.addEventListener=function(type,data,callback){var i,events,event,storeArray,tmp,subtype,listener,listenerId,listenerIds=[],dataType=typeString(data);if("function"!==typeString(callback))return console.error(callback,"is not a function; please provide a function for callback"),-1;if("position"===type)return listenerId=this.addPositionEventListener(data,callback);if("string"===dataType){if(events=findEvent(this.song,data),this.searchPatterns.push({searchstring:data,callback:callback,type:"event",subtype:"searchstring"}),0===events.length)return-1;subtype="searchstring",storeArray=this.allListenersByType.event.searchstring,this.eventListenersBySearchstring[data]=tmp=[]}else{if(-1===(events=getEvents(type,data)))return-1;subtype="instance",storeArray=this.allListenersByType.event.instance}for("note"===type&&(events=findEvent(events,"type = NOTE_ON OR type = NOTE_OFF")),i=events.length-1;i>=0;i--)event=events[i],listenerId="event_"+listenerIndex++,listener={id:listenerId,event:event,type:type,subtype:subtype,callback:callback},this.allListenersById[listenerId]=listener,void 0===storeArray[event.id]&&(storeArray[event.id]=[]),storeArray[event.id].push(listenerId),listenerIds.push(listenerId),"searchstring"===subtype&&tmp.push(listenerId);return"searchstring"===subtype||"array"===dataType||"note"===type?listenerIds:listenerIds[0]},FollowEvent.prototype.addPositionEventListener=function(data,callback){var tmp,listenerId,listener,millis,searchString=data.split(/[\s+]/g),len=searchString.length,type=searchString[0],operator1=searchString[1],value1=searchString[2],operator2=searchString[3],value2=searchString[4],value1Type=typeString(value1);if(1!==len&&3!==len&&5!==len)return console.error("invalid search string, please consult documentation"),!1;if(1!==supportedTimeEvents[type])return console.error(type,"is not a supported event id, please consult documentation"),-1;switch("="!==operator1&&"=="!==operator1||(operator1="==="),type){case"barsbeats":case"barsandbeats":case"time":case"ticks":case"millis":if(void 0===operator1||"==="!==operator1)return console.error(type,"can only be used conditionally with the operators '===', '==' or '='"),-1;operator2&&console.warn("this position event type can only be used with a single condition, ignoring second condition");break;case"bar":case"beat":case"sixteenth":case"hour":case"minute":case"second":if(value1&&isNaN(value1))return console.error("please provide a number"),-1;if(value2&&isNaN(value2))return console.error("please provide a number"),-1}if(operator1&&-1===supportedOperators.indexOf(operator1))return console.error(operator1,"is not a supported operator, please use any of",supportedOperators),-1;if(operator1&&void 0===value1)return void console.error("operator without value");if(operator2&&-1===supportedOperators.indexOf(operator1))return console.error(operator2,"is not a supported operator, please use any of",supportedOperators),-1;if(operator2&&void 0===value2)return void console.error("operator without value");if(operator1&&operator2&&!1===checkOperatorConflict(operator1,operator2))return console.error("you can't use "+operator1+" together with "+operator2),-1;if("function"!==typeString(callback))return console.error(callback,"is not a function; please provide a function for callback"),-1;switch(type){case"bar":case"beat":case"sixteenth":value1-=0,value2-=0;case"hour":case"minute":case"second":value1-=0,value2-=0,operator1&&("<="===operator1?(value1++,operator1="<"):">="===operator1&&(value1--,operator1=">")),operator2&&("<="===operator2?(value2++,operator2="<"):">="===operator2&&(value2--,operator2=">"));break;case"ticks":value1-=0;break;case"barsbeats":case"barsandbeats":isNaN(value1)?"string"===value1Type?(value1=value1.replace(/[\[\]\s]/g,""),value1=value1.split(","),value1=getPosition(this.song,["barsbeats",value1[0],value1[1]||1,value1[2]||1,value1[3]||0]).ticks):console.error("please provide a number or an array of numbers"):value1=getPosition(this.song,["barsbeats",value1,1,1,0]).ticks,type="ticks";break;case"millis":value1=getPosition(this.song,["millis",value1]).ticks,type="ticks";break;case"time":isNaN(value1)?"string"===value1Type?(value1=value1.replace(/[\[\]\s]/g,""),console.log(value1),value1=value1.split(","),1===value1.length?(millis=60*value1[0]*1e3,value1=getPosition(this.song,["millis",millis]).ticks):value1=getPosition(this.song,["time",value1[0],value1[1],value1[2],value1[3]]).ticks):console.error("please provide a number or an array of numbers"):(millis=60*value1*1e3,value1=getPosition(this.song,["millis",millis]).ticks),console.log(value1),type="ticks"}return listenerId="position_"+listenerIndex++,"ticks"===type?(listener={id:listenerId,callback:callback,type:"position",subtype:"ticks",ticks:value1,searchstring:data},this.allListenersByType.position.ticks.push(listenerId)):operator1||operator2?operator1&&!operator2?(listener={id:listenerId,callback:callback,type:"position",subtype:"conditional_simple",position_type:type,data:value1,operator:operator1,searchstring:data},tmp=this.allListenersByType.position.conditional_simple,void 0===tmp[type]&&(tmp[type]=[]),tmp[type].push(listenerId)):operator1&&operator2&&(listener={id:listenerId,callback:callback,type:"position",subtype:"conditional_complex",position_type:type,value1:value1,value2:value2,operator1:operator1,operator2:operator2,searchstring:data},tmp=this.allListenersByType.position.conditional_complex,void 0===tmp[type]&&(tmp[type]=[]),tmp[type].push(listenerId)):(listener={id:listenerId,callback:callback,type:"position",subtype:"repetitive",position_type:type,searchstring:data},tmp=this.allListenersByType.position.repetitive,void 0===tmp[type]&&(tmp[type]=[]),tmp[type].push(listenerId)),this.allListenersById[listenerId]=listener,this.positionListenersBySearchstring[data]=listenerId,listenerId},FollowEvent.prototype.removeEventListener=function(args){var arg0,numArgs,type,subtype,data,callback,id,ids,listener,listenerId,event,eventId,eventIds,i,j,removeMe,listenerIds,dataType,filteredListenerIds=[],removedListenerIds=[];if(arg0=args[0],1===(numArgs=args.length))for(ids="array"===typeString(arg0)?arg0:[arg0],i=ids.length-1;i>=0;i--)if(id=ids[i],void 0!==this.allListenersById[id]){if(listener=this.allListenersById[id],type=listener.type,subtype=listener.subtype,"position"===type){for(listenerIds=this.allListenersByType[type][subtype][listener.position_type],j=listenerIds.length-1;j>=0;j--)(listenerId=listenerIds[j])!==id&&filteredListenerIds.push(listenerId);this.allListenersByType[listener.type][listener.subtype][listener.position_type]=[].concat(filteredListenerIds),delete this.allListenersById[id]}else if("event"===type||"note"===type){for(event=listener.event,eventId=event.id,listenerIds=this.allListenersByType.event[subtype][eventId],j=listenerIds.length-1;j>=0;j--)if(listenerId=listenerIds[j],listener=this.allListenersById[listenerId],listenerId!==id){filteredListenerIds.push(listenerId);break}
this.allListenersByType.event[subtype][eventId]=[].concat(filteredListenerIds),delete this.allListenersById[id]}}else console.warn("no event listener found with id",id);else if(2===numArgs||3===numArgs)switch(type=args[0],data=args[1],callback=args[2],dataType=typeString(data),type){case"position":if("string"===dataType){for(id=this.positionListenersBySearchstring[data],listener=this.allListenersById[id],listenerIds=this.allListenersByType[listener.type][listener.subtype][listener.position_type],i=listenerIds.length-1;i>=0;i--)(listenerId=listenerIds[i])!==id&&filteredListenerIds.push(listenerId);this.allListenersByType[listener.type][listener.subtype][listener.position_type]=[].concat(filteredListenerIds),delete this.allListenersById[id],delete this.positionListenersBySearchstring[data]}break;case"event":case"note":if("string"===dataType){for(listenerIds=this.eventListenersBySearchstring[data],i=listenerIds.length-1;i>=0;i--)removedListenerIds.push(listenerIds[i]);eventIds=this.allListenersByType.event.searchstring;for(eventId in eventIds)if(eventIds.hasOwnProperty(eventId)){for(listenerIds=eventIds[eventId],filteredListenerIds=[],i=listenerIds.length-1;i>=0;i--){for(listenerId=listenerIds[i],removeMe=!1,j=removedListenerIds.length-1;j>=0;j--)if(listenerId===removedListenerIds[j]){removeMe=!0;break}!1===removeMe?filteredListenerIds.push(listenerId):delete this.allListenersById[listenerIds[i]]}this.allListenersByType.event.searchstring[eventId]=[].concat(filteredListenerIds)}delete this.eventListenersBySearchstring[data]}else if("object"===dataType){if("MidiEvent"!==data.className&&"MidiNote"!==data.className)return void console.error("please provide a midi event or a midi note");if("MidiNote"===data.className?id=data.noteOn.id:"MidiEvent"===data.className&&(id=data.id),void 0!==this.allListenersByType.event.instance[id]?(type="instance",listenerIds=this.allListenersByType.event.instance[id]):void 0!==this.allListenersByType.event.searchstring[id]&&(type="searchstring",listenerIds=this.allListenersByType.event.searchstring[id]),void 0===listenerIds)return void console.warn("no event listener bound to event with id",id);for("MidiNote"===data.className&&(ids=this.allListenersByType.event[type][data.noteOff.id],listenerIds=listenerIds.concat(ids)),i=listenerIds.length-1;i>=0;i--)listenerId=listenerIds[i],listener=this.allListenersById[listenerId],callback&&listener.callback!==callback?filteredListenerIds.push(listener.id):delete this.allListenersById[listener.id],this.allListenersByType.event[type][listener.event.id]=[].concat(filteredListenerIds)}}},FollowEvent.prototype.resetAllListeners=function(){var key,listener,listeners=this.allListenersById;for(key in listeners)listeners.hasOwnProperty(key)&&(listener=listeners[key],listener.called=!1)},getEvents=function(type,data){var i,e,dataType=typeString(data),events=[];if("array"!==dataType&&void 0!==data&&"MidiEvent"!==data.className&&"MidiNote"!==data.className)return console.error(data," is not valid data for event type 'event', please consult documentation"),-1;if("array"===dataType)for(i=data.length-1;i>=0;i--)e=data[i],"event"!==type||"MidiEvent"===e.className||"AudioEvent"===e.className?"note"!==type||"MidiNote"===e.className?events.push(e):console.warn("skipping",e,"because it is not a MidiNote"):console.warn("skipping",e,"because it is not a MidiEvent nor an AudioEvent");else if("event"===type){if("MidiEvent"!==data.className&&"AudioEvent"!==data.className)return console.error(data," is not a MidiEvent nor an AudioEvent"),-1;events=[data]}else if("note"===type){if("MidiNote"!==data.className)return console.error(data," is not a MidiNote"),-1;events=[data.noteOn,data.noteOff]}return events},checkOperatorConflict=function(operator1,operator2){switch(operator1){case"=":case"==":case"===":return!1}switch(operator2){case"=":case"==":case"===":return!1}return!0},sequencer.protectedScope.createFollowEvent=function(song){return new FollowEvent(song)},sequencer.protectedScope.addInitMethod(function(){typeString=sequencer.protectedScope.typeString,getPosition=sequencer.protectedScope.getPosition,midiEventNumberByName=sequencer.midiEventNumberByName,midiEventNameByNumber=sequencer.midiEventNameByNumber,findEvent=sequencer.findEvent})}(),function(){"use strict";var getPosition,floor,round,typeString,positionToGrid,eventToGrid,noteToGrid,positionToSong;positionToSong=function(song,x,y,width,height){var ticks,note,position;return void 0===song?void console.error("please provide a song"):void 0===x||void 0===y?void console.error("please provide a coordinate"):void 0===width||void 0===height?void console.error("please provide width and height"):(ticks=floor(x/width*song.ticks),note=song.highestNote-floor(y/height*song.pitchRange),position=getPosition(song,["ticks",ticks]),note=sequencer.createNote(note),{position:position,note:note})},sequencer.positionToSong=sequencer.coordinatesToPosition=sequencer.gridToSong=function(){var args=Array.prototype.slice.call(arguments),numArgs=args.length,arg0=args[0];return 4===numArgs&&"Song"!==arg0.className?positionToSong(sequencer.getSong(),arg0,args[1],args[2],args[3]):positionToSong(arg0,args[1],args[2],args[3],args[4])},sequencer.songToGrid=function(){var args=Array.prototype.slice.call(arguments),numArgs=args.length,arg0=args[0],arg1=args[1];switch(numArgs){case 3:eventToGrid(arg0,arg1,args[2]);break;case 4:"x"===arg0?positionToGrid(arg1,args[2],args[3]):"y"===arg0&&noteToGrid(arg1,args[2],args[3]);break;case 6:break;default:console.error("wrong number of arguments")}},eventToGrid=function(event,width,height,song){if(void 0===song&&(song=sequencer.getSong()),event.type!==sequencer.NOTE_ON&&event.type!==sequencer.NOTE_OFF)return console.error("please provide a NOTE_ON or a NOTE_OFF event"),null;var note=(event.millis,song.durationMillis,sequencer.createNote(event.noteNumber));return{x:positionToGrid(["ticks",event.ticks],width,song),y:noteToGrid(note,height,song)}},positionToGrid=function(position,width,song){void 0===song&&(song=sequencer.getSong()),"array"!==typeString(position)&&"ticks"===position.type||(position=getPosition(song,position));var x=floor(position.ticks/song.quantizeTicks)*song.quantizeTicks;return x/=song.ticks,x*=width},noteToGrid=function(note,height,song){void 0===song&&(song=sequencer.getSong());var y,noteNumber=note.number;return noteNumber<song.lowestNote||noteNumber>song.highestNote?(console.error("note is out of range of the pitch range of this song"),null):(y=(noteNumber-song.highestNote)/song.pitchRange,y=y<0?-y:y,y*=height)},sequencer.protectedScope.addInitMethod(function(){getPosition=sequencer.protectedScope.getPosition,floor=sequencer.protectedScope.floor,round=sequencer.protectedScope.round,typeString=sequencer.protectedScope.typeString})}(),function(){"use strict";function checkDuration(song,trim){var position,key,lastEvent=song.lastEventTmp;!1===song.autoSize?song.lastBar=song.bars:song.lastBar=trim?lastEvent.bar:Math.max(song.lastBar,lastEvent.bar),song.bars=parseInt(song.lastBar),position=getPosition(song,["barsandbeats",song.bars,lastEvent.nominator,lastEvent.numSixteenth,lastEvent.ticksPerSixteenth,!0]),song.durationTicks=position.ticks,song.durationMillis=position.millis;for(key in position)position.hasOwnProperty(key)&&(song.lastEvent[key]=position[key])}function parseMetronomeEvents(song,events){var tmp=events.concat(song.timeEvents);parseEvents(song,tmp),events=events.concat(song.events),events.sort(function(a,b){return a.sortIndex-b.sortIndex}),song.eventsMidiAudioMetronome=[].concat(events)}function parseParts(song,parts){var i,part;for(i=parts.length-1;i>=0;i--)part=parts[i],part.startPosition=song.getPosition("ticks",part.start.ticks),part.endPosition=song.getPosition("ticks",part.end.ticks),part.start.millis=part.startPosition.millis,part.end.millis=part.endPosition.millis,part.duration.millis=part.end.millis-part.start.millis,part.state="clean"}function parseMidiNotes(song,notes){var i,note;for(i=notes.length-1;i>=0;i--)note=notes[i],!0===note.endless?(note.durationTicks=sequencer.ticks-note.noteOn.ticks,note.durationMillis=sequencer.millis-note.noteOn.millis):(note.durationTicks=note.noteOff.ticks-note.noteOn.ticks,note.durationMillis=note.noteOff.millis-note.noteOn.millis),note.ticks=note.noteOn.ticks,note.millis=note.noteOn.millis,note.number=note.noteOn.noteNumber,note.state="clean"}function parseRecordedEvents(song,events){var i,timeData,position,event,time,timestamp=song.recordTimestamp,startMillis=song.recordStartMillis,totalTime=startMillis,maxi=events.length,playhead=song.playheadRecording;for(playhead.set("millis",startMillis),i=0;i<maxi;i++)event=events[i],time=event.recordMillis-timestamp+startMillis,position=playhead.update("millis",time-totalTime),totalTime=time,timeData=sequencer.getNiceTime(position.millis),event.ticks=position.ticks,event.bpm=position.bpm,event.factor=position.factor,event.nominator=position.nominator,event.denominator=position.denominator,event.ticksPerBar=position.ticksPerBar,event.ticksPerBeat=position.ticksPerBeat,event.ticksPerSixteenth=position.ticksPerSixteenth,event.numSixteenth=position.numSixteenth,event.millisPerTick=position.millisPerTick,event.secondsPerTick=position.secondsPerTick,event.millis=position.millis,event.seconds=position.millis/1e3,event.hour=timeData.hour,event.minute=timeData.minute,event.second=timeData.second,event.millisecond=timeData.millisecond,event.timeAsString=timeData.timeAsString,event.timeAsArray=timeData.timeAsArray,event.bar=position.bar,event.beat=position.beat,event.sixteenth=position.sixteenth,event.tick=position.tick,event.barsAsString=position.bar+":"+position.beat+":"+position.sixteenth+":"+position.tick,event.barsAsArray=[position.bar,position.beat,position.sixteenth,position.tick],event.state="clean";song.recordStartMillis=void 0,song.recordTimestamp=void 0}var getPosition,parseTimeEvents,parseEvents,getInstrument,scheduledTasks,update,update2,sequencer=window.sequencer;window.console;update=function(song,updateTimeEvents){if(!0===sequencer.playing)return void(scheduledTasks.updateSong=function(){update2(song,updateTimeEvents)});update2(song,updateTimeEvents)},update2=function(song,updateTimeEvents){var i,id1,id2,id3,tmp,track,part,event,note,dirtyEvents,dirtyNotes,newEvents=[],changedEvents=[],removedEvents=[],recordedEvents=[],newNotes=[],changedNotes=[],removedNotes=[],newParts=[],changedParts=[],removedParts=[],newTracks=[],changedTracks=[],removedTracks=[],eventsMidiAudioMetronome=[],eventsMidiTime=[],events=[],midiEvents=[],audioEvents=[],notes=[],parts=[],tracks=[],eventsById={},notesById={},partsById={};!0===updateTimeEvents&&parseTimeEvents(song);for(id1 in song.tracksById)if(song.tracksById.hasOwnProperty(id1)){track=song.tracksById[id1],!0===track.needsUpdate&&track.update();for(id2 in track.partsById)if(track.partsById.hasOwnProperty(id2)){part=track.partsById[id2],!0===part.needsUpdate&&part.update(),dirtyEvents=part.dirtyEvents;for(id3 in dirtyEvents)if(dirtyEvents.hasOwnProperty(id3))switch(event=dirtyEvents[id3],event.state){case"new":newEvents.push(event);break;case"recorded":recordedEvents.push(event);break;case"changed":changedEvents.push(event);break;case"removed":removedEvents.push(event),delete part.eventsById[id3]}dirtyNotes=part.dirtyNotes;for(id3 in dirtyNotes)if(dirtyNotes.hasOwnProperty(id3))switch(note=dirtyNotes[id3],note.state){case"new":newNotes.push(note);break;case"changed":changedNotes.push(note);break;case"removed":removedNotes.push(note),delete part.notesById[id3]}switch(part.dirtyEvents={},part.dirtyNotes={},"removed"!==part.state?(notes=notes.concat(part.notes),events=events.concat(part.events)):(removedNotes=removedNotes.concat(part.notes),removedEvents=removedEvents.concat(part.events)),part.state){case"new":newParts.push(part),partsById[part.id]=part;break;case"changed":changedParts.push(part),partsById[part.id]=part;break;case"removed":removedParts.push(part),delete track.partsById[part.id]}}switch(parts=parts.concat(track.parts),track.state){case"clean":track.index=tracks.length,tracks.push(track);break;case"new":newTracks.push(track),track.state="clean",track.index=tracks.length,tracks.push(track);break;case"changed":changedTracks.push(track),track.state="clean",track.index=tracks.length,tracks.push(track);break;case"removed":removedTracks.push(track),delete song.tracksById[track.id]}}for(i=removedEvents.length-1;i>=0;i--)event=removedEvents[i],event.state="clean";for(i=removedNotes.length-1;i>=0;i--)note=removedNotes[i],note.state="clean";for(i=removedParts.length-1;i>=0;i--)part=removedParts[i],part.state="clean";for(recordedEvents.length>0&&parseRecordedEvents(song,recordedEvents),events.sort(function(a,b){return a.sortIndex-b.sortIndex}),notes.sort(function(a,b){return a.ticks-b.ticks}),parts.sort(function(a,b){return a.ticks-b.ticks}),i=events.length-1;i>=0;i--)event=events[i],eventsById[event.id]=event,"audio"===event.type?audioEvents.push(event):midiEvents.push(event);for(i=notes.length-1;i>=0;i--)note=notes[i],notesById[note.id]=note;!1===updateTimeEvents?(tmp=song.timeEvents.concat(newEvents,changedEvents),parseEvents(song,tmp),tmp=[].concat(newNotes,changedNotes),parseMidiNotes(song,tmp),tmp=[].concat(newParts,changedParts),parseParts(song,tmp)):(tmp=song.timeEvents.concat(events),parseEvents(song,tmp),parseMidiNotes(song,notes),parseParts(song,parts)),checkDuration(song),song.metronome.bars!==song.bars?song.metronome.update():!0===updateTimeEvents&&song.metronome.update(),eventsMidiAudioMetronome=[].concat(midiEvents,audioEvents,song.metronome.events),eventsMidiAudioMetronome.sort(function(a,b){return a.ticks-b.ticks}),eventsMidiTime=[].concat(events,song.timeEvents),eventsMidiTime.sort(function(a,b){return a.ticks-b.ticks}),song.eventsMidiAudioMetronome=eventsMidiAudioMetronome,song.eventsMidiTime=eventsMidiTime,song.events=events,song.midiEvents=midiEvents,song.audioEvents=audioEvents,song.notes=notes,song.parts=parts,song.tracks=tracks,song.numEvents=events.length,song.numNotes=notes.length,song.numParts=parts.length,song.numTracks=tracks.length,song.eventsById=eventsById,song.notesById=notesById,song.partsById=partsById,song.newEvents=newEvents,song.changedEvents=changedEvents,song.removedEvents=removedEvents,song.newNotes=newNotes,song.changedNotes=changedNotes,song.removedNotes=removedNotes,song.newParts=newParts,song.changedParts=changedParts,song.removedParts=removedParts,song.playhead.updateSong(),song.playheadRecording.updateSong(),song.scheduler.updateSong(),song.scheduler.reschedule(),song.followEvent.updateSong(),void 0!==song.grid&&song.grid.update(),void 0!==song.keyEditor&&song.keyEditor.updateSong({numBars:song.bars,newEvents:newEvents,changedEvents:changedEvents,removedEvents:removedEvents,newNotes:newNotes,changedNotes:changedNotes,removedNotes:removedNotes,newParts:newParts,changedParts:changedParts,removedParts:removedParts})},sequencer.protectedScope.update=update,sequencer.protectedScope.checkDuration=checkDuration,sequencer.protectedScope.parseMetronomeEvents=parseMetronomeEvents,sequencer.protectedScope.addInitMethod(function(){getPosition=sequencer.protectedScope.getPosition,parseEvents=sequencer.protectedScope.parseEvents,parseTimeEvents=sequencer.protectedScope.parseTimeEvents,getInstrument=sequencer.protectedScope.getInstrument,scheduledTasks=sequencer.protectedScope.scheduledTasks})}(),function(){"use strict";function getPart(data,track){var part=!1;return data?"Part"===data.className?part=data:"string"===typeString(data)?part=track.partsById[data]:!1===isNaN(data)&&(part=track.parts[data]):part=!1,part}function getEvent(data,track){var event=!1;return data?"MidiEvent"===data.className||"AudioEvent"===data.className?event=data:"array"===typeString(data)&&4===data.length?event=createMidiEvent(data):"string"===typeString(data)?event=track.eventsById[data]:!1===isNaN(data)&&(event=track.events[data]):event=!1,event}function getPartsAndConfig(args,track){args=Array.prototype.slice.call(args);var maxi,part,arg,j=0,i=0,arg0=args[0],parts=[],config=[];if("array"===typeString(arg0)){for(i=arg0.length-1;i>=0;i--)arg=arg0[i],(part=getPart(arg,track))&&parts.push(part);j=0===parts.length?0:1}for(maxi=args.length,i=j;i<maxi;i++)arg=args[i],part=getPart(arg,track),part?parts.push(part):config.push(arg);return 0===parts.length?(console.warn("no parts added"),!1):{parts:parts,config:config}}function getEventsAndConfig(args,track){args=Array.prototype.slice.call(args);var maxi,event,arg,j=0,i=0,arg0=args[0],events=[],config=[];if("array"===typeString(arg0)){for(i=arg0.length-1;i>=0;i--)arg=arg0[i],(event=getEvent(arg,track))&&events.push(event);j=1}for(maxi=args.length,i=j;i<maxi;i++)arg=args[i],event=getEvent(arg,track),event?events.push(event):config.push(arg);return 0===events.length&&debug>=2&&console.info("Please provide one or more events, or an array of events"),1===config.length&&"array"===typeString(config[0])&&(config=config[0]),{events:events,config:config}}function getTicksAtPosition(position,song){var type,ticks;if(!1===(position=checkPosition(position)))return!1;if(type=position[0],void 0===song&&"ticks"!==type)return console.error("Track has not been added to a song yet, you can only use tick values"),!1;switch(type){case"ticks":ticks=position[1];break;case"millis":ticks=song.millisToTicks(position[1]);break;case"barsbeats":case"barsandbeats":case"time":position=song.getPosition(position,"ticks"),ticks=position.ticks}return ticks}function addParts(args,track){if(!1!==args){var i,j,e,part,eventsById,ticks,move,song=track.song,parts=args.parts,maxi=parts.length,partsById=track.partsById;for(i=0;i<maxi;i++)if(!1!==(part=getPart(parts[i]))){void 0!==part.track&&(part=part.copy()),part.hasAudioEvents&&void 0===track.audio&&(track.audio=createAudioTrack(track)),part.song=song,part.track=track,part.trackId=track.id,eventsById=part.eventsById,ticks=part.ticks,move=0!==ticks;for(j in eventsById)eventsById.hasOwnProperty(j)&&(e=eventsById[j],e.track=track,e.channel=track.channel,e.trackId=track.id,move&&(e.ticks+=ticks),e.state="new");part.state="new",part.needsUpdate=!0,partsById[part.id]=part}else console.error(part,"is not a part");track.needsUpdate=!0}}function moveParts(args,track){if(!1!==args){var newTicks,part,i,parts=args.parts,ticks=args.config[0],diffTicks=ticks;for(i=parts.length-1;i>=0;i--)part=parts[i],newTicks=part.ticks+ticks,newTicks<0&&(newTicks=0,diffTicks=-part.ticks),part.ticks=newTicks,part.moveEvents(part.events,diffTicks),"new"!==part.state&&(part.state="changed");track.needsUpdate=!0}}function movePartsTo(args,track){if(!1!==args){var i,part,ticks,diffTicks,song=track.song,parts=args.parts,positions=args.config;for(i=parts.length-1;i>=0;i--)part=parts[i],ticks=getTicksAtPosition(positions[i],song),!1!==ticks?(diffTicks=ticks-part.ticks,part.ticks=ticks,part.moveAllEvents(diffTicks),"new"!==part.state&&(part.state="changed")):console.warn("wrong position data, skipping part",part.id);track.needsUpdate=!0}}function removeParts(args,track){if(!1===args)return[];var i,part,removed=[],tobeRemoved=args.parts;if(void 0===tobeRemoved)return console.log("weird situation, check this when it happens"),[];for(i=tobeRemoved.length-1;i>=0;i--)part=tobeRemoved[i],void 0===part.track||part.track===track?(removed.push(part),part.state="removed",part.reset(!0,!0)):console.warn("can't remove: this part belongs to track",part.track.id);return track.needsUpdate=!0,removed}function removeEvents(args,track){if(!1!==args){var i,part,partId,event,eventsPerPart={},removed=[],tobeRemoved=args;for(i=tobeRemoved.length-1;i>=0;i--)event=tobeRemoved[i],void 0===event.track||event.track===track?(partId=event.partId,void 0===eventsPerPart[partId]&&(eventsPerPart[partId]=[]),eventsPerPart[partId].push(event),removed.push(event)):console.warn("can't remove: this event belongs to track",event.track.id);for(partId in eventsPerPart)eventsPerPart.hasOwnProperty(partId)&&(part=track.partsById[partId],part.removeEvents(eventsPerPart[partId]));return track.needsUpdate=!0,removed}}function getDefaultInstrumentConfig(track){var config;return void 0!==track.song&&void 0!==track.song.defaultInstrument&&(config=findItem(track.song.defaultInstrument,sequencer.storage.instruments)),!1!==config&&void 0!==config||(config=findItem(sequencer.defaultInstrument,sequencer.storage.instruments)),config}var createPart,typeString,copyName,findItem,objectForEach,checkPosition,createMidiEvent,createMidiNote,context,createInstrument,createAudioTrack,createPanner,addMidiEventListener,removeMidiEventListener,encodeAudio,handleMidiMessageTrack,findEvent,findNote,getStats,Track,sequencer=window.sequencer,console=window.console,debug=sequencer.debug,slice=Array.prototype.slice,trackId=0;Track=function(name,type,song){this.className="Track",this.id="T"+trackId+++(new Date).getTime(),this.type=type||"instrument",this.name=name||this.id,this.song=song,this.instrumentName="",this.events=[],this.eventsById={},this.notes=[],this.notesById={},this.parts=[],this.partsById={},this.numParts=0,this.numEvents=0,this.needsUpdate=!1,this.audioLatency=0,this.effects={},this.numEffects=0,this.volume=1,this.input=context.createGainNode(),this.input.gain.value=1,this.output=context.createGainNode(),this.output.gain.value=this.volume,this.panner=createPanner(),this.input.connect(this.panner.node),this.panner.node.connect(this.output),this.lastEffect=this.input,this.midiInputs={},this.midiOutputs={},this.routeToMidiOut=!1,this.midiEventListeners={},this.monitor=!1,this.recordEnabled=!1,this.mute=!1,this.solo=!1,this.channel="any",this.quantizeValue=0,this.fixedLengthValue=0,this.autoQuantize=!1,this.retrospectiveRecording=[],this.recordingNotes={},this.enableRetrospectiveRecording=!1,"metronome"!==type&&this.setInstrument(this.instrumentName)},Track.prototype.addPart=Track.prototype.addParts=function(){addParts(getPartsAndConfig(arguments,this),this)},Track.prototype.addPartAt=Track.prototype.addPartsAt=function(){var config,parts,i,part,ticks,args=getPartsAndConfig(arguments,this);if(!1!==args){if(parts=args.parts,void 0===(config=args.config))return console.error("please provide position data"),!1;for(i=parts.length-1;i>=0;i--)part=parts[i],!1!==(ticks="ticks"===config[0]?config[1]:getTicksAtPosition(config[i],this.song))&&(part.ticks+=ticks);addParts(args,this)}},Track.prototype.movePart=Track.prototype.moveParts=function(){moveParts(getPartsAndConfig(arguments,this),this)},Track.prototype.movePartTo=Track.prototype.movePartsTo=function(){movePartsTo(getPartsAndConfig(arguments,this),this)},Track.prototype.moveAllParts=function(ticks){this.moveParts({parts:this.parts,config:[ticks]})},Track.prototype.copyPart=Track.prototype.copyParts=function(){var selectedParts,args=getPartsAndConfig(arguments,this),copiedParts=[];if(!1!==args)return 0===selectedParts.length?void console.error("no parts"):(selectedParts=args.parts,selectedParts.forEach(function(part){copiedParts.push(part.copy())}),1===copiedParts.length?copiedParts[0]:copiedParts)},Track.prototype.removePart=function(){var args=getPartsAndConfig(arguments,this),removed=removeParts(args,this);return 1===removed.length?removed[0]:removed},Track.prototype.removeParts=function(){return removeParts(getPartsAndConfig(arguments,this),this)},Track.prototype.getPart=function(arg){return getPart(arg)},Track.prototype.getParts=function(){var arg,loop,args=Array.prototype.slice.call(arguments),result=[];return loop=function(data,i){arg=data[i],"array"===typeString(arg)?loop(arg,0):result.push(getPart(arg))},loop(args,0),result},Track.prototype.getPartAt=Track.prototype.getPartsAt=function(position){var ticks=getTicksAtPosition(position,this.song),parts=this.parts,selectedParts=[];return!1===ticks?void console.error("please provide position as array, for instance: ['barsandbeats',5,1,2,0]"):(parts.forEach(function(part){part.ticks===ticks&&selectedParts.push(part)}),selectedParts)},Track.prototype.getPartFromTo=Track.prototype.getPartsFromTo=function(from,to){var parts=this.parts,selectedParts=[],fromTicks=getTicksAtPosition(from,this.song),toTicks=getTicksAtPosition(to,this.song);return!1===fromTicks?void console.error("invalid position data for from position"):!1===toTicks?void console.error("invalid position data for from position"):(parts.forEach(function(part){(fromTicks>=part.start.ticks&&fromTicks<=part.end.ticks||toTicks>=part.start.ticks&&toTicks<=part.end.ticks)&&selectedParts.push(part)}),selectedParts)},Track.prototype.getPartBetween=Track.prototype.getPartBetween=function(from,to){var parts=this.parts,selectedParts=[],fromTicks=getTicksAtPosition(from,this.song),toTicks=getTicksAtPosition(toTicks,this.song);return!1===fromTicks||!1===toTicks?void console.error("please provide position as array, for instance: ['barsandbeats',5,1,2,0]"):(parts.forEach(function(part){part.start.ticks>=fromTicks&&part.end.ticks<=toTicks&&selectedParts.push(part)}),selectedParts)},Track.prototype.copy=function(){var part,i,effect,track=new Track(copyName(this.name)),parts=this.parts,copiedParts=[];if(track.song=null,track.instrumentId=this.instrumentId,track.numEffects=this.numEffects,this.numEffects>0){track.effects={};for(i in this.effects)this.effects.hasOwnProperty(i)&&(effect=this.effects[i],track.effects[effect.id]=effect.copy())}for(i=parts.length-1;i>=0;i--)part=parts[i],copiedParts.push(part.copy());return track.addParts(copiedParts),track},Track.prototype.removeEvent=Track.prototype.removeEvents=function(){removeEvents(getEventsAndConfig(arguments,this).events,this)},Track.prototype.removeEventsFromTo=function(from,to){console.warn("removeEventsFromTo() is temporarily disabled")},Track.prototype.removeEventAt=Track.prototype.removeEventsAt=function(position){console.warn("removeEventAt() is temporarily disabled")},Track.prototype.removeAllEvents=function(){removeEvents(this.events,this)},Track.prototype.transposePart=function(part,semi){var stats=part.getStats("noteNumber all"),min=0,max=127;return this.song&&(min=this.song.lowestNote,max=this.song.highestNote),stats.min+semi<min?void(min-stats.min):stats.max+semi>max?void(max=stats.max):void part.transposeAllEvents(semi)},Track.prototype.reset=function(){var id,part;this.song=null,this.audio&&this.audio.setSong(null);for(id in this.partsById)this.partsById.hasOwnProperty(id)&&(part=this.partsById[id],part.reset(!1,!0));this.needsUpdate=!0},Track.prototype.findEvent=function(pattern){return findEvent(this,pattern)},Track.prototype.findNote=function(pattern){return findNote(this,pattern)},Track.prototype.getStats=function(pattern){return getStats(this,pattern)},Track.prototype.update=function(){this.parts=[],this.notes=[],this.events=[];var i,id,part,event,events,note;for(id in this.partsById)if(this.partsById.hasOwnProperty(id)){if(part=this.partsById[id],!0===part.needsUpdate&&part.update(),0===part.events.length&&!1===part.keepWhenEmpty&&this.removePart(part),"new"===part.state&&void 0!==this.song)for(events=part.events,i=events.length-1;i>=0;i--)event=events[i],event.song=this.song;"removed"!==part.state&&(this.parts.push(part),this.notes=this.notes.concat(part.notes),this.events=this.events.concat(part.events))}for(this.parts.sort(function(a,b){return a.ticks-b.ticks}),this.notes.sort(function(a,b){return a.ticks-b.ticks}),this.events.sort(function(a,b){return a.sortIndex-b.sortIndex}),this.numEvents=this.events.length,this.numNotes=this.notes.length,this.numParts=this.parts.length,i=this.numEvents-1;i>=0;i--)event=this.events[i],this.eventsById[event.id]=event;for(i=this.numNotes-1;i>=0;i--)note=this.notes[i],this.notesById[note.id]=note;this.needsUpdate=!1},Track.prototype.getIndex=function(){var track,i,index=-1,tracks=this.song.tracks,numTracks=tracks.length;if(numTracks>0)for(i=0;i<numTracks;i++)if(track=tracks[i],track.id===this.id){index=i;break}return index},Track.prototype.addEffect=function(effect,position){effect&&(this.effects[effect.id]=effect,this.numEffects++,void 0!==this.lastEffect&&(this.lastEffect.disconnect(0),effect.setInput(this.lastEffect)),effect.output.connect(this.panner.node),this.lastEffect=effect.output)},Track.prototype.removeEffect=function(effect){!1!==effect&&(delete this.effects[effect.id],this.numEffects--)},Track.prototype.setEffectPosition=function(effect,position){var i,fx,maxi=this.numEffects-1;if(!(position<0||position>maxi))for(effect.position=position,i=0;i<maxi-1;i++)fx=this.effects[i],fx.position>=position&&fx!==effect&&(fx.position+=1)},Track.prototype.setSolo=function(flag){void 0===flag&&(flag=!this.solo),this.mute=!1,this.solo=flag,this.song&&this.song.setTrackSolo(this,flag)},Track.prototype.setPartSolo=function(soloPart,flag){var i,part;for(i=this.numParts-1;i>=0;i--)part=this.parts[i],!0===flag?part.mute=part===soloPart?!flag:flag:!1===flag&&(part.mute=!1),part.solo=part===soloPart&&flag},Track.prototype.setVolume=function(value){isNaN(value)?sequencer.debug>=1&&console.error("please pass a number"):value<0||value>1?sequencer.debug>=1&&console.error("please pass a float between 0 and 1"):(this.volume=value,this.input.gain.value=this.volume)},Track.prototype.getVolume=function(){return this.volume},Track.prototype.setPanning=function(value){this.panner.setPosition(value)},Track.prototype.connect=function(node){this.output.connect(node)},Track.prototype.disconnect=function(node){this.output.disconnect(0)},Track.prototype.setInstrument=function(arg){""!==arg&&void 0!==arg&&!1!==arg||(arg=getDefaultInstrumentConfig(this));var instrument=createInstrument(arg);!1===instrument&&(instrument=createInstrument(getDefaultInstrumentConfig(this))),instrument.track=this,this.instrument&&this.instrument.allNotesOff(),this.instrument=instrument,this.instrumentId=instrument.name,this.song&&(this.instrument.song=this.song)},Track.prototype.setMidiInput=function(id,flag){var input,availableInputs,midiInputs=this.midiInputs;if(flag=void 0===flag||flag,"all"===id)return availableInputs=void 0!==this.song?this.song.midiInputs:sequencer.midiInputs,void objectForEach(availableInputs,function(value,key){!0===flag?midiInputs[key]=value:delete midiInputs[key]});void 0!==(input=this.song.midiInputs[id])&&(flag?this.midiInputs[id]=input:delete this.midiInputs[id])},Track.prototype.setMidiOutput=function(id,flag){flag=void 0===flag||flag;var output=this.song.midiOutputs[id],me=this;void 0!==output&&(!0===flag&&this.instrument.allNotesOff(),flag?this.midiOutputs[id]=output:delete this.midiOutputs[id],this.routeToMidiOut=!1,objectForEach(this.midiOutputs,function(value,key){!1!==value&&(me.routeToMidiOut=!0)}))},Track.prototype.prepareForRecording=function(recordId,callback){"midi"!==this.recordEnabled&&"audio"!==this.recordEnabled||(this.recordPart=sequencer.createPart(),this.addPart(this.recordPart),this.recordingNotes={},this.recordId=recordId,"audio"===this.recordEnabled&&(void 0===this.audio&&(this.audio=createAudioTrack(this)),this.audio.prepareForRecording(recordId,callback)))},Track.prototype.stopRecording=function(recordId,callback){if(this.recordId===recordId)if(this.recordingNotes={},(this.autoQuantize||this.song.autoQuantize)&&(debug>=1&&console.log("performing auto quantize"),this.quantizeRecording()),"midi"===this.recordEnabled)this.recordPart.update(),callback(this.recordPart.events);else if("audio"===this.recordEnabled){var scope=this;this.audio.stopRecording(function(recording){var event=sequencer.createAudioEvent({ticks:scope.song.recordTimestampTicks,buffer:recording.audioBuffer,sampleId:recording.id});scope.recordPart.addEvent(event),scope.recordPart.update(),callback([event])})}},Track.prototype.undoRecording=function(data){var type=typeString(data);"string"===type?this.recordId===data&&this.removePart(this.recordPart):"array"===type&&this.removeEvents(data)},Track.prototype.setWaveformConfig=function(config){this.waveformConfig=config,void 0!==this.audio&&(this.audio.recorder.waveformConfig=config)},Track.prototype.getAudioRecordingData=function(recordId){
if(void 0!==this.audio)return void 0===recordId?(sequencer.debug>=sequencer.WARN&&console.warn("please provide a recording id"),!1):sequencer.storage.audio.recordings[recordId]},Track.prototype.encodeAudioRecording=function(recordId,type,bitrate,callback){if(void 0!==this.audio){if(void 0===recordId)return sequencer.debug>=sequencer.WARN&&console.warn("please provide a recording id"),void(callback&&callback(!1));var recording=sequencer.storage.audio.recordings[recordId];encodeAudio(recording.audioBuffer,type,bitrate,function(mp3Data){recording.mp3=mp3Data,callback(recording)})}},Track.prototype.setAudioRecordingLatency=function(recordId,value,callback){void 0!==this.audio&&this.audio.setAudioRecordingLatency(recordId,value,function(recording){var i,event,sampleId,audioEvents=this.song.audioEvents;for(i=audioEvents.length-1;i>=0;i--)event=audioEvents[i],void 0!==(sampleId=event.sampleId)&&recordId===sampleId&&(event.buffer=recording.audioBuffer);void 0!==callback&&callback()})},Track.prototype.quantizeRecording=function(value){return value=value||this.quantizeValue,sequencer.quantize(this.recordPart.events,value,this.song.ppq)},Track.prototype.quantize=function(){var i,arg,type,value,args=slice.call(arguments),numArgs=args.length;for(i=0;i<numArgs;i++)arg=args[i],type=typeString(arg),"string"===type||"number"===type?value=arg:"object"===type&&arg;return void 0===value&&(value=this.quantizeValue),sequencer.quantize(this.events,value,this.song.ppq,history)},Track.prototype.undoQuantize=function(history){if(void 0===history)return void(sequencer.debug>=2&&console.warn("please pass a quantize history object"));var i,event,events=history.tracks[this.id].quantizedEvents,numEvents=events.length;for(i=0;i<numEvents;i++)event=events[i],event.ticks=history.events[event.id].ticks},Track.prototype.addMidiEventListener=function(){return addMidiEventListener(arguments,this)},Track.prototype.removeMidiEventListener=function(id){removeMidiEventListener(id,this)},Track.prototype.allNotesOff=function(id){this.audio&&this.audio.allNotesOff(),this.instrument&&this.instrument.allNotesOff()},Track.prototype.processMidiEvent=function(event){handleMidiMessageTrack(event,this)},sequencer.protectedScope.Track=Track,sequencer.createTrack=function(name,type,song){return new Track(name,type,song)},sequencer.protectedScope.addInitMethod(function(){var protectedScope=sequencer.protectedScope;getStats=sequencer.getStats,findEvent=sequencer.findEvent,findNote=sequencer.findNote,createPart=sequencer.createPart,createMidiEvent=sequencer.createMidiEvent,createMidiNote=sequencer.createMidiNote,createInstrument=sequencer.createInstrument,createPanner=sequencer.createPanner,encodeAudio=sequencer.encodeAudio,context=protectedScope.context,findItem=protectedScope.findItem,addMidiEventListener=protectedScope.addMidiEventListener,removeMidiEventListener=protectedScope.removeMidiEventListener,createAudioTrack=sequencer.protectedScope.createAudioTrack,checkPosition=protectedScope.checkPosition,objectForEach=protectedScope.objectForEach,typeString=protectedScope.typeString,copyName=protectedScope.copyName,handleMidiMessageTrack=protectedScope.handleMidiMessageTrack})}(),function(){"use strict";function typeString(o){return"object"!=typeof o?typeof o:null===o?"null":Object.prototype.toString.call(o).match(/\[object\s(\w+)\]/)[1].toLowerCase()}function getNiceTime(millis){var h,m,s,ms,seconds,timeAsString="";return seconds=millis/1e3,h=floor(seconds/3600),m=floor(seconds%3600/60),s=floor(seconds%60),ms=round(1e3*(seconds-3600*h-60*m-s)),timeAsString+=h+":",timeAsString+=m<10?"0"+m:m,timeAsString+=":",timeAsString+=s<10?"0"+s:s,timeAsString+=":",timeAsString+=0===ms?"000":ms<10?"00"+ms:ms<100?"0"+ms:ms,{hour:h,minute:m,second:s,millisecond:ms,timeAsString:timeAsString,timeAsArray:[h,m,s,ms]}}function clone(obj){var attr,copy;if(null===obj||"object"!=typeof obj)return obj;copy=obj.constructor();for(attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=clone(obj[attr]));return copy}function copyObject(obj){var prop,copy={};if("object"!==typeString(obj))return{};for(prop in obj)obj.hasOwnProperty(prop)&&(copy[prop]=obj[prop]);return copy}function copyName(name){var copy,numCopies,i=name.indexOf("_copy");return-1===i?copy=name+"_copy":(numCopies=name.substring(i+5),copy=""===numCopies?name+"2":name.slice(0,-1)+(parseInt(numCopies,10)+1)),copy}function removeFromArray(tobeRemoved,array){var i,j,maxi,maxj,remove,elementA,elementB,newArray=[];for("array"!==typeString(tobeRemoved)&&(tobeRemoved=[tobeRemoved]),maxi=array.length,maxj=tobeRemoved.length,i=0;i<maxi;i++){for(elementA=array[i],remove=!1,j=0;j<maxj;j++)if(elementB=tobeRemoved[j],elementA===elementB){remove=!0;break}!1===remove&&newArray.push(elementA)}return newArray}function removeFromArray2(array,callback){var i,element,maxi=array.length,newArray=[];for(i=0;i<maxi;i++)element=array[i],!1===callback(element)&&newArray.push(element);return newArray}function round(value,decimals){if(void 0===decimals||decimals<=0)return mRound(value);var p=mPow(10,decimals);return mRound(value*p)/p}function floor(value,decimals){if(void 0===decimals||decimals<=0)return mFloor(value);var p=mPow(10,decimals);return mFloor(value*p)/p}function isEmptyObject(obj,ignore_keys){if(void 0===obj)return!1;var i,isEmpty=!0;ignore_keys=ignore_keys||"";for(i in obj)if(obj.hasOwnProperty(i)&&-1===ignore_keys.indexOf(i)){isEmpty=!1;break}return isEmpty}function objectForEach(o,cb){var name,obj=o;for(name in obj)obj.hasOwnProperty(name)&&cb(obj[name],name)}function objectToArray(obj){var i,a=[];for(i in obj)obj.hasOwnProperty(i)&&a.push(obj[i]);return a}function arrayToObject(arr,property){var i,o={};for(i=arr.length-1;i>=0;i--)o[arr[i][property]]=arr[i];return o}function createClass(parent,constructor){var thisClass;return thisClass=function(){this.parent=parent,arguments.length>0&&(parent.apply(this,arguments),void 0!==constructor&&constructor.apply(this,arguments))},thisClass.prototype=Object.create(parent.prototype),thisClass}function ajax(config){function executor(resolve,reject){reject=reject||function(){},resolve=resolve||function(){},request.onload=function(){if(200!==request.status)return void reject(request.status);"json"===config.responseType?(fileSize=request.response.length,resolve(JSON.parse(request.response),fileSize)):resolve(request.response)},request.onerror=function(e){config.onError(e)},request.open(method,config.url,!0),config.overrideMimeType&&request.overrideMimeType(config.overrideMimeType),config.responseType&&("json"===config.responseType?request.responseType="text":request.responseType=config.responseType),"POST"===method&&request.setRequestHeader("Content-type","application/x-www-form-urlencoded"),config.data?request.send(config.data):request.send()}var fileSize,promise,request=new XMLHttpRequest,method=void 0===config.method?"GET":config.method;if(promise=new Promise(executor),void 0===config.onSuccess)return promise;promise.then(config.onSuccess,config.onError)}function ajax2(config){var fileSize,request=new XMLHttpRequest,method=void 0===config.method?"GET":config.method;request.onreadystatechange=function(){404===request.request&&config.onError(404)},request.onload=function(){if(200!==request.status)return void config.onError(request.status);"json"===config.responseType?(fileSize=request.response.length,config.onSuccess(JSON.parse(request.response),fileSize)):config.onSuccess(request.response)},request.onerror=function(e){config.onError(e)},request.open(method,config.url,!0),config.overrideMimeType&&request.overrideMimeType(config.overrideMimeType),config.responseType&&("json"===config.responseType?request.responseType="text":request.responseType=config.responseType),"POST"===method&&request.setRequestHeader("Content-type","application/x-www-form-urlencoded"),config.data?request.send(config.data):request.send()}function loop2(root,id,indent){var i,tmp;for(i in root){if(!1!==foundFolder)return;if(root.hasOwnProperty(i)&&void 0!==(tmp=root[i])&&"Folder"===tmp.className){if(i===id)return void(foundFolder=tmp);loop2(tmp,id,indent+".")}}}function loop3(folder,items,search_subfolders,indent){var i,item;for(i in folder)if(folder.hasOwnProperty(i)){if("id"===i||"path"===i||"className"===i)continue;if(void 0===(item=folder[i]))continue;"Folder"===item.className?!0===search_subfolders&&loop3(item,items,search_subfolders,indent+"."):void 0===item.name?items.push({name:i,data:item}):items.push(item)}}function findItemsInFolder(path,root,search_subfolders){search_subfolders=void 0===search_subfolders||search_subfolders;var currentFolder,i,folder,folders=pathToArray(path),numFolders=folders.length,searchFolder=folders[numFolders-1],items=[];if(0===numFolders)loop3(root,items,search_subfolders,".");else{for(currentFolder=root,i=0;i<numFolders&&(folder=folders[i],void 0!==(currentFolder=currentFolder[folder]));i++);currentFolder?loop3(currentFolder,items,search_subfolders,"."):(foundFolder=!1,loop2(root,searchFolder,"."),loop3(foundFolder,items,search_subfolders,"."))}return items.sort(function(a,b){var nameA=a.name.toLowerCase(),nameB=b.name.toLowerCase();return nameA<nameB?-1:nameA>nameB?1:0}),items}function loop(obj,id,indent){var i,tmp;for(i in obj){if(!1!==foundItem)return;if(obj.hasOwnProperty(i)){if(tmp=obj[i],typeString(tmp),i===id){foundItem=tmp;break}void 0!==tmp&&"Folder"===tmp.className&&(indent+=".",loop(tmp,id,indent))}}}function findItem(path,root,exact_match){if(exact_match=void 0!==exact_match&&exact_match,void 0===path||""===path)return root;var i,folder,folders,numFolders,currentFolder,item,itemId;if(folders=pathToArray(path),itemId=folders.pop(),numFolders=folders.length,""===itemId)return root;if(foundItem=!1,folders.length>0){for(currentFolder=root,i=0;i<numFolders&&(folder=folders[i],void 0!==(currentFolder=currentFolder[folder]));i++);currentFolder&&(item=currentFolder[itemId])}return void 0===item&&(!0===exact_match?item=root[itemId]:(loop(root,itemId,"."),item=foundItem)),void 0===item&&(item=!1),item}function storeItem(item,path,root){var folder,folders,numFolders,currentFolder,i,pathString="";for(folders=pathToArray(path),numFolders=folders.length,currentFolder=root,i=0;i<numFolders;i++){if(folder=folders[i],pathString+="/"+folder,void 0===currentFolder[folder]&&(currentFolder[folder]={path:pathString,className:"Folder"}),i===numFolders-1){currentFolder[folder]=item;break}currentFolder=currentFolder[folder]}}function deleteItem(path,root){var item,itemId,i,obj=root;if(!(item=findItem(path,root,!0)))return!1;if("Folder"===item.className)for(i in item)item.hasOwnProperty(i)&&"className"!==i&&delete item[i];for(path=pathToArray(path);path.length>1;){for(i=0,obj=root;i<path.length-1;)obj=obj[path[i++]];itemId=path[i],item=obj[itemId],"Folder"===item.className?isEmptyObject(item,"path className")&&delete obj[itemId]:delete obj[itemId],path.pop()}return 1===path.length&&""!==path[0]&&(itemId=path[0],item=root[itemId],"Folder"===item.className?isEmptyObject(root[itemId],"path className")&&delete root[itemId]:delete root[itemId]),!0}function parseSample(id,sample){return new Promise(function(resolve,reject){try{context.decodeAudioData(sample,function(buffer){resolve({id:id,buffer:buffer})},function(e){console.log("error decoding audiodata",id,e),resolve({id:id,buffer:void 0})})}catch(e){console.log("error decoding audiodata",id,e),resolve({id:id,buffer:void 0})}})}function loadAndParseSample(id,url){return new Promise(function(resolve,reject){ajax({url:url,responseType:"arraybuffer"}).then(function(data){parseSample(id,data).then(resolve,reject)},function(){resolve({id:id,buffer:void 0})})})}function parseSamples(mapping){var key,sample,promises=[];for(key in mapping)mapping.hasOwnProperty(key)&&(sample=mapping[key],-1===sample.indexOf("http://")?promises.push(parseSample(key,base64ToBinary(sample))):promises.push(loadAndParseSample(key,sample)));return new Promise(function(resolve,reject){Promise.all(promises).then(function(values){var mapping={};values.forEach(function(value){mapping[value.id]=value.buffer}),resolve(mapping)},function(e){reject(e)})})}function toBinaryString(input){var t,ff,mx,scc,z;for(t=input||"",ff=[],mx=t.length,scc=String.fromCharCode,z=0;z<mx;z++)ff[z]=scc(255&t.charCodeAt(z));return ff.join("")}function toUint8Array(input){var t,uint,mx,scc,z;for(t=input||"",mx=t.length,uint=new Uint8Array(mx),scc=String.fromCharCode,z=0;z<mx;z++)uint[z]=scc(255&t.charCodeAt(z));return uint}function base64ToBinary(input){var bytes,uarray,buffer,lkey1,lkey2,chr1,chr2,chr3,enc1,enc2,enc3,enc4,i,keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",j=0;for(bytes=Math.ceil(3*input.length/4),buffer=new ArrayBuffer(bytes),uarray=new Uint8Array(buffer),lkey1=keyStr.indexOf(input.charAt(input.length-1)),lkey2=keyStr.indexOf(input.charAt(input.length-1)),64==lkey1&&bytes--,64==lkey2&&bytes--,input=input.replace(/[^A-Za-z0-9\+\/\=]/g,""),i=0;i<bytes;i+=3)enc1=keyStr.indexOf(input.charAt(j++)),enc2=keyStr.indexOf(input.charAt(j++)),enc3=keyStr.indexOf(input.charAt(j++)),enc4=keyStr.indexOf(input.charAt(j++)),chr1=enc1<<2|enc2>>4,chr2=(15&enc2)<<4|enc3>>2,chr3=(3&enc3)<<6|enc4,uarray[i]=chr1,64!=enc3&&(uarray[i+1]=chr2),64!=enc4&&(uarray[i+2]=chr3);return buffer}function pathToArray(path){return void 0===path?[]:(path=path.replace(/undefined/g,""),path=path.replace(/\/{2,}/g,"/"),path=path.replace(/^\//,""),path=path.replace(/\/$/,""),path=path.split("/"))}function parseUrl(url){var slash,dot,ext,filePath="",fileName=url,fileExtension="";return url=url.replace(/\/{2,}/g,"/"),url=url.replace(/^\//,""),url=url.replace(/\/$/,""),slash=url.lastIndexOf("/"),-1!==slash&&(fileName=url.substring(slash+1),filePath=url.substring(0,slash)),dot=url.lastIndexOf("."),-1!==dot&&(ext=url.substring(dot+1),ext.length>=3&&ext.length<=4&&(fileExtension=ext,fileName=url.substring(slash+1,dot))),{path:filePath,name:fileName,ext:fileExtension}}function loadLoop(i,numItems,items,callback1,callback2){if(0===numItems)return void(callback1&&callback1());items[i].load(function(){callback2&&callback2(arguments),i++,i<numItems?loadLoop(i,numItems,items,callback1,callback2):callback1&&callback1()})}function getArguments(args){var loop,arg,result=[];return args=slice.call(args),loop=function(data,i,maxi){for(i=0;i<maxi;i++)arg=data[i],"array"===typeString(arg)?loop(arg,0,arg.length):result.push(arg)},loop(args,0,args.length),result}function getEqualPowerCurve(numSteps,type,maxValue){var i,value,percent,values=new Float32Array(numSteps);for(i=0;i<numSteps;i++)percent=i/numSteps,"fadeIn"===type?value=Math.cos(.5*(1-percent)*Math.PI)*maxValue:"fadeOut"===type&&(value=Math.cos(.5*percent*Math.PI)*maxValue),values[i]=value,i===numSteps-1&&(values[i]="fadeIn"===type?1:0);return values}function remap(value,oldMin,oldMax,newMin,newMax){var oldRange=oldMax-oldMin,newRange=newMax-newMin;return(value-oldMin)*newRange/oldRange+newMin}function filterItemsByClassName(obj,name,result){var i,item;for(i in obj)obj.hasOwnProperty(i)&&(item=obj[i],item.className===name?result.push(item):"object"===typeString(item)&&loop(item,name,result))}function createSlider(config){function onMouseDown(e){var value=slider.valueAsNumber;config.onMouseDown&&config.onMouseDown(value,e),sliderWrapper.onMouseDown&&sliderWrapper.onMouseDown(value,e)}function onMouseUp(e){var value=slider.valueAsNumber;config.onMouseUp&&config.onMouseUp(value,e),sliderWrapper.onMouseUp&&sliderWrapper.onMouseUp(value,e)}function onMouseMove(e){var value=slider.valueAsNumber;config.onMouseMove&&config.onMouseMove(value,e),sliderWrapper.onMouseMove&&sliderWrapper.onMouseMove(value,e)}function onChange(e){var value=slider.valueAsNumber;config.onChange&&config.onChange(value,e),sliderWrapper.onChange&&sliderWrapper.onChange(value,e)}var sliderWrapper,slider=config.slider,message=config.message,label=config.label;return void 0===config.label&&(label=slider.parentNode.firstChild),void 0!==config.initialSliderValue&&(slider.value=config.initialSliderValue),void 0!==config.initialLabelValue&&(label.innerHTML=message.replace("{value}",config.initialLabelValue)),void 0!==config.min&&(slider.min=config.min),void 0!==config.max&&(slider.max=config.max),void 0!==config.step&&(slider.step=config.step),slider.addEventListener("mousedown",function(e){setTimeout(onMouseDown,0,e),slider.addEventListener("mousemove",onMouseMove,!1)},!1),slider.addEventListener("mouseup",function(e){setTimeout(onMouseUp,0,e),slider.removeEventListener("mousemove",onMouseMove,!1)},!1),slider.addEventListener("change",function(e){onChange(e)},!1),sliderWrapper={getValue:function(){return config.getValue?config.getValue(slider.valueAsNumber):slider.valueAsNumber},setValue:function(value){config.setValue?slider.value=config.setValue(value):slider.value=value},setLabel:function(value){label.innerHTML=message.replace("{value}",value)},elem:slider,element:slider},sliderWrapper.set=function(value){setLabel(value),setValue(value)},sliderWrapper}function createSlider2(config){function onMouseMove(){var value=calculate();void 0!==config.onMouseMove&&config.onMouseMove(slider.valueAsNumber,value),label.innerHTML=message.replace("{value}",value)}function onMouseUp(){var value=calculate();void 0!==config.onMouseUp&&config.onMouseUp(slider.valueAsNumber,value),label.innerHTML=message.replace("{value}",value)}function onMouseDown(){var value=calculate();void 0!==config.onMouseDown&&config.onMouseDown(slider.valueAsNumber,value),label.innerHTML=message.replace("{value}",value)}function calculate(){var value=slider.valueAsNumber;return void 0!==config.calculate&&(value=config.calculate(value)),value}function calculateFromLabel(value){return void 0!==config.calculateFromLabel&&(value=config.calculateFromLabel(value)),value}var slider=config.slider,message=config.message,label=slider.parentNode.firstChild;return config.initialValueSlider&&(slider.value=config.initialValueSlider,label.innerHTML=message.replace("{value}",calculate())),config.initialValueLabel&&(label.innerHTML=message.replace("{value}",config.initialValueLabel),slider.value=calculateFromLabel(config.initialValueLabel)),slider.addEventListener("mousedown",function(){setTimeout(onMouseDown,0),slider.addEventListener("mousemove",onMouseMove,!1)},!1),slider.addEventListener("mouseup",function(){setTimeout(onMouseUp,0),slider.removeEventListener("mousemove",onMouseMove,!1)},!1),{updateSlider:function(value){slider.value=value,label.innerHTML=message.replace("{value}",calculate())},updateLabel:function(value){label.innerHTML=message.replace("{value}",value),slider.value=calculateFromLabel(value)},getValue1:function(){return slider.valueAsNumber},getValue2:function(){return calculate(slider.valueAsNumber)}}}function getRandom(min,max,round){var r=mRandom()*(max-min)+min;return!0===round?mRound(r):r}function getRandomNotes(config){var i,midiEvent,velocity,numNotes,noteNumber,noteLength,minVelocity,maxVelocity,minNoteNumber,maxNoteNumber,ppq,ticks=0,events=[];for(config=config||{},ppq=config.ppq||sequencer.defaultPPQ,numNotes=config.numNotes||20,noteLength=config.noteLength||ppq/2,minVelocity=config.minVelocity||30,maxVelocity=config.maxVelocity||127,minNoteNumber=config.minNoteNumber||60,maxNoteNumber=config.maxNoteNumber||127,noteLength>ppq&&(noteLength=ppq),i=0;i<numNotes;i++)noteNumber=getRandom(minNoteNumber,maxNoteNumber,!0),velocity=getRandom(minVelocity,maxVelocity,!0),midiEvent=sequencer.createMidiEvent(ticks,sequencer.NOTE_ON,noteNumber,velocity),events.push(midiEvent),ticks+=noteLength,midiEvent=sequencer.createMidiEvent(ticks,sequencer.NOTE_OFF,noteNumber,0),events.push(midiEvent),ticks+=ppq-noteLength;return events}function convertPPQ(){function convert(events){for(i=events.length-1;i>=0;i--)event=events[i],event.ticks=ratio*event.ticks,"new"!==event.state&&(event.state="changed")}var i,event,args=slice.call(arguments),oldPPQ=args[0],newPPQ=args[1],ratio=newPPQ/oldPPQ;if(isNaN(oldPPQ)||isNaN(newPPQ))return void(4===sequencer.debug&&console.error("PPQ values must be numbers"));!function(data,i,maxi){var arg,type,track,j,t;for(j=i;j<maxi;j++)if(arg=data[j],"array"===(type=typeString(arg)))convert(arg);else if("object"===type)if("Part"===arg.className||"Track"===arg.className||"Song"===arg.className)convert(arg.events);else if("MidiFile"===arg.className)for(t=arg.numTracks-1;t>=0;t--)track=arg.tracks[t],!0===track.needsUpdate&&(track.update(),track.events&&convert(track.events))}(args,2,args.length)}function getNoteLengthName(song,value){for(var divider in noteLengthNames)if(noteLengthNames.hasOwnProperty(divider)&&value===song.ppq/divider)return noteLengthNames[divider];return!1}function getMicrosecondsFromBPM(bpm){return round(6e7/bpm)}function insertLink(s){var href,i=s.indexOf("http://");return-1!==i&&(href=s.substring(i),-1!==(i=href.indexOf(" "))&&(href=href.substring(0,i))),'<a href="'+href+'"></a>'}function getWaveformData(buffer,config,callback){var i,width,density,height,lastWidth,numImages,currentImage,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),pcmRight=buffer.getChannelData(0),numSamples=(buffer.getChannelData(0),pcmRight.length),height=config.height||100,color=config.color||"#71DE71",bgcolor=config.bgcolor||"#000",scale=height/2,sampleStep=config.sampleStep||50,xPos=0,offset=0,urls=[];for(void 0!==config.width?(width=config.width,density=width/numSamples):(density=config.density||1,width=1e3,lastWidth=numSamples*config.density%width,numImages=Math.ceil(numSamples*config.density/width),currentImage=0),canvas.width=width,canvas.height=height,ctx.fillStyle=bgcolor,ctx.fillRect(0,0,width,height),ctx.beginPath(),ctx.strokeStyle=color,ctx.lineWidth=1,ctx.moveTo(0,scale),i=0;i<numSamples;i+=sampleStep)xPos=(i-offset)*density,xPos>=width?(ctx.stroke(),urls.push(canvas.toDataURL("image/png")),currentImage++,canvas.width=currentImage===numImages-1?lastWidth:width,ctx.beginPath(),ctx.strokeStyle=color,offset=i,xPos=0,ctx.moveTo(xPos,scale-pcmRight[i]*scale)):ctx.lineTo(xPos,scale-pcmRight[i]*scale);xPos<width&&(ctx.stroke(),urls.push(canvas.toDataURL("image/png"))),callback(urls)}function encode64(buffer){for(var binary="",bytes=new Uint8Array(buffer),len=bytes.byteLength,i=0;i<len;i++)binary+=String.fromCharCode(bytes[i]);return window.btoa(binary)}function b64ToUint6(nChr){return nChr>64&&nChr<91?nChr-65:nChr>96&&nChr<123?nChr-71:nChr>47&&nChr<58?nChr+4:43===nChr?62:47===nChr?63:0}function base64DecToArr(sBase64,nBlocksSize){for(var nMod3,nMod4,sB64Enc=sBase64.replace(/[^A-Za-z0-9\+\/]/g,""),nInLen=sB64Enc.length,nOutLen=nBlocksSize?Math.ceil((3*nInLen+1>>2)/nBlocksSize)*nBlocksSize:3*nInLen+1>>2,taBytes=new Uint8Array(nOutLen),nUint24=0,nOutIdx=0,nInIdx=0;nInIdx<nInLen;nInIdx++)if(nMod4=3&nInIdx,nUint24|=b64ToUint6(sB64Enc.charCodeAt(nInIdx))<<18-6*nMod4,3===nMod4||nInLen-nInIdx==1){for(nMod3=0;nMod3<3&&nOutIdx<nOutLen;nMod3++,nOutIdx++)taBytes[nOutIdx]=nUint24>>>(16>>>nMod3&24)&255;nUint24=0}return taBytes}function uint6ToB64(nUint6){return nUint6<26?nUint6+65:nUint6<52?nUint6+71:nUint6<62?nUint6-4:62===nUint6?43:63===nUint6?47:65}function base64EncArr(aBytes){for(var nMod3=2,sB64Enc="",nLen=aBytes.length,nUint24=0,nIdx=0;nIdx<nLen;nIdx++)nMod3=nIdx%3,nIdx>0&&4*nIdx/3%76==0&&(sB64Enc+="\r\n"),nUint24|=aBytes[nIdx]<<(16>>>nMod3&24),2!==nMod3&&aBytes.length-nIdx!=1||(sB64Enc+=String.fromCharCode(uint6ToB64(nUint24>>>18&63),uint6ToB64(nUint24>>>12&63),uint6ToB64(nUint24>>>6&63),uint6ToB64(63&nUint24)),nUint24=0);return sB64Enc.substr(0,sB64Enc.length-2+nMod3)+(2===nMod3?"":1===nMod3?"=":"==")}function UTF8ArrToStr(aBytes){for(var nPart,sView="",nLen=aBytes.length,nIdx=0;nIdx<nLen;nIdx++)nPart=aBytes[nIdx],sView+=String.fromCharCode(nPart>251&&nPart<254&&nIdx+5<nLen?1073741824*(nPart-252)+(aBytes[++nIdx]-128<<24)+(aBytes[++nIdx]-128<<18)+(aBytes[++nIdx]-128<<12)+(aBytes[++nIdx]-128<<6)+aBytes[++nIdx]-128:nPart>247&&nPart<252&&nIdx+4<nLen?(nPart-248<<24)+(aBytes[++nIdx]-128<<18)+(aBytes[++nIdx]-128<<12)+(aBytes[++nIdx]-128<<6)+aBytes[++nIdx]-128:nPart>239&&nPart<248&&nIdx+3<nLen?(nPart-240<<18)+(aBytes[++nIdx]-128<<12)+(aBytes[++nIdx]-128<<6)+aBytes[++nIdx]-128:nPart>223&&nPart<240&&nIdx+2<nLen?(nPart-224<<12)+(aBytes[++nIdx]-128<<6)+aBytes[++nIdx]-128:nPart>191&&nPart<224&&nIdx+1<nLen?(nPart-192<<6)+aBytes[++nIdx]-128:nPart);return sView}function strToUTF8Arr(sDOMStr){for(var aBytes,nChr,nStrLen=sDOMStr.length,nArrLen=0,nMapIdx=0;nMapIdx<nStrLen;nMapIdx++)nChr=sDOMStr.charCodeAt(nMapIdx),nArrLen+=nChr<128?1:nChr<2048?2:nChr<65536?3:nChr<2097152?4:nChr<67108864?5:6;aBytes=new Uint8Array(nArrLen);for(var nIdx=0,nChrIdx=0;nIdx<nArrLen;nChrIdx++)nChr=sDOMStr.charCodeAt(nChrIdx),nChr<128?aBytes[nIdx++]=nChr:nChr<2048?(aBytes[nIdx++]=192+(nChr>>>6),aBytes[nIdx++]=128+(63&nChr)):nChr<65536?(aBytes[nIdx++]=224+(nChr>>>12),aBytes[nIdx++]=128+(nChr>>>6&63),aBytes[nIdx++]=128+(63&nChr)):nChr<2097152?(aBytes[nIdx++]=240+(nChr>>>18),aBytes[nIdx++]=128+(nChr>>>12&63),aBytes[nIdx++]=128+(nChr>>>6&63),aBytes[nIdx++]=128+(63&nChr)):nChr<67108864?(aBytes[nIdx++]=248+(nChr>>>24),aBytes[nIdx++]=128+(nChr>>>18&63),aBytes[nIdx++]=128+(nChr>>>12&63),aBytes[nIdx++]=128+(nChr>>>6&63),aBytes[nIdx++]=128+(63&nChr)):(aBytes[nIdx++]=252+(nChr>>>30),aBytes[nIdx++]=128+(nChr>>>24&63),aBytes[nIdx++]=128+(nChr>>>18&63),aBytes[nIdx++]=128+(nChr>>>12&63),aBytes[nIdx++]=128+(nChr>>>6&63),aBytes[nIdx++]=128+(63&nChr));return aBytes}var context,foundItem,foundFolder,sequencer=window.sequencer,console=window.console,slice=Array.prototype.slice,mPow=Math.pow,mRound=Math.round,mFloor=Math.floor,mRandom=Math.random,noteLengthNames={1:"quarter",2:"eighth",4:"sixteenth",8:"32th",16:"64th"};sequencer.protectedScope.addInitMethod(function(){context=sequencer.protectedScope.context}),sequencer.util.b64ToUint6=b64ToUint6,sequencer.util.base64DecToArr=base64DecToArr,sequencer.util.uint6ToB64=uint6ToB64,sequencer.util.base64EncArr=base64EncArr,sequencer.util.UTF8ArrToStr=UTF8ArrToStr,sequencer.util.strToUTF8Arr=strToUTF8Arr,sequencer.util.ajax=ajax,sequencer.util.ajax2=ajax2,sequencer.util.parseSamples=parseSamples,sequencer.util.round=round,sequencer.util.floor=floor,sequencer.util.remap=remap,sequencer.util.getRandom=getRandom,sequencer.util.createSlider=createSlider,sequencer.util.createSlider2=createSlider2,sequencer.util.getRandomNotes=getRandomNotes,sequencer.util.getEqualPowerCurve=getEqualPowerCurve,sequencer.util.objectForEach=objectForEach,sequencer.util.insertLink=insertLink,sequencer.util.encode64=encode64,sequencer.protectedScope.getNoteLengthName=getNoteLengthName,sequencer.protectedScope.toBinaryString=toBinaryString,sequencer.protectedScope.base64ToBinary=base64ToBinary,sequencer.protectedScope.toUint8Array=toUint8Array,sequencer.protectedScope.getArguments=getArguments,sequencer.protectedScope.pathToArray=pathToArray,sequencer.protectedScope.parseUrl=parseUrl,sequencer.protectedScope.loadLoop=loadLoop,sequencer.protectedScope.findItem=findItem,sequencer.protectedScope.storeItem=storeItem,sequencer.protectedScope.deleteItem=deleteItem,sequencer.protectedScope.toBinaryString=toBinaryString,sequencer.protectedScope.ajax=ajax,sequencer.protectedScope.copyObject=copyObject,sequencer.protectedScope.findItemsInFolder=findItemsInFolder,sequencer.convertPPQ=convertPPQ,sequencer.getNiceTime=getNiceTime,sequencer.protectedScope.isEmptyObject=isEmptyObject,sequencer.protectedScope.objectForEach=objectForEach,sequencer.protectedScope.objectToArray=objectToArray,sequencer.protectedScope.arrayToObject=arrayToObject,sequencer.protectedScope.createClass=createClass,sequencer.protectedScope.clone=clone,sequencer.protectedScope.round=round,sequencer.protectedScope.floor=floor,sequencer.protectedScope.typeString=typeString,sequencer.protectedScope.copyName=copyName,sequencer.protectedScope.removeFromArray=removeFromArray,sequencer.protectedScope.removeFromArray2=removeFromArray2,sequencer.protectedScope.filterItemsByClassName=filterItemsByClassName,sequencer.getMicrosecondsFromBPM=getMicrosecondsFromBPM,sequencer.getWaveformData=getWaveformData}(),function(){"use strict";function quantize(events,value,ppq,history){var track;if(value=""+value,value=value.toUpperCase(),ppq=ppq||sequencer.defaultPPQ,0===value)return{};var i,event,ticks,quantized,diff,quantizeTicks,quantizeHistory=history||{};if(void 0===quantizeHistory.events&&(quantizeHistory.events={}),void 0===quantizeHistory.tracks&&(quantizeHistory.tracks={}),void 0===(quantizeTicks=-1!==value.indexOf("TICKS")?parseInt(value.replace(/TICKS/,""),10):noteFractions[value]*ppq))return void(sequencer.debug&&console.warn("invalid quantize value"));for(i=events.length-1;i>=0;i--)event=events[i],quantizeHistory.events[event.id]={event:event,ticks:event.ticks},128!==event.type&&(ticks=event.ticks,quantized=round(ticks/quantizeTicks)*quantizeTicks,diff=quantized-ticks,event.ticks=quantized,event.state="changed",event.part.needsUpdate=!0,event.track.needsUpdate=!0,track=event.track,void 0===quantizeHistory.tracks[track.id]&&(quantizeHistory.tracks[track.id]={track:track,quantizedEvents:[]}),quantizeHistory.tracks[track.id].quantizedEvents.push(event),void 0!==event.midiNote&&(event.midiNote.noteOff.ticks+=diff,event.midiNote.noteOff.state="changed",event.midiNote.state="changed",quantizeHistory.tracks[track.id].quantizedEvents.push(event.midiNote.noteOff)));return quantizeHistory}function fixedLength(events,value,ppq,history){}var copyObject,sequencer=window.sequencer,console=window.console,round=(Math.floor,Math.round),noteFractions={1:4,"1.":6,"1..":7,"1...":7.5,"1T":2/3*4,2:2,"2.":3,"2..":3.5,"2...":3.75,"2T":2/3*2,4:1,"4.":1.5,"4..":1.75,"4...":1.875,"4T":2/3*1,8:.5,"8.":.75,"8..":.875,"8...":.9375,"8T":2/3*1/2,16:.25,"16.":.375,"16..":.4375,"16...":.46875,"16T":2/3*1/4,32:1/8,"32.":.1875,"32..":.21875,"32...":.234375,"32T":2/3*1/8,64:1/16,"64.":.09375,"64..":.109375,"64...":.1171875,"64T":2/3*1/16,128:1/32,"128.":1.5/32,"128..":1.75/32,"128...":1.875/32,"128T":2/3*1/32};sequencer.protectedScope.addInitMethod(function(){copyObject=sequencer.protectedScope.copyObject}),sequencer.quantize=quantize,sequencer.fixedLength=fixedLength}(),function(){"use strict";function testType(base64,type,callback){try{context.decodeAudioData(base64ToBinary(base64),function(){window.sequencer[type]=!0,callback()},function(){callback()})}catch(e){callback()}}var context,initMidi,base64ToBinary,sequencer=window.sequencer,ready=!1,readyCallbacks=[];sequencer.protectedScope.callInitMethods(),context=sequencer.protectedScope.context,initMidi=sequencer.protectedScope.initMidi,base64ToBinary=sequencer.protectedScope.base64ToBinary,delete sequencer.protectedScope,sequencer.ready=function(cb){!0===ready?cb():readyCallbacks.push(cb)},sequencer.addInstrument({name:"sinewave",folder:"heartbeat",autopan:!1,attack:200,keyrange:[21,108],release_duration:50}),sequencer.addInstrument({name:"metronome",folder:"heartbeat",sample_path:"heartbeat/metronome",keyrange:[60,61],mapping:{60:{n:"lowtick"},61:{n:"hightick"}}}),sequencer.addSamplePack({name:"metronome",folder:"heartbeat",mapping:{
hightick:"UklGRkQFAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YSAFAACx/xf/dADOACwBsP3p+6H+zAGoBOkCCwBX/EH5OvxlA4kJ2wcSArT9E/ut+HT2evUx98n6OAF5CCUMwQvfCOsJxAx0DSIMEAq9BiAB3vhz7mLkT9sR133YxN2s5QLv0vrUBnwRnxuQJeEsSDCiMd8yFS8aKFIhohUsCKj64u625OraA9HuyPnElcP+wxvJWtW25637VQ0jHPgnBTDDM1o0CzKLK+8hzhgFDOz8Se4J47DYVtG0z5fQq9LB12rfA+j99roHAhelIyMwIjdTOuU8mjwIOGoxhCb5E53/j+3k3/fTY8pTw4y/Tr+ew8DMvdsk8RcHRRkSKO4yGTkHPkU/rzzyNcgsrR94Dp/5r+Zs17zOncoDxhfE38WLyn/TeOMi9r0IRxlRKIQzyTlOPKo9yjmWMcokDRLc/Y7rudtdzu/D2L1Iu+27JcG3yYrVLujl+3UOZx1UK5Q0qzmNPDk8ZjeeMPojzhH+/jLtPd5m0hHLHsYIw5TEMMnA0jvj8fSOBiwXASZgMzM8dUBGQbI+rzjpKkIZygZT9QflcdaRyqXCz7+VwUPH784r3K7s+v0KDu8bvyeLMb43NjrhOIo0dSvQHi0PnP6i7ovg3NTxy4/Gf8X8yH/QBtvX55P2Ygb0FcUjsy4LNmI5ejiXM38r7iC8FJwHPvok7dDgQdaJzlTKIsoFzsrVkuA87d/6qAi7FQ0h9ClKMLEz3TOrMBcqYSD8E9AFd/dS6kTf6dbU0XnQv9IH2MXfZ+ln9DEAFwwdFy8giib6KawqeChgI/UbHBOTCZj/vvXe7InlFuDN3P3b0d1F4gzpifG2+u4D7Qw1FfwbnCD+IlgjWyHLHPMVog2mBL37qvP+7NvnYuTv4rvjfubN6k3wpPZ0/WkEOwtiEUsWcxm+Gl4aOhhiFDAPIwmbAtn7TPVy77zqcefr5YHmHull7enyfPmcAHgHew1REr8Vhhd/F+AV1RJ0DikJWQNc/ZP3efKd7hvs2ur46rHs5u8e9N/48/0hA/8HFgwuD04RSBIREqsQOg7mCssGMAJW/Xn4G/TK8Lbuzu0I7qTvnPJy9sX6bP84BLYIbAwdD84QYxG7EOcODAxwCFMEAQC9+7P3SvTX8XHw+u9R8KTxIvSo9+X7VQCUBJ0IMwziDj4QLhAGD9UMrgnTBZcBRv1v+Xv2UfS+8tfx+vES87z0+vb3+Zf9ZgEQBSEIUArWC8kM2QyzC5EJEAdvBHgBXP5n++r4Avd89Wj07fMw9D31Jvfp+Uj9xQD9A8QG5QhXClELrAsvC9wJ7gd6BWIC3v6O+7T4PPZN9EHzWvNf9Pz1Fvit+qL9rQCHAwEG/weCCZUKFwvDCnIJcAcQBWcCaf8Z/CD55vaB9dD0wPSP9UL3m/k7/Mz+JwEyAw8FzAY7CBsJaQk5CWkI2gatBCICYf+j/Fr6vfiV9872sfZP91z4p/lR+3H9zf89AroEFAfjCP0Jcwo8CjAJdQdgBSEDkgDQ/Vj7ZfnR95T28fUd9v32Vvg2+nb8+/6xAWoE4AbDCP4JpAqbCqQJ0weEBfgCTACT/R37M/m+9672IPY69gb3afhW+tT8qf+MAj0FggcuCScKXAriCcMIEAfyBJYCFwCP/Rz7A/l793z2F/Zn9mH37fjd+i39yf9pAt0EFAfRCNkJGAqrCZYIvgZPBJ8B6P4//M350vdz9q/1lfUq9mz3RPmi+3H+bgFVBOQG3wgHCkwK0Am7CCAHCgWmAjAA",lowtick:"UklGRlQFAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YTAFAAB0/5v+U/4T/3gA0wFTAuUB+f8d/nT90f1q/ub+tf46/mb/8wFQA9gC7wCd/mr+FAGRA3cE6wJf/h36evmv+8v/NwRHBZUC2/60+//5EvuZ/aX/bgFOAp8Azvzh9wfzLPF68zT4y/2BAygIfQwaEjYY0x31Irwl8SOWHVESOgPh9NfpReFt22nYHddD2BXcZeDa5InqgPDx9nP+6gS4CBYLnw0zES0WXxv4HkcgLh/1G+EX1RNpD4wKigXH/6r5/fNu7lTpj+Zu5hHoXOtL71byr/Qp91L64v6OBO4JoQ5zEskU+hU1FiQVeRP7EWgP4Qr0BIT+tPid9C3y1vCh8FDxJvK28vvyy/LA8pLzU/XP95v6xvw4/uD/RAK2BSkKcg6BEScTZBMeEqkPTQxjCKEEVwFi/nv7h/hp9aDyAvHP8MfxLvM+9PX0uPW19g/4Lfr7/C4AKgNaBXQGywb0BhIHWQfWB1oIzAjtCF8IHwdtBakDVwKLAeYA8v9w/kj81/nQ94v29/XX9bz1bPUY9Uz1Z/aH+Hr7yP4MAi4F+wcfCnYLNgyfDPsMSw0sDUAMfgrcB5IEMwFb/iX8T/pT+O/1X/Mf8cbvrO+18MLyvfVP+Rf9wgAoBCEHpwnIC5EN4Q5AD3wO1Ay0CpsIvwbvBNcCbQAr/nX8Ofsf+vb4mvda9rj1z/WX9pL3a/hH+ZX6R/wn/vP/eQESA/AE+wYDCcwKFAyPDCkMFQuSCe4HVQbSBHQDCwI8ANL9JPuY+HX28vTq82PzdPMV9Az1MfZ49zD5gftx/sQBBQXLB8cJ/gqpCw8MigwWDXENXQ2rDDUL7QgDBswCdv8S/K74WPVk8hXwou4P7mvu1+9T8pz1Uvli/ZoBwgWRCcsMPg/CEEQR4RDADwoO9wusCVMH4ARSApn/ufzd+Wj3bvX78xzzx/L68qzz1vSD9qX4Gfvd/c0AhwO/BWwHmghvCQEKVQonClsJCwiIBh0F0gOgAm0BOwAx/03+XP0g/Lb6cPmX+F/4vfh++TH6s/os+7/7cvwL/Zz9XP5O/3IA3AF9AzsF9gaUCAAKHgueCzcL9wntB3sF4wIzAI396fp1+Gv2IvWn9N30p/Xi9m74G/ru+9P9k/8aAYEC1AMTBSIG0wYuB1gHkgcACGEISAhTBzEFWAKt/5L92fuU+vX50fmf+SP5i/gb+Bf4mviv+Sr7kvyb/Uj+r/4X/8r/+gCiAo0EUAaRBzwISwjqB3IHGQfCBv8FpgTMApQAKf67+5n5/vfn9jz2yPVn9SL1RPXq9SP3Dvmr+6f+sQGKBAcH+whOCh0Laws3C28KLAmDB5AFfQNoAVP/Zv3e+7P6sfnL+Cv4vPeM95b37feV+Jn51Poq/LL9mv+YAVYD3gQuBmcHSAikCIEI7Af+BuEFngQXA1sBv/9v/pf9MP3W/Fj8q/sR+6H6U/o3+mP6y/pN+/f7xvye/WH+Jf9mAD4CQAQJBisHtgf6Bw0I8QdsB1sGywT4AggBCP/o/KX6mPg19572jfaz9uf2S/cM+E35E/tW/af/5wH1A8AFKgfkB/AHgwfxBlAGgQVIBMMCJwGs/43+vP0i/Zr8Lfzl+9H76fvi+9f75fsf/In8BP10/ej9cf4O/7f/dAAcAaUBEgKMAhgDpAMEBCEEDwTfA3IDxQL8ASoBUwCG/87+J/6h/Rr9pPxk/Gb8oPwJ/XH9w/39/UD+qP41/9D/WwDeAGsBAgKdAhEDQQNAA0sDbwOVA5YDVwPOAhgCVAGRAA=="}}),sequencer.addTask({type:"test mp3",method:function(cb){testType("//sQxAADwAABpAAAACAAADSAAAAETEFNRTMuOTkuNVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU=","mp3",cb)},params:[]}),sequencer.addTask({type:"test ogg",method:function(cb){testType("T2dnUwACAAAAAAAAAABdxd4XAAAAADaS0jQBHgF2b3JiaXMAAAAAAUSsAAAAAAAAgLsAAAAAAAC4AU9nZ1MAAAAAAAAAAAAAXcXeFwEAAAAaXK+QDz3/////////////////MgN2b3JiaXMtAAAAWGlwaC5PcmcgbGliVm9yYmlzIEkgMjAxMDExMDEgKFNjaGF1ZmVudWdnZXQpAAAAAAEFdm9yYmlzH0JDVgEAAAEAGGNUKUaZUtJKiRlzlDFGmWKSSomlhBZCSJ1zFFOpOdeca6y5tSCEEBpTUCkFmVKOUmkZY5ApBZlSEEtJJXQSOiedYxBbScHWmGuLQbYchA2aUkwpxJRSikIIGVOMKcWUUkpCByV0DjrmHFOOSihBuJxzq7WWlmOLqXSSSuckZExCSCmFkkoHpVNOQkg1ltZSKR1zUlJqQegghBBCtiCEDYLQkFUAAAEAwEAQGrIKAFAAABCKoRiKAoSGrAIAMgAABKAojuIojiM5kmNJFhAasgoAAAIAEAAAwHAUSZEUybEkS9IsS9NEUVV91TZVVfZ1Xdd1Xdd1IDRkFQAAAQBASKeZpRogwgxkGAgNWQUAIAAAAEYowhADQkNWAQAAAQAAYig5iCa05nxzjoNmOWgqxeZ0cCLV5kluKubmnHPOOSebc8Y455xzinJmMWgmtOaccxKDZiloJrTmnHOexOZBa6q05pxzxjmng3FGGOecc5q05kFqNtbmnHMWtKY5ai7F5pxzIuXmSW0u1eacc84555xzzjnnnHOqF6dzcE4455xzovbmWm5CF+eccz4Zp3tzQjjnnHPOOeecc84555xzgtCQVQAAEAAAQRg2hnGnIEifo4EYRYhpyKQH3aPDJGgMcgqpR6OjkVLqIJRUxkkpnSA0ZBUAAAgAACGEFFJIIYUUUkghhRRSiCGGGGLIKaecggoqqaSiijLKLLPMMssss8wy67CzzjrsMMQQQwyttBJLTbXVWGOtueecaw7SWmmttdZKKaWUUkopCA1ZBQCAAAAQCBlkkEFGIYUUUoghppxyyimooAJCQ1YBAIAAAAIAAAA8yXNER3RER3RER3RER3REx3M8R5RESZRESbRMy9RMTxVV1ZVdW9Zl3fZtYRd23fd13/d149eFYVmWZVmWZVmWZVmWZVmWZVmC0JBVAAAIAACAEEIIIYUUUkghpRhjzDHnoJNQQiA0ZBUAAAgAIAAAAMBRHMVxJEdyJMmSLEmTNEuzPM3TPE30RFEUTdNURVd0Rd20RdmUTdd0Tdl0VVm1XVm2bdnWbV+Wbd/3fd/3fd/3fd/3fd/3dR0IDVkFAEgAAOhIjqRIiqRIjuM4kiQBoSGrAAAZAAABACiKoziO40iSJEmWpEme5VmiZmqmZ3qqqAKhIasAAEAAAAEAAAAAACia4imm4imi4jmiI0qiZVqipmquKJuy67qu67qu67qu67qu67qu67qu67qu67qu67qu67qu67qu67ouEBqyCgCQAADQkRzJkRxJkRRJkRzJAUJDVgEAMgAAAgBwDMeQFMmxLEvTPM3TPE30RE/0TE8VXdEFQkNWAQCAAAACAAAAAAAwJMNSLEdzNEmUVEu1VE21VEsVVU9VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU1TdM0TSA0ZCUAAAQAwGKNweUgISUl5d4QwhCTnjEmIbVeIQSRkt4xBhWDnjKiDHLeQuMQgx4IDVkRAEQBAADGIMcQc8g5R6mTEjnnqHSUGuccpY5SZynFmGLNKJXYUqyNc45SR62jlGIsLXaUUo2pxgIAAAIcAAACLIRCQ1YEAFEAAIQxSCmkFGKMOaecQ4wp55hzhjHmHHOOOeegdFIq55x0TkrEGHOOOaecc1I6J5VzTkonoQAAgAAHAIAAC6HQkBUBQJwAgEGSPE/yNFGUNE8URVN0XVE0XdfyPNX0TFNVPdFUVVNVbdlUVVmWPM80PdNUVc80VdVUVVk2VVWWRVXVbdN1ddt0Vd2Wbdv3XVsWdlFVbd1UXds3Vdf2Xdn2fVnWdWPyPFX1TNN1PdN0ZdV1bVt1XV33TFOWTdeVZdN1bduVZV13Zdn3NdN0XdNVZdl0Xdl2ZVe3XVn2fdN1hd+VZV9XZVkYdl33hVvXleV0Xd1XZVc3Vln2fVvXheHWdWGZPE9VPdN0Xc80XVd1XV9XXdfWNdOUZdN1bdlUXVl2Zdn3XVfWdc80Zdl0Xds2XVeWXVn2fVeWdd10XV9XZVn4VVf2dVnXleHWbeE3Xdf3VVn2hVeWdeHWdWG5dV0YPlX1fVN2heF0Zd/Xhd9Zbl04ltF1fWGVbeFYZVk5fuFYlt33lWV0XV9YbdkYVlkWhl/4neX2feN4dV0Zbt3nzLrvDMfvpPvK09VtY5l93VlmX3eO4Rg6v/Djqaqvm64rDKcsC7/t68az+76yjK7r+6osC78q28Kx677z/L6wLKPs+sJqy8Kw2rYx3L5uLL9wHMtr68ox675RtnV8X3gKw/N0dV15Zl3H9nV040c4fsoAAIABBwCAABPKQKEhKwKAOAEAjySJomRZoihZliiKpui6omi6rqRppqlpnmlammeapmmqsimarixpmmlanmaamqeZpmiarmuapqyKpinLpmrKsmmasuy6sm27rmzbomnKsmmasmyapiy7sqvbruzquqRZpql5nmlqnmeapmrKsmmarqt5nmp6nmiqniiqqmqqqq2qqixbnmeamuippieKqmqqpq2aqirLpqrasmmqtmyqqm27quz6sm3rummqsm2qpi2bqmrbruzqsizbui9pmmlqnmeamueZpmmasmyaqitbnqeaniiqquaJpmqqqiybpqrKlueZqieKquqJnmuaqirLpmraqmmatmyqqi2bpirLrm37vuvKsm6qqmybqmrrpmrKsmzLvu/Kqu6KpinLpqrasmmqsi3bsu/Lsqz7omnKsmmqsm2qqi7Lsm0bs2z7umiasm2qpi2bqirbsi37uizbuu/Krm+rqqzrsi37uu76rnDrujC8smz7qqz6uivbum/rMtv2fUTTlGVTNW3bVFVZdmXZ9mXb9n3RNG1bVVVbNk3VtmVZ9n1Ztm1hNE3ZNlVV1k3VtG1Zlm1htmXhdmXZt2Vb9nXXlXVf133j12Xd5rqy7cuyrfuqq/q27vvCcOuu8AoAABhwAAAIMKEMFBqyEgCIAgAAjGGMMQiNUs45B6FRyjnnIGTOQQghlcw5CCGUkjkHoZSUMucglJJSCKGUlFoLIZSUUmsFAAAUOAAABNigKbE4QKEhKwGAVAAAg+NYlueZomrasmNJnieKqqmqtu1IlueJommqqm1bnieKpqmqruvrmueJommqquvqumiapqmqruu6ui6aoqmqquu6sq6bpqqqriu7suzrpqqqquvKriz7wqq6rivLsm3rwrCqruvKsmzbtm/cuq7rvu/7wpGt67ou/MIxDEcBAOAJDgBABTasjnBSNBZYaMhKACADAIAwBiGDEEIGIYSQUkohpZQSAAAw4AAAEGBCGSg0ZEUAECcAABhDKaSUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJIKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKqaSUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKZVSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWUUgoAkIpwAJB6MKEMFBqyEgBIBQAAjFFKKcacgxAx5hhj0EkoKWLMOcYclJJS5RyEEFJpLbfKOQghpNRSbZlzUlqLMeYYM+ekpBRbzTmHUlKLseaaa+6ktFZrrjXnWlqrNdecc825tBZrrjnXnHPLMdecc8455xhzzjnnnHPOBQDgNDgAgB7YsDrCSdFYYKEhKwGAVAAAAhmlGHPOOegQUow55xyEECKFGHPOOQghVIw55xx0EEKoGHPMOQghhJA55xyEEEIIIXMOOugghBBCBx2EEEIIoZTOQQghhBBKKCGEEEIIIYQQOgghhBBCCCGEEEIIIYRSSgghhBBCCaGUUAAAYIEDAECADasjnBSNBRYashIAAAIAgByWoFLOhEGOQY8NQcpRMw1CTDnRmWJOajMVU5A5EJ10EhlqQdleMgsAAIAgACDABBAYICj4QgiIMQAAQYjMEAmFVbDAoAwaHOYBwANEhEQAkJigSLu4gC4DXNDFXQdCCEIQglgcQAEJODjhhife8IQbnKBTVOogAAAAAAAMAOABAOCgACIimquwuMDI0Njg6PAIAAAAAAAWAPgAADg+gIiI5iosLjAyNDY4OjwCAAAAAAAAAACAgIAAAAAAAEAAAACAgE9nZ1MABAEAAAAAAAAAXcXeFwIAAABq2npxAgEBAAo=","ogg",cb)},params:[]}),sequencer.addTask({type:"init midi",method:initMidi,params:[]},function(){if(readyCallbacks.forEach(function(cb){cb()}),sequencer.debug>=4){var msg="sequencer ready, support for:";!0===sequencer.ogg&&(msg+=" ogg"),!0===sequencer.mp3&&(msg+=" mp3"),console.log(msg)}ready=!0},!1)}();
