!function(t){var e={};function i(n){if(e[n])return e[n].exports;var s=e[n]={i:n,l:!1,exports:{}};return t[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(n,s,function(e){return t[e]}.bind(null,s));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=12)}([function(t,e,i){"use strict";var n,s=i(1),o=o||"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(t){if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var e=t.document,i=t.URL||t.webkitURL||t,n=e.createElementNS("http://www.w3.org/1999/xhtml","a"),s=!t.externalHost&&"download"in n,o=t.webkitRequestFileSystem,r=t.requestFileSystem||o||t.mozRequestFileSystem,a=function(e){(t.setImmediate||t.setTimeout)((function(){throw e}),0)},c=0,h=[],u=function(){for(var t=h.length;t--;){var e=h[t];"string"==typeof e?i.revokeObjectURL(e):e.remove()}h.length=0},d=function(t,e,i){for(var n=(e=[].concat(e)).length;n--;){var s=t["on"+e[n]];if("function"==typeof s)try{s.call(t,i||t)}catch(t){a(t)}}},p=function(i,a){var u,p,l,f=this,m=i.type,v=!1,g=function(){var e=(t.URL||t.webkitURL||t).createObjectURL(i);return h.push(e),e},y=function(){d(f,"writestart progress write writeend".split(" "))},b=function(){!v&&u||(u=g()),p?p.location.href=u:window.open(u,"_blank"),f.readyState=f.DONE,y()},k=function(t){return function(){if(f.readyState!==f.DONE)return t.apply(this,arguments)}},P={create:!0,exclusive:!1};if(f.readyState=f.INIT,a||(a="download"),s){u=g(),e=t.document,(n=e.createElementNS("http://www.w3.org/1999/xhtml","a")).href=u,n.download=a;var w=e.createEvent("MouseEvents");return w.initMouseEvent("click",!0,!1,t,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(w),f.readyState=f.DONE,void y()}t.chrome&&m&&"application/octet-stream"!==m&&(l=i.slice||i.webkitSlice,i=l.call(i,0,i.size,"application/octet-stream"),v=!0),o&&"download"!==a&&(a+=".download"),("application/octet-stream"===m||o)&&(p=t),r?(c+=i.size,r(t.TEMPORARY,c,k((function(t){t.root.getDirectory("saved",P,k((function(t){var e=function(){t.getFile(a,P,k((function(t){t.createWriter(k((function(e){e.onwriteend=function(e){p.location.href=t.toURL(),h.push(t),f.readyState=f.DONE,d(f,"writeend",e)},e.onerror=function(){var t=e.error;t.code!==t.ABORT_ERR&&b()},"writestart progress write abort".split(" ").forEach((function(t){e["on"+t]=f["on"+t]})),e.write(i),f.abort=function(){e.abort(),f.readyState=f.DONE},f.readyState=f.WRITING})),b)})),b)};t.getFile(a,{create:!1},k((function(t){t.remove(),e()})),k((function(t){t.code===t.NOT_FOUND_ERR?e():b()})))})),b)})),b)):b()},l=p.prototype,f=function(t,e){return new p(t,e)};return l.abort=function(){this.readyState=this.DONE,d(this,"abort")},l.readyState=l.INIT=0,l.WRITING=1,l.DONE=2,l.error=l.onwritestart=l.onprogress=l.onwrite=l.onabort=l.onerror=l.onwriteend=null,t.addEventListener("unload",u,!1),f.unload=function(){u(),t.removeEventListener("unload",u,!1)},f}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||(void 0).content);function r(){var t,e,i,s,o,r,a,c=!1,h=0,u={},d=[],p=[];n.removeMidiFile=function(i){var n,r,a=[];for("MidiFile"===i.className?i=(n=i).localPath:n=t(i,o.midi),"MidiFile"===n.className?a.push(n):s(n,(function(t){"MidiFile"===t.className&&a.push(t)})),r=a.length-1;r>=0;r--)n=a[r],e(n.localPath,o.midi)},n.removeInstrument=function(i,n){var a,c,h,u,d,p=[];if("InstrumentConfig"===i.className?i=(a=i).localPath:a=t(i,o.instruments),"InstrumentConfig"===a.className)p.push(a);else for(c in h=a)h.hasOwnProperty(c)&&"InstrumentConfig"===(a=h[c]).className&&p.push(a);for(c=p.length-1;c>=0;c--)u=(a=p[c]).mapping,d=a.sample_path,!0===n&&(s(u,(function(t){e(d+"/"+t.n,o.audio)})),e(d,o.samplepacks)),e(a.localPath,o.instruments);r()},n.removeSamplePack=function(i){var n,a,c,h,u,d=[];for("SamplePack"===i.className?i=(n=i).localPath:n=t(i,o.samplepacks),"SamplePack"===n.className?d.push(n):s(n,(function(t){"SamplePack"===t.className&&d.push(t)})),a=d.length-1;a>=0;a--){for(u=(c=(n=d[a]).samples).length-1;u>=0;u--)h=c[u],e(h.folder+"/"+h.id,o.audio);n.reset(),e(n.localPath,o.samplepacks)}r()},n.removeAssetPack=function(e){var i;"AssetPack"===e.className?e=(i=e).localPath:i=t(e,o.assetpacks),"AssetPack"===i.className?i.unload():s(i,(function(t){"AssetPack"===t.className&&t.unload()}))},n.startTaskQueue=function(t){!0!==c&&(c=!0,function t(e,n){var s,o,r,a,l,f,m,v;if(e===d.length){for(a=p.length-1;a>=0;a--)if(!1!==(f=p[a])){var g=f.method;setTimeout((function(){g()}),0)}return u={},d=[],p=[],h=0,c=!1,void(n&&(console.log("onTaskQueueDone"),n()))}s=d[e];r=s.scope||null;o=s.params||[];"array"!==i(o)&&(o=[o]);o.push((function(i){for(u[s.id]=!0,a=p.length-1;a>=0;a--)if(!1!==(f=p[a])&&void 0!==(m=f.taskIds)){for(v=!0,l=m.length-1;l>=0;l--)!0!==u[m[l]]&&(v=!1);if(v){var o=f.method;p[a]=!1,setTimeout((function(){o(i)}),0)}}t(++e,n)}));s.method.apply(r,o)}(0,t))},n.addTask=function(t,e,i){return t.id="task"+h++,d.push(t),void 0!==e&&(!0===i?n.addCallbackAfterTask(e):n.addCallbackAfterTask(e,[t.id])),t.id},n.addCallbackAfterTask=function(t,e){p.push({method:t,taskIds:e})},n.getInstrument=function(e,i){return t(e,o.instruments,i)},n.getMidiFile=function(e,i){return t(e,o.midi,i)},n.getSamplePack=function(e,i){return t(e,o.samplepacks,i)},n.getSample=function(e,i){return t(e,o.audio,i)},n.getAssetPack=function(e,i){return t(e,o.assetpacks,i)},n.getSamplePacks=function(t,e){return a(t,o.samplepacks,e)},n.getAssetPacks=function(t,e){return a(t,o.assetpacks,e)},n.getSamples=function(t,e){return a(t,o.audio,e)},n.getInstruments=function(t,e){return a(t,o.instruments,e)},n.getMidiFiles=function(t,e){return a(t,o.midi,e)},n.protectedScope.addInitMethod((function(){o=n.storage,n.protectedScope.loadLoop,t=n.protectedScope.findItem,n.protectedScope.storeItem,e=n.protectedScope.deleteItem,i=n.protectedScope.typeString,n.protectedScope.getArguments,n.protectedScope.isEmptyObject,s=n.protectedScope.objectForEach,r=n.protectedScope.updateInstruments,a=n.protectedScope.findItemsInFolder}))}function a(){var t,e,i,s,o,r,a,c,h,u,d,p,l,f=0;function m(t,n){void 0!==t.url?e({url:t.url,responseType:"json",onError:function(t){!function(t,e){e(!1)}(0,n)},onSuccess:function(e,s){null!==e?(t.loaded=!0,void 0!==e.name&&void 0===t.name&&(t.name=e.name),void 0!==e.folder&&void 0===t.folder&&(t.folder=e.folder),void 0===t.name&&(t.name=i(t.url).name),t.localPath=void 0!==t.folder?t.folder+"/"+t.name:t.name,t.filesize=s,e.instruments&&(t.instruments=t.instruments.concat(e.instruments)),e.samplepacks&&(t.samplepacks=t.samplepacks.concat(e.samplepacks)),e.midifiles&&(t.midifiles=t.midifiles.concat(e.midifiles)),v(t,n)):n(!1)}}):(t.localPath=void 0!==t.folder?t.folder+"/"+t.name:t.name,v(t,n))}function v(t,e){var i,r,a,c=function(t){var e=s(t.localPath,n.storage.assetpacks,!0),i=t.action;return e&&"AssetPack"===e.className&&"overwrite"!==i?(n.debug>=2&&console.warn("there is already an AssetPack at",t.localPath),!0):(o(t,t.localPath,n.storage.assetpacks),!1)}(t),h=t.localPath;if(!0!==c){if(void 0!==t.url){var d,p,l=n.storage.assetpacks,f=null;for(p in l)if("AssetPack"===(d=l[p]).className&&d.id!==t.id&&d.url===t.url){f=d;break}if(null!==f)return h=t.localPath,u(h),t=null,void e(t=s(f.localPath,n.storage.assetpacks,!0))}for(i=(r=t.midifiles).length-1;i>=0;i--)(a=r[i]).pack=t,n.addMidiFile(a);for(i=(r=t.instruments).length-1;i>=0;i--)(a=r[i]).pack=t,n.addInstrument(a);for(i=(r=t.samplepacks).length-1;i>=0;i--)(a=r[i]).pack=t,n.addSamplePack(a);e(t)}else e(t=s(h,n.storage.assetpacks,!0))}(l=function(t){this.id="AP"+f+++(new Date).getTime(),this.name=this.id,this.className="AssetPack",this.loaded=!1,this.midifiles=t.midifiles||[],this.samplepacks=t.samplepacks||[],this.instruments=t.instruments||[],this.url=t.url;var e=this;c(t,(function(t,i){e[i]=t}))}).prototype.unload=function(){var e,i,n;for(e=(i=this.midifiles).length-1;e>=0;e--)n=i[e],h(n.folder+"/"+n.name);for(e=(i=this.instruments).length-1;e>=0;e--)n=i[e],d(n.folder+"/"+n.name);for(e=(i=this.samplepacks).length-1;e>=0;e--)n=i[e],p(n.folder+"/"+n.name);r(this.localPath,t.assetpacks)},n.addAssetPack=function(t,e){var i,s,o;if("object"!==a(t))return n.debug>=2&&console.warn("can't create an AssetPack with this data",t),!1;if(void 0===e&&(e=function(){}),t.json){if(i=t.json,s=t.name,o=t.folder,"string"===a(i))try{i=JSON.parse(i)}catch(e){return n.debug>=2&&console.warn("can't create an AssetPack with this data",t),!1}if(void 0===i.instruments&&void 0===i.midifiles&&void 0===i.samplepacks)return n.debug>=2&&console.warn("can't create an AssetPack with this data",t),!1;t={midifiles:i.midifiles,instruments:i.instruments,samplepacks:i.samplepacks,name:void 0===s?i.name:s,folder:void 0===o?i.folder:o}}n.addTask({type:"load asset pack",method:m,params:new l(t)},(function(i){t=null,e(i)}),!0),n.startTaskQueue()},n.protectedScope.addInitMethod((function(){e=n.protectedScope.ajax,n.protectedScope.round,i=n.protectedScope.parseUrl,s=n.protectedScope.findItem,o=n.protectedScope.storeItem,r=n.protectedScope.deleteItem,a=n.protectedScope.typeString,c=n.protectedScope.objectForEach,t=n.storage,h=n.removeMidiFile,d=n.removeInstrument,p=n.removeSamplePack,u=n.removeAssetPack}))}function c(){var t,e,i,s,o,r,a=null,c={height:200,width:800,sampleStep:1,color:"#71DE71",bgcolor:"#000"};function h(o){this.track=o,this.song=o.song,this.audioEvents={},this.callback=null,this.worker=i(),this.waveformConfig=o.waveformConfig||c;var r=this;this.worker.onmessage=function(i){!function(i,o,r,a){t.decodeAudioData(o,(function(t){var c=e(o),h={id:i.recordId,audioBuffer:t,wavArrayBuffer:o,wav:{blob:new Blob([new Uint8Array(o)],{type:"audio/wav"}),base64:c,dataUrl:"data:audio/wav;base64,"+c},waveform:{}};h.interleavedSamples="new"===a?r:n.storage.audio.recordings[i.recordId].interleavedSamples,s(t,i.waveformConfig,(function(t){h.waveform={dataUrls:t},n.storage.audio.recordings[i.recordId]=h,null!==i.callback&&(i.callback(h),i.callback=null)}))}),(function(){n.debug>=n.WARN&&console.warn("no valid audiodata")}))}(r,i.data.wavArrayBuffer,i.data.interleavedSamples,i.data.id)}}h.prototype.prepare=function(t,e){var i=this;this.recordId=t,null===a?function(t){navigator.getUserMedia({audio:!0},(function(e){a=!0,o=e,t()}),(function(e){n.debug>=n.WARN&&console.log(e),a=!1,t()}))}((function(){e(a),void 0!==o&&i.start()})):(e(a),void 0!==o&&this.start())},h.prototype.start=function(){var e=this,i=this.track.song;e.worker.postMessage({command:"init",sampleRate:t.sampleRate}),this.scriptProcessor=t.createScriptProcessor(8192,1,1),this.scriptProcessor.onaudioprocess=function(t){1===t.inputBuffer.numberOfChannels?e.worker.postMessage({command:"record_mono",buffer:t.inputBuffer.getChannelData(0)}):e.worker.postMessage({command:"record_stereo",buffer:[t.inputBuffer.getChannelData(0),t.inputBuffer.getChannelData(1)]}),!1===i.recording&&!1===i.precounting&&e.createAudio()},this.sourceNode=t.createMediaStreamSource(o),this.sourceNode.connect(this.scriptProcessor),this.scriptProcessor.connect(t.destination)},h.prototype.stop=function(e){this.stopRecordingTimestamp=1e3*t.currentTime,this.timestamp=window.performance.now(),void 0!==this.sourceNode?this.callback=e:e()},h.prototype.createAudio=function(){this.sourceNode.disconnect(this.scriptProcessor),this.scriptProcessor.disconnect(t.destination),this.scriptProcessor.onaudioprocess=null,this.sourceNode=null,this.scriptProcessors=null;var e=parseInt((this.song.metronome.precountDurationInMillis+this.song.audioRecordingLatency)/r);this.worker.postMessage({command:"get_wavfile",bufferIndexStart:e,bufferIndexEnd:-1})},h.prototype.setAudioRecordingLatency=function(t,e,i){var s=parseInt(e/r);this.callback=i,this.worker.postMessage({command:"update_wavfile",samples:n.storage.audio.recordings[t].interleavedSamples,bufferIndexStart:s,bufferIndexEnd:-1})},h.prototype.cleanup=function(){void 0!==o?(this.scriptProcessor.disconnect(),this.scriptProcessor.onaudioprocess=null,this.sourceNode.disconnect(),this.scriptProcessor=null,this.sourceNode=null,this.worker.terminate()):this.worker.terminate()},n.protectedScope.createAudioRecorder=function(t){return!1!==n.record_audio&&new h(t)},n.protectedScope.addInitMethod((function(){e=n.util.encode64,t=n.protectedScope.context,s=n.getWaveformData,i=n.protectedScope.createAudioRecorderWorker,r=1/t.sampleRate*1e3,n.protectedScope.songDispatchEvent,8192*r}))}function h(){var t,e,i,s,o,r,a,c=0;function h(t,e){e&&e(!1)}function u(i,n){if(void 0===i.url)return i.localPath=void 0!==i.folder?i.folder+"/"+i.name:i.name,void n();t({url:i.url,responseType:"json",onError:function(){h(0,n)},onSuccess:function(t){null!==t?(void 0!==t.name&&void 0===i.name&&(i.name=t.name),void 0!==t.folder&&void 0===i.folder&&(i.folder=t.folder),void 0===i.name&&(i.name=e(i.url).name),i.localPath=void 0!==i.folder?i.folder+"/"+i.name:i.name,r(t,(function(t,e){"name"!==e&&"folder"!==e&&(i[e]=t)})),n()):n(!1)}})}a=function(t){this.id="IC"+c+++(new Date).getTime(),this.className="InstrumentConfig";var e=this;r(t,(function(t,i){e[i]=t}))},n.addInstrument=function(t,e,r){var c,d,p,l;if("object"!==o(t))return n.debug>=2&&console.warn("can't add an Instrument with this data",t),!1;if(t.json){if(d=t.json,p=t.name,l=t.folder,"string"===o(d))try{d=JSON.parse(d)}catch(e){return n.debug>=2&&console.warn("can't add an Instrument with this data",t),!1}if(void 0===d.mapping)return n.debug>=2&&console.warn("can't add an Instrument with this data",t),!1;t={mapping:d.mapping,name:void 0===p?d.name:p,folder:void 0===l?d.folder:l}}c=new a(t),n.addTask({type:"load instrument config",method:u,params:c},(function(t){!function(t){var e=i(t.localPath,n.storage.instruments,!0),o=t.action;e&&"InstrumentConfig"===e.className&&"overwrite"!==o?n.debug>=2&&(console.warn("there is already an Instrument at",t.localPath),h()):s(t,t.localPath,n.storage.instruments)}(c),e&&e(c)}),r),n.startTaskQueue()},n.protectedScope.addInitMethod((function(){t=n.protectedScope.ajax,i=n.protectedScope.findItem,e=n.protectedScope.parseUrl,s=n.protectedScope.storeItem,o=n.protectedScope.typeString,r=n.protectedScope.objectForEach}))}function u(){var t,e,i,s,o,r,a,c,h,u,d,p=0;function l(t,e){e&&e(!1)}function f(t,e,i){var s,o,r,d,p,l,f,m,v,g,y,b,k,P,w,E,N,S;for(e=new Uint8Array(e),s=a(e),t.base64="",t.numTracks=0,o=0,f=s.tracks.length,!0===n.overrulePPQ&&!1===isNaN(n.defaultPPQ)&&n.defaultPPQ>0?(E=n.defaultPPQ/s.header.ticksPerBeat,t.ppq=n.defaultPPQ):(E=1,t.ppq=s.header.ticksPerBeat),P=[],t.tracks=[];o<f;){for(d=(m=s.tracks[o]).length,g=0,y=0,b=-1,p=h(),l=c(),k=[],r=0,0,0,0,{},{},r=0;r<d;r++){switch(y+=(v=m[r]).deltaTime*E,-1===b&&void 0!==v.channel&&(b=v.channel,l.channel=b),"noteOn"===(N=v.subtype)?0:"noteOff"===N?0:0,v.subtype){case"trackName":l.name=v.text;break;case"instrumentName":v.text&&(l.instrumentName=v.text);break;case"noteOn":k.push(u(y,144,v.noteNumber,v.velocity));break;case"noteOff":k.push(u(y,128,v.noteNumber,v.velocity));break;case"endOfTrack":break;case"setTempo":w=6e7/v.microsecondsPerBeat,y===g&&S===N&&(n.debug>=3&&console.info("tempo events on the same tick",r,y,w),P.pop()),void 0===t.bpm&&(t.bpm=w),P.push(u(y,81,w));break;case"timeSignature":y===g&&S===N&&(n.debug>=3&&console.info("time signature events on the same tick",r,y,v.numerator,v.denominator),P.pop()),void 0===t.nominator&&(t.nominator=v.numerator,t.denominator=v.denominator),P.push(u(y,88,v.numerator,v.denominator));break;case"controller":k.push(u(y,176,v.controllerType,v.value));break;case"programChange":k.push(u(y,192,v.programNumber));break;case"channelAftertouch":k.push(u(y,208,v.amount));break;case"pitchBend":k.push(u(y,224,v.value))}S=N,g=y}k.length>0&&(l.addPart(p),p.addEvents(k),t.tracks.push(l),t.numTracks++),o++}t.timeEvents=P,t.autoSize=!0,t.loaded=!0,i(t)}function m(i,o){void 0===i.base64?void 0===i.arraybuffer?s({url:i.url,responseType:i.responseType,onError:function(){l(0,o)},onSuccess:function(s){if("json"===i.responseType){if(null===s)return void o(!1);if(void 0===s.base64)return l(0,o),void(n.debug&&console.warn("no base64 data"));void 0!==s.name&&void 0===i.name&&(i.name=s.name),void 0!==s.folder&&void 0===i.folder&&(i.folder=s.folder),void 0===i.name&&(i.name=t(i.url).name),i.localPath=void 0!==i.folder?i.folder+"/"+i.name:i.name,f(i,e(s.base64),o)}else void 0===i.name&&(i.name=t(i.url).name),i.localPath=void 0!==i.folder?i.folder+"/"+i.name:i.name,f(i,s,o)}}):f(i,i.arraybuffer,o):f(i,e(i.base64),o)}function v(t){var i=new FileReader;this._promise=new Promise((function(n,s){i.addEventListener("loadend",(function(){f({},i.result,(function(t){n(t)}))})),i.addEventListener("error",(function(t){s(t)})),void 0!==t.blob?i.readAsArrayBuffer(t.blob):void 0!==t.arraybuffer?f({},t.arraybuffer,(function(t){n(t)})):void 0!==t.base64&&f({},e(t.base64),(function(t){n(t)}))}))}d=function(t){this.id="MF"+p+++(new Date).getTime(),this.className="MidiFile",this.url=t.url,this.json=t.json,this.base64=t.base64,this.arraybuffer=t.arraybuffer,this.name=t.name,this.folder=t.folder,void 0!==this.url?this.responseType=this.url.indexOf(".json")===this.url.lastIndexOf(".")?"json":"arraybuffer":void 0===this.name&&void 0===this.folder?(this.name=this.id,this.localPath=this.id):this.localPath=void 0!==this.folder?this.folder+"/"+this.name:this.name},n.addMidiFile=function(t,e){var s,a,c,h;if("object"!==i(t))return n.debug>=2&&console.warn("can't create a MidiFile with this data",t),!1;if(t.json){if(a=t.json,c=t.name,h=t.folder,"string"===i(a))try{a=JSON.parse(a)}catch(e){return n.debug>=2&&console.warn("can't create a MidiFile with this data",t),!1}if(void 0===a.base64)return n.debug>=2&&console.warn("can't create a MidiFile with this data",t),!1;t={base64:a.base64,name:void 0===c?a.name:c,folder:void 0===h?a.folder:h}}s=new d(t),n.addTask({type:"load midifile",method:m,params:s},(function(){!function(t){var e=o(t.localPath,n.storage.midi,!0),i=t.action;e&&"MidiFile"===e.className&&"overwrite"!==i?n.debug>=2&&(console.warn("there is already a midifile at",t.localPath),l()):r(t,t.localPath,n.storage.midi)}(s),e&&e(s)})),n.startTaskQueue()},n.createMidiFile=function(t){return new v(t)._promise},n.protectedScope.addInitMethod((function(){s=n.protectedScope.ajax,o=n.protectedScope.findItem,r=n.protectedScope.storeItem,n.protectedScope.deleteItem,t=n.protectedScope.parseUrl,i=n.protectedScope.typeString,a=n.protectedScope.parseMidiFile,e=n.protectedScope.base64ToBinary,h=n.createPart,c=n.createTrack,u=n.createMidiEvent}))}function d(){var t,e,i;function s(t){var e=t.read(4,!0),i=t.readInt32();return{id:e,length:i,data:t.read(i,!1)}}function o(i){var n={};n.deltaTime=i.readVarInt();var s,o,r=i.readInt8();if(240==(240&r)){if(255==r){n.type="meta";var a=i.readInt8();switch(s=i.readVarInt(),a){case 0:if(n.subtype="sequenceNumber",2!==s)throw"Expected length for sequenceNumber event is 2, got "+s;return n.number=i.readInt16(),n;case 1:return n.subtype="text",n.text=i.read(s),n;case 2:return n.subtype="copyrightNotice",n.text=i.read(s),n;case 3:return n.subtype="trackName",n.text=i.read(s),e=n.text,n;case 4:return n.subtype="instrumentName",n.text=i.read(s),n.text,n;case 5:return n.subtype="lyrics",n.text=i.read(s),n;case 6:return n.subtype="marker",n.text=i.read(s),n;case 7:return n.subtype="cuePoint",n.text=i.read(s),n;case 32:if(n.subtype="midiChannelPrefix",1!==s)throw"Expected length for midiChannelPrefix event is 1, got "+s;return n.channel=i.readInt8(),n;case 47:if(n.subtype="endOfTrack",0!==s)throw"Expected length for endOfTrack event is 0, got "+s;return n;case 81:if(n.subtype="setTempo",3!==s)throw"Expected length for setTempo event is 3, got "+s;return n.microsecondsPerBeat=(i.readInt8()<<16)+(i.readInt8()<<8)+i.readInt8(),n;case 84:if(n.subtype="smpteOffset",5!==s)throw"Expected length for smpteOffset event is 5, got "+s;var c=i.readInt8();return n.frameRate={0:24,32:25,64:29,96:30}[96&c],n.hour=31&c,n.min=i.readInt8(),n.sec=i.readInt8(),n.frame=i.readInt8(),n.subframe=i.readInt8(),n;case 88:if(n.subtype="timeSignature",4!==s)throw"Expected length for timeSignature event is 4, got "+s;return n.numerator=i.readInt8(),n.denominator=Math.pow(2,i.readInt8()),n.metronome=i.readInt8(),n.thirtyseconds=i.readInt8(),n;case 89:if(n.subtype="keySignature",2!==s)throw"Expected length for keySignature event is 2, got "+s;return n.key=i.readInt8(!0),n.scale=i.readInt8(),n;case 127:return n.subtype="sequencerSpecific",n.data=i.read(s),n;default:return n.subtype="unknown",n.data=i.read(s),n}return n.data=i.read(s),n}if(240==r)return n.type="sysEx",s=i.readVarInt(),n.data=i.read(s),n;if(247==r)return n.type="dividedSysEx",s=i.readVarInt(),n.data=i.read(s),n;throw"Unrecognised MIDI event type byte: "+r}0==(128&r)?(o=r,r=t):(o=i.readInt8(),t=r);var h=r>>4;switch(n.channel=15&r,n.type="channel",h){case 8:return n.subtype="noteOff",n.noteNumber=o,n.velocity=i.readInt8(),n;case 9:return n.noteNumber=o,n.velocity=i.readInt8(),0===n.velocity?n.subtype="noteOff":n.subtype="noteOn",n;case 10:return n.subtype="noteAftertouch",n.noteNumber=o,n.amount=i.readInt8(),n;case 11:return n.subtype="controller",n.controllerType=o,n.value=i.readInt8(),n;case 12:return n.subtype="programChange",n.programNumber=o,n;case 13:return n.subtype="channelAftertouch",n.amount=o,n;case 14:return n.subtype="pitchBend",n.value=o+(i.readInt8()<<7),n;default:return n.value=i.readInt8(),n.subtype="unknown",n}}n.protectedScope.parseMidiFile=function(t){return function(t){var n,r,a,c,h,u,d,p,l=[],f=[];if("MThd"!==(d=s(t)).id||6!==d.length)throw"Bad .mid file - header not found";if(n=(p=i(d.data)).readInt16(),r=p.readInt16(),32768&(a=p.readInt16()))throw"Expressing time division in SMTPE frames is not supported yet";var m={formatType:n,trackCount:r,ticksPerBeat:a};for(c=0;c<r;c++){if(l[c]=[],f[c]=e,"MTrk"!==(h=s(t)).id)throw"Unexpected chunk - expected MTrk, got "+h.id;for(u=i(h.data);!u.eof();){var v=o(u);l[c].push(v)}}return{header:m,tracks:l,trackNames:f}}(i(t))},n.protectedScope.addInitMethod((function(){i=n.protectedScope.createStream}))}function p(){var t,e,i,s,o,r,a,c,h,u=Array.prototype.slice,d=!1,p=0;function l(t){c=[],h=[],a.inputs.forEach((function(t){c.push({name:t.name,id:t.id}),n.midiInputs[t.id]=t})),c.sort((function(t,e){var i=t.name.toLowerCase(),n=e.name.toLowerCase();return i<n?-1:i>n?1:0})),n.numMidiInputs=c.length,a.outputs.forEach((function(t){h.push({name:t.name,id:t.id}),n.midiOutputs[t.id]=t})),h.sort((function(t,e){var i=t.name.toLowerCase(),n=e.name.toLowerCase();return i<n?-1:i>n?1:0})),n.numMidiOutputs=h.length}function f(e,n,o){var r,a,c,h=n.song;if(e.recordMillis=1e3*t.currentTime,e.state="recorded",144===e.type)r=s(e),n.recordingNotes[e.data1]=r;else if(128===e.type){if(void 0===(r=n.recordingNotes[e.data1]))return;r.addNoteOff(e),delete n.recordingNotes[e.data1]}(h.prerolling||h.recording)&&"midi"===n.recordEnabled?(144===e.type&&n.song.recordedNotes.push(r),n.recordPart.addEvent(e),n.song.recordedEvents.push(e)):n.enableRetrospectiveRecording&&n.retrospectiveRecording.push(e),void 0!==(a=n.midiEventListeners[e.type])&&i(a,(function(t){t(e,o)})),"any"!==(c=n.channel)&&void 0!==c&&!0!==isNaN(c)||(c=0),i(n.midiOutputs,(function(t){128!==e.type&&144!==e.type&&176!==e.type||t.send([e.type,e.data1,e.data2])})),!1===n.routeToMidiOut&&(e.track=n,n.instrument.processEvent(e))}function m(t,e){var n,s,o=document.createElement("select"),r=t.type,a=t.id||r,c=t.div,h=t.firstOption;if("input"===r||"output"===r)return void 0===h&&(h="input"===r?"choose MIDI in":"choose MIDI out"),o.id=a,s="input"===r?e.midiInputs:e.midiOutputs,!1!==h&&((n=document.createElement("option")).value=-1,n.innerHTML=h,o.appendChild(n)),i(s,(function(t){(n=document.createElement("option")).value=t.id,n.innerHTML=t.name,o.appendChild(n)})),c&&c.appendChild(o),o;console.log('please set type to "input" or "output"')}function v(t,e){var s,o;if(e===n)for(s=0,o=c.length;s<o;s++)t(e.midiInputs[c[s].id],s);else i(e.midiInputs,(function(e){t(e,s)}))}function g(t,e){var s,o;if(e===n)for(s=0,o=h.length;s<o;s++)t(e.midiOutputs[h[s].id],s);else i(e.midiOutputs,(function(e,i){t(e,i)}))}n.getMidiPortsAsDropdown=function(){m(n)},n.getMidiInputsAsDropdown=function(t){return m(t=t||{type:"input"},n)},n.getMidiOutputsAsDropdown=function(t){return m(t=t||{type:"output"},n)},n.getMidiInputs=function(t){v(t,n)},n.getMidiOutputs=function(t){g(t,n)},n.protectedScope.addInitMethod((function(){t=n.protectedScope.context,s=n.createMidiNote,o=n.createMidiEvent,e=n.protectedScope.typeString,i=n.protectedScope.objectForEach})),n.protectedScope.initMidi=function(t){!0!==d?(d=!0,void 0!==navigator.requestMIDIAccess?navigator.requestMIDIAccess().then((function(e){void 0!==e._jazzInstances?(n.jazz=e._jazzInstances[0]._Jazz.version,n.midi=!0):(n.webmidi=!0,n.midi=!0),(a=e).onstatechange=l,a.inputs&&a.outputs?(l(),t()):t()}),(function(e){console.log("MIDI could not be initialized:",e),t()})):("chrome"===n.browser?console.log("Web MIDI API not enabled"):console.log("Web MIDI API not supported"),t())):t()},n.protectedScope.initMidiSong=function(t){r=function(e){!function(t,e,n){var s,r,a,c,h=t.data,u=e.tracks,d=e.numTracks;for(a=o(e.ticks,h[0],h[1],h[2]),s=0;s<d;s++)!0===(r=u[s]).monitor&&void 0!==r.midiInputs[n.id]&&f(a,r,n);if(void 0===(c=e.midiEventListeners[a.type]))return;i(c,(function(t){t(a,n)}))}(e,t,this)},i(n.midiInputs,(function(e){e.onmidimessage=r,t.midiInputs[e.id]=e})),i(n.midiOutputs,(function(e){t.midiOutputs[e.id]=e})),t.numMidiInputs=n.numMidiInputs,t.numMidiOutputs=n.numMidiOutputs},n.protectedScope.getMidiInputs=v,n.protectedScope.getMidiOutputs=g,n.protectedScope.setMidiInputSong=function(t,e,i){var s,o=n.midiInputs[t],a=i.tracks,c=i.numTracks-1;if(e=void 0===e||e,void 0!==o)for(!1===e?(delete i.midiInputs[t],o.onmidimessage=null,i.numMidiInputs--):void 0!==o&&(i.midiInputs[t]=o,o.onmidimessage=r,i.numMidiInputs++),s=c;s>=0;s--)a[s].setMidiInput(t,e);else!0===n.debug&&console.log("no midi input with id",t,"found")},n.protectedScope.setMidiOutputSong=function(t,e,i){var s,o,r=n.midiOutputs[t],a=i.tracks,c=i.numTracks-1;if(e=void 0===e||e,void 0!==r)for(!1===e?(delete i.midiOutputs[t],i.numMidiOutputs--,o=i.scheduler.lastEventTime+100,r.send([176,123,0],o),r.send([176,121,0],o)):void 0!==r&&(i.midiOutputs[t]=r,i.numMidiOutputs++),s=c;s>=0;s--)a[s].setMidiOutput(t,e);else!0===n.debug&&console.log("no midi output with id",t,"found")},n.protectedScope.addMidiEventListener=function(t,s){t=u.call(t);var o,r,a=p++,c={},h=[];return(r=function(t,i,s){for(i=0;i<s;i++){var a=t[i],h=e(a);"array"===h?r(a,0,a.length):"function"===h?o=a:!1===isNaN(a)?(a=parseInt(a,10),!1!==n.checkEventType(a)&&(c[a]=a)):"string"===h&&!1!==n.checkEventType(a)&&(a=n.midiEventNumberByName(a),c[a]=a)}})(t,0,t.length),i(c,(function(t){void 0===s.midiEventListeners[t]&&(s.midiEventListeners[t]={}),s.midiEventListeners[t][a]=o,h.push(t+"_"+a)})),1===h.length?h[0]:h},n.protectedScope.getMidiPortsAsDropdown=m,n.protectedScope.removeMidiEventListener=function(t,e){var i;i=(t=t.split("_"))[0],t=t[1],delete e.midiEventListeners[i][t]},n.protectedScope.removeMidiEventListeners=function(){},n.protectedScope.handleMidiMessageTrack=f}function l(){var t,e,i;function s(t){var s=(new DOMParser).parseFromString(t,"application/xml"),o=s.firstChild.nextSibling.nodeName;return i=s.createNSResolver(null===s.ownerDocument?s.documentElement:s.ownerDocument.documentElement),"score-partwise"===o?function(t){var s,o,r,a,c,h,u,d,p,l,f,m,v,g,y,b,k,P,w,E,N,S,_,T,A,I,O,M,x,C,B,L,R=t.evaluate("//score-part",t,i,XPathResult.ANY_TYPE,null),D=[],F=[],j={},z=n.defaultPPQ;for(;null!==(s=R.iterateNext());){for(b=t.evaluate("@id",s,i,XPathResult.STRING_TYPE,null).stringValue,y=t.evaluate("part-name",s,i,XPathResult.STRING_TYPE,null).stringValue,I=t.evaluate("midi-instrument/volume",s,i,XPathResult.NUMBER_TYPE,null).numberValue,I=parseInt(I/100*127),L=0,f=n.createTrack(y),m=n.createPart(),f.addPart(m),D.push(f),l=[],o=t.evaluate('//part[@id="'+b+'"]/measure',s,i,XPathResult.ANY_TYPE,null);null!==(r=o.iterateNext());)for(t.evaluate("@number",r,i,XPathResult.NUMBER_TYPE,null).numberValue,k=t.evaluate("attributes/divisions",r,i,XPathResult.NUMBER_TYPE,null).numberValue,isNaN(k)||(x=k),k=t.evaluate("attributes/time/beats",r,i,XPathResult.NUMBER_TYPE,null).numberValue,P=t.evaluate("attributes/time/beat-type",r,i,XPathResult.NUMBER_TYPE,null).numberValue,isNaN(k)||(C=k,B=P,F.push(n.createMidiEvent(L,n.TIME_SIGNATURE,C,B))),a=t.evaluate("*[self::note or self::backup or self::forward]",r,i,XPathResult.ANY_TYPE,null);null!==(c=a.iterateNext());){for(h=!1,u=!1,d=t.evaluate("tie",c,i,XPathResult.ANY_TYPE,null);null!==(p=d.iterateNext());)"start"===(k=t.evaluate("@type",p,i,XPathResult.STRING_TYPE,null).stringValue)?h=!0:"stop"===k&&(u=!0);if(O=t.evaluate("rest",c,i,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,M=t.evaluate("chord",c,i,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,null!==O)_=t.evaluate("duration",c,i,XPathResult.NUMBER_TYPE,null).numberValue,L+=_/x*z;else if("note"===c.nodeName){if(w=t.evaluate("pitch/step",c,i,XPathResult.STRING_TYPE,null).stringValue,E=t.evaluate("pitch/alter",c,i,XPathResult.NUMBER_TYPE,null).numberValue,S=t.evaluate("voice",c,i,XPathResult.NUMBER_TYPE,null).numberValue,N=t.evaluate("pitch/octave",c,i,XPathResult.NUMBER_TYPE,null).numberValue,_=t.evaluate("duration",c,i,XPathResult.NUMBER_TYPE,null).numberValue,t.evaluate("type",c,i,XPathResult.STRING_TYPE,null).stringValue,T=w,""!==w){if(!isNaN(E))switch(E){case-2:T+="bb";break;case-1:T+="b";break;case 1:T+="#";break;case 2:T+="##"}A=e(T,N),v=n.createMidiEvent(L,n.NOTE_ON,A,I),L+=_/x*z,g=n.createMidiEvent(L,n.NOTE_OFF,A,0),null!==M&&(L-=_/x*z),!1===h&&!1===u?l.push(v,g):!0===h&&!1===u?(j[S+"-"+A]=g,l.push(v,g)):!0===h&&!0===u?j[S+"-"+A].ticks+=_/x*z:!1===h&&!0===u&&(j[S+"-"+A].ticks+=_/x*z,delete j[S+"-"+A])}}else"backup"===c.nodeName?(_=t.evaluate("duration",c,i,XPathResult.NUMBER_TYPE,null).numberValue,L-=_/x*z):"forward"===c.nodeName&&(_=t.evaluate("duration",c,i,XPathResult.NUMBER_TYPE,null).numberValue,L+=_/x*z)}m.addEvents(l)}return n.createSong({bpm:110,tracks:D[0],timeEvents:F,useMetronome:!1})}(s):"score-timewise"===o?function(t){return t}(s):(console.log("unknown type",o),!1)}n.loadMusicXML=function(e,i,o){void 0!==e&&void 0!==i||n.debug>=n.WARN&&console.warn("please provide an url and a callback method"),t({url:e+"?"+(new Date).getTime(),method:"GET",onError:function(){i(!1)},onSuccess:function(t){i(!0===o?t:s(t))},responseType:"xml"})},n.parseMusicXML=s,n.protectedScope.addInitMethod((function(){t=n.protectedScope.ajax,n.protectedScope.typeString,e=n.getNoteNumber}))}function f(){var t,e,i,s,o,r,a,c,h,u,d,p,l,f,m,v=Math.round,g=Math.pow(10,n.precision);function y(y){var b,k;b=n.getNiceTime(f),y.bpm=m,y.factor=t,y.nominator=e,y.denominator=i,y.ticksPerBar=c,y.ticksPerBeat=h,y.ticksPerSixteenth=u,y.numSixteenth=d,y.millisPerTick=p,y.secondsPerTick=l,y.millis=v(f*g)/g,y.hour=b.hour,y.minute=b.minute,y.second=b.second,y.millisecond=b.millisecond,y.timeAsString=b.timeAsString,y.timeAsArray=b.timeAsArray,y.bar=s,y.beat=o,y.sixteenth=r,y.tick=a,k=0===a?"000":a<10?"00"+a:a<100?"0"+a:a,y.barsAsString=s+":"+o+":"+r+":"+k,y.barsAsArray=[s,o,r,a],y.state="clean",y.update()}n.protectedScope.parseEvents=function(n,v){var g,b,k,P,w=0;for(b=v.length,v.sort((function(t,e){return t.sortIndex-e.sortIndex})),function(n){m=n.bpm,t=n.factor,e=n.nominator,i=n.denominator,c=n.ticksPerBar,h=n.ticksPerBeat,u=n.ticksPerSixteenth,d=n.numSixteenth,p=n.millisPerTick,l=n.secondsPerTick,f=n.millis,s=n.bar,o=n.beat,r=n.sixteenth,a=n.tick}(n.timeEvents[0]),P=0;P<b;P++){for(k=(g=v[P]).ticks-w,a+=k;a>=u;)for(r++,a-=u;r>d;)for(r-=d,o++;o>e;)o-=e,s++;switch(g.type){case 81:m=g.bpm,f=g.millis,p=g.millisPerTick,l=g.secondsPerTick;break;case 88:t=g.factor,e=g.nominator,i=g.denominator,d=g.numSixteenth,c=g.ticksPerBar,h=g.ticksPerBeat,u=g.ticksPerSixteenth,f=g.millis;break;default:f+=k*p,y(g)}w=g.ticks}n.lastEventTmp=g},n.protectedScope.addInitMethod((function(){}))}function m(){var t,e,i,s,o,r,a,c,h,u,d,p,l,f,m,v,g,y,b,k;function P(){l=1e3*(f=1/r*60/e/t)}function w(){y=4*(i=4/o),v=(m=t*i)*s,g=t/4}function E(t){t.bpm=e,t.nominator=s,t.denominator=o,t.ticksPerBar=v,t.ticksPerBeat=m,t.ticksPerSixteenth=g,t.factor=i,t.numSixteenth=y,t.secondsPerTick=f,t.millisPerTick=l,t.ticks=d,t.millis=p,t.seconds=p/1e3,t.bar=a,t.beat=c,t.sixteenth=h,t.tick=u;var r=0===u?"000":u<10?"00"+u:u<100?"0"+u:u;t.barsAsString=a+":"+c+":"+h+":"+r,t.barsAsArray=[a,c,h,u];var b=n.getNiceTime(p);t.hour=b.hour,t.minute=b.minute,t.second=b.second,t.millisecond=b.millisecond,t.timeAsString=b.timeAsString,t.timeAsArray=b.timeAsArray}n.protectedScope.parseTimeEvents=function(i){var n,f,m,v=0;if(void 0===i)return b=[],void console.log("reset",b);for(function(i){r=i.playbackSpeed,b=i.timeEvents,k=b.length,t=i.ppq,e=i.bpm,s=i.nominator,o=i.denominator,0,a=1,c=1,h=1,u=0,d=0,p=0}(i),P(),w(),b.sort((function(t,e){return t.ticks-e.ticks})),v=0;v<k;v++){for((f=b[v]).song=i,n=f.ticks-d,u+=n,d=f.ticks,m=f.type,p+=n*l;u>=g;)for(h++,u-=g;h>y;)for(h-=y,c++;c>s;)c-=s,a++;switch(m){case 81:e=f.bpm,P();break;case 88:s=f.nominator,o=f.denominator,w();break;default:continue}E(f)}i.lastEventTmp=f},n.protectedScope.addInitMethod((function(){n.createMidiEvent}))}function v(){var t,e,i,s,o,r,a,c,h,u,d,p,l,f=0;function m(t,e){var i,n,s,o,r,a,c,h,u,d,p,l=e.mapping;for(i in t.samples=[],t.samplesById={},u=void 0!==(u=e.remote_path)&&u,l)l.hasOwnProperty(i)&&(d={id:i,folder:t.folder+"/"+t.name},!1!==u?0===(n=l[i]).indexOf("http://")||0===n.indexOf("https://")?d.url=n:(o=n,-1!==(a=n.lastIndexOf("/"))&&(o=n.substring(a+1)),s=n.substring(0,a),c=n.lastIndexOf("."),p=e.extension,-1!==c&&(r=n.substring(c+1)).length>=3&&r.length<=4&&(p=r,o=n.substring(a,c)),n=(n=(n=(n=u+"/"+s+"/"+o+"."+p).replace(/\/{2,}/g,"/")).replace(/^\//,"")).replace(/$\//,""),d.url=n):(void 0!==(h=l[i]).d?(d.base64=l[i].d,void 0!==h.s&&(d.sustain=h.s),void 0!==h.r&&(d.release=h.r)):d.base64=l[i],t.samplesById[i]=d),t.samples.push(d))}function v(t,e){!function(t,e,n){var s=0,o=t.length,r=t[s];k(r,(function a(c){i(c,d+"/"+p,h.audio),e&&e(c),++s<o?k(r=t[s],a):n()}))}(t.samples,(function(t){}),(function(){t.loaded=!0,t.parseTime=u,n.debug>=2&&console.info("parsing",t.name,"took",1e3*u,"ms"),e&&e(!0)}))}function g(t,e){t.reset(),t=void 0,e(!1)}function y(t){var o,r,a,c=e(t.localPath,n.storage.samplepacks,!0),h=t.action;if(c&&"SamplePack"===c.className)if("overwrite"===h)for(o=(r=c.samples).length-1;o>=0;o--)a=r[o],s(a.name+"/"+a.folder,n.storage.audio);else{if("append"!==h)return n.debug>=2&&console.warn("there is already a samplepack at",t.localPath),!1;for(o=(r=c.samples).length-1;o>=0;o--)t.samples.push(r[o])}return i(t,t.localPath,n.storage.samplepacks),!0}function b(e,i){!0!==e.hasMapping?t({url:e.url,responseType:"json",onError:function(){g(e,i)},onSuccess:function(t){if(null!==t){if(void 0===t.mapping)return n.debug>=2&&console.warn("can't create a SamplePack with this data",t),void g(e,i);void 0!==t.name&&void 0===e.name&&(e.name=t.name),void 0!==t.folder&&void 0===e.folder&&(e.folder=t.folder),void 0===e.name&&(e.name=r(e.url).name),e.action=t.action,e.localPath=void 0!==e.folder?e.folder+"/"+e.name:e.name,!0===y(e)?(m(e,t),v(e,i)):i(!1)}else i(!1)}}):!0===y(e)?v(e,i):i(!1)}function k(i,n){var s,o=i.url,r=i.base64;p=i.id,d=i.folder,!1!==(s=e(d+"/"+p,h.audio,!0))?n(s):r?("TWAAAP"!==r?P(s=a(r),n):n(s),i.base64=""):o?t({url:o,responseType:"arraybuffer",onError:function(){n()},onSuccess:function(t){P(t,n)}}):console.error("could not load sample",d+"/"+p)}function P(t,e){var i=n.getTime();if(null!==t)try{c.decodeAudioData(t,(function(t){u+=n.getTime()-i,e(t)}),(function(t){console.log("error decoding audiodata",p,t),e()}))}catch(t){console.log(p,t),e()}}(l=function(t){this.id="SP"+f+++(new Date).getTime(),this.className="SamplePack",this.loaded=!1,this.loadTime=0,this.parseTime=u=0,this.url=t.url,this.name=t.name,this.folder=t.folder,this.info=t.info||t.samplepack_info,this.author=t.author||t.samplepack_author,this.license=t.license||t.samplepack_license,this.compression=t.compression||t.samplepack_compression,void 0===this.compression&&void 0!==t.compression_type&&(this.compression=t.compression_type+" "+t.compression_level),this.pack=t.pack,this.filesize=t.filesize,void 0===this.filesize&&void 0!==this.pack&&(this.filesize=this.pack.filesize),t.mapping?(void 0===this.name&&void 0===this.folder?(this.name=this.id,this.localPath=this.id):this.localPath=void 0!==this.folder?this.folder+"/"+this.name:this.name,this.hasMapping=!0,this.action=t.action,m(this,t)):t.url&&(this.url=t.url)}).prototype.reset=function(){this.samples=[]},n.addSamplePack=function(t,e,i){var s,r,a,c;if(i=void 0!==i&&i,"object"!==o(t))return n.debug>=2&&console.warn("can't create a SamplePack with this data",t),!1;if(t.json){if(r=t.json,a=t.name,c=t.folder,"string"===o(r))try{r=JSON.parse(r)}catch(e){return n.debug>=2&&console.warn("can't create a SamplePack with this data",t),!1}if(void 0===r.mapping)return n.debug>=2&&console.warn("can't create a SamplePack with this data",t),!1;t={mapping:r.mapping,name:void 0===a?r.name:a,folder:void 0===c?r.folder:c}}s=new l(t),n.addTask({type:"load sample pack",method:b,params:s},(function(t){e&&(!1===t?(s=null,e(null)):e(s))}),i),n.startTaskQueue()},n.protectedScope.addInitMethod((function(){h=n.storage,t=n.protectedScope.ajax,c=n.protectedScope.context,e=n.protectedScope.findItem,r=n.protectedScope.parseUrl,i=n.protectedScope.storeItem,s=n.protectedScope.deleteItem,o=n.protectedScope.typeString,a=n.protectedScope.base64ToBinary}))}function g(){var t,e,i,s,o,r;function a(e,i){var n,s,o=e.lastEventTmp;for(s in!1===e.autoSize?e.lastBar=e.bars:e.lastBar=i?o.bar:Math.max(e.lastBar,o.bar),e.bars=parseInt(e.lastBar),n=t(e,["barsandbeats",e.bars,o.nominator,o.numSixteenth,o.ticksPerSixteenth,!0]),e.durationTicks=n.ticks,e.durationMillis=n.millis,n)n.hasOwnProperty(s)&&(e.lastEvent[s]=n[s])}function c(t,e){var i,n;for(i=e.length-1;i>=0;i--)(n=e[i]).startPosition=t.getPosition("ticks",n.start.ticks),n.endPosition=t.getPosition("ticks",n.end.ticks),n.start.millis=n.startPosition.millis,n.end.millis=n.endPosition.millis,n.duration.millis=n.end.millis-n.start.millis,n.state="clean"}function h(t,e){var i,s;for(i=e.length-1;i>=0;i--)!0===(s=e[i]).endless?(s.durationTicks=n.ticks-s.noteOn.ticks,s.durationMillis=n.millis-s.noteOn.millis):(s.durationTicks=s.noteOff.ticks-s.noteOn.ticks,s.durationMillis=s.noteOff.millis-s.noteOn.millis),s.ticks=s.noteOn.ticks,s.millis=s.noteOn.millis,s.number=s.noteOn.noteNumber,s.state="clean"}o=function(t,e){!0!==n.playing?r(t,e):s.updateSong=function(){r(t,e)}},r=function(t,s){var o,r,u,d,p,l,f,m,v,g,y,b=[],k=[],P=[],w=[],E=[],N=[],S=[],_=[],T=[],A=[],I=[],O=[],M=[],x=[],C=[],B=[],L=[],R=[],D=[],F=[],j=[],z={},U={},q={};for(r in!0===s&&e(t),t.tracksById)if(t.tracksById.hasOwnProperty(r)){for(u in!0===(l=t.tracksById[r]).needsUpdate&&l.update(),l.partsById)if(l.partsById.hasOwnProperty(u)){for(d in!0===(f=l.partsById[u]).needsUpdate&&f.update(),g=f.dirtyEvents)if(g.hasOwnProperty(d))switch((m=g[d]).state){case"new":b.push(m);break;case"recorded":w.push(m);break;case"changed":k.push(m);break;case"removed":P.push(m),delete f.eventsById[d]}for(d in y=f.dirtyNotes)if(y.hasOwnProperty(d))switch((v=y[d]).state){case"new":E.push(v);break;case"changed":N.push(v);break;case"removed":S.push(v),delete f.notesById[d]}switch(f.dirtyEvents={},f.dirtyNotes={},"removed"!==f.state?(D=D.concat(f.notes),B=B.concat(f.events)):(S=S.concat(f.notes),P=P.concat(f.events)),f.state){case"new":_.push(f),q[f.id]=f;break;case"changed":T.push(f),q[f.id]=f;break;case"removed":A.push(f),delete l.partsById[f.id]}}switch(F=F.concat(l.parts),l.state){case"clean":l.index=j.length,j.push(l);break;case"new":I.push(l),l.state="clean",l.index=j.length,j.push(l);break;case"changed":O.push(l),l.state="clean",l.index=j.length,j.push(l);break;case"removed":M.push(l),delete t.tracksById[l.id]}}for(o=P.length-1;o>=0;o--)(m=P[o]).state="clean";for(o=S.length-1;o>=0;o--)(v=S[o]).state="clean";for(o=A.length-1;o>=0;o--)(f=A[o]).state="clean";for(w.length>0&&function(t,e){var i,s,o,r,a,c=t.recordTimestamp,h=t.recordStartMillis,u=h,d=e.length,p=t.playheadRecording;for(p.set("millis",h),i=0;i<d;i++)r=e[i],a=r.recordMillis-c+h,o=p.update("millis",a-u),u=a,s=n.getNiceTime(o.millis),r.ticks=o.ticks,r.bpm=o.bpm,r.factor=o.factor,r.nominator=o.nominator,r.denominator=o.denominator,r.ticksPerBar=o.ticksPerBar,r.ticksPerBeat=o.ticksPerBeat,r.ticksPerSixteenth=o.ticksPerSixteenth,r.numSixteenth=o.numSixteenth,r.millisPerTick=o.millisPerTick,r.secondsPerTick=o.secondsPerTick,r.millis=o.millis,r.seconds=o.millis/1e3,r.hour=s.hour,r.minute=s.minute,r.second=s.second,r.millisecond=s.millisecond,r.timeAsString=s.timeAsString,r.timeAsArray=s.timeAsArray,r.bar=o.bar,r.beat=o.beat,r.sixteenth=o.sixteenth,r.tick=o.tick,r.barsAsString=o.bar+":"+o.beat+":"+o.sixteenth+":"+o.tick,r.barsAsArray=[o.bar,o.beat,o.sixteenth,o.tick],r.state="clean";t.recordStartMillis=void 0,t.recordTimestamp=void 0}(t,w),B.sort((function(t,e){return t.sortIndex-e.sortIndex})),D.sort((function(t,e){return t.ticks-e.ticks})),F.sort((function(t,e){return t.ticks-e.ticks})),o=B.length-1;o>=0;o--)z[(m=B[o]).id]=m,"audio"===m.type?R.push(m):L.push(m);for(o=D.length-1;o>=0;o--)U[(v=D[o]).id]=v;!1===s?(p=t.timeEvents.concat(b,k),i(t,p),h(t,p=[].concat(E,N)),c(t,p=[].concat(_,T))):(p=t.timeEvents.concat(B),i(t,p),h(t,D),c(t,F)),a(t),t.metronome.bars!==t.bars?t.metronome.update():!0===s&&t.metronome.update(),(x=[].concat(L,R,t.metronome.events)).sort((function(t,e){return t.ticks-e.ticks})),(C=[].concat(B,t.timeEvents)).sort((function(t,e){return t.ticks-e.ticks})),t.eventsMidiAudioMetronome=x,t.eventsMidiTime=C,t.events=B,t.midiEvents=L,t.audioEvents=R,t.notes=D,t.parts=F,t.tracks=j,t.numEvents=B.length,t.numNotes=D.length,t.numParts=F.length,t.numTracks=j.length,t.eventsById=z,t.notesById=U,t.partsById=q,t.newEvents=b,t.changedEvents=k,t.removedEvents=P,t.newNotes=E,t.changedNotes=N,t.removedNotes=S,t.newParts=_,t.changedParts=T,t.removedParts=A,t.playhead.updateSong(),t.playheadRecording.updateSong(),t.scheduler.updateSong(),t.scheduler.reschedule(),t.followEvent.updateSong(),void 0!==t.grid&&t.grid.update(),void 0!==t.keyEditor&&t.keyEditor.updateSong({numBars:t.bars,newEvents:b,changedEvents:k,removedEvents:P,newNotes:E,changedNotes:N,removedNotes:S,newParts:_,changedParts:T,removedParts:A})},n.protectedScope.update=o,n.protectedScope.checkDuration=a,n.protectedScope.parseMetronomeEvents=function(t,e){var n=e.concat(t.timeEvents);i(t,n),(e=e.concat(t.events)).sort((function(t,e){return t.sortIndex-e.sortIndex})),t.eventsMidiAudioMetronome=[].concat(e)},n.protectedScope.addInitMethod((function(){t=n.protectedScope.getPosition,i=n.protectedScope.parseEvents,e=n.protectedScope.parseTimeEvents,n.protectedScope.getInstrument,s=n.protectedScope.scheduledTasks}))}function y(){var t,e,i=window.Pitchshift,s=2048;n.protectedScope.transpose=function(i,n,s){if(void 0!==e)if(0===n&&s)s(i);else{var o,r,a,c,h,u,d,p=i.numberOfChannels,l=[];for(o=0;o<p;o++){for(a=(r=i.getChannelData(o)).length,c=new Float32Array(a),h=Math.pow(1.0595,n),e.process(h,r.length,4,r),u=0;u<a;u++)c[u]=e.outdata[u];l[o]=c}for(d=t.createBuffer(p,a,i.sampleRate),o=0;o<p;o++)d.getChannelData(o).set(l[o]);s(d)}else console.log("include Kiev II")},n.protectedScope.addInitMethod((function(){t=n.protectedScope.context,window.Pitchshift&&(e=new i(s,t.sampleRate,"FFT"))}))}function b(){var t,e,i,s=Array.prototype.slice,o=Math.pow,r=Math.round,a=Math.floor,c=Math.random,h={1:"quarter",2:"eighth",4:"sixteenth",8:"32th",16:"64th"};function u(t){return"object"!=typeof t?typeof t:null===t?"null":Object.prototype.toString.call(t).match(/\[object\s(\w+)\]/)[1].toLowerCase()}function d(t,e){if(void 0===e||e<=0)return r(t);var i=o(10,e);return r(t*i)/i}function p(t,e){if(void 0===e||e<=0)return a(t);var i=o(10,e);return a(t*i)/i}function l(t,e){if(void 0===t)return!1;var i,n=!0;for(i in e=e||"",t)if(t.hasOwnProperty(i)&&-1===e.indexOf(i)){n=!1;break}return n}function f(t,e){var i,n=t;for(i in n)n.hasOwnProperty(i)&&e(n[i],i)}function m(t){var e,i,n=new XMLHttpRequest,s=void 0===t.method?"GET":t.method;if(i=new Promise((function(i,o){o=o||function(){},i=i||function(){},n.onload=function(){200===n.status?"json"===t.responseType?(e=n.response.length,i(JSON.parse(n.response),e)):i(n.response):o(n.status)},n.onerror=function(e){t.onError(e)},n.open(s,t.url,!0),t.overrideMimeType&&n.overrideMimeType(t.overrideMimeType),t.responseType&&("json"===t.responseType?n.responseType="text":n.responseType=t.responseType),"POST"===s&&n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.data?n.send(t.data):n.send()})),void 0===t.onSuccess)return i;i.then(t.onSuccess,t.onError)}function v(t,e,i,n){var s,o;for(s in t)if(t.hasOwnProperty(s)){if("id"===s||"path"===s||"className"===s)continue;if(void 0===(o=t[s]))continue;"Folder"===o.className?!0===i&&v(o,e,i,n+"."):void 0===o.name?e.push({name:s,data:o}):e.push(o)}}function g(t,i,n){var s,o;for(s in t){if(!1!==e)return;if(t.hasOwnProperty(s)){if(u(o=t[s]),s===i){e=o;break}void 0!==o&&"Folder"===o.className&&g(o,i,n+=".")}}}function y(t,i,n){if(n=void 0!==n&&n,void 0===t||""===t)return i;var s,o,r,a,c,h;if(h=(o=E(t)).pop(),r=o.length,""===h)return i;if(e=!1,o.length>0){for(a=i,s=0;s<r&&void 0!==(a=a[o[s]]);s++);a&&(c=a[h])}return void 0===c&&(!0===n?c=i[h]:(g(i,h,"."),c=e)),void 0===c&&(c=!1),c}function b(e,i){return new Promise((function(n,s){try{t.decodeAudioData(i,(function(t){n({id:e,buffer:t})}),(function(t){console.log("error decoding audiodata",e,t),n({id:e,buffer:void 0})}))}catch(t){console.log("error decoding audiodata",e,t),n({id:e,buffer:void 0})}}))}function k(t,e){return new Promise((function(i,n){m({url:e,responseType:"arraybuffer"}).then((function(e){b(t,e).then(i,n)}),(function(){i({id:t,buffer:void 0})}))}))}function P(t){var e,i,n,s,o;for(i=[],n=(e=t||"").length,s=String.fromCharCode,o=0;o<n;o++)i[o]=s(255&e.charCodeAt(o));return i.join("")}function w(t){var e,i,n,s,o,r,a,c,h,u,d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",p=0;for(e=Math.ceil(3*t.length/4),n=new ArrayBuffer(e),i=new Uint8Array(n),64==d.indexOf(t.charAt(t.length-1))&&e--,64==d.indexOf(t.charAt(t.length-1))&&e--,t=t.replace(/[^A-Za-z0-9\+\/\=]/g,""),u=0;u<e;u+=3)s=d.indexOf(t.charAt(p++))<<2|(a=d.indexOf(t.charAt(p++)))>>4,o=(15&a)<<4|(c=d.indexOf(t.charAt(p++)))>>2,r=(3&c)<<6|(h=d.indexOf(t.charAt(p++))),i[u]=s,64!=c&&(i[u+1]=o),64!=h&&(i[u+2]=r);return n}function E(t){return void 0===t?[]:t=(t=(t=(t=(t=t.replace(/undefined/g,"")).replace(/\/{2,}/g,"/")).replace(/^\//,"")).replace(/\/$/,"")).split("/")}function N(t,e,i){var n=c()*(e-t)+t;return!0===i?r(n):n}function S(t){return t>64&&t<91?t-65:t>96&&t<123?t-71:t>47&&t<58?t+4:43===t?62:47===t?63:0}function _(t){return t<26?t+65:t<52?t+71:t<62?t-4:62===t?43:63===t?47:65}n.protectedScope.addInitMethod((function(){t=n.protectedScope.context})),n.util.b64ToUint6=S,n.util.base64DecToArr=function(t,e){for(var i,n,s=t.replace(/[^A-Za-z0-9\+\/]/g,""),o=s.length,r=e?Math.ceil((3*o+1>>2)/e)*e:3*o+1>>2,a=new Uint8Array(r),c=0,h=0,u=0;u<o;u++)if(n=3&u,c|=S(s.charCodeAt(u))<<18-6*n,3===n||o-u==1){for(i=0;i<3&&h<r;i++,h++)a[h]=c>>>(16>>>i&24)&255;c=0}return a},n.util.uint6ToB64=_,n.util.base64EncArr=function(t){for(var e=2,i="",n=t.length,s=0,o=0;o<n;o++)e=o%3,o>0&&4*o/3%76==0&&(i+="\r\n"),s|=t[o]<<(16>>>e&24),2!==e&&t.length-o!=1||(i+=String.fromCharCode(_(s>>>18&63),_(s>>>12&63),_(s>>>6&63),_(63&s)),s=0);return i.substr(0,i.length-2+e)+(2===e?"":1===e?"=":"==")},n.util.UTF8ArrToStr=function(t){for(var e,i="",n=t.length,s=0;s<n;s++)e=t[s],i+=String.fromCharCode(e>251&&e<254&&s+5<n?1073741824*(e-252)+(t[++s]-128<<24)+(t[++s]-128<<18)+(t[++s]-128<<12)+(t[++s]-128<<6)+t[++s]-128:e>247&&e<252&&s+4<n?(e-248<<24)+(t[++s]-128<<18)+(t[++s]-128<<12)+(t[++s]-128<<6)+t[++s]-128:e>239&&e<248&&s+3<n?(e-240<<18)+(t[++s]-128<<12)+(t[++s]-128<<6)+t[++s]-128:e>223&&e<240&&s+2<n?(e-224<<12)+(t[++s]-128<<6)+t[++s]-128:e>191&&e<224&&s+1<n?(e-192<<6)+t[++s]-128:e);return i},n.util.strToUTF8Arr=function(t){for(var e,i,n=t.length,s=0,o=0;o<n;o++)s+=(i=t.charCodeAt(o))<128?1:i<2048?2:i<65536?3:i<2097152?4:i<67108864?5:6;e=new Uint8Array(s);for(var r=0,a=0;r<s;a++)(i=t.charCodeAt(a))<128?e[r++]=i:i<2048?(e[r++]=192+(i>>>6),e[r++]=128+(63&i)):i<65536?(e[r++]=224+(i>>>12),e[r++]=128+(i>>>6&63),e[r++]=128+(63&i)):i<2097152?(e[r++]=240+(i>>>18),e[r++]=128+(i>>>12&63),e[r++]=128+(i>>>6&63),e[r++]=128+(63&i)):i<67108864?(e[r++]=248+(i>>>24),e[r++]=128+(i>>>18&63),e[r++]=128+(i>>>12&63),e[r++]=128+(i>>>6&63),e[r++]=128+(63&i)):(e[r++]=252+(i>>>30),e[r++]=128+(i>>>24&63),e[r++]=128+(i>>>18&63),e[r++]=128+(i>>>12&63),e[r++]=128+(i>>>6&63),e[r++]=128+(63&i));return e},n.util.ajax=m,n.util.ajax2=function(t){var e,i=new XMLHttpRequest,n=void 0===t.method?"GET":t.method;i.onreadystatechange=function(){404===i.request&&t.onError(404)},i.onload=function(){200===i.status?"json"===t.responseType?(e=i.response.length,t.onSuccess(JSON.parse(i.response),e)):t.onSuccess(i.response):t.onError(i.status)},i.onerror=function(e){t.onError(e)},i.open(n,t.url,!0),t.overrideMimeType&&i.overrideMimeType(t.overrideMimeType),t.responseType&&("json"===t.responseType?i.responseType="text":i.responseType=t.responseType),"POST"===n&&i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.data?i.send(t.data):i.send()},n.util.parseSamples=function(t){var e,i,n=[];for(e in t)t.hasOwnProperty(e)&&(-1===(i=t[e]).indexOf("http://")?n.push(b(e,w(i))):n.push(k(e,i)));return new Promise((function(t,e){Promise.all(n).then((function(e){var i={};e.forEach((function(t){i[t.id]=t.buffer})),t(i)}),(function(t){e(t)}))}))},n.util.round=d,n.util.floor=p,n.util.remap=function(t,e,i,n,s){return(t-e)*(s-n)/(i-e)+n},n.util.getRandom=N,n.util.createSlider=function(t){var e,i=t.slider,n=t.message,s=t.label;function o(n){var s=i.valueAsNumber;t.onMouseDown&&t.onMouseDown(s,n),e.onMouseDown&&e.onMouseDown(s,n)}function r(n){var s=i.valueAsNumber;t.onMouseUp&&t.onMouseUp(s,n),e.onMouseUp&&e.onMouseUp(s,n)}function a(n){var s=i.valueAsNumber;t.onMouseMove&&t.onMouseMove(s,n),e.onMouseMove&&e.onMouseMove(s,n)}return void 0===t.label&&(s=i.parentNode.firstChild),void 0!==t.initialSliderValue&&(i.value=t.initialSliderValue),void 0!==t.initialLabelValue&&(s.innerHTML=n.replace("{value}",t.initialLabelValue)),void 0!==t.min&&(i.min=t.min),void 0!==t.max&&(i.max=t.max),void 0!==t.step&&(i.step=t.step),i.addEventListener("mousedown",(function(t){setTimeout(o,0,t),i.addEventListener("mousemove",a,!1)}),!1),i.addEventListener("mouseup",(function(t){setTimeout(r,0,t),i.removeEventListener("mousemove",a,!1)}),!1),i.addEventListener("change",(function(n){!function(n){var s=i.valueAsNumber;t.onChange&&t.onChange(s,n),e.onChange&&e.onChange(s,n)}(n)}),!1),(e={getValue:function(){return t.getValue?t.getValue(i.valueAsNumber):i.valueAsNumber},setValue:function(e){t.setValue?i.value=t.setValue(e):i.value=e},setLabel:function(t){s.innerHTML=n.replace("{value}",t)},elem:i,element:i}).set=function(t){setLabel(t),setValue(t)},e},n.util.createSlider2=function(t){var e=t.slider,i=t.message,n=e.parentNode.firstChild;function s(){var s=a();void 0!==t.onMouseMove&&t.onMouseMove(e.valueAsNumber,s),n.innerHTML=i.replace("{value}",s)}function o(){var s=a();void 0!==t.onMouseUp&&t.onMouseUp(e.valueAsNumber,s),n.innerHTML=i.replace("{value}",s)}function r(){var s=a();void 0!==t.onMouseDown&&t.onMouseDown(e.valueAsNumber,s),n.innerHTML=i.replace("{value}",s)}function a(){var i=e.valueAsNumber;return void 0!==t.calculate&&(i=t.calculate(i)),i}function c(e){return void 0!==t.calculateFromLabel&&(e=t.calculateFromLabel(e)),e}return t.initialValueSlider&&(e.value=t.initialValueSlider,n.innerHTML=i.replace("{value}",a())),t.initialValueLabel&&(n.innerHTML=i.replace("{value}",t.initialValueLabel),e.value=c(t.initialValueLabel)),e.addEventListener("mousedown",(function(){setTimeout(r,0),e.addEventListener("mousemove",s,!1)}),!1),e.addEventListener("mouseup",(function(){setTimeout(o,0),e.removeEventListener("mousemove",s,!1)}),!1),{updateSlider:function(t){e.value=t,n.innerHTML=i.replace("{value}",a())},updateLabel:function(t){n.innerHTML=i.replace("{value}",t),e.value=c(t)},getValue1:function(){return e.valueAsNumber},getValue2:function(){return a(e.valueAsNumber)}}},n.util.getRandomNotes=function(t){var e,i,s,o,r,a,c,h,u,d,p,l=0,f=[];for(p=(t=t||{}).ppq||n.defaultPPQ,o=t.numNotes||20,a=t.noteLength||p/2,c=t.minVelocity||30,h=t.maxVelocity||127,u=t.minNoteNumber||60,d=t.maxNoteNumber||127,a>p&&(a=p),e=0;e<o;e++)r=N(u,d,!0),s=N(c,h,!0),i=n.createMidiEvent(l,n.NOTE_ON,r,s),f.push(i),l+=a,i=n.createMidiEvent(l,n.NOTE_OFF,r,0),f.push(i),l+=p-a;return f},n.util.getEqualPowerCurve=function(t,e,i){var n,s,o,r=new Float32Array(t);for(n=0;n<t;n++)o=n/t,"fadeIn"===e?s=Math.cos(.5*(1-o)*Math.PI)*i:"fadeOut"===e&&(s=Math.cos(.5*o*Math.PI)*i),r[n]=s,n===t-1&&(r[n]="fadeIn"===e?1:0);return r},n.util.objectForEach=f,n.util.insertLink=function(t){var e,i=t.indexOf("http://");return-1!==i&&-1!==(i=(e=t.substring(i)).indexOf(" "))&&(e=e.substring(0,i)),'<a href="'+e+'"></a>'},n.util.encode64=function(t){for(var e="",i=new Uint8Array(t),n=i.byteLength,s=0;s<n;s++)e+=String.fromCharCode(i[s]);return window.btoa(e)},n.protectedScope.getNoteLengthName=function(t,e){for(var i in h)if(h.hasOwnProperty(i)&&e===t.ppq/i)return h[i];return!1},n.protectedScope.toBinaryString=P,n.protectedScope.base64ToBinary=w,n.protectedScope.toUint8Array=function(t){var e,i,n,s,o;for(n=(e=t||"").length,i=new Uint8Array(n),s=String.fromCharCode,o=0;o<n;o++)i[o]=s(255&e.charCodeAt(o));return i},n.protectedScope.getArguments=function(t){var e,i,n=[];return t=s.call(t),(e=function(t,s,o){for(s=0;s<o;s++)"array"===u(i=t[s])?e(i,0,i.length):n.push(i)})(t,0,t.length),n},n.protectedScope.pathToArray=E,n.protectedScope.parseUrl=function(t){var e,i,n,s="",o=t,r="";return-1!==(e=(t=(t=(t=t.replace(/\/{2,}/g,"/")).replace(/^\//,"")).replace(/\/$/,"")).lastIndexOf("/"))&&(o=t.substring(e+1),s=t.substring(0,e)),-1!==(i=t.lastIndexOf("."))&&(n=t.substring(i+1)).length>=3&&n.length<=4&&(r=n,o=t.substring(e+1,i)),{path:s,name:o,ext:r}},n.protectedScope.loadLoop=function t(e,i,n,s,o){0!==i?n[e].load((function(){o&&o(arguments),++e<i?t(e,i,n,s,o):s&&s()})):s&&s()},n.protectedScope.findItem=y,n.protectedScope.storeItem=function(t,e,i){var n,s,o,r,a,c="";for(o=(s=E(e)).length,r=i,a=0;a<o;a++){if(c+="/"+(n=s[a]),void 0===r[n]&&(r[n]={path:c,className:"Folder"}),a===o-1){r[n]=t;break}r=r[n]}},n.protectedScope.deleteItem=function(t,e){var i,n,s,o=e;if(!(i=y(t,e,!0)))return!1;if("Folder"===i.className)for(s in i)i.hasOwnProperty(s)&&"className"!==s&&delete i[s];for(t=E(t);t.length>1;){for(s=0,o=e;s<t.length-1;)o=o[t[s++]];"Folder"===(i=o[n=t[s]]).className?l(i,"path className")&&delete o[n]:delete o[n],t.pop()}return 1===t.length&&""!==t[0]&&("Folder"===(i=e[n=t[0]]).className?l(e[n],"path className")&&delete e[n]:delete e[n]),!0},n.protectedScope.toBinaryString=P,n.protectedScope.ajax=m,n.protectedScope.copyObject=function(t){var e,i={};if("object"!==u(t))return{};for(e in t)t.hasOwnProperty(e)&&(i[e]=t[e]);return i},n.protectedScope.findItemsInFolder=function(t,e,n){n=void 0===n||n;var s,o,r=E(t),a=r.length,c=r[a-1],h=[];if(0===a)v(e,h,n,".");else{for(s=e,o=0;o<a&&void 0!==(s=s[r[o]]);o++);s?v(s,h,n,"."):(i=!1,function t(e,n,s){var o,r;for(o in e){if(!1!==i)return;if(e.hasOwnProperty(o)&&void 0!==(r=e[o])&&"Folder"===r.className){if(o===n)return void(i=r);t(r,n,s+".")}}}(e,c,"."),v(i,h,n,"."))}return h.sort((function(t,e){var i=t.name.toLowerCase(),n=e.name.toLowerCase();return i<n?-1:i>n?1:0})),h},n.convertPPQ=function(){var t,e,i=s.call(arguments),o=i[0],r=i[1],a=r/o;function c(i){for(t=i.length-1;t>=0;t--)(e=i[t]).ticks=a*e.ticks,"new"!==e.state&&(e.state="changed")}isNaN(o)||isNaN(r)?4===n.debug&&console.error("PPQ values must be numbers"):function(t,e,i){var n,s,o,r,a;for(r=e;r<i;r++)if("array"===(s=u(n=t[r])))c(n);else if("object"===s)if("Part"===n.className||"Track"===n.className||"Song"===n.className)c(n.events);else if("MidiFile"===n.className)for(a=n.numTracks-1;a>=0;a--)!0===(o=n.tracks[a]).needsUpdate&&(o.update(),o.events&&c(o.events))}(i,2,i.length)},n.getNiceTime=function(t){var e,i,n,s,o,r="";return r+=(e=p((o=t/1e3)/3600))+":",r+=(i=p(o%3600/60))<10?"0"+i:i,r+=":",r+=(n=p(o%60))<10?"0"+n:n,r+=":",{hour:e,minute:i,second:n,millisecond:s=d(1e3*(o-3600*e-60*i-n)),timeAsString:r+=0===s?"000":s<10?"00"+s:s<100?"0"+s:s,timeAsArray:[e,i,n,s]}},n.protectedScope.isEmptyObject=l,n.protectedScope.objectForEach=f,n.protectedScope.objectToArray=function(t){var e,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(t[e]);return i},n.protectedScope.arrayToObject=function(t,e){var i,n={};for(i=t.length-1;i>=0;i--)n[t[i][e]]=t[i];return n},n.protectedScope.createClass=function(t,e){var i;return(i=function(){this.parent=t,arguments.length>0&&(t.apply(this,arguments),void 0!==e&&e.apply(this,arguments))}).prototype=Object.create(t.prototype),i},n.protectedScope.clone=function t(e){var i,n;if(null===e||"object"!=typeof e)return e;for(i in n=e.constructor(),e)e.hasOwnProperty(i)&&(n[i]=t(e[i]));return n},n.protectedScope.round=d,n.protectedScope.floor=p,n.protectedScope.typeString=u,n.protectedScope.copyName=function(t){var e,i=t.indexOf("_copy");return-1===i?t+"_copy":""===(e=t.substring(i+5))?t+"2":t.slice(0,-1)+(parseInt(e,10)+1)},n.protectedScope.removeFromArray=function(t,e){var i,n,s,o,r,a,c=[];for("array"!==u(t)&&(t=[t]),s=e.length,o=t.length,i=0;i<s;i++){for(a=e[i],r=!1,n=0;n<o;n++)if(a===t[n]){r=!0;break}!1===r&&c.push(a)}return c},n.protectedScope.removeFromArray2=function(t,e){var i,n,s=t.length,o=[];for(i=0;i<s;i++)!1===e(n=t[i])&&o.push(n);return o},n.protectedScope.filterItemsByClassName=function(t,e,i){var n,s;for(n in t)t.hasOwnProperty(n)&&((s=t[n]).className===e?i.push(s):"object"===u(s)&&g(s,e,i))},n.getMicrosecondsFromBPM=function(t){return d(6e7/t)},n.getWaveformData=function(t,e,i){var n,s,o,r,a,c,h=document.createElement("canvas"),u=h.getContext("2d"),d=t.getChannelData(0),p=(t.getChannelData(0),d.length),l=e.height||100,f=e.color||"#71DE71",m=e.bgcolor||"#000",v=l/2,g=e.sampleStep||50,y=0,b=0,k=[];for(void 0!==e.width?o=(s=e.width)/p:(o=e.density||1,s=1e3,r=p*e.density%s,a=Math.ceil(p*e.density/s),c=0),h.width=s,h.height=l,u.fillStyle=m,u.fillRect(0,0,s,l),u.beginPath(),u.strokeStyle=f,u.lineWidth=1,u.moveTo(0,v),n=0;n<p;n+=g)(y=(n-b)*o)>=s?(u.stroke(),k.push(h.toDataURL("image/png")),c++,h.width=c===a-1?r:s,u.beginPath(),u.strokeStyle=f,b=n,y=0,u.moveTo(y,v-d[n]*v)):u.lineTo(y,v-d[n]*v);y<s&&(u.stroke(),k.push(h.toDataURL("image/png"))),i(k)}}var k,P,w,E,N,S,_,T,A,I,O,M,x,C,B,L,R,D="heartbeat "+s.a+", initializing took";console.time(D),function(){var t,e,i,o,r,a,c=[],h=!1,u=0,d=["threshold","knee","ratio","reduction","attack","release"],p=navigator.userAgent;if(p.match(/(iPad|iPhone|iPod)/g)?r="ios":-1!==p.indexOf("Android")?r="android":-1!==p.indexOf("Linux")?r="linux":-1!==p.indexOf("Macintosh")?r="osx":-1!==p.indexOf("Windows")&&(r="windows"),-1!==p.indexOf("Chrome")?(a="chrome",-1!==p.indexOf("OPR")?a="opera":-1!==p.indexOf("Chromium")&&(a="chromium")):-1!==p.indexOf("Safari")?a="safari":-1!==p.indexOf("Firefox")?a="firefox":-1!==p.indexOf("Trident")&&(a="Internet Explorer"),"ios"===r&&-1!==p.indexOf("CriOS")&&(a="chrome"),window.AudioContext)"function"!=typeof(e=new window.AudioContext).createGainNode&&(e.createGainNode=e.createGain);else{if(!window.webkitAudioContext)throw new Error("The WebAudio API hasn't been implemented in "+a+", please use any other browser");"function"!=typeof(e=new window.webkitAudioContext).createGainNode&&(e.createGainNode=e.createGain)}(o=e.createDynamicsCompressor()).connect(e.destination),(i=e.createGainNode()).connect(e.destination),i.gain.value=1,t={context:e,masterGainNode:i,masterCompressor:o,useDelta:!1,timedTasks:{},scheduledTasks:{},repetitiveTasks:{},getSampleId:function(){return"S"+u+++(new Date).getTime()},addInitMethod:function(t){c.push(t)},callInitMethods:function(){var t,e=c.length;for(t=0;t<e;t++)c[t]()}},n={name:"qambi",version:s.a,protectedScope:t,ui:{},ua:p,os:r,browser:a,legacy:!1,midi:!1,webmidi:!1,webaudio:!0,jazz:!1,ogg:!1,mp3:!1,record_audio:void 0!==navigator.getUserMedia,bitrate_mp3_encoding:128,util:{},debug:0,defaultInstrument:"sinewave",pitch:440,bufferTime:.35,autoAdjustBufferTime:!1,noteNameMode:"sharp",minimalSongLength:6e4,pauseOnBlur:!1,restartOnFocus:!0,defaultPPQ:960,overrulePPQ:!0,precision:3,midiInputs:{},midiOutputs:{},storage:{midi:{id:"midi"},audio:{id:"audio",recordings:{}},instruments:{id:"instruments"},samplepacks:{id:"samplepacks"},assetpacks:{id:"assetpacks"}},getAudioContext:function(){return e},getTime:function(){return e.currentTime},getTimeDiff:function(){var t=1e3*e.currentTime;return performance.now()-t},setMasterVolume:function(t){t=t<0?0:t>1?1:t,i.gain.value=t},getMasterVolume:function(){return i.gain.value},getCompressionReduction:function(){return o.reduction.value},enableMasterCompressor:function(t){t?(i.disconnect(0),i.connect(o),o.disconnect(0),o.connect(e.destination)):(o.disconnect(0),i.disconnect(0),i.connect(e.destination))},configureMasterCompressor:function(t){var e,i;for(e=d.length;e>=0;e--)void 0!==t[i=d[e]]&&(o[i].value=t[i])},unlockWebAudio:function(){if(!0!==h){"function"==typeof e.resume&&e.resume();var t=e.createOscillator(),i=e.createGainNode();i.gain.value=0,t.connect(i),i.connect(e.destination),void 0!==t.noteOn&&(t.start=t.noteOn,t.stop=t.noteOff),t.start(0),t.stop(.001),h=!0}}},Object.defineProperty(n,"ERROR",{value:1}),Object.defineProperty(n,"WARN",{value:2}),Object.defineProperty(n,"INFO",{value:3}),Object.defineProperty(n,"LOG",{value:4})}(),r(),a(),w=Array.prototype.slice,(P=function(t){if(void 0!==t)if(void 0===t.ticks?this.ticks=0:this.ticks=t.ticks,this.buffer=t.buffer,this.sampleId=t.sampleId,this.path=t.path,void 0!==this.buffer||void 0!==this.path)if(void 0===this.buffer||"audiobuffer"===k(this.buffer)){if(void 0!==this.path){if("string"!==k(this.path))return void(n.debug>=n.WARN&&console.warn("path has to be a String"));if(this.sampleId=this.path,this.sampleId=this.sampleId.replace(/^\//,""),this.sampleId=this.sampleId.replace(/\/$/,""),this.sampleId=this.sampleId.split("/"),this.sampleId=this.sampleId[this.sampleId.length-1],this.buffer=n.getSample(this.path),!1===this.buffer)return void(n.debug>=n.WARN&&console.warn("no sample found at",this.path));this.buffer=n.getSample(this.path)}this.durationTicks=t.durationTicks,this.durationMillis=t.durationMillis,void 0===this.durationTicks&&void 0===this.durationMillis&&(this.duration=this.buffer.duration,this.durationMillis=1e3*this.duration),this.muted=!1,void 0===t.velocity?this.velocity=127:this.velocity=t.velocity,this.sampleOffsetTicks=t.sampleOffsetTicks,this.sampleOffsetMillis=t.sampleOffsetMillis,void 0===this.sampleOffsetMillis&&void 0===this.sampleOffsetTicks?(this.sampleOffsetTicks=0,this.sampleOffsetMillis=0,this.sampleOffset=0):void 0!==this.sampleOffsetMillis&&(this.sampleOffset=this.sampleOffsetMillis/1e3),this.latencyCompensation=t.latencyCompensation,void 0===this.latencyCompensation&&(this.latencyCompensation=0),this.playheadOffset=0,this.className="AudioEvent",this.time=0,this.type="audio",this.id="A0"+(new Date).getTime()}else n.debug>=n.WARN&&console.warn("buffer has to be an AudioBuffer");else n.debug>=n.WARN&&console.warn("please provide an AudioBuffer or a path to a sample in the sequencer.storage object")}).prototype.update=function(){var t;void 0===this.duration?(t=this.song.getPosition("ticks",this.ticks+this.durationTicks),this.durationMillis=t.millis-this.millis,this.duration=this.durationMillis/1e3):void 0===this.durationTicks&&(t=this.song.getPosition("millis",this.millis+this.durationMillis),this.durationTicks=t.ticks-this.ticks),void 0===this.sampleOffset?(t=this.song.getPosition("ticks",this.ticks+this.sampleOffsetTicks),this.sampleOffsetMillis=t.millis-this.millis,this.sampleOffset=this.sampleOffsetMillis/1e3):void 0===this.sampleOffsetTicks&&(t=this.song.getPosition("millis",this.millis+this.sampleOffsetMillis),this.sampleOffsetTicks=t.ticks-this.ticks),this.endTicks=this.ticks+this.durationTicks,this.endMillis=this.millis+this.durationMillis},P.prototype.stopSample=function(t){this.track.audio.stopSample(this,t)},P.prototype.setSampleOffset=function(t,e){"millis"===t?(this.sampleOffsetMillis=e,this.sampleOffset=e/1e3,this.durationTicks=void 0,void 0!==this.song&&this.update()):"ticks"===t?(this.sampleOffsetTicks=e,this.sampleOffset=void 0,this.sampleOffsetMillis=void 0,void 0!==this.song&&this.update()):n.debug>=n.WARN&&console.warn('you have to provide a type "ticks" or "millis" and a value')},P.prototype.setDuration=function(t,e){"millis"===t?(this.durationMillis=e,this.duration=e/1e3,this.durationTicks=void 0,void 0!==this.song&&this.update()):"ticks"===t?(this.durationTicks=e,this.duration=void 0,this.durationMillis=void 0,void 0!==this.song&&this.update()):n.debug>=n.WARN&&console.warn('you have to provide a type "ticks" or "millis" and a value')},P.prototype.clone=P.prototype.copy=function(){var t,e=new P;for(t in this)this.hasOwnProperty(t)&&("id"!==t&&"eventNumber"!==t&&(e[t]=this[t]),e.song=void 0,e.track=void 0,e.trackId=void 0,e.part=void 0,e.partId=void 0);return e},P.prototype.reset=function(t,e,i){e=void 0===e,i=void 0===i,(t=void 0===t)&&(this.part=void 0,this.partId=void 0),e&&(this.track=void 0,this.trackId=void 0,this.channel=0),i&&(this.song=void 0)},P.prototype.move=function(t){isNaN(t)?n.debug>=1&&console.error("please provide a number"):(this.ticks+=parseInt(t,10),void 0!==this.song&&this.update(),"new"!==this.state&&(this.state="changed"),void 0!==this.part&&(this.part.needsUpdate=!0))},P.prototype.moveTo=function(){var t=w.call(arguments);"ticks"===t[0]&&!1===isNaN(t[1])?this.ticks=parseInt(t[1],10):void 0===this.song?n.debug>=1&&console.error("The audio event has not been added to a song yet; you can only move to ticks values"):!1===(t=this.song.getPosition(t))?n.debug>=1&&console.error("wrong position data"):this.ticks=t.ticks,void 0!==this.song&&this.update(),"new"!==this.state&&(this.state="changed"),void 0!==this.part&&(this.part.needsUpdate=!0)},n.createAudioEvent=function(t){return"AudioEvent"===t.className?t.clone():new P(t)},n.protectedScope.addInitMethod((function(){k=n.protectedScope.typeString})),c(),Array.prototype.slice,N=function(t){delete this.scheduledSamples[t.id],t=null},(S=function(t){this.track=t,this.className="AudioTrack",this.scheduledSamples={},this.recorder=E(t)}).prototype.setAudioRecordingLatency=function(t,e,i){this.recorder.setAudioRecordingLatency(t,e,i)},S.prototype.processEvent=function(t){var e=n.createSample({buffer:t.buffer,track:t.track});t.sample=e,t.offset=t.sampleOffset+t.playheadOffset,t.playheadOffset=0,e.start(t),this.scheduledSamples[e.id]=e},S.prototype.stopSample=function(t,e){void 0!==t.sample&&t.sample.stop(e,N.bind(this))},S.prototype.allNotesOff=function(){var t,e,i=this.scheduledSamples;for(t in i)i.hasOwnProperty(t)&&(e=i[t])&&e.unschedule(0,N.bind(this));this.scheduledSamples={}},S.prototype.prepareForRecording=function(t,e){if(!1===this.recorder)return!1;this.recorder.prepare(t,e)},S.prototype.stopRecording=function(t){this.recorder.stop((function(e){t(e)}))},n.protectedScope.createAudioTrack=function(t){return new S(t)},n.protectedScope.addInitMethod((function(){n.protectedScope.typeString,E=n.protectedScope.createAudioRecorder})),function(){var t,e,i,s,o,r,a,c,h,u=0;function d(e){this.id="FX"+u+++(new Date).getTime(),this.type=e.type,this.buffer=e.buffer,this.config=e,this.bypass=!1,this.amount=0,this.output=t.createGainNode(),this.wetGain=t.createGainNode(),this.dryGain=t.createGainNode(),this.output.gain.value=1,this.wetGain.gain.value=this.amount,this.dryGain.gain.value=1-this.amount}d.prototype.setInput=function(t){t.connect(this.dryGain),this.dryGain.connect(this.output),t.connect(this.node),this.node.connect(this.wetGain),this.wetGain.connect(this.output)},d.prototype.setAmount=function(t){this.amount=t<0?0:t>1?1:t,this.wetGain.gain.value=this.amount,this.dryGain.gain.value=1-this.amount},d.prototype.copy=function(){switch(this.type){case"reverb":return new s(this.config);case"panner":return new o(this.config);case"panner2":return new r(this.config);case"delay":return new a(this.config);case"compressor":return new h(this.config)}},n.createReverb=function(t){var e=i(t);return!1===e?(console.warn("no reverb with id",t,"loaded"),!1):new s({type:"reverb",buffer:e})},n.createPanner=function(t){return(t=t||{}).type="panner",new o(t)},n.createPanner2=function(t){return(t=t||{}).type="panner2",new r(t)},n.createDelay=function(t){return(t=t||{}).type="delay",new a(t)},n.createCompressor=function(t){return(t=t||{}).type="compressor",new h(t)},n.createBiQuadFilter=function(t){return(t=t||{}).type="biquadfilter",new c(t)},n.protectedScope.addInitMethod((function(){t=n.protectedScope.context,e=n.protectedScope.createClass,i=n.getSample,s=e(d,(function(e){this.node=t.createConvolver(),this.node.buffer=e.buffer})),o=e(d,(function(e){this.node=t.createPanner(),this.node.panningModel="equalpower",this.node.setPosition(1e-17,1e-17,1e-17)})),r=e(d,(function(e){this.node=t.createPanner(),this.node.panningModel="HRTF",this.node.setPosition(1e-17,1e-17,1e-17)})),a=e(d,(function(e){this.node=t.createDelay(),this.node.delayTime.value=.3})),h=e(d,(function(e){this.node=t.createDynamicsCompressor()})),c=e(d,(function(e){this.node=t.createBiquadFilter(),this.node.type=0,this.node.Q.value=4,this.node.frequency.value=1600})),o.prototype.setPosition=function(t){var e=t,i=0,n=1-Math.abs(e);e=0===e?1e-17:e,i=0===i?1e-17:i,n=0===n?1e-17:n,this.node.setPosition(e,i,n)},r.prototype.setPosition=function(t){var e,i,n,s=parseInt(t),o=s+90;o>90&&(o=180-o),e=0===(e=Math.sin(s*(Math.PI/180)))?1e-17:e,i=0==(i=0)?1e-17:i,n=0===(n=Math.sin(o*(Math.PI/180)))?1e-17:n,this.node.setPosition(e,i,n)},a.prototype.setTime=function(t){this.node.delayTime.value=t}}))}(),function(){var t,e=n.createNote,i=n.findEvent,s=n.protectedScope.round,o=n.protectedScope.getEvents,r=n.protectedScope.typeString;t=function(){var t,n,a,c,h,u,d,p,l,f,m,v=Array.prototype.slice.call(arguments),g=v.length,y=128,b=-1,k=0,P=0,w=!1;if(0===(a=o(v[0])).length)return-1;if(c=v[1],"string"!==r(c))return console.error("please provide a search string like for instance get('velocity max bar >= 1 < 8')"),-1;if(g>2&&console.warn("ignoring invalid arguments, please consult documentation"),h=(c=c.split(" ")).length,t=c[0],n=c[1],-1==="data1 data2 velocity noteNumber noteName frequency".indexOf(t))return console.error("you can't use 'min', 'max' or 'avg'","on the property",t),-1;if(-1==="max min avg all".indexOf(n))return console.error(n,"is not a valid operator"),-1;for(h>2&&(6===h&&console.warn("ignoring cruft found in search string, please consult documentation"),c.shift(),c.shift(),a=i(a,c.join(" "))),"noteName"===t&&(t="noteNumber",w=!0),u=0,d=a.length;u<d;u++)(l=(p=a[u])[t])>b&&(b=l,m=p.noteName),l<y&&(y=l,f=p.noteName),void 0!==l&&(k+=l);return P=k/d,w&&(P=s(P),P=e(P).name,y=f,b=m),"max"===n?b:"min"===n?y:"avg"===n?P:"all"===n?{min:y,max:b,avg:P}:void 0},n.getStats=t,n.protectedScope.addInitMethod((function(){e=n.createNote,i=n.findEvent,s=n.protectedScope.round,o=n.protectedScope.getEvents,r=n.protectedScope.typeString}))}(),function(){var t,e,i,s,o,r,a,c,h,u,d,p,l,f,m,v,g,y,b={barsbeats:["bar","beat","sixteenth","tick"],time:["hour","minute","second","millisecond"]},k=new RegExp(" "+"OR AND NOT XOR".replace(/\s+/g," | ")+" "),P={bar:1,beat:1,sixteenth:1,tick:1,ticks:1,barsbeats:1,musical_time:1,hour:1,minute:1,second:1,millisecond:1,millis:1,time:1,linear_time:1,id:1,type:1,data1:1,data2:1,velocity:1,noteNumber:1,frequency:1,noteName:1};a=function(){var t,i,n,s,a,c,u,p,l,f,m,b,P=Array.prototype.slice.call(arguments);if(f=[],0===(l=h(P[0])).length)return console.warn("findEvent: no events"),f;if("string"!==e(P[1]))return console.error("please provide a search string like for instance findEvent('beat = 2 AND velocity > 60 < 100');"),f;for(i=(s=(n=P[1]).split(" ")).length,r=[],t=0;t<i;t++)a=s[t],k.test(" "+a+" ")&&r.push(a);for(i=(s=n.split(k)).length,o=[],t=0;t<i;t++)d(s[t].split(" "));for(i=o.length,u=0,p=-1,t=0;t<i;t++)c=o[u++],"AND"===(a=r[p++])?f=y(f,c):"NOT"===a?f=y(f,c,!0):"XOR"===a?(b=y(l,c),f=v(f,b)):(m=y(l,c),f=f.concat(m));return g(f)},v=function(t,e){var i,n,s,o,r,a=t.length,c=e.length,h=[];for(i=0;i<a;i++){for(r=!0,o=(s=t[i]).id,n=0;n<c;n++)if(e[n].id===o){r=!1;break}r&&h.push(s)}for(n=0;n<c;n++){for(r=!0,o=(s=e[n]).id,i=0;i<a;i++)if(t[i].id===o){r=!1;break}r&&h.push(s)}return h},g=function(t){var e,i,n,s,o=t.length,r=[];for(t.sort((function(t,e){return t.eventNumber-e.eventNumber})),e=0;e<o;e++)(n=(i=t[e]).id)!==s&&r.push(i),s=n;return r},y=function(t,e,i){var n,s,o=[],r=e.property,a=e.operator1,c=e.operator2,h=e.value1,u=e.value2,d=t.length;for((i=i||!1)&&(a=m(a),c=m(c)),s=0;s<d;s++)n=t[s],l(r,n[r],a,h,c,u)&&o.push(n);return o},l=function(t,i,n,o,r,a){var c=!1,h=!1;if(void 0===i)return c;switch(t){case"noteName":if("="===n)return 3===o.length&&4===i.length?c=0===i.indexOf(o):4===o.length&&5===i.length&&(c=0===i.indexOf(o)),c;break;case"type":"number"!==e(o)&&isNaN(o)&&(o=s(o))}switch("string"===e(i)?("string"!==e(o)&&(o="'"+o+"'"),a&&"string"!==e(a)&&(a="'"+a+"'"),h=!0):"number"===e(i)&&("number"!==e(o)&&(o=parseInt(o)),a&&"number"!==e(a)&&(a=parseInt(a))),n){case"=":case"==":case"===":c=i===o;break;case"*=":c=-1!==i.indexOf(o);break;case"^=":c=0===i.indexOf(o);break;case"$=":c=i.indexOf(o)===i.length-o.length;break;case"%=":c=!h&&i%o==0;break;case"!*=":c=!(-1!==i.indexOf(o));break;case"!^=":c=!(0===i.indexOf(o));break;case"!$=":c=!(i.indexOf(o)===i.length-o.length);break;case"!%=":c=!(!h&&i%o==0);break;case"!=":case"!==":c=h?-1===i.indexOf(o):i!==o;break;case">":c=r?f(i,n,o,r,a):i>o;break;case">=":c=r?f(i,n,o,r,a):i>=o;break;case"<":c=r?f(i,n,o,r,a):i<o;break;case"<=":c=r?f(i,n,o,r,a):i<=o;break;default:console.warn("eval is evil!")}return c},f=function(t,e,i,n,s){var o=!1;switch(e){case">":switch(n){case"<":o=t>i&&t<s;break;case"<=":o=t>i&&t<=s}break;case">=":switch(n){case"<":o=t>=i&&t<s;break;case"<=":o=t>=i&&t<=s}break;case"<":switch(n){case">":o=t<i||t>s;break;case">=":o=t<i||t>=s}break;case"<=":switch(n){case">":o=t<=i||t>s;break;case">=":o=t<=i||t>=s}}return o},h=function(t){var i=[];return"array"===e(t)?i=t:void 0===t.className?console.warn(t):"Track"===t.className||"Part"===t.className?i=t.events:"Song"===t.className&&(i=t.eventsMidiTime),i},d=function(t){var e,i={property:t[0],operator1:t[1],value1:t[2],operator2:t[3],value2:t[4]},n=t[0],s=t[1],a=t[2],c=t[3],h=t[4];if(1!==P[n])return console.error(n,"is not a supported property"),!1;if(i=p(i),"barsbeats"===n||"time"===n){for(a=u(a,n),e=0;e<4;e++)(i={}).property=b[n][e],i.operator1=s,i.value1=a[e],o.push(i),r.push("AND");if(r.pop(),h){for(h=u(h,n),e=0;e<4;e++)(i={}).property=b[n][e],i.operator2=c,i.value2=h[e],o.push(i),r.push("AND");r.pop()}}else o.push(i)},u=function(t,i){switch(t=t.replace(/(\[|\])/g,""),"array"!==e(t)&&("barsbeats"===i?t=-1===t.indexOf(",")?[t,1,1,0]:t.split(","):"time"===i&&(t=-1===t.indexOf(",")?[0,t,0,0]:t.split(","))),t.length){case 1:"barsbeats"===i?t.push(1,1,0):"time"===i&&t.push(0,0,0);break;case 2:"barsbeats"===i?t.push(1,0):"time"===i&&t.push(0,0);break;case 3:t.push(0)}return t},p=function(e){var i=e.operator1,n=e.operator2,s=function(t){return"<"===t||">"===t||"<="===t||">="===t},o=function(t){return"="===t||"=="===t||"==="===t};return"noteName"===e.property&&(s(i)||o(i))&&(e.property="noteNumber",e.value1=t(e.value1).number),"noteName"===e.property&&(s(n)||o(n))&&(e.property="noteNumber",e.value2=t(e.value2).number),s(i)&&!s(n)&&(delete e.operator2,delete e.value2),e},m=function(t){var e;switch(t){case"=":case"==":case"===":e="!==";break;case"!=":case"!==":e="===";break;case"<":e=">=";break;case">":e="<=";break;case"<=":e=">";break;case">=":e="<";break;case"*=":case"^=":case"&=":case"%=":e="!"+t;break;default:e=t}return e},c=function(){var t,e,s,o,r=a.apply(this,arguments),c=r.length,h={},u=[];for(t=0;t<c;t++)(e=r[t]).type===n.NOTE_ON?(void 0===h[e.noteNumber]&&(h[e.noteNumber]=[]),h[e.noteNumber].push(e)):e.type===n.NOTE_OFF&&((o=h[e.noteNumber])&&(s=o.shift(),u.push(i(s,e))),0===o.length&&delete h[e.noteNumber]);return u.sort((function(t,e){return t.sortIndex-e.sortIndex})),u},n.findEvent=a,n.findNote=c,n.protectedScope.getEvents=h,n.protectedScope.addInitMethod((function(){t=n.createNote,e=n.protectedScope.typeString,i=n.createMidiNote,s=n.midiEventNumberByName}))}(),function(){var t,e,i,s,o,r,a,c,h,u,d,p,l,f,m,v=n.debug;function g(t){}function y(t,e,i,n){var s;for(e=0;e<i;e++)void 0!==(s=t[e])&&("MidiNote"===s.className?n.push(s.noteOn):"array"===r(s)&&y(s,0,s.length))}function b(t){return{getValue:function(t){return Math.sin(2*t*Math.PI)}}}(f=function(t){this.className="Instrument",this.config=t,this.scheduledEvents={},this.scheduledSamples={},this.sustainPedalDown=!1,this.sustainPedalSamples={},this.sampleDataByNoteNumber={},this.sampleData=[],this.info=t.info||t.instrument_info,this.author=t.author||t.instrument_author,this.license=t.license||t.instrument_license,this.pack=t.pack,this.parse()}).prototype.reset=function(){var t=n.getInstrument(this.config.localPath);!1!==n.getSamplePack(this.config.sample_path)&&!1!==t||(this.scheduledEvents={},this.scheduledSamples={},this.sustainPedalSamples={},this.sampleDataByNoteNumber={},this.sampleData=[],this.update&&delete s[this.updateTaskId],!1===t&&this.track.setInstrument())},f.prototype.parse=function(){var t,i,o,a,c,h,u,d,p,l,f,m,v,g,y,k,P,w,E,N,S=this.config,_=void 0===S.notename_mode?n.noteNameMode:S.notename_mode,T=S.mapping,A=this;if(void 0===S.name)return console.error("instruments must have a name",S),!1;if(void 0===T)return console.error("instruments must have a mapping to samples",S),!1;for(this.name=S.name,this.folder=S.folder||"",this.autopan=S.autopan||!1,this.singlePitch=S.single_pitch||!1,this.samplePath=S.sample_path||this.name,this.keyScalingRelease=S.keyscaling_release,this.keyScalingPanning=S.keyscaling_panning,this.keyRange=S.keyrange||S.key_range,f=this.samplePath.split("/"),E=e.samplepacks,t=0,i=f.length;t<i;t++){if(void 0===E)return void(n.debug&&console.log("sample pack not found",f.join("/")));E=E[f[t]]}N=e.audio;try{for(t=0,i=f.length;t<i;t++)N=N[f[t]]}catch(e){return void(n.debug&&console.log('sample pack "'+f[t]+'" is not loaded'))}if(void 0!==N){if("array"===r(T))for(this.keyRange=T,T={},t=this.keyRange[0];t<=this.keyRange[1];t++)T[t]="";for(g in void 0===this.keyRange?(this.lowestNote=128,this.highestNote=-1):(this.lowestNote=this.keyRange[0],this.highestNote=this.keyRange[1],this.numNotes=this.highestNote-this.lowestNote),void 0!==S.release_duration?this.releaseDuration=S.release_duration:this.releaseDuration=0,this.releaseEnvelope=S.release_envelope||"equal power",this.autopan&&(this.autoPanner=b()),this.samplepack=E,T)if(T.hasOwnProperty(g))if(y=T[g],isNaN(g)?(h=g.length,u=g.substring(h-1),d=g.substring(0,h-1),p=g,l=n.getNoteNumber(d,u)):(p=(p=n.getNoteNameFromNoteNumber(g,_)).join(""),l=g),l=parseInt(l,10),void 0===this.keyRange&&(this.lowestNote=l<this.lowestNote?l:this.lowestNote,this.highestNote=l>this.highestNote?l:this.highestNote),"array"===r(y))for(this.multiLayered=!0,t=0,i=y.length;t<i;t++){for(I(k=y[t]),void 0===this.sampleDataByNoteNumber[l]&&(this.sampleDataByNoteNumber[l]=[]),a=k.v[0],c=k.v[1],o=a;o<=c;o++)this.sampleDataByNoteNumber[l][o]=w;this.sampleData.push(w)}else I(y),this.sampleDataByNoteNumber[l]=w,this.sampleData.push(w);if(void 0===this.keyRange&&(this.numNotes=this.highestNote-this.lowestNote,this.keyRange=[this.lowestNote,this.highestNote]),this.config.mapping=T,this.singlePitch)for(t=127;t>=0;t--)this.sampleData[t]=w,this.sampleDataByNoteNumber[t]=w;P&&(this.updateTaskId="update_"+this.name+"_"+(new Date).getTime(),s[this.updateTaskId]=function(){A.autopan?A.update(this.autoPanner.getValue()):A.update()})}else n.debug&&console.log("sample pack not found",f.join("/"));function I(t){var e,i;if(t.n)m=N[t.n];else for(v=[l,p,p.toLowerCase()],i=2;i>=0;i--)if(void 0!==(m=N[v[i]])){T[g]={n:v[i]};break}if(void 0===m)return n.debug&&console.log("no buffer found for "+g+" ("+A.name+")"),void(w=!1);w={noteNumber:l,buffer:m,bufferId:t.n,autopan:A.autopan},!0===S.sustain&&(w.sustain=!0,P=!0),void 0!==t.s?(w.sustain_start=t.s[0],w.sustain_end=t.s[1],w.sustain=!0,P=!0):!0===S.sustain&&(void 0!==(e=E.samplesById[t.n].sustain)?(w.sustain_start=e[0],w.sustain_end=e[1]):w.sustain=!1),void 0!==S.release_duration&&(w.release_duration=S.release_duration,w.release_envelope=S.release_envelope||A.releaseEnvelope,w.release=!0,P=!0),void 0!==t.r&&("array"===r(t.r)?(w.release_duration=t.r[0],w.release_envelope=t.r[1]||A.releaseEnvelope):isNaN(t.r)||(w.release_duration=t.r,w.release_envelope=A.releaseEnvelope),w.release=!0,P=!0),void 0!==t.p&&(w.panPosition=t.p,w.panning=!0)}},f.prototype.getInfoAsHTML=function(){var t="",e="",i="",s=this.samplepack;return void 0!==this.info&&(e+="<tr><td>info</td><td>"+this.info+"</td></tr>"),void 0!==this.author&&(e+="<tr><td>author</td><td>"+this.author+"</td></tr>"),void 0!==this.license&&(e+="<tr><td>license</td><td>"+this.license+"</td></tr>"),e+="<tr><td>keyrange</td><td>"+this.lowestNote+"("+n.getFullNoteName(this.lowestNote)+")",""!=(e+=" - "+this.highestNote+"("+n.getFullNoteName(this.highestNote)+")</td></tr>")&&(t+=e='<table><th colspan="2">instrument</th>'+e+"</table>"),void 0===s?t:(void 0!==s.info&&(i+="<tr><td>info</td><td>"+s.info+"</td></tr>"),void 0!==s.author&&(i+="<tr><td>author</td><td>"+s.author+"</td></tr>"),void 0!==s.license&&(i+="<tr><td>license</td><td>"+s.license+"</td></tr>"),void 0!==s.compression&&(i+="<tr><td>compression</td><td>"+s.compression+"</td></tr>"),void 0!==s.filesize&&(i+="<tr><td>filesize</td><td>"+p(s.filesize/1024/1024,2)+" MiB</td></tr>"),""!==i&&(t+=i='<table><th colspan="2">samplepack</th>'+i+"</table>"),t)},f.prototype.getInfo=function(){var t={instrument:{},samplepack:{}};return void 0!==this.info&&(t.instrument.info=this.info),void 0!==this.author&&(t.instrument.author=this.author),void 0!==this.license&&(t.instrument.license=this.license),void 0!==this.keyrange&&(t.instrument.keyrange=this.keyrange),void 0!==this.info&&(t.samplepack.info=this.info),void 0!==this.author&&(t.samplepack.author=this.author),void 0!==this.license&&(t.samplepack.license=this.license),void 0!==this.compression&&(t.samplepack.compression=this.compression),void 0!==this.filesize&&(t.samplepack.filesize=p(this.samplepack.filesize/1024/1024,2)),t},f.prototype.createSample=function(t){var e=t.noteNumber,i=t.velocity,n=this.sampleDataByNoteNumber[e];return"array"===r(n)&&(n=n[i]),void 0===n||!1===n?{start:function(){console.warn("no audio data loaded for",e)},stop:function(){},update:function(){},addData:function(){},unschedule:function(){}}:(n.track=t.track,h(n))},f.prototype.setKeyScalingPanning=function(t,e){var i,n,s,o,r=this.sampleData.length;if(!1===t)for(i=0;i<r;i++)(n=this.sampleData[i]).panning=!1;if(!1===isNaN(t)&&!1===isNaN(e))for(s=(e-t)/this.numNotes,o=t,i=0;i<r;i++)(n=this.sampleData[i]).panning=!0,n.panPosition=o,o+=s},f.prototype.setRelease=function(t,e){if(void 0!==t){this.releaseEnvelope=e||this.releaseEnvelope,this.keyScalingRelease=void 0;var i,n,s=this.sampleData.length;for(i=0;i<s;i++)(n=this.sampleData[i]).release=!0,n.release_duration=t,n.release_envelope=this.releaseEnvelope;this.releaseDuration=t}},f.prototype.setKeyScalingRelease=function(t,e,i){var n,s,o,r,a=this.sampleData.length;if(this.releaseEnvelope=i||this.releaseEnvelope,!1===isNaN(t)&&!1===isNaN(e))for(this.keyScalingRelease=[t,e],this.releaseDuration=0,o=(e-t)/this.numNotes,r=t,n=0;n<a;n++)(s=this.sampleData[n]).release_duration=r,s.release_envelope=r,r+=o},f.prototype.transpose=function(t,e,i){if(void 0!==l){var n=this.sampleData.length;!function s(o,r){var a;i&&i("transposing sample "+(o+1)+" of "+n),o<n?(a=r[o],setTimeout((function(){l(a.buffer,t,(function(t){a.buffer=t,s(++o,r)}))}),10)):e&&(console.log("ready"),e())}(0,this.sampleData)}else console.log("transpose is still experimental")},f.prototype.processEvent=function(t){var e,i,n=t.type;void 0===t.time&&(t.time=0),128===n||144===n?128===n?(!0===this.sustainPedalDown&&(t.sustainPedalDown=!0),this.stopNote(t)):this.playNote(t):176===t.type&&(e=t.data1,i=t.data2,64===e?127===i?(this.sustainPedalDown=!0,u(this.track.song,"sustain_pedal","down")):0===i&&(this.sustainPedalDown=!1,u(this.track.song,"sustain_pedal","up"),this.stopSustain(t.time)):10===e?this.track.setPanning(d(i,0,127,-1,1)):7===e&&this.track.output.gain.setValueAtTime(i/127,t.time))},f.prototype.stopSustain=function(t){var e,i=this.scheduledSamples,n=this.sustainPedalSamples;c(n,(function(n){void 0!==n&&((e=n.midiNote).noteOn.sustainPedalDown=void 0,e.noteOff.sustainPedalDown=void 0,n.stop(t,(function(t){i[t.sourceId]=null,delete i[t.sourceId]})))})),this.sustainPedalSamples={}},f.prototype.playNote=function(t){var e,i;t.midiNote?(i=t.midiNote.id,void 0!==(e=this.scheduledSamples[i])&&e.unschedule(0),(e=this.createSample(t)).addData({midiNote:t.midiNote,noteName:t.midiNote.note.fullName,sourceId:i}),this.scheduledSamples[i]=e,e.start(t)):n.debug&&console.warn("playNote() no midi note")},f.prototype.stopNote=function(t){if(void 0!==t.midiNote){var e=t.midiNote.id,i=this.scheduledSamples[e],s=this.scheduledSamples,o=this.sustainPedalSamples;!0!==t.sustainPedalDown?void 0!==i&&i.stop(t.time,(function(){s[e]=null,delete s[e]})):o[e]=i}else n.debug&&console.warn("stopNote() no midi note",t.ticks,t.noteNumber)},f.prototype.hasScheduledSamples=function(){return a(this.scheduledSamples)},f.prototype.reschedule=function(t){var e,i,s,o=t.millis,r=o+1e3*n.bufferTime,a=this.scheduledSamples;for(e in a)if(a.hasOwnProperty(e))if(void 0===(i=(s=a[e]).midiNote)||"removed"===i.state)s.unschedule(0,g),delete a[e];else{if(i.noteOn.millis>=o&&i.noteOff.millis<r&&s.noteName===i.fullName)continue;delete a[e],s.unschedule(null,g)}},f.prototype.unschedule=function(){var t,e,n,s,o=Array.prototype.slice.call(arguments),r=[];for(y(o,0,o.length,r),t=r.length-1;t>=0;t--)void 0!==(e=r[t]).midiNote?(n=e.midiNote.id,void 0!==(s=this.scheduledSamples[n])&&(s.unschedule(0,g),delete this.scheduledSamples[n])):"MidiEvent"===e.className&&(n=e.id,delete i["event_"+n],delete this.scheduledEvents[n])},f.prototype.allNotesOff=function(){var t,e,n=this.scheduledSamples;if(this.stopSustain(0),this.sustainPedalDown=!1,void 0!==n&&!0!==a(n)){for(e in n)n.hasOwnProperty(e)&&(t=n[e])&&t.unschedule(0,g);this.scheduledSamples={},c(this.scheduledEvents,(function(t,e){delete i["event_"+e]})),this.scheduledEvents={}}},f.prototype.allNotesOffPart=function(t){var e,n,s=this.scheduledSamples;if(this.stopSustain(0),this.sustainPedalDown=!1,void 0!==s&&!0!==a(s)){for(n in s)s.hasOwnProperty(n)&&(e=s[n])&&e.unschedule(0,g);this.scheduledSamples={},c(this.scheduledEvents,(function(t,e){delete i["event_"+e]})),this.scheduledEvents={}}},f.prototype.update=function(t){var e,i;for(e in this.scheduledSamples)this.scheduledSamples.hasOwnProperty(e)&&(i=this.scheduledSamples[e])&&i.update(t)},n.createInstrument=function(t){var i,n,s=r(t);return"object"===s?("Instrument"===t.className?n=t:"InstrumentConfig"===t.className&&(n="sinewave"===t.name?new m(t):new f(t)),n):("string"===s&&(i=o(t,e.instruments)),0==i||"InstrumentConfig"!==i.className?(v>=2&&console.info("can not create instrument from",t),!1):n="sinewave"===i.name?new m(i):new f(i))},n.protectedScope.addInitMethod((function(){var v=n.protectedScope;e=n.storage,h=n.createSample,n.createReverb,u=n.protectedScope.songDispatchEvent,t=v.context,i=v.timedTasks,s=v.repetitiveTasks,c=v.objectForEach,a=v.isEmptyObject,o=v.findItem,v.storeItem,r=v.typeString,v.pathToArray,l=v.transpose,m=v.createClass(f),d=n.util.remap,p=n.util.round,n.util.getEqualPowerCurve,m.prototype.parse=function(){var e=this,i=this.config;this.name="SineWave",this.waveForm=i.wave_form||"sine",this.autopan=i.autopan||!1,this.folder=i.folder||"heartbeat",this.releaseDuration=i.release_duration||1500,this.autopan&&(this.autoPanner=b()),s["update_"+this.name+"_"+(new Date).getTime()]=function(){e.autopan?e.update(Math.sin(2*t.currentTime*Math.PI)):e.update()}},m.prototype.createSample=function(t){var e={oscillator:!0,track:t.track,event:t,autopan:this.autopan,wave_form:this.waveForm,release_envelope:"equal power",release_duration:this.releaseDuration};return h(e)},n.createSimpleSynth=function(t){return new m(t=t||{})}}))}(),h(),function(){var t,e,i,s,o,r,a,c,h,u,d,p,l,f="newEvents newNotes newParts changedEvents changedNotes changedParts removedEvents removedNotes removedParts".split(" "),m=Math.ceil;(t=function(t,i){this.song=t,this.song.keyEditor=this,this.playhead=s(this.song,"barsbeats ticks millis","keyeditor"),this.numBars=t.bars,this.newNumBars=this.numBars,this.eventListeners={},this.interrupt=!1,this.iteratorFactory=e(this.song,this),this.verticalLine=this.iteratorFactory.createVerticalLineIterator(this),this.horizontalLine=this.iteratorFactory.createHorizontalLineIterator(this),this.eventIterator=this.iteratorFactory.createEventIterator(this),this.noteIterator=this.iteratorFactory.createNoteIterator(this),this.partIterator=this.iteratorFactory.createPartIterator(this),this.exactFitVertical=i.exactFitVertical||!1,this.exactFitHorizontal=i.exactFitHorizontal||!1,this.activeEvents=[],this.activeNotes=[],this.activeParts=[],this.newEvents=[],this.newNotes=[],this.newParts=[],this.changedEvents=[],this.changedNotes=[],this.changedParts=[],this.removedEvents=[],this.removedNotes=[],this.removedParts=[],this.recordedNotesObj={},this.recordedEventsObj={},this.snapshot={activeEvents:this.activeEvents,activeNotes:this.activeNotes,activeParts:this.activeParts,newEvents:this.newEvents,newNotes:this.newNotes,newParts:this.newParts,changedEvents:this.changedEvents,changedNotes:this.changedNotes,changedParts:this.changedParts,removedEvents:this.removedEvents,removedNotes:this.removedNotes,removedParts:this.removedParts},i.paginate?(this.paginate=!0,this.pageNo=0,this.barsPerPage=i.barsPerPage,this.pageWidth=i.pageWidth,this.pageHeight=i.pageHeight,this.width=this.pageWidth,this.lowestNote=i.lowestNote||t.lowestNote,this.highestNote=i.highestNote||t.highestNote,this.pitchRange=this.highestNote-this.lowestNote,this.exactFitVertical?(this.pitchHeight=this.height/this.pitchRange,this.height=this.pageHeight):(this.pitchHeight=i.pitchHeight||10,this.height=this.pitchHeight*this.pitchRange),u(this,0),d(this)):(this.setStartPosition(i.startPosition||1),this.setEndPosition(i.endPosition||t.bars+1),this.numTicks=this.endTicks-this.startTicks,i.width?(this.width=i.width,this.tickWidth=this.width/this.numTicks):i.tickWidth?(this.tickWidth=i.tickWidth,this.width=this.numTicks*this.tickWidth,this.exactFitHorizontal=!1):i.barsPerPage&&i.viewportWidth?(this.barsPerPage=i.barsPerPage,this.viewportWidth=i.viewportWidth,this.tickWidth=this.viewportWidth/(this.startPosition.ticksPerBar*this.barsPerPage),this.width=this.numTicks*this.tickWidth,this.scrollX=0,this.scrollPosition=0,this.viewportTicks=this.viewportWidth/this.tickWidth,this.maxScrollPosition=m(this.width/this.viewportWidth),this.scrollLimit=this.viewportWidth/this.tickWidth,p(this),this.exactFitHorizontal=!1):i.viewportWidth?(this.viewportWidth=this.width=i.viewportWidth,this.tickWidth=this.viewportWidth/this.numTicks,this.exactFitHorizontal=!0):(this.tickWidth=.1,this.width=this.numTicks*this.tickWidth,this.exactFitHorizontal=!1),this.lowestNote=i.lowestNote||t.lowestNote,this.highestNote=i.highestNote||t.highestNote,this.pitchRange=i.pitchRange||this.highestNote-this.lowestNote+1,i.height?(this.height=i.height,this.pitchHeight=this.height/this.pitchRange):i.pitchHeight?(this.pitchHeight=i.pitchHeight,this.height=this.pitchRange*this.pitchHeight,this.exactFitVertical=!1):i.viewportHeight?(this.viewportHeight=this.height=i.viewportHeight,this.pitchHeight=this.viewportHeight/this.pitchRange,this.exactFitVertical=!0):(this.pitchHeight=10,this.height=this.pitchRange*this.pitchHeight,this.exactFitVertical=!1)),this.scrollX=0,this.scrollY=0,this.currentPage=1,this.numPages=m(this.width/this.viewportWidth),this.snapValueX=void 0===i.snapX?0:i.snapX,this.snapValueY=void 0===i.snapY?"chromatic":i.snapY,this.setSnapX(this.snapValueX),this.setSnapY(this.snapValueY)}).prototype.setBarsPerPage=function(t){this.interrupt=!0;var e=a(this.scrollX/(this.viewportWidth/this.barsPerPage));this.barsPerPage=t,this.tickWidth=this.viewportWidth/(this.startPosition.ticksPerBar*this.barsPerPage),this.viewportTicks=this.viewportWidth/this.tickWidth,this.width=this.numTicks*this.tickWidth,this.verticalLine.reset(),this.horizontalLine.reset(),this.eventIterator.reset(),this.partIterator.reset(),this.scrollLimit=this.viewportWidth/this.tickWidth,this.maxScrollPosition=m(this.width/this.viewportWidth),this.snapWidth=this.tickWidth*this.snapTicks,this.numPages=m(this.numBars/this.barsPerPage),this.currentPage=c(this.song.ticks/(this.barsPerPage*this.song.ticksPerBar))+1,l(this,"scale",{}),this.song.playing?this.scrollPosition=c(this.song.ticks/this.viewportTicks):(this.scrollPosition=this.viewportWidth/this.barsPerPage*e/this.viewportWidth,l(this,"scroll",{x:this.scrollPosition*this.viewportWidth})),this.interrupt=!1},t.prototype.setViewport=function(t,e){var i=!1;this.barsPerPage&&t!==this.viewportWidth?(this.viewportWidth=t,this.tickWidth=this.viewportWidth/(this.startPosition.ticksPerBar*this.barsPerPage),this.viewportTicks=this.viewportWidth/this.tickWidth,this.width=this.numTicks*this.tickWidth,i=!0):!0===this.exactFitHorizontal&&t!==this.width&&(this.viewportWidth=this.width=t,this.tickWidth=this.width/this.numTicks,i=!0),!0===this.exactFitVertical&&e!==this.height&&(this.viewportHeight=this.height=e,this.pitchHeight=this.height/this.pitchRange,i=!0),i&&(this.verticalLine.reset(),this.horizontalLine.reset(),this.eventIterator.reset(),this.noteIterator.reset(),this.partIterator.reset(),l(this,"draw",{}))},t.prototype.updateSong=function(t){this.iteratorFactory.updateSong();var e,i,n,s,o=0;for(o=f.length-1;o>=0;o--)switch(e=f[o]){case"newNotes":case"changedNotes":for(i=(n=t[e]).length-1;i>=0;i--)(s=n[i]).bbox=this.getNoteRect(s);break;case"newParts":case"changedParts":for(i=(n=t[e]).length-1;i>=0;i--)(s=n[i]).bbox=this.getPartRect(s)}this.newNumBars=t.numBars,this.newEvents=this.newEvents.concat(t.newEvents),this.changedEvents=this.changedEvents.concat(t.changedEvents),this.removedEvents=this.removedEvents.concat(t.removedEvents),this.removedEventsObj=r(this.removedEvents,"id"),this.newNotes=this.newNotes.concat(t.newNotes),this.changedNotes=this.changedNotes.concat(t.changedNotes),this.removedNotes=this.removedNotes.concat(t.removedNotes),this.removedNotesObj=r(this.removedNotes,"id"),this.newParts=this.newParts.concat(t.newParts),this.changedParts=this.changedParts.concat(t.changedParts),this.removedParts=this.removedParts.concat(t.removedParts),this.removedPartsObj=r(this.removedParts,"id")},t.prototype.setStartPosition=function(t){"array"!==o(t)&&(t=["barsandbeats",t,1,1,0]),this.startPosition=i(this.song,t),this.startTicks=this.startPosition.ticks,this.startMillis=this.startPosition.millis},t.prototype.setEndPosition=function(t){"array"!==o(t)&&(t=["barsandbeats",t,1,1,0]),this.endPosition=i(this.song,t),this.endTicks=this.endPosition.ticks,this.endMillis=this.endPosition.millis},t.prototype.addEventListener=function(t,e){var i,n=t.split(" "),s=this;n.forEach((function(t){void 0===(i=s.eventListeners[t])&&(s.eventListeners[t]=[],i=s.eventListeners[t]),i.length,i.push(e)}))},t.prototype.nextPage=function(){u(this,this.startBar+this.barsPerPage),l(this,"pagechange",{pageNo:this.pageNo,lastPage:this.lastPage})},t.prototype.prevPage=function(){u(this,this.startBar-this.barsPerPage),l(this,"pagechange",{pageNo:this.pageNo,lastPage:this.lastPage})},t.prototype.gotoPage=function(t){console.warn("ooops, not implemented yet!")},t.prototype.scroll=function(t){var e,i=a(this.scrollX/(this.viewportWidth/this.barsPerPage));switch(this.scrollPosition=this.viewportWidth/this.barsPerPage*i/this.viewportWidth,t){case">":this.scrollPosition+=1,this.scrollPosition=this.scrollPosition>this.maxScrollPosition?this.maxScrollPosition:this.scrollPosition;break;case">>":this.scrollPosition=this.maxScrollPosition;break;case"<":this.scrollPosition-=1,this.scrollPosition=this.scrollPosition<0?0:this.scrollPosition;break;case"<<":this.scrollPosition=0;break;default:if(isNaN(t))return;this.scrollPosition=parseInt(t)}e=this.scrollPosition*this.viewportWidth,this.scrollLimit=(e+this.viewportWidth)/this.tickWidth,this.currentPage=m(e/this.viewportWidth)+1,0===this.currentPage?this.currentPage=1:this.currentPage>this.maxScrollPosition&&(this.currentPage=this.maxScrollPosition),l(this,"scroll",{x:e})},t.prototype.updateScroll=function(t,e){this.scrollX=t,this.scrollY=e,this.scrollLimit=(t+this.viewportWidth)/this.tickWidth},t.prototype.getEventRect=function(t){var e=this.ticksToX(t.ticks-this.startTicks,!1),i=this.pitchToY(t.number),n=2*this.tickWidth,s=this.pitchHeight;return{x:e,y:i,width:n,height:s,top:i,left:e,bottom:i+s,right:e+n}},t.prototype.getNoteRect=function(t){var e,i,n=this.ticksToX(t.ticks-this.startTicks,!1),s=this.pitchToY(t.number),o=t.durationTicks*this.tickWidth,r=this.pitchHeight;if(t.endless&&(o=(this.song.ticks-t.noteOn.ticks)*this.tickWidth),this.paginate){if(e=t.ticks,i=t.noteOff.ticks,!(e<this.startTicks))return!1;n=(e=e+(this.startTicks-e)-this.startTicks)*this.tickWidth,o=((i=i>this.endTicks?this.endTicks:i)-this.startTicks)*this.tickWidth}return{x:n,y:s,width:o,height:r,top:s,left:n,bottom:s+r,right:n+o}},t.prototype.getPartRect=function(t){var e=t.getStats("noteNumber all"),i={top:this.pitchToY(e.max),bottom:this.pitchToY(e.min)+this.pitchHeight,left:this.ticksToX(t.start.ticks-this.startTicks,!1),right:this.ticksToX(t.end.ticks-this.startTicks,!1)};return i.x=i.left,i.y=i.top,i.width=i.right-i.left,i.height=i.bottom-i.top,t.bbox=i,t.stats=e,i},t.prototype.getBBox=function(t){var e,i;if("string"===o(t))switch(t.substring(0,1)){case"E":if(e="event",144!==event.type||void 0===event.endEvent)return void console.error("argument not supported, please check documentation");i=this.song.findEvent("id = "+t);break;case"P":e="part",i=this.song.getPart(t);break;case"T":e="track";break;default:return void console.error("argument not supported, please check documentation")}else switch(t.className){case"AudioEvent":e="audio";break;case"MidiEvent":e="event";break;case"Part":e="part";break;case"Track":e="track";break;default:return void console.error("argument not supported, please check documentation")}if(void 0!==i)switch(e){case"event":return this.getNoteRect(i);case"part":return this.getPartRect(i)}else console.error(t,"could not be found")},t.prototype.startMoveNote=function(t,e,i){"MidiNote"===t.className?(this.selectedNote=t,this.gripX=e-this.selectedNote.bbox.x):n.debug>=n.WARN&&console.warn(t,"is not a MidiNote")},t.prototype.stopMoveNote=function(){this.selectedNote=void 0},t.prototype.moveNote=function(t,e){if(void 0!==this.selectedNote){var i=this.yToPitch(e).number,n=this.selectedNote.pitch,s=this.xToTicks(t-this.gripX),o=this.selectedNote.ticks,r=this.selectedNote.part,a=!1;i!==n&&(r.transposeNote(this.selectedNote,i-n),a=!0),s!==o&&(r.moveNote(this.selectedNote,s-o),a=!0),!0===a&&this.song.update()}},t.prototype.startMovePart=function(t,e,i){"Part"===t.className?(this.selectedPart=t,this.selectedPart.pitch=this.yToPitch(i).number,this.gripX=e-this.selectedPart.bbox.x):n.debug>=n.WARN&&console.warn(t,"is not a Part")},t.prototype.stopMovePart=function(){this.selectedPart=void 0},t.prototype.movePart=function(t,e,i){if(void 0!==this.selectedPart){void 0===i&&(i=!0);var n=this.yToPitch(e).number,s=this.selectedPart.pitch,o=this.xToTicks(t-this.gripX),r=this.selectedPart.ticks,a=!1;n!==s&&(this.selectedPart.track.transposePart(this.selectedPart,n-s),this.selectedPart.pitch=n,a=!0),o!==r&&(this.selectedPart.track.movePart(this.selectedPart,o-r),a=!0),!0===a&&!0===i&&this.song.update()}},t.prototype.getTicksAt=t.prototype.xToTicks=function(t,e){var i=(t+this.scrollX)/this.width*this.numTicks;return!1!==e&&0!==this.snapTicks&&(i=a(i/this.snapTicks)*this.snapTicks),i},t.prototype.getPitchAt=t.prototype.yToPitch=function(t){var e=this.highestNote-a((t+this.scrollY)/this.height*this.pitchRange);return e=h(e)},t.prototype.getXAt=t.prototype.ticksToX=function(t,e){var i=(t-this.startTicks)*this.tickWidth;return!1!==e&&0!==this.snapWidth&&(i=a(i/this.snapWidth)*this.snapWidth),i},t.prototype.getYAt=t.prototype.pitchToY=function(t){return this.height-(t-this.lowestNote+1)*this.pitchHeight},t.prototype.getPositionAt=function(t){var e=this.getTicksAt(t);return this.playhead.set("ticks",e,!1),this.playhead.get()},t.prototype.getPlayheadX=function(t){var e=this.song.ticks/this.song.durationTicks*this.width;return e=!0===t?e-this.scrollX:e},t.prototype.setPlayheadToX=function(t){var e=this.xToTicks(t,!1);this.song.setPlayhead("ticks",e)},t.prototype.getPlayheadPosition=function(t){var e=this.song.ticks/this.song.durationTicks*this.width;return e=!0===t?e-this.scrollX:e},t.prototype.setPlayheadPosition=function(t,e){var n;switch(t){case"x":n=this.xToTicks(e,!1);break;case"ticks":n=e;break;case"millis":n=this.playhead.set("millis",e).ticks;break;case"barsbeats":case"barsandbeats":n=i(this.song,["barsbeats",e]).ticks}this.song.setPlayhead("ticks",n)},t.prototype.getEventAt=function(t,e){this.getSongPosition(t),this.getPitchAt(e)},t.prototype.getEventsInRect=function(t,e,i,n){this.getSongPosition(t),this.getSongPosition(t+i),this.getPitchAt(e+n),this.getPitchAt(e)},t.prototype.getNoteAt=function(t,e){this.getSongPosition(t),this.getPitchAt(e)},t.prototype.getNotesInRect=function(t,e,i,n){this.getSongPosition(t),this.getSongPosition(t+i),this.getPitchAt(e+n),this.getPitchAt(e)},t.prototype.snap=function(t,e){return{x:this.snapX(t),y:this.snapY(e)}},t.prototype.snapX=function(t){return a((t+this.scrollX)/this.snapWidth)*this.snapWidth},t.prototype.snapY=function(t){return a((t+this.scrollY)/this.snapHeight)*this.snapHeight},t.prototype.setSnapX=function(t){if(void 0!==t){var e=4/this.song.denominator;"off"===t?this.snapTicks=0:"tick"===t?this.snapTicks=1:"beat"===t?this.snapTicks=this.song.ppq*e:"bar"===t?this.snapTicks=this.song.ppq*this.song.nominator*e:isNaN(t)&&-1!==t.indexOf("ticks")?(this.snapTicks=t.replace(/ticks/,""),isNaN(this.snapTicks)?this.snapTicks=this.song.ppq/4:this.snapTicks=parseInt(this.snapTicks)):isNaN(t)||0===t?(t=0,this.snapTicks=0):(t=parseInt(t),this.snapTicks=4/t*this.song.ppq),this.snapValueX=t,this.snapWidth=this.tickWidth*this.snapTicks}},t.prototype.setSnapY=function(t){void 0!==t&&(this.snapValueY=t,this.snapHeight=this.pitchHeight)},t.prototype.removeNote=function(t){t.part.removeEvents(t.noteOn,t.noteOff),this.song.update()},t.prototype.removePart=function(t){t.track.removePart(t),this.song.update()},t.prototype.prepareForRecording=function(){this.recordedEventsObj={},this.recordedNotesObj={}},t.prototype.getSnapshot=function(){var t,e,n,s,o,r,a,h,u,d,p,l=[],f=[],v=[],g=[].concat(this.activeEvents),y=[].concat(this.activeNotes),b=[].concat(this.activeParts),k=[],P=[],w=[];for(a in this.activeEvents=[],this.activeNotes=[],this.activeParts=[],this.activeStateChangedEvents=[],this.activeStateChangedNotes=[],this.activeStateChangedParts=[],this.newNumBars!==this.numBars&&(d=this.numBars,p=this.song.lastBar+1,this.endPosition=i(this.song,["barsbeats",p,1,1,0,!0]),this.verticalLine.reset(i(this.song,["barsbeats",d,1,1,0,!0]),this.endPosition),this.numBars=this.song.bars,this.endTicks=this.endPosition.ticks,this.numTicks=this.song.durationTicks,this.width=this.numTicks*this.tickWidth,this.maxScrollPosition=m(this.width/this.viewportWidth),this.numPages=m(this.numBars/this.barsPerPage)),t=this.song.activeEvents)t.hasOwnProperty(a)&&(h=t[a],this.activeEvents.push(h),!0!==h.active&&(h.active=!0,this.activeStateChangedEvents.push(h)));for(a in e=this.song.activeNotes)e.hasOwnProperty(a)&&(h=e[a],this.activeNotes.push(h),!0!==h.active&&(h.active=!0,this.activeStateChangedNotes.push(h)));for(a in n=this.song.activeParts)n.hasOwnProperty(a)&&(h=n[a],this.activeParts.push(h),!0!==h.active&&(h.active=!0,this.activeStateChangedParts.push(h)));if(o=this.song.recordedEvents)for(u=o.length,a=0;a<u;a++)h=o[a],void 0===this.recordedEventsObj[h.id]&&(h.bbox=this.getEventRect(h),k.push(h),this.recordedEventsObj[h.id]=h);if(s=this.song.recordedNotes)for(u=s.length,a=0;a<u;a++)h=s[a],void 0===this.recordedNotesObj[h.id]?(this.recordedNotesObj[h.id]=h,h.bbox=this.getNoteRect(h),P.push(h)):!0===h.endless?(h.bbox=this.getNoteRect(h),w.push(h)):!1===h.endless&&(h.bbox=this.getNoteRect(h),w.push(h),h.endless=void 0);for(a=g.length-1;a>=0;a--)void 0!==(h=g[a])?void 0===t[h.id]&&(l.push(h),!1!==h.active&&(h.active=!1,this.activeStateChangedEvents.push(h))):console.warn("event is undefined");for(a=y.length-1;a>=0;a--)void 0!==(h=y[a])?void 0===e[h.id]&&(f.push(h),!1!==h.active&&(h.active=!1,this.activeStateChangedNotes.push(h))):console.warn("note is undefined");for(a=b.length-1;a>=0;a--)void 0!==(h=b[a])?void 0===n[h.id]&&(v.push(h),!1!==h.active&&(h.active=!1,this.activeStateChangedParts.push(h))):console.warn("part is undefined");return this.song.playing&&(this.currentPage=c(this.song.ticks/(this.barsPerPage*this.song.ticksPerBar))+1),r={events:{active:this.activeEvents,inActive:this.nonActiveEvents,recorded:k,new:this.newEvents,changed:this.changedEvents,removed:this.removedEvents,stateChanged:this.activeStateChangedEvents},notes:{active:this.activeNotes,inActive:f,recorded:P,recording:w,new:this.newNotes,changed:this.changedNotes,removed:this.removedNotes,stateChanged:this.activeStateChangedNotes},parts:{active:this.activeParts,inActive:v,new:this.newParts,changed:this.changedParts,removed:this.removedParts,stateChanged:this.activeStateChangedParts},hasNewBars:d!==p,newWidth:this.width,pageNo:this.currentPage,lastPage:this.numPages},this.newEvents=[],this.changedEvents=[],this.removedEvents=[],this.newNotes=[],this.changedNotes=[],this.removedNotes=[],this.newParts=[],this.changedParts=[],this.removedParts=[],r},u=function(t,e){var i;for(t.numTicks=0,t.startBar=e>0?e:0,t.startBar=t.startBar>t.numBars-t.barsPerPage?t.numBars-t.barsPerPage:t.startBar,t.endBar=e+t.barsPerPage,t.endBar=t.endBar>t.numBars?t.numBars:t.endBar,t.endBar=t.endBar<t.barsPerPage?t.barsPerPage:t.endBar,console.log(e,t.startBar,t.endBar,t.numBars,t.numBars-t.barsPerPage),i=t.startBar;i<t.endBar;i++)t.numTicks+=t.bars[i].ticksPerBar;t.tickWidth=t.pageWidth/t.numTicks,t.startPosition=t.bars[t.startBar],t.endPosition=t.bars[t.endBar],t.startTicks=t.startPosition.ticks,t.endTicks=t.endPosition.ticks,t.verticalLine.reset(),t.horizontalLine.reset(),t.eventIterator.reset()},d=function(t){t.song.playing()&&t.song.ticks>=t.endTicks&&t.nextPage(),requestAnimationFrame((function(){d(t)}))},p=function(t){if(t.song.playing&&!1===t.interrupt)if(t.song.ticks>=t.scrollLimit)l(t,"scroll",{x:t.scrollX+t.viewportWidth}),t.scrollLimit+=t.viewportWidth/t.tickWidth;else{var e=c(t.song.ticks/t.viewportTicks)*t.viewportTicks*t.tickWidth;t.scrollX!==e&&l(t,"scroll",{x:e})}requestAnimationFrame((function(){p(t)}))},l=function(t,e,i){var n=t.eventListeners[e];n&&n.forEach((function(t){t(i)}))},n.createKeyEditor=function(e,i){return new t(e,i)},n.protectedScope.addInitMethod((function(){i=n.protectedScope.getPosition,s=n.protectedScope.createPlayhead,h=n.createNote,n.debug,c=n.protectedScope.floor,a=n.protectedScope.round,o=n.protectedScope.typeString,n.protectedScope.objectToArray,r=n.protectedScope.arrayToObject,n.protectedScope.getScaffoldingBars,e=n.protectedScope.createKeyEditorIteratorFactory}))}(),function(){var t,e;function i(e,i){this.song=e,this.editor=i,this.position=t(this.song,"all","iterators"),this.updateSong()}i.prototype.updateSong=function(){this.events=this.song.events,this.numEvents=this.events.length,this.notes=this.song.notes,this.numNotes=this.notes.length,this.parts=this.song.parts,this.numParts=this.parts.length,this.position.updateSong()},i.prototype.createVerticalLineIterator=function(){var t,e,i,n,s,o,r,a,c,h,u,d,p,l,f,m={},v=this.editor,g=this.position;return f=function(){l=g.update("ticks",s),m.bar=l.ticksPerBar,m.beat=l.ticksPerBeat,m.sixteenth=l.ticksPerSixteenth,h=l.nominator,u=l.numSixteenth},{next:function(d){switch(d?n=d:e<.02?n="bar":e<.042&&(n="beat"),n){case"sixteenth":t="sixteenth",++c>u&&(t="beat",c=1,++a>h&&(t="bar",a=1,r++));break;case"beat":t="beat",c=1,++a>h&&(t="bar",a=1,r++);break;case"bar":t="bar",c=1,a=1,r++}return s+=m[n],f(),!(s>o)&&{x:s*e-i,bar:r,beat:a,sixteenth:c,type:t,position:l}},reset:function(t,h){d=t||v.startPosition,p=h||v.endPosition,s=d.ticks,r=d.bar,a=d.beat,c=d.sixteenth,o=p.ticks,e=v.tickWidth,i=0,g.set("ticks",s),e<.02?n="bar":e<.042&&(n="beat"),f()},hasNext:function(t){var i=o-s,r=!1;switch(t&&(n=t,e<.02?n="bar":e<.042&&(n="beat")),n){case"bar":case"beat":case"sixteenth":r=i>=m[n]}return r},setType:function(t){n=t,e<.02?n="bar":e<.042&&(n="beat")}}},i.prototype.createHorizontalLineIterator=function(){var t,i,n,s,o={},r=this.editor;return{next:function(n){return o={note:e(i),y:t*s},i--,t++,o},reset:function(){t=0,i=r.highestNote,n=r.pitchRange,s=r.pitchHeight},hasNext:function(e){var i=!1;switch(e){case"chromatic":i=t<n}return i}}},i.prototype.createEventIterator=function(){var t,e,i,s,o,r=this.editor,a=this.position,c=this.events,h=this.numEvents,u="";return{next:function(t){return u=t||u,e||o(u),e=!1,s},reset:function(){r.startTicks,t=r.endTicks,e=!1,!0===r.paginate&&!0===n.isPlaying()||(i=a.get().eventIndex-2)},hasNext:o=function(n){return u=n||u,e=!0,++i!==h&&(s=c[i],""===u&&s.ticks<=t)},setTypes:function(){var t=Array.prototype.slice.call(arguments);t.forEach((function(t){u+=t+" "}))}}},i.prototype.createNoteIterator=function(){var t,e,i,s,o,r,a,c=this.editor,h=this.song,u=this.notes,d=this.numNotes,p="";return{next:function(t){return p=t||p,i||a(p),i=!1,r.bbox=c.getNoteRect(r),r},reset:function(){if(t=c.startTicks,e=c.endTicks,u=h.notes,d=h.numNotes,i=!1,!0!==c.paginate||!0!==n.isPlaying()){for(s=0;s<d&&!(u[s].ticks>=t);s++);s--}},hasNext:a=function(n){if(p=n||p,i=!0,++s===this.numNotes)return!1;for(o=!1;s<d&&!((r=u[s]).ticks>=e);s++)if(c.paginate){if(r.ticks<t&&r.noteOff.ticks>t?o=!0:r.ticks<e&&(o=!0),o)break}else if(o=r.ticks<=e)break;return o}}},i.prototype.createPartIterator=function(){var t,e,i,n=this.editor,s=this.song,o=this.parts;return{next:function(e){return(i=o[t++]).bbox=n.getPartRect(i),i},reset:function(){o=s.parts,e=s.numParts,t=0},hasNext:function(i){return t<e}}},n.protectedScope.createKeyEditorIteratorFactory=function(t,e){return new i(t,e)},n.protectedScope.addInitMethod((function(){e=n.createNote,t=n.protectedScope.createPlayhead}))}(),function(){var t,e,i,s,o,r,a={volume:"setVolume",instrument:"setInstrument",noteNumberAccentedTick:"setNoteNumberAccentedTick",noteNumberNonAccentedTick:"setNoteNumberNonAccentedTick",velocityAccentedTick:"setVelocityAccentedTick",velocityNonAccentedTick:"setVelocityNonAccentedTick",noteLengthAccentedTick:"setNoteLengthAccentedTick",noteLengthNonAccentedTick:"setNoteLengthNonAccentedTick"};function c(t){return isNaN(t)?(n.debug&&console.log("please provide a number"),!1):t<0||t>127?(n.debug&&console.log("please provide a number between 0 and 127"),!1):t}function h(e,s,o,r){var a,c,h,u,d,p,l,f,m,v,g=0,y=[],b=e.song;for(a=s;a<=o;a++)for(l=(h=t(b,["barsbeats",a])).nominator,f=h.ticksPerBeat,c=0;c<l;c++)p=0===c?e.noteNumberAccented:e.noteNumberNonAccented,d=0===c?e.noteLengthAccented:e.noteLengthNonAccented,u=0===c?e.velocityAccented:e.velocityNonAccented,m=n.createMidiEvent(g,144,p,u),v=n.createMidiEvent(g+d,128,p,0),"precount"===r&&(m.part={id:"precount"},m.track=e.track,v.part={id:"precount"},v.track=e.track),i(m,v),y.push(m,v),g+=f;return y}(r=function(t){this.song=t,this.track=n.createTrack(this.song.id+"_metronome","metronome"),this.part=n.createPart(),this.track.addPart(this.part),this.track.connect(this.song.gainNode),this.events=[],this.precountEvents=[],this.noteNumberAccented=61,this.noteNumberNonAccented=60,this.volume=1,this.velocityNonAccented=100,this.velocityAccented=100,this.noteLengthNonAccented=t.ppq/4,this.noteLengthAccented=t.ppq/4,this.track.setInstrument("heartbeat/metronome"),this.precountDurationInMillis=0,this.bars=0}).prototype.init=function(t,e,i){t=void 0===t?"init":t,this.part.numEvents>0&&this.part.removeEvents(this.part.events),this.events=h(this,e,i,t),this.numEvents=this.events.length,this.part.addEvents(this.events),this.bars=this.song.bars,o(this.song,this.events)},r.prototype.update=function(t,e){0===t&&(t=1),void 0!==t&&void 0!==e?this.init("update",t,e):this.init("update",1,this.song.bars)},r.prototype.updateConfig=function(){this.init("configure",1,this.bars),this.allNotesOff(),this.song.scheduler.updateSong()},r.prototype.configure=function(t){var i=this;e(t,(function(t,e){i[a[e]](t)})),this.updateConfig()},r.prototype.setInstrument=function(t){"Instrument"!==t.className&&(t=n.createInstrument(t)),!1!==t?this.track.setInstrument(t):this.track.setInstrument("heartbeat/metronome"),this.updateConfig()},r.prototype.setNoteLengthAccentedTick=function(t){isNaN(t)&&n.debug>=2&&console.warn("please provide a number"),this.noteLengthAccented=t,this.updateConfig()},r.prototype.setNoteLengthNonAccentedTick=function(t){isNaN(t)&&n.debug>=2&&console.warn("please provide a number"),this.noteLengthNonAccented=t,this.updateConfig()},r.prototype.setVelocityAccentedTick=function(t){!1!==(t=c(t))?this.velocityAccented=t:n.debug>=2&&console.warn("please provide a number"),this.updateConfig()},r.prototype.setVelocityNonAccentedTick=function(t){!1!==(t=c(t))?this.velocityNonAccented=t:n.debug>=2&&console.warn("please provide a number"),this.updateConfig()},r.prototype.setNoteNumberAccentedTick=function(t){!1!==(t=c(t))?this.noteNumberAccented=t:n.debug>=2&&console.warn("please provide a number"),this.updateConfig()},r.prototype.setNoteNumberNonAccentedTick=function(t){!1!==(t=c(t))?this.noteNumberNonAccented=t:n.debug>=2&&console.warn("please provide a number"),this.updateConfig()},r.prototype.reset=function(){this.volume=1,this.track.setInstrument("heartbeat/metronome"),this.noteNumberAccented=61,this.noteNumberNonAccented=60,this.velocityAccented=100,this.velocityNonAccented=100,this.noteLengthAccented=this.song.ppq/4,this.noteLengthNonAccented=this.song.ppq/4},r.prototype.allNotesOff=function(){this.track.instrument&&this.track.instrument.allNotesOff()},r.prototype.createPrecountEvents=function(t){if(!(t<=0)){var e=this.song.getPosition("barsbeats",this.song.bar+t);this.index=0,this.millis=0,this.startMillis=this.song.millis,this.precountDurationInMillis=e.millis-this.startMillis,this.precountEvents=h(this,this.song.bar,e.bar-1,"precount"),s(this.song,this.precountEvents)}},r.prototype.getPrecountEvents=function(t){var e,i,n=this.precountEvents,s=n.length,o=[];for(e=this.index;e<s&&(i=n[e]).millis<t;e++)i.time=this.startTime+i.millis,o.push(i),this.index++;return o},r.prototype.setVolume=function(t){this.track.setVolume(t)},n.protectedScope.createMetronome=function(t){return new r(t)},n.protectedScope.addInitMethod((function(){n.protectedScope.context,n.protectedScope.findItem,t=n.protectedScope.getPosition,i=n.createMidiNote,e=n.util.objectForEach,s=n.protectedScope.parseEvents,o=n.protectedScope.parseMetronomeEvents}))}(),function(){var t,e,i,s=Array.prototype.slice,o=0;(i=function(i){var s,r;if(this.className="MidiEvent",this.id="M"+o+(new Date).getTime(),this.eventNumber=o,this.channel="any",this.time=0,this.muted=!1,o++,i)if("midimessageevent"!==e(i[0])){if("array"===e(i[0]))s=i[0];else{if("number"!==e(i[0])||"number"!==e(i[1]))return n.debug>=1&&console.error("wrong number of arguments, please consult documentation"),!1;s=[i[0],i[1]],i.length>=3&&"number"===e(i[2])&&s.push(i[2]),4===i.length&&"number"===e(i[3])&&s.push(i[3]),5===i.length&&"number"===e(i[4])&&s.push(i[4])}switch(this.ticks=s[0],this.status=s[1],this.type=16*(this.status>>4),this.type>=128?(this.command=this.type,this.channel=1+(15&this.status)):(this.type=this.status,this.channel=s[4]||"any"),this.sortIndex=this.type+this.ticks,this.type){case 0:break;case 128:this.data1=s[2],r=t(this.data1),this.note=r,this.noteName=r.fullName,this.noteNumber=r.number,this.octave=r.octave,this.frequency=r.frequency,this.data2=0,this.velocity=this.data2;break;case 144:this.data1=s[2],this.data2=s[3],0===this.data2&&(this.type=128),r=t(this.data1),this.note=r,this.noteName=r.fullName,this.noteNumber=r.number,this.octave=r.octave,this.frequency=r.frequency,this.velocity=this.data2;break;case 81:this.bpm=s[2];break;case 88:this.nominator=s[2],this.denominator=s[3];break;case 176:this.data1=s[2],this.data2=s[3],this.controllerType=s[2],this.controllerValue=s[3];break;case 192:this.data1=s[2],this.programNumber=s[2];break;case 208:case 224:this.data1=s[2],this.data2=s[3];break;case 47:break;default:console.warn("not a recognized type of midi event!")}}else console.log("midimessageevent")}).prototype.clone=i.prototype.copy=function(){var t,e=new i;for(t in this)this.hasOwnProperty(t)&&("id"!==t&&"eventNumber"!==t&&"midiNote"!==t&&(e[t]=this[t]),e.song=void 0,e.track=void 0,e.trackId=void 0,e.part=void 0,e.partId=void 0);return e},i.prototype.transpose=function(i){if(128===this.type||144===this.type){if("array"===e(i)){var s=i[0];"hertz"===s||"semi"!==s&&"semitone"!==s||(i=i[1])}else if(!0===isNaN(i))return void(n.debug>=1&&console.error("please provide a number"));var o=this.data1+parseInt(i,10);o<0?o=0:o>127&&(o=127),this.data1=o;var r=t(this.data1);this.note=r,this.noteName=r.fullName,this.noteNumber=r.number,this.octave=r.octave,this.frequency=r.frequency,void 0!==this.midiNote&&(this.midiNote.pitch=this.data1),"new"!==this.state&&(this.state="changed"),void 0!==this.part&&(this.part.needsUpdate=!0)}else n.debug>=1&&console.error("you can only transpose note on and note off events")},i.prototype.setPitch=function(i){if(128===this.type||144===this.type){if("array"===e(i)){var s=i[0];"hertz"===s||"semi"!==s&&"semitone"!==s||(i=i[1])}else if(!0===isNaN(i))return void(n.debug>=1&&console.error("please provide a number"));this.data1=parseInt(i,10);var o=t(this.data1);this.note=o,this.noteName=o.fullName,this.noteNumber=o.number,this.octave=o.octave,this.frequency=o.frequency,void 0!==this.midiNote&&(this.midiNote.pitch=this.data1),"new"!==this.state&&(this.state="changed"),void 0!==this.part&&(this.part.needsUpdate=!0)}else n.debug>=1&&console.error("you can only set the pitch of note on and note off events")},i.prototype.move=function(t){isNaN(t)?n.debug>=1&&console.error("please provide a number"):(this.ticks+=parseInt(t,10),"new"!==this.state&&(this.state="changed"),void 0!==this.part&&(this.part.needsUpdate=!0))},i.prototype.moveTo=function(){var t=s.call(arguments);"ticks"===t[0]&&!1===isNaN(t[1])?this.ticks=parseInt(t[1],10):void 0===this.song?n.debug>=1&&console.error("The midi event has not been added to a song yet; you can only move to ticks values"):!1===(t=this.song.getPosition(t))?n.debug>=1&&console.error("wrong position data"):this.ticks=t.ticks,"new"!==this.state&&(this.state="changed"),void 0!==this.part&&(this.part.needsUpdate=!0)},i.prototype.reset=function(t,e,i){e=void 0===e,i=void 0===i,(t=void 0===t)&&(this.part=void 0,this.partId=void 0),e&&(this.track=void 0,this.trackId=void 0,this.channel=0),i&&(this.song=void 0)},i.prototype.update=function(){},n.createMidiEvent=function(){var t=s.call(arguments),e=t[0].className;return"MidiEvent"===e?t[0].copy():new i(t)},n.protectedScope.addInitMethod((function(){t=n.createNote,e=n.protectedScope.typeString}))}(),function(){var t={"note off":128,"note on":144,"poly pressure":160,"control change":176,"program change":192,"channel pressure":208,"pitch bend":224,tempo:81,"time signature":88,"end of track":47},e={NOTE_OFF:128,NOTE_ON:144,POLY_PRESSURE:160,CONTROL_CHANGE:176,PROGRAM_CHANGE:192,CHANNEL_PRESSURE:208,PITCH_BEND:224,TEMPO:81,TIME_SIGNATURE:88,END_OF_TRACK:47},i={128:"note off",144:"note on",160:"poly pressure",176:"control change",192:"program change",208:"channel pressure",224:"pitch bend",81:"tempo",88:"time signature",47:"end of track"},s={128:"NOTE_OFF",144:"NOTE_ON",160:"POLY_PRESSURE",176:"CONTROL_CHANGE",192:"PROGRAM_CHANGE",208:"CHANNEL_PRESSURE",224:"PITCH_BEND",81:"TEMPO",88:"TIME_SIGNATURE",47:"END_OF_TRACK"};function o(i){var s=!1;return i=i.replace(/_/g," "),!1!==(s=t[i]||!1)?s:(i=i.replace(/\s/g,"_"),!1===(s=e[i]||!1)&&!0===n.debug&&console.warn(i,"is not a valid (or supported) midi event name, please consult documentation"),s)}function r(t,e){var o=!1;return"lower"===(e=e||"upper")?(!1===(o=i[t]||!1)&&!0===n.debug&&console.warn(t,"is not a valid (or supported) midi event number, please consult documentation"),o):(!1===(o=s[t]||!1)&&!0===n.debug&&console.warn(t,"is not a valid (or supported) midi event number, please consult documentation"),o)}Object.defineProperty(n,"DUMMY_EVENT",{value:0}),Object.defineProperty(n,"MIDI_NOTE",{value:112}),Object.defineProperty(n,"NOTE_OFF",{value:128}),Object.defineProperty(n,"NOTE_ON",{value:144}),Object.defineProperty(n,"POLY_PRESSURE",{value:160}),Object.defineProperty(n,"CONTROL_CHANGE",{value:176}),Object.defineProperty(n,"PROGRAM_CHANGE",{value:192}),Object.defineProperty(n,"CHANNEL_PRESSURE",{value:208}),Object.defineProperty(n,"PITCH_BEND",{value:224}),Object.defineProperty(n,"SYSTEM_EXCLUSIVE",{value:240}),Object.defineProperty(n,"MIDI_TIMECODE",{value:241}),Object.defineProperty(n,"SONG_POSITION",{value:242}),Object.defineProperty(n,"SONG_SELECT",{value:243}),Object.defineProperty(n,"TUNE_REQUEST",{value:246}),Object.defineProperty(n,"EOX",{value:247}),Object.defineProperty(n,"TIMING_CLOCK",{value:248}),Object.defineProperty(n,"START",{value:250}),Object.defineProperty(n,"CONTINUE",{value:251}),Object.defineProperty(n,"STOP",{value:252}),Object.defineProperty(n,"ACTIVE_SENSING",{value:254}),Object.defineProperty(n,"SYSTEM_RESET",{value:255}),Object.defineProperty(n,"TEMPO",{value:81}),Object.defineProperty(n,"TIME_SIGNATURE",{value:88}),Object.defineProperty(n,"END_OF_TRACK",{value:47}),n.checkEventType=function(t){return isNaN(t)?o(t):r(t)},n.midiEventNameByNumber=r,n.midiEventNumberByName=o}(),u(),A=0,(_=function(t){var e,i,s,o,r,a,c=t.length;if(1===c){if(void 0===(e=t[0]))return void console.error("please provide at least a note on event");this.noteOn=e}else if(2===c){if(e=t[0],i=t[1],void 0===e)return void console.error("please provide at least a note on event");if("MidiEvent"===e.className&&i&"MidiEvent"===i.className){if(e.ticks>=i.ticks)return void console.error("MidiNote has wrong duration");this.noteOn=e,this.noteOff=i}}else{if(4!==c)return void console.error("wrong number of arguments, please consult documentation");if(s=t[0],o=t[1],r=t[2],a=t[3],s&&o&&s>=o)return void console.error("MidiNote has wrong duration");if(r<0||r>127)return void console.error("MidiNote has wrong note number");if(a<0||a>127)return void console.error("MidiNote has wrong velocity");e=T(s,n.NOTE_ON,r,a),i&&(i=T(o,n.NOTE_OFF,r,0))}e.midiNote=this,this.noteOn=e,void 0===i?this.endless=!0:(i.midiNote=this,this.endless=!1,this.noteOff=i,this.durationTicks=i.ticks-e.ticks,this.durationMillis=i.millis-e.millis),this.note=e.note,this.number=e.noteNumber,this.ticks=e.ticks,this.pitch=e.data1,this.velocity=e.velocity,this.id="N"+A+(new Date).getTime(),this.name=e.noteName,this.className="MidiNote",this.type=n.MIDI_NOTE,A++}).prototype.addNoteOff=function(t){void 0!==this.noteOff&&(console.log(t.ticks,t.noteNumber,this.id,"override note off event"),this.noteOff.midiNote=void 0);var e=this.noteOn;t.midiNote=this,this.endless=!1,this.noteOff=t,this.durationTicks=t.ticks-e.ticks,this.durationMillis=t.millis-e.millis,this.endless=!1},_.prototype.setPitch=function(t){t<0||t>127||(this.noteOn.setPitch(t),!1===this.endless&&this.noteOff.setPitch(t),this.number=this.noteOn.noteNumber,this.name=this.noteOn.noteName,this.pitch=t)},_.prototype.mute=function(t){this.mute=void 0!==t?t:!this.mute},n.protectedScope.addInitMethod((function(){T=n.createMidiEvent,n.protectedScope.typeString})),n.createMidiNote=function(){return new _(Array.prototype.slice.call(arguments))},d(),I=String.fromCharCode,n.protectedScope.createStream=function(t){var e=0;function i(i){var n=t[e];return i&&n>127&&(n-=256),e+=1,n}return{eof:function(){return e>=t.length},read:function(i,n){var s,o;if(n=void 0===n||n){for(s="",o=0;o<i;o++,e++)s+=I(t[e]);return s}for(s=[],o=0;o<i;o++,e++)s.push(t[e]);return s},readInt32:function(){var i=(t[e]<<24)+(t[e+1]<<16)+(t[e+2]<<8)+t[e+3];return e+=4,i},readInt16:function(){var i=(t[e]<<8)+t[e+1];return e+=2,i},readInt8:i,readVarInt:function(){for(var t=0;;){var e=i();if(!(128&e))return t+e;t+=127&e,t<<=7}}}},p(),function(){var t=Array.prototype,e=n.defaultPPQ,i=["M".charCodeAt(0),"T".charCodeAt(0),"h".charCodeAt(0),"d".charCodeAt(0)],s=[0,0,0,6],r=[0,1],a=d(e.toString(16),2),c=["M".charCodeAt(0),"T".charCodeAt(0),"r".charCodeAt(0),"k".charCodeAt(0)];function h(t){var e,n,c,h,p,l,f=[].concat(i,s,r),m=t.tracks,v=t.tracks.length+1;for(f=(f=f.concat(d(v.toString(16),2),a)).concat(u(t.timeEvents,t.durationTicks,"tempo")),e=0,n=m.length;e<n;e++)c=m[e],f=f.concat(u(c.events,t.durationTicks,c.name,c.instrumentId));for(n=f.length,p=new ArrayBuffer(n),l=new Uint8Array(p),e=0;e<n;e++)l[e]=f[e];h=new Blob([l],{type:"application/x-midi",endings:"transparent"}),o(h,t.name)}function u(t,i,n,s){var o,r,a,h,u,f=0,m=0,v=[];for(n&&(v.push(0),v.push(255),v.push(3),v=(v=v.concat(p(n.length))).concat(l(n))),s&&(v.push(0),v.push(255),v.push(4),v=(v=v.concat(p(s.length))).concat(l(s))),r=0,a=t.length;r<a;r++){if(m=p(m=(h=t[r]).ticks-f),v=v.concat(m),128===h.type||144===h.type)u=h.type+h.channel,v.push(u),v.push(h.noteNumber),v.push(h.velocity);else if(81===h.type){v.push(255),v.push(81),v.push(3);var g=Math.round(6e7/h.bpm);v=v.concat(d(g.toString(16),3))}else if(88===h.type){var y=h.denominator;2===y?y=1:4===y?y=2:8===y?y=3:16===y?y=4:32===y&&(y=5),v.push(255),v.push(88),v.push(4),v.push(h.nominator),v.push(y),v.push(e/h.nominator),v.push(8)}f=h.ticks}return m=p(m=i-f),(v=v.concat(m)).push(255),v.push(47),v.push(0),o=d(v.length.toString(16),4),[].concat(c,o,v)}function d(t,e){if(e)for(;t.length/2<e;)t="0"+t;for(var i=[],n=t.length-1;n>=0;n-=2){var s=0===n?t[n]:t[n-1]+t[n];i.unshift(parseInt(s,16))}return i}function p(t){for(var e=127&t;t>>=7;)e<<=8,e|=127&t|128;for(var i=[];i.push(255&e),128&e;)e>>=8;return i}function l(e){return t.map.call(e,(function(t){return t.charCodeAt(0)}))}n.protectedScope.saveToMidiFile=h,n.saveSongAsMidiFile=h}(),l(),function(){var t,e,i,s,o,r,a,c,h,u=Math.pow;e={sharp:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],flat:["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],"enharmonic-sharp":["B#","C#","C##","D#","D##","E#","F#","F##","G#","G##","A#","A##"],"enharmonic-flat":["Dbb","Db","Ebb","Eb","Fb","Gbb","Gb","Abb","Ab","Bbb","Bb","Cb"]},a=function(){var e,a,u,d,p,l=Array.prototype.slice.call(arguments),f=l.length,m=!1,v=!1,g=l[0],y=l[1],b=l[2];return 1!==f||isNaN(g)?1===f&&"string"===t(g)?(e=o(g))?(u=e[0],a=e[1],(d=i(u,a))?(d<0||d>127)&&(v="please provide a note between C0 and G10"):v=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave"):v=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave":2!==f||"string"!==t(g)||isNaN(y)?2===f&&"string"===t(g)&&"string"===t(y)?(e=o(g))?((p=c(y))||(m=y+" is not a valid note name mode, using "+(p=n.noteNameMode)),u=e[0],a=e[1],(d=i(u,a))?(d<0||d>127)&&(v="please provide a note between C0 and G10"):v=u+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave",u=s(d,p)[0]):v=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave":2===f&&"number"===t(g)&&"string"===t(y)?g<0||g>127?v="please provide a note number >= 0 and <= 127":((p=c(y))||(m=y+" is not a valid note name mode, using "+(p=n.noteNameMode)),u=(e=s(d=g,p))[0],a=e[1],u=s(d,p)[0]):3!==f||"string"!==t(g)||isNaN(y)||"string"!==t(b)?v="wrong arguments, please consult documentation":(e=o(g,y))?((p=c(b))||(m=b+" is not a valid note name mode, using "+(p=n.noteNameMode)),u=e[0],a=e[1],(d=i(u,a))?(d<0||d>127)&&(v="please provide a note between C0 and G10"):v=u+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave",u=s(d,p)[0]):v=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb, followed by a number for the octave":(e=o(g,y))?(u=e[0],a=e[1],(d=i(u,a))?(d<0||d>127)&&(v="please provide a note between C0 and G10"):v=u+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb"):v=g+" is not a valid note name, please use letters A - G and if necessary an accidental like #, ##, b or bb":g<0||g>127?v="please provide a note number >= 0 and <= 127":(u=(e=s(d=g))[0],a=e[1]),v?(console.error(v),!1):(m&&console.warn(m),{name:u,octave:a,fullName:u+a,number:d,frequency:r(d),blackKey:h(d)})},s=function(t,i){i=i||n.noteNameMode;var s=Math.floor(t/12-1);return[e[i][t%12],s]},i=function(t,i,n){var s,o,r,a;for(s in e)if(e.hasOwnProperty(s))for(r=0,a=(n=e[s]).length;r<a;r+=1)if(n[r]===t){o=r;break}return-1!==o&&o+12+12*i},r=function(t){return n.pitch*u(2,(t-69)/12)},o=function(){var e,i,n,s,o,r=Array.prototype.slice.call(arguments),a=r.length,c=r[0],h=r[1];if(1===a&&"string"===t(c)){for(e=c.length,s="",o="",i=0;i<e;i++)n=c[i],isNaN(n)&&"-"!==n?s+=n:o+=n;""===o&&(o=0)}else{if(2!==a||"string"!==t(c)||isNaN(h))return!1;s=c,o=h}return o=parseInt(o,10),[s=s.substring(0,1).toUpperCase()+s.substring(1),o]},c=function(t){var e=!1;switch(t){case"sharp":case"flat":case"enharmonic-sharp":case"enharmonic-flat":e=t}return e},h=function(t){var e;switch(!0){case t%12==1:case t%12==3:case t%12==6:case t%12==8:case t%12==10:e=!0;break;default:e=!1}return e},n.getNoteNumber=function(){var t=a.apply(this,arguments);return!!t&&t.number},n.getNoteName=function(){var t=a.apply(this,arguments);return!!t&&t.name},n.getNoteNameFromNoteNumber=function(t,e){return s(t,e)},n.getNoteOctave=function(){var t=a.apply(this,arguments);return!!t&&t.octave},n.getFullNoteName=function(){var t=a.apply(this,arguments);return!!t&&t.fullName},n.getFrequency=function(){var t=a.apply(this,arguments);return!!t&&t.frequency},n.isBlackKey=function(){var t=a.apply(this,arguments);return!!t&&t.blackKey},Object.defineProperty(n,"SHARP",{value:"sharp"}),Object.defineProperty(n,"FLAT",{value:"flat"}),Object.defineProperty(n,"ENHARMONIC_SHARP",{value:"enharmonic-sharp"}),Object.defineProperty(n,"ENHARMONIC_FLAT",{value:"enharmonic-flat"}),n.createNote=a,n.protectedScope.addInitMethod((function(){t=n.protectedScope.typeString}))}(),f(),m(),function(){var t,e,i,s,o,r,a,c,h,u,d,p,l,f,m,v,g=0;l=function(t,e){var i,o,r,a=0,h=0,u=(t=Array.prototype.slice.call(t))[0],d=[],p=[];if("array"===s(u)){for(h=u.length-1;h>=0;h--)r=u[h],(o=c(r,e))&&d.push(o);a=0===d.length?0:1}for(i=t.length,h=a;h<i;h++)r=t[h],(o=c(r,e))?d.push(o):p.push(r);return 0===d.length?(n.debug&&console.warn("no events added",e.name),!1):(1===p.length&&"array"===s(p[0])&&(p=p[0]),{events:d,config:p})},c=function(t,i){var n=!1;return t?"MidiEvent"===t.className||"AudioEvent"===t.className?n=t:"array"===s(t)&&4===t.length?n=e(t):"string"===s(t)?n=i.eventsById[t]:!1===isNaN(t)&&(n=i.events[t]):n=!1,n},h=function(t,e,i){if(!1!==t){var s,o,r=t.events,a=e.ticks,c=r.length,h=e.track,u=e.eventsById;for(s=0;s<c;s++)(o=r[s]).type===n.END_OF_TRACK||"MidiEvent"!==o.className&&"AudioEvent"!==o.className||("AudioEvent"===o.className&&!0!==e.hasAudioEvents&&(e.hasAudioEvents=!0),void 0!==o.part&&(o=o.clone()),o.part=e,o.partId=e.id,i&&(a+=o.ticks,o.ticks=a),o.track=h,o.trackId=h?h.id:void 0,o.song=void 0,void 0!==h&&(o.song=h.song),"recorded"!==o.state&&(o.state="new"),u[o.id]=o);"new"!==e.state&&(e.state="changed"),e.needsUpdate=!0}},p=function(t,e){if(!1!==t){var i,n=t.events,s=t.config[0];for(i=n.length-1;i>=0;i--)n[i].transpose(s);"new"!==e.state&&void 0!==e.track&&(e.state="changed",e.track.needsUpdate=!0)}},u=function(t,e){if(!1!==t){var i,n,s,o=t.events,r=t.config[0];if(isNaN(r))console.warn("Part.moveEvent(s) -> please provide a number");else{for(i=o.length-1;i>=0;i--)(s=(n=o[i]).ticks+r)<0&&(s=0),n.ticks=s,"new"!==n.state&&(n.state="changed");e.needsUpdate=!0,"new"!==e.state&&e.track&&(e.state="changed",e.track.needsUpdate=!0)}}},d=function(t,e){var i,n,s=[];for(i=t.length-1;i>=0;i--)!1!==(n=c(t[i],e))&&(n.part===e||null===n.part?(n.state="removed",n.reset(),s.push(n)):console.warn("can't remove: this event belongs to part",n.part.id));return void 0!==e.track&&(e.track.needsUpdate=!0),e.needsUpdate=!0,s},f=function(t){var e,i,n,s,o=t.notes,r=t.lowestNote,a=t.highestNote;for(n=o.length-1;n>=0;n--)(s=o[n]).setPitch(r+(a-s.number)),e=s.noteOn,i=s.noteOff,e.state="changed",i.state="changed",s.state="changed";t.needsUpdate=!0,"new"!==t.state&&t.track&&(t.state="changed",t.track.needsUpdate=!0)},m=function(t,e){var i,n,s,o,r,a,c=t.notes;for(e=e||t.duration.ticks,a=c.length-1;a>=0;a--)n=(i=c[a]).noteOn,o=e-(s=i.noteOff).ticks,r=e-n.ticks,n.ticks=o,s.ticks=r,i.ticks=o,n.state="changed",s.state="changed",i.state="changed";t.needsUpdate=!0,"new"!==t.state&&t.track&&(t.state="changed",t.track.needsUpdate=!0)},(v=function(t){this.className="Part",this.id="P"+g+++(new Date).getTime(),this.partIndex=g,this.name=t||this.id,this.events=[],this.eventsById={},this.numEvents=0,this.notes=[],this.notesById={},this.numNotes=0,this.dirtyEvents={},this.dirtyNotes={},this.song=void 0,this.autoSize="right",this.ticks=0,this.millis=0,this.start={ticks:this.ticks,millis:this.millis},this.end={ticks:0,millis:0},this.duration={ticks:0,millis:0},this.startPosition=void 0,this.endPosition=void 0,this.needsUpdate=!1,this.state="clean",this.mute=!1,this.solo=!1,this.keepWhenEmpty=!0}).prototype.addEvent=v.prototype.addEvents=function(){var t=l(arguments,this);h(t,this,!1)},v.prototype.addEventsRelative=function(){var t=l(arguments,this);h(t,this,!0)},v.prototype.removeEvent=v.prototype.removeEvents=function(){var t=l(arguments,this);return!1!==t&&d(t.events,this)},v.prototype.moveEvent=v.prototype.moveEvents=function(){var t=l(arguments,this);u(t,this)},v.prototype.moveAllEvents=function(t){u({events:this.events,config:[t]},this)},v.prototype.moveNote=function(t,e){u({events:[t.noteOn,t.noteOff],config:[e]},this)},v.prototype.transposeEvents=function(){var t=l(arguments,this);p(t,this)},v.prototype.transposeAllEvents=function(t){p({events:this.events,config:[t]},this)},v.prototype.transposeNote=function(t,e){p({events:[t.noteOn,t.noteOff],config:[e]},this)},v.prototype.reverseByTicks=function(t){this.needsUpdate&&this.update(),m(this,t)},v.prototype.reverseByPitch=function(){this.needsUpdate&&this.update(),f(this)},v.prototype.findEvents=function(t){return o(this,t)},v.prototype.findNotes=function(t){return r(this,t)},v.prototype.getStats=function(t){return a(this,t)},v.prototype.getIndex=function(){var t,e;if(this.track)for(t=this.track.parts,e=this.track.numParts-1;e>=0;e--)if(t[e].id===this.id)return e;return-1},v.prototype.copy=function(){var t,e,n=new v(i(this.name)),s=this.ticks,o=this.eventsById,r=[];for(e in n.song=void 0,n.track=void 0,n.trackId=void 0,o)o.hasOwnProperty(e)&&((t=o[e].copy()).ticks=t.ticks-s,r.push(t));return n.addEvents(r),n},v.prototype.setSolo=function(t){void 0===t&&(t=!this.solo),this.mute=!1,this.solo=t,this.allNotesOff(),this.track&&this.track.setPartSolo(this,t)},v.prototype.allNotesOff=function(){void 0!==this.track&&this.track.instrument.allNotesOffPart(this.id)},v.prototype.reset=function(t,e){var i,n,s=this.eventsById;for(i in e&&(this.song=void 0),t&&(this.track=void 0),this.trackId=void 0,this.start.millis=void 0,this.end.millis=void 0,s)s.hasOwnProperty(i)&&((n=s[i]).ticks-=this.ticks,n.reset(!1,t,e));this.ticks=0,this.needsUpdate=!0},v.prototype.update=function(){var e,i,s,o,r,a,c,h,u,d=[],p=this.id,l=this.track,f=this.track?this.track.id:void 0;for(s in this.events=[],this.eventsById)this.eventsById.hasOwnProperty(s)&&("clean"!==(o=this.eventsById[s]).state&&(this.dirtyEvents[o.id]=o),"removed"!==o.state&&this.events.push(o));for(this.events.sort((function(t,e){return t.sortIndex-e.sortIndex})),e=0,i=this.notes.length;e<i;e++)"removed"===(a=this.notes[e]).noteOn.state||void 0!==a.noteOff&&"removed"===a.noteOff.state?(a.state="removed",this.dirtyNotes[a.id]=a,delete this.notesById[a.id]):("changed"===a.noteOn.state||void 0!==a.noteOff&&"changed"===a.noteOff.state)&&(a.state="changed",this.dirtyNotes[a.id]=a);for(e=0,i=this.events.length;e<i;e++)if(r=(o=this.events[e]).noteNumber,o.type===n.NOTE_ON)void 0===o.midiNote&&((a=t(o)).part=this,a.partId=p,a.track=l,a.trackId=f,a.state="new",this.notesById[a.id]=a,this.dirtyNotes[a.id]=a,void 0===d[r]&&(d[r]=[]),d[r].push(a));else if(o.type===n.NOTE_OFF)if(void 0===o.midiNote){if(void 0===d[r])continue;var m=d[r].length-1;if(void 0!==(a=d[r][m]).noteOff&&a.durationTicks>0)continue;if(null===a)continue;if(void 0===a.noteOn)continue;"new"!==a.state&&(a.state="changed"),this.dirtyNotes[a.id]=a,a.addNoteOff(o)}else void 0===this.notesById[o.midiNote.id]&&((a=o.midiNote).part=this,a.partId=p,a.track=l,a.trackId=f,this.notesById[a.id]=a);for(s in this.notes=[],d=null,this.notesById)this.notesById.hasOwnProperty(s)&&(a=this.notesById[s],this.notes.push(a));if(this.notes.sort((function(t,e){return t.ticks-e.ticks})),this.numEvents=this.events.length,this.numNotes=this.notes.length,c=this.events[0],h=this.events[this.numEvents-1],c)switch(c.ticks<this.ticks&&(this.autoSize="both"),this.autoSize){case"right":this.start.ticks=this.ticks,this.end.ticks=h.ticks,this.duration.ticks=h.ticks-this.start.ticks;break;case"both":this.start.ticks=c.ticks,this.end.ticks=h.ticks,this.duration.ticks=h.ticks-c.ticks}else this.start.ticks=this.ticks,this.end.ticks=this.ticks+100,this.duration.ticks=100;u=this.getStats("noteNumber all"),this.lowestNote=u.min,this.highestNote=u.max,this.ticks=this.start.ticks,"clean"===this.state&&(this.state="changed"),this.needsUpdate=!1},n.createPart=function(){return new v},n.protectedScope.addInitMethod((function(){t=n.createMidiNote,e=n.createMidiEvent,i=n.protectedScope.copyName,s=n.protectedScope.typeString,o=n.findEvent,r=n.findNote,a=n.getStats}))}(),C=0,(O=function(t,e,i,n){this.id="POS"+C+++(new Date).getTime(),this.song=t,this.type=e||"",this.name=i||this.id,this.data=n||{},this.lastEvent=void 0,this.activeParts=[],this.activeNotes=[],this.activeEvents=[]}).prototype.set=function(t,e){return this.unit=t,this.currentValue=e,this.eventIndex=0,this.noteIndex=0,this.partIndex=0,this.calculate(),this.data},O.prototype.get=function(){return this.data},O.prototype.update=function(t,e){return 0===e?this.data:(this.unit=t,this.currentValue+=e,this.calculate(),this.data)},O.prototype.updateSong=function(){this.events=this.song.eventsMidiTime,this.numEvents=this.events.length,this.notes=this.song.notes,this.numNotes=this.song.numNotes,this.parts=this.song.parts,this.numParts=this.song.numParts,this.set("millis",this.song.millis||0)},O.prototype.setType=function(t){this.type=t,this.set(this.unit,this.currentValue)},O.prototype.addType=function(t){this.type+=" "+t,this.set(this.unit,this.currentValue)},O.prototype.removeType=function(t){var e=this.type.split(" ");this.type="",e.forEach((function(e){e!==t&&(this.type+=t+" ")})),this.type.trim(),this.set(this.currentValue)},O.prototype.calculate=function(){var t,e,i,s,o,r=[],a=[],c=[],h=[],u=[],d=[];for(t=this.eventIndex;t<this.numEvents&&(e=this.events[t])[this.unit]<=this.currentValue;t++)e.type!==n.MIDI_NOTE&&e.type!==n.DUMMY_EVENT&&d.push(e),this.lastEvent=e,this.eventIndex++;if(void 0===this.lastEvent&&(this.lastEvent=this.song.timeEvents[0]),o=M(this.song,this.unit,this.currentValue,"all",this.lastEvent),this.data.eventIndex=this.eventIndex,this.data.millis=o.millis,this.data.ticks=o.ticks,-1!==this.type.indexOf("all")){var p=this.data;x(o,(function(t,e){p[e]=t}))}else-1!==this.type.indexOf("barsbeats")?(this.data.bar=o.bar,this.data.beat=o.beat,this.data.sixteenth=o.sixteenth,this.data.tick=o.tick,this.data.barsAsString=o.barsAsString,this.data.ticksPerBar=o.ticksPerBar,this.data.ticksPerBeat=o.ticksPerBeat,this.data.ticksPerSixteenth=o.ticksPerSixteenth,this.data.numSixteenth=o.numSixteenth):-1!==this.type.indexOf("time")?(this.data.hour=o.hour,this.data.minute=o.minute,this.data.second=o.second,this.data.millisecond=o.millisecond,this.data.timeAsString=o.timeAsString):-1!==this.type.indexOf("percentage")&&(this.data.percentage=o.percentage);if(-1!==this.type.indexOf("events")||-1!==this.type.indexOf("all")){for(this.collectedEvents=d,t=this.activeEvents.length-1;t>=0;t--)81!==(e=this.activeEvents[t]).type&&88!==e.type&&0!==e.state.indexOf("removed")&&void 0!==this.song.eventsById[e.id]&&e[this.unit]<=this.currentValue&&e[this.unit]>this.currentValue-10&&c.push(e);for(this.activeEvents=[].concat(c),t=d.length-1;t>=0;t--)(e=d[t])[this.unit]>this.currentValue-10&&this.activeEvents.push(e);for(this.song.activeEvents={},t=this.activeEvents.length-1;t>=0;t--)e=this.activeEvents[t],this.song.activeEvents[e.id]=e}if(-1!==this.type.indexOf("notes")||-1!==this.type.indexOf("all")){for(t=this.noteIndex;t<this.numNotes&&(i=this.notes[t]).noteOn[this.unit]<=this.currentValue;t++)u.push(i),this.noteIndex++;for(t=this.activeNotes.length-1;t>=0;t--)0!==(i=this.activeNotes[t]).noteOn.state.indexOf("removed")&&void 0!==this.song.notesById[i.id]&&(void 0!==i.noteOff?i.noteOn[this.unit]<=this.currentValue&&i.noteOff[this.unit]>this.currentValue&&a.push(i):n.debug&&console.warn("note with id",i.id,"has no noteOff event",i.noteOn.track.name));for(this.activeNotes=[].concat(a),t=u.length-1;t>=0;t--)void 0!==(i=u[t]).noteOff?i.noteOff[this.unit]>this.currentValue&&this.activeNotes.push(i):n.debug&&console.warn("note with id",i.id,"has no noteOff event",i.noteOn.track.name);for(this.song.activeNotes={},t=this.activeNotes.length-1;t>=0;t--)i=this.activeNotes[t],this.song.activeNotes[i.id]=i}if(-1!==this.type.indexOf("parts")||-1!==this.type.indexOf("all")){for(t=this.partIndex;t<this.numParts&&(s=this.parts[t]).start[this.unit]<=this.currentValue;t++)h.push(s),this.partIndex++;for(t=this.activeParts.length-1;t>=0;t--)(s=this.activeParts[t]).start[this.unit]<=this.currentValue&&s.end[this.unit]>this.currentValue&&r.push(s);for(this.activeParts=[].concat(r),t=h.length-1;t>=0;t--)(s=h[t]).end[this.unit]>this.currentValue&&this.activeParts.push(s);for(this.song.activeParts={},t=this.activeParts.length-1;t>=0;t--)s=this.activeParts[t],this.song.activeParts[s.id]=s}!0===this.busy&&(this.busy=!1)},n.protectedScope.createPlayhead=function(t,e,i,n){return new O(t,e,i,n)},n.protectedScope.addInitMethod((function(){M=n.protectedScope.getPosition2,x=n.protectedScope.objectForEach,n.debug})),function(){var t,e,i,s,o,r,a,c,h,u,d,p,l,f,m,v,g,y,b,k,P,w,E,N,S,_,T,A,I,O,M,x,C,B,L,R,D,F="all",j=!0;function z(t,e,i){var n,s,o=t.timeEvents;for(n=o.length-1;n>=0;n--)if((s=o[n])[e]<=i)return w=n,s}E=function(t,e,i){return j=void 0===i,L(t,e),l},N=function(t,e,i){return j=void 0===i,R(t,e),f},S=function(t,e,i){return e=["barsbeats"].concat(e),C(t,e,"millis",i),f},_=function(t,e,i){return e=["barsbeats"].concat(e),C(t,e,"ticks",i),l},T=function(t,e,i){return j=void 0===i,R(t,e),x(),F="barsandbeats",M()},A=function(t,e,i){return j=void 0===i,L(t,e),x(),F="barsandbeats",M()},L=function(t,e,i){var n=t.lastEvent;return!1===j&&e>n.millis&&(e=n.millis),void 0===i&&(i=z(t,"millis",e)),O(i),i.millis===e?(v=0,m=0):(v=e-i.millis,m=v/u),f+=v,l+=m},R=function(t,e,i){var n=t.lastEvent;return!1===j&&e>n.ticks&&(e=n.ticks),void 0===i&&(i=z(t,"ticks",e)),O(i),i.ticks===e?(m=0,v=0):v=(m=e-l)*u,l+=m,f+=v},D=function(t,e,i,n,s,r){var d,P=0,E=t.lastEvent;for(!1===j&&e>E.bar&&(e=E.bar),e=I(e),i=I(i),n=I(n),s=I(s,!0),void 0===r&&(r=z(t,"bar",e)),O(r);s>=h;)n++,s-=h;for(;n>p;)i++,n-=p;for(;i>o;)e++,i-=o;for(r=z(t,"bar",e),P=w;P>=0;P--)if((r=t.timeEvents[P]).bar<=e){O(r);break}d=s-k,v=(e-g)*c*u,v+=(i-y)*a*u,v+=(n-b)*h*u,g=e,y=i,b=n,k=s,f+=v+=d*u,l+=m=v/u},x=function(){for(var e=t(m);e>=h;)for(b++,e-=h;b>p;)for(b-=p,y++;y>o;)y-=o,g++;k=t(e)},O=function(t){s=t.bpm,o=t.nominator,r=t.denominator,c=t.ticksPerBar,a=t.ticksPerBeat,h=t.ticksPerSixteenth,p=t.numSixteenth,u=t.millisPerTick,d=t.secondsPerTick,g=t.bar,y=t.beat,b=t.sixteenth,k=t.tick,l=t.ticks,f=t.millis},M=function(e){var i,m,v={};switch(F){case"millis":v.millis=t(1e3*f)/1e3,v.millisRounded=t(f);break;case"ticks":v.ticks=t(l);break;case"barsbeats":case"barsandbeats":v.bar=g,v.beat=y,v.sixteenth=b,v.tick=k,m=0===k?"000":k<10?"00"+k:k<100?"0"+k:k,v.barsAsString=g+":"+y+":"+b+":"+m;break;case"time":i=n.getNiceTime(f),v.hour=i.hour,v.minute=i.minute,v.second=i.second,v.millisecond=i.millisecond,v.timeAsString=i.timeAsString;break;case"all":v.millis=t(1e3*f)/1e3,v.millisRounded=t(f),v.ticks=t(l),v.bar=g,v.beat=y,v.sixteenth=b,v.tick=k,m=0===k?"000":k<10?"00"+k:k<100?"0"+k:k,v.barsAsString=g+":"+y+":"+b+":"+m,i=n.getNiceTime(f),v.hour=i.hour,v.minute=i.minute,v.second=i.second,v.millisecond=i.millisecond,v.timeAsString=i.timeAsString,v.bpm=t(s*e.playbackSpeed,3),v.nominator=o,v.denominator=r,v.ticksPerBar=c,v.ticksPerBeat=a,v.ticksPerSixteenth=h,v.numSixteenth=p,v.millisPerTick=u,v.secondsPerTick=d,v.percentage=l/e.durationTicks}return v},I=function(e,i){return e=isNaN(e)?i?0:1:e,e=t(e),e=i?e<0?0:e:e<1?1:e},B=function(t){if(F="all",j=!0,"array"===i(t)){var e,n,s,o,r=t.length;if(P=t[0],"array"===i(t[0])&&(t=t[0],P=t[0],r=t.length),e=[P],-1!=="barsandbeats barsbeats time millis ticks perc percentage".indexOf(P)){for(n=1;n<r;n++)if(!0===(s=t[n])||!1===s)j=s;else if(isNaN(s)){if(-1==="barsandbeats barsbeats time millis ticks all".indexOf(s))return!1;F=s}else e.push(s);return(2===(o=e.length)||3===o||5===o)&&e}}return!1},C=function(t,i){var n,s,o,r=B(i);if(!1===r)return console.error("wrong position data"),!1;switch(P){case"barsbeats":case"barsandbeats":return D(t,r[1],r[2],r[3],r[4]),M(t);case"time":return n=0,n+=60*(s=r[1]||0)*60*1e3,n+=60*(s=r[2]||0)*1e3,n+=1e3*(s=r[3]||0),s=r[4]||0,L(t,n+=s),x(),M(t);case"millis":return L(t,r[1]),x(),M(t);case"ticks":return R(t,r[1]),x(),M(t);case"perc":case"percentage":return o=r[2],l=r[1]*t.durationTicks,void 0!==o&&(l=e(l/o)*o),R(t,l),x(),s=M(t)}return!1},n.protectedScope.getPosition=C,n.protectedScope.getPosition2=function(t,e,i,n,s){return"millis"===e?L(t,i,s):"ticks"===e&&R(t,i,s),"all"===n&&x(),M(t)},n.protectedScope.checkPosition=B,n.protectedScope.millisToTicks=E,n.protectedScope.ticksToMillis=N,n.protectedScope.ticksToBars=T,n.protectedScope.millisToBars=A,n.protectedScope.barsToTicks=_,n.protectedScope.barsToMillis=S,n.protectedScope.addInitMethod((function(){t=n.protectedScope.round,e=n.protectedScope.floor,i=n.protectedScope.typeString}))}(),function(){Math.floor;var t=Math.round,e={1:4,"1.":6,"1..":7,"1...":7.5,"1T":2/3*4,2:2,"2.":3,"2..":3.5,"2...":3.75,"2T":2/3*2,4:1,"4.":1.5,"4..":1.75,"4...":1.875,"4T":2/3*1,8:.5,"8.":.75,"8..":.875,"8...":.9375,"8T":2/3*1/2,16:.25,"16.":.375,"16..":.4375,"16...":.46875,"16T":2/3*1/4,32:1/8,"32.":.1875,"32..":.21875,"32...":.234375,"32T":2/3*1/8,64:1/16,"64.":.09375,"64..":.109375,"64...":.1171875,"64T":2/3*1/16,128:1/32,"128.":1.5/32,"128..":1.75/32,"128...":1.875/32,"128T":2/3*1/32};n.protectedScope.addInitMethod((function(){n.protectedScope.copyObject})),n.quantize=function(i,s,o,r){var a;if(s=(s=""+s).toUpperCase(),o=o||n.defaultPPQ,0===s)return{};var c,h,u,d,p,l,f=r||{};if(void 0===f.events&&(f.events={}),void 0===f.tracks&&(f.tracks={}),void 0!==(l=-1!==s.indexOf("TICKS")?parseInt(s.replace(/TICKS/,""),10):e[s]*o)){for(c=i.length-1;c>=0;c--)h=i[c],f.events[h.id]={event:h,ticks:h.ticks},128!==h.type&&(u=h.ticks,p=(d=t(u/l)*l)-u,h.ticks=d,h.state="changed",h.part.needsUpdate=!0,h.track.needsUpdate=!0,a=h.track,void 0===f.tracks[a.id]&&(f.tracks[a.id]={track:a,quantizedEvents:[]}),f.tracks[a.id].quantizedEvents.push(h),void 0!==h.midiNote&&(h.midiNote.noteOff.ticks+=p,h.midiNote.noteOff.state="changed",h.midiNote.state="changed",f.tracks[a.id].quantizedEvents.push(h.midiNote.noteOff)));return f}n.debug&&console.warn("invalid quantize value")},n.fixedLength=function(t,e,i,n){}}(),function(){var t,e,i,s,o,r,a,c,h,u,d,p,l,f,m=function(e){this.id=o(),this.output=t.createGainNode(),this.output.connect(e.track.input),this.buffer=e.buffer,this.buffer&&(this.duration=this.buffer.duration),this.noteNumber=e.noteNumber,this.stopCallback=function(){},this.track=e.track};c=function(t,e){t.source.onended=function(){t.stopCallback(t)},e=e||0;try{t.source.stop(e)}catch(t){console.log(t)}},h=function(e){var i,n,s,o=t.currentTime;if(e.release_duration>0)try{switch(e.releaseEnvelope){case"linear":e.output.gain.linearRampToValueAtTime(e.volume,o),e.output.gain.linearRampToValueAtTime(0,o+e.releaseDuration);break;case"equal power":i=a(100,"fadeOut",e.volume),e.output.gain.setValueCurveAtTime(i,o,e.releaseDuration);break;case"array":for(s=e.releaseEnvelopeArray.length,i=new Float32Array(s),n=0;n<s;n++)i[n]=e.releaseEnvelopeArray[n]*e.volume;e.output.gain.setValueCurveAtTime(i,o,e.releaseDuration)}}catch(t){console.error(e.id,t)}},m.prototype.addData=function(t){this.sourceId=t.sourceId,this.noteName=t.noteName,this.midiNote=t.midiNote},m.prototype.createSource=function(){this.source=t.createBufferSource(),this.source.buffer=this.buffer},m.prototype.route=function(){this.source.connect(this.output)},m.prototype.start=function(t){if(void 0===this.source){this.volume=t.velocity/127,this.output.gain.value=this.volume,this.createSource(),this.phase="decay",this.route(),!0===i&&(this.source.start=this.source.noteOn,this.source.stop=this.source.noteOff);try{this.source.start(t.time,t.offset||0,t.duration||this.duration)}catch(t){console.warn(t)}}else console.error("this should never happen")},m.prototype.stop=function(t,e){void 0!==this.source?(0!==t&&void 0!==t||(t=n.getTime()),this.stopCallback=e||function(){},this.release?(this.source.loop=!1,this.startReleasePhase=t,this.stopTime=t+this.releaseDuration):c(this,t)):n.debug&&console.log("Sample.stop() source is undefined")},m.prototype.unschedule=function(i,n){var s=t.currentTime,o=this,r=null===i?100:i;this.source.onended=void 0;try{this.output.gain.cancelScheduledValues(0),this.output.gain.linearRampToValueAtTime(0,s+r/1e3),0===r?void 0!==o.source&&(o.source.disconnect(0),o.source=void 0,"function"==typeof n&&n(o)):e["unschedule_"+this.id]={time:s+r/1e3,execute:function(){o?(o.panner&&o.panner.node.disconnect(0),void 0!==o.source&&(o.source.disconnect(0),o.source=void 0),n&&n(o)):console.log("sample is gone")}}}catch(t){console.log(t)}},m.prototype.update=function(e){var i="Sonata # 3"===this.track.name&&this.track.song.bar>=6&&this.track.song.bar<=10;this.autopan&&this.panner.setPosition(e),void 0!==this.startReleasePhase&&t.currentTime>=this.startReleasePhase&&"decay"===this.phase?(!0===i&&console.log(this.phase,"-> release",this.releaseDuration),this.phase="release",h(this)):void 0!==this.stopTime&&t.currentTime>=this.stopTime&&"release"===this.phase&&(!0===i&&console.log(this.phase,"-> stopped",this.stopTime,t.currentTime),this.phase="stopped",c(this))},n.createSample=function(t){return t.oscillator?new u(t):t.sustain&&t.release&&t.panning?new f(t):t.release&&t.panning?new l(t):t.release&&t.sustain?new p(t):t.release?new d(t):new m(t)},n.protectedScope.addInitMethod((function(){var c=n.protectedScope.createClass;t=n.protectedScope.context,e=n.protectedScope.timedTasks,a=n.util.getEqualPowerCurve,i=n.legacy,o=n.protectedScope.getSampleId,s=n.protectedScope.typeString,r=n.createPanner,d=c(m,(function(t){this.release=!0,this.releaseDuration=t.release_duration/1e3,this.releaseEnvelope=t.release_envelope})),(p=c(m,(function(t){this.release=!0,this.sustainStart=t.sustain_start/1e3,this.sustainEnd=t.sustain_end/1e3,this.releaseDuration=t.release_duration/1e3,this.releaseEnvelope=t.release_envelope,void 0===this.releaseEnvelope?this.releaseEnvelope="equal power":"array"===s(this.releaseEnvelope)&&(this.releaseEnvelopeArray=t.release_envelope_array,this.releaseEnvelope="array")}))).prototype.route=function(){this.source.loop=!0,this.source.loopStart=this.sustainStart,this.source.loopEnd=this.sustainEnd,this.source.connect(this.output)},(l=c(m,(function(t){this.release=!0,this.releaseDuration=t.release_duration/1e3,this.releaseEnvelope=t.release_envelope,void 0===this.releaseEnvelope?this.releaseEnvelope="equal power":"array"===s(this.releaseEnvelope)&&(this.releaseEnvelopeArray=t.release_envelope_array,this.releaseEnvelope="array"),this.panPosition=t.panPosition}))).prototype.route=function(){this.panner=r(),this.panner.setPosition(this.panPosition||0),this.source.connect(this.panner.node),this.panner.node.connect(this.output)},(f=c(m,(function(t){this.release=!0,this.sustainStart=t.sustain_start/1e3,this.sustainEnd=t.sustain_end/1e3,this.releaseDuration=t.release_duration/1e3,this.releaseEnvelope=t.release_envelope,void 0===this.releaseEnvelope?this.releaseEnvelope="equal power":"array"===s(this.releaseEnvelope)&&(this.releaseEnvelopeArray=t.release_envelope_array,this.releaseEnvelope="array"),this.panPosition=t.panPosition}))).prototype.route=function(){this.source.loop=!0,this.source.loopStart=this.sustainStart,this.source.loopEnd=this.sustainEnd,this.panner=r(),this.panner.setPosition(this.panPosition||0),this.source.connect(this.panner.node),this.panner.node.connect(this.output)},(u=c(m,(function(t){this.release=!0,this.panPosition=0,this.autopan=t.autopan||!1,this.frequency=t.event.frequency,this.waveForm=t.wave_form||0,this.releaseDuration=t.release_duration/1e3||1.5,this.releaseEnvelope=t.release_envelope||"equal power"}))).prototype.createSource=function(){this.source=t.createOscillator(),this.source.type=this.waveForm,this.source.frequency.value=this.frequency},u.prototype.route=function(){this.volume*=.3,this.output.gain.value=this.volume,this.autopan?(this.panner=r(),this.panner.setPosition(0),this.source.connect(this.panner.node),this.panner.node.connect(this.output)):this.source.connect(this.output)}}))}(),v(),function(){var t,e,i,s;function o(e,i,n,s){var r;for(i=0;i<n;i++)void 0!==(r=e[i])&&("MidiEvent"===r.className?s.push(r):"MidiNote"===r.className?s.push(r.noteOn):"array"===t(r)&&o(r,0,r.length))}(s=function(t){this.song=t,this.looped=!1,this.notes={},this.audioEvents={},this.timeDiff=i()}).prototype.updateSong=function(){this.events=this.song.eventsMidiAudioMetronome,this.numEvents=this.events.length,this.index=0,this.maxtime=0,this.notes={},this.audioEvents=this.song.audioEvents,this.numAudioEvents=this.audioEvents.length,this.scheduledAudioEvents={},this.looped=!1,this.setIndex(this.song.millis)},s.prototype.setIndex=function(t){var e;for(e=0;e<this.numEvents;e++)if(this.events[e].millis>=t){this.index=e;break}this.beyondLoop=!1,t>this.song.loopEnd&&(this.beyondLoop=!0),this.scheduledAudioEvents={}},s.prototype.getDanglingAudioEvents=function(t,e){var i,n;for(i=0;i<this.numAudioEvents;i++)(n=this.audioEvents[i]).millis<t&&n.endMillis>t?(n.playheadOffset=t-n.millis,n.time=this.startTime+n.millis-this.songStartMillis+n.playheadOffset,n.playheadOffset/=1e3,this.scheduledAudioEvents[n.id]=n,e.push(n)):n.playheadOffset=0;return e},s.prototype.getEvents=function(){var t,e,i,s,o,r,a,c,h,u=[];if(c=1e3*n.bufferTime,!0===this.song.doLoop&&this.song.loopDuration<c&&(this.maxtime=this.songMillis+this.song.loopDuration-1),!0===this.song.doLoop)if(this.maxtime>=this.song.loopEnd&&!1===this.beyondLoop){if(a=this.maxtime-this.song.loopEnd,this.maxtime=this.song.loopStart+a,!1===this.looped){for(this.looped=!0,t=this.index;t<this.numEvents&&(e=this.events[t]).millis<this.song.loopEnd;t++)e.time=this.startTime+e.millis-this.songStartMillis,u.push(e),this.index++;for(t in r=this.song.loopEndTicks-1,o=this.song.getPosition("ticks",r).millis,this.notes)if(this.notes.hasOwnProperty(t)){if(s=(i=this.notes[t]).noteOn,i.noteOff.millis<=this.song.loopEnd)continue;(e=n.createMidiEvent(r,128,s.data1,0)).millis=o,e.part=s.part,e.track=s.track,e.midiNote=s.midiNote,e.time=this.startTime+e.millis-this.songStartMillis,u.push(e)}for(t in this.scheduledAudioEvents)this.scheduledAudioEvents.hasOwnProperty(t)&&(h=this.scheduledAudioEvents[t]).endMillis>this.song.loopEnd&&(h.stopSample(this.song.loopEnd/1e3),delete this.scheduledAudioEvents[t]);this.notes={},this.setIndex(this.song.loopStart),this.song.startTime+=this.song.loopDuration,this.startTime=this.song.startTime,this.getDanglingAudioEvents(this.song.loopStart,u)}}else this.looped=!1;for(!0===this.firstRun&&(this.getDanglingAudioEvents(this.song.millis,u),this.firstRun=!1),t=this.index;t<this.numEvents&&(e=this.events[t]).millis<this.maxtime;t++)e.time=this.startTime+e.millis-this.songStartMillis,144===e.type||128===e.type?void 0!==e.midiNote&&void 0!==e.midiNote.noteOff&&(144===e.type?this.notes[e.midiNote.id]=e.midiNote:128===e.type&&delete this.notes[e.midiNote.id],u.push(e)):"audio"===e.type?(void 0!==this.scheduledAudioEvents[e.id]&&void 0!==(h=this.scheduledAudioEvents[e.id]).sample&&void 0!==h.sample.source&&h.stopSample(0),this.scheduledAudioEvents[e.id]=e,e.time=e.time+1e3*e.playheadOffset,u.push(e)):u.push(e),this.index++;return u},s.prototype.update=function(){var t,s,o,r,a,c,h=i();for(this.prevMaxtime=this.maxtime,!0===this.song.precounting?(this.songMillis=this.song.metronome.millis,this.maxtime=this.songMillis+1e3*n.bufferTime,r=[].concat(this.song.metronome.getPrecountEvents(this.maxtime)),this.maxtime>this.song.metronome.endMillis&&(this.songMillis=0,this.maxtime=this.song.millis+1e3*n.bufferTime,this.startTime=this.song.startTime,this.songStartMillis=this.song.startMillis,r=this.getEvents())):(this.songMillis=this.song.millis,this.maxtime=this.songMillis+1e3*n.bufferTime,this.startTime=this.song.startTime,this.songStartMillis=this.song.startMillis,r=this.getEvents()),o=r.length,t=0;t<o;t++)s=r[t],void 0===(a=s.track)||!0===s.muted||!0===s.part.mute||!0===s.track.mute||"metronome"===s.track.type&&!1===this.song.useMetronome||("audio"===s.type?(s.time/=1e3,a.audio.processEvent(s)):!1===a.routeToMidiOut?(s.time/=1e3,a.instrument.processEvent(s)):("any"!==(c=a.channel)&&void 0!==c&&!0!==isNaN(c)||(c=0),e(a.midiOutputs,(function(t){128===s.type||144===s.type||176===s.type?t.send([s.type+c,s.data1,s.data2],s.time+a.audioLatency+h):192!==s.type&&224!==s.type||t.send([s.type+c,s.data1],s.time+a.audioLatency)})),this.lastEventTime=s.time))},s.prototype.unschedule=function(){var t,e,i,n=Array.prototype.slice.call(arguments),s=[];for(o(n,0,n.length,s),t=s.length-1;t>=0;t--)(i=(e=s[t]).track.instrument)&&i.unscheduleEvent(e)},s.prototype.reschedule=function(){var t,e=this.song.numTracks,i=this.song.tracks;for(t=0;t<e;t++)i[t].instrument.reschedule(this.song)},n.protectedScope.addInitMethod((function(){i=n.getTimeDiff,n.protectedScope.context,t=n.protectedScope.typeString,e=n.protectedScope.objectForEach})),n.protectedScope.createScheduler=function(t){return new s(t)}}(),function(){var t,e,i,s,o,r,a,c,h,u,d,p,l=Array.prototype.slice,f=0,m={},v=[],g={},y={};function b(t){g[t.id]=t}function k(t){var e;for(e in t)t.hasOwnProperty(e)&&(t[e]=null)}n.getSongs=function(){return g},n.deleteSong=function(t){if(null!=t&&"Song"===t.className){var e,i,n,s,o;for(t.stop(),t.disconnect(h),delete g[t.id],e=t.eventsMidiAudioMetronome.length-1;e>=0;e--)k(t.eventsMidiAudioMetronome[e]);for(e=t.timeEvents.length-1;e>=0;e--)t.timeEvents[e];for(e=t.numTracks-1;e>=0;e--){for(void 0!==(i=t.tracks[e]).audio&&i.audio.recorder.cleanup(),n=i.numParts-1;n>=0;n--){for(o=(s=i.parts[n]).numNotes-1;o>=0;o--)k(s.notes[o]);k(s),s=null}k(i),i=null}return k(t),t=null,null}},n.getSnapshot=function(t,i){if(void 0!==t){i=i||t.id;var n,s,o,r,a,c,h,u=y[i],d=t.activeEvents,p=t.activeNotes,l=t.activeParts,f=[],m=[],v=[];if(void 0!==u){for(n=u.activeEvents,s=u.activeNotes,o=u.activeParts,h=n.length-1;h>=0;h--)void 0===d[(r=n[h]).id]&&void 0!==t.eventsLib[r.id]&&f.push(r);for(h=s.length-1;h>=0;h--)void 0===p[(a=s[h]).id]&&void 0!==t.notesLib[a.id]&&m.push(a);for(h=o.length-1;h>=0;h--)void 0===l[(c=o[h]).id]&&v.push(c)}return u={activeEvents:e(d),activeNotes:e(p),activeParts:e(l),nonActiveEvents:f,nonActiveNotes:m,nonActiveParts:v},y[i]=u,u}console.error("song is undefined")},u=function(t){var e,i,s,o=n.getTime();for(e in r)r.hasOwnProperty(e)&&(s=r[e]).time>=o&&(s.execute(),s=null,delete r[e]);for(e in a)a.hasOwnProperty(e)&&a[e]();for(e in c)c.hasOwnProperty(e)&&c[e]();f>=10?(i=(t-d)/1e3,n.diff=i,i>n.bufferTime&&!0===n.autoAdjustBufferTime&&(n.debug&&console.log("adjusted buffertime:"+n.bufferTime+" -> "+i),n.bufferTime=i)):f++,d=t,a={},window.requestAnimationFrame(u)},n.processEvent=n.processEvents=function(){var e,i,r,a,c,h,u,d,f,v,g,y,b=l.call(arguments),k=60;for(p=[],(e=function(n,o,r){for(o=0;o<r;o++)i=n[o],d=t(i),void 0!==i&&("midimessageevent"===d?(n=i.data,u=s(0,n[0],n[1],n[2]),p.push(u)):"MidiEvent"===i.className?p.push(i):"array"===d?e(i,0,i.length):"string"===d?f=i:!1===isNaN(i)&&(k=i))})(b,0,b.length),v=n.createPart(),(g=n.createTrack()).setInstrument(f),void 0===m[g.instrumentId]?(m[g.instrumentId]=g,g.addPart(v),g.connect(o.destination)):v=(g=m[g.instrumentId]).parts[0],v.addEvents(p),g.update(),a=p.length,c=n.getTime(),y=60/k/n.defaultPPQ,r=0;r<a;r++)(h=p[r]).time=c+h.ticks*y+.002,g.instrument.processEvent(h)},n.stopProcessEvent=n.stopProcessEvents=function(){i(m,(function(t){t.instrument.allNotesOff(),t=void 0})),m={}},n.play=function(){var e,i,s,o,r,a,c,h,u,d,p=l.call(arguments),f=[],m=[],v=[],y=[],k=[];for((s=function(e,n,r,p){for(n=0;n<r;n++)void 0!==(i=e[n])&&("string"===t(i)?d=i:"Song"===i.className?(void 0===c&&(c=i.bpm,h=i.nominator,u=i.denominator),y.push(i)):"Track"===i.className?(void 0===c&&void 0!==(o=i.song)&&(c=o.bpm,h=o.nominator,u=o.denominator),v.push(i)):"Part"===i.className?(void 0===c&&void 0!==(o=i.song)&&(c=o.bpm,h=o.nominator,u=o.denominator),m.push(i)):"MidiEvent"===i.className||"AudioEvent"===i.className?(void 0===c&&void 0!==(a=i.part)&&void 0!==(o=a.song)&&(c=o.bpm,h=o.nominator,u=o.denominator),81===i.type||88===i.type?k.push(i):f.push(i)):"array"===t(i)?s(i,0,i.length,"    "):!0===i||!1===i||0===i.indexOf("S")&&(o=g[i])&&o.play())})(p,0,p.length,"  "),e=y.length-1;e>=0;e--)o=y[e],v=v.concat(o.tracks),k=k.concat(o.timeEvents);return m.length>0&&((r=n.createTrack()).instrument=d,r.addParts(m),v.push(r)),f.length>0&&((r=n.createTrack()).instrument=d,(a=n.createPart()).addEvents(f),r.addPart(a),v.push(r)),b(o=n.createSong({bpm:c||120,nominator:h||4,denominator:u||4,timeEvents:k,tracks:v})),o.play(),o},n.setAnimationFrameType=function(t,e){switch(t=(t=t||"default").toLowerCase(),e=e||15,t){case"settimeout":window.requestAnimationFrame=function(t){setTimeout(t,e)};break;default:window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.requestAnimationFrame}},n.protectedScope.updateInstruments=function(){var t,e,i;for(t in g)if(g.hasOwnProperty(t))for(e=(i=g[t].tracks).length-1;e>=0;e--)i[e].instrument.reset()},n.allNotesOff=function(){i(g,(function(t){t.allNotesOff()}))},window.onblur=function(){!1!==n.pauseOnBlur&&(n.allNotesOff(),v=[],i(g,(function(t){!0===t.playing&&(n.debug&&console.log("pause song",t.id),v.push(t),t.pause())})))},window.onfocus=function(){if(!1!==n.pauseOnBlur){var t,e,i,s=v.length;for(i=0;i<s;i++)e=(t=v[i]).millis,t.stop(),t.setPlayhead("millis",e),n.restartOnFocus&&t.play();v=[]}},n.protectedScope.addSong=b,n.protectedScope.addInitMethod((function(){e=n.protectedScope.objectToArray,n.protectedScope.isEmptyObject,n.protectedScope.isEmptyObject,i=n.protectedScope.objectForEach,r=n.protectedScope.timedTasks,a=n.protectedScope.scheduledTasks,c=n.protectedScope.repetitiveTasks,t=n.protectedScope.typeString,o=n.protectedScope.context,s=n.createMidiEvent,h=n.protectedScope.masterGainNode,n.protectedScope.parseTimeEvents,u()}))}(),function(){var t,e,i,s,o,r,a,c,h,u,d,p,l,f,m,v,g,y,b,k,P,w,E,N,S,_,T,A,I,O,M,x,C,B,L,R,D,F,j,z,U,q,V,W,G,H,X,Q,Y,K,J,Z,$,tt,et=Array.prototype.slice,it=0;tt=function(r){r=r||{},this.id="S"+it+++(new Date).getTime(),this.name=r.name||this.id,this.className="Song",q(this),this.midiInputs={},this.midiOutputs={},u(this),this.bpm=r.bpm||120,this.ppq=r.ppq||n.defaultPPQ,this.bars=r.bars||30,this.lastBar=this.bars,this.lowestNote=r.lowestNote||0,this.highestNote=r.highestNote||127,this.pitchRange=this.highestNote-this.lowestNote+1,this.nominator=r.nominator||4,this.denominator=r.denominator||4,this.factor=4/this.denominator,this.ticksPerBeat=this.ppq*this.factor,this.ticksPerBar=this.ticksPerBeat*this.nominator,this.millisPerTick=6e4/this.bpm/this.ppq,this.quantizeValue=r.quantizeValue||"8",this.fixedLengthValue=r.fixedLengthValue||!1,this.positionType=r.positionType||"all",this.useMetronome=r.useMetronome,this.autoSize=void 0===r.autoSize||!0===r.autoSize,this.playbackSpeed=1,this.defaultInstrument=r.defaultInstrument||n.defaultInstrument,this.recordId=-1,this.autoQuantize=!1,this.loop=r.loop||!1,this.doLoop=!1,this.illegalLoop=!0,this.loopStart=0,this.loopEnd=0,this.loopDuration=0,this.audioRecordingLatency=0,!0!==this.useMetronome&&!1!==this.useMetronome&&(this.useMetronome=!1),this.grid=void 0,r.timeEvents&&r.timeEvents.length>0?(this.timeEvents=[].concat(r.timeEvents),this.tempoEvent=K(n.TEMPO,this)[0],this.timeSignatureEvent=K(n.TIME_SIGNATURE,this)[0],void 0===this.tempoEvent?(this.tempoEvent=t(0,n.TEMPO,this.bpm),this.timeEvents.unshift(this.tempoEvent)):this.bpm=this.tempoEvent.bpm,void 0===this.timeSignatureEvent?(this.timeSignatureEvent=t(0,n.TIME_SIGNATURE,this.nominator,this.denominator),this.timeEvents.unshift(this.timeSignatureEvent)):(this.nominator=this.timeSignatureEvent.nominator,this.denominator=this.timeSignatureEvent.denominator)):(this.tempoEvent=t(0,n.TEMPO,this.bpm),this.timeSignatureEvent=t(0,n.TIME_SIGNATURE,this.nominator,this.denominator),this.timeEvents=[this.tempoEvent,this.timeSignatureEvent]),void 0!==r.timeEvents&&void 0!==r.bpm&&this.bpm!==r.bpm&&this.setTempo(r.bpm,!1),void 0===r.timeEvents||void 0===r.nominator&&void 0===r.denominator||this.nominator===r.nominator&&this.denominator===r.denominator||this.setTimeSignature(r.nominator||this.nominator,r.denominator||this.denominator,!1),this.tracks=[],this.parts=[],this.notes=[],this.events=[],this.allEvents=[],this.tracksById={},this.tracksByName={},this.partsById={},this.notesById={},this.eventsById={},this.activeEvents=null,this.activeNotes=null,this.activeParts=null,this.recordedNotes=[],this.recordedEvents=[],this.recordingNotes={},this.numTracks=0,this.numParts=0,this.numNotes=0,this.numEvents=0,this.instruments=[],this.playing=!1,this.paused=!1,this.stopped=!0,this.recording=!1,this.prerolling=!1,this.precounting=!1,this.preroll=!0,this.precount=0,this.listeners={},this.playhead=e(this,this.positionType,this.id,this),this.playheadRecording=e(this,"all",this.id+"_recording"),this.scheduler=s(this),this.followEvent=i(this),this.volume=1,this.gainNode=a.createGainNode(),this.gainNode.gain.value=this.volume,this.metronome=o(this,T),this.connect(),"MidiFile"===r.className&&!1===r.loaded&&n.debug&&console.warn("midifile",r.name,"has not yet been loaded!"),r.tracks&&this.addTracks(r.tracks),r.parts&&this.addParts(r.parts),r.events&&this.addEvents(r.events),r.events||r.parts||r.tracks?(void 0===r.bars&&(this.lastBar=0),this.lastEvent=t([this.lastBar,n.END_OF_TRACK])):this.lastEvent=t([this.bars*this.ticksPerBar,n.END_OF_TRACK]),this.update(!0),this.numTimeEvents=this.timeEvents.length,this.playhead.set("ticks",0),this.midiEventListeners={}},Q=function(t,e){var i=!1;return void 0===t?i=!1:"Part"===i.className?i=t:"string"===B(t)?i=e.partsById[t]:!1===isNaN(t)&&(i=e.parts[t]),i},H=function(t,e){var i=!1;return void 0===t?i=!1:"Track"===t.className?i=t:"string"===B(t)?void 0===(i=e.tracksById[t])&&(i=e.tracksByName[t]):!1===isNaN(t)&&(i=e.tracks[t]),void 0===i&&(i=!1),i},X=function(t,e){var i,n,s=e.tracksById,o=e.tracksByName,r=[];for(i=t.length-1;i>=0;i--)!1!==(n=H(t[i]))&&(void 0!==n.song&&null!==n.song&&(n=n.copy()),n.song=e,n.instrument.song=e,n.quantizeValue=e.quantizeValue,n.connect(e.gainNode),n.state="new",n.needsUpdate=!0,s[n.id]=n,o[n.name]=n,r.push(n.id),U(n.partsById,(function(t){t.state="new"})));return r},V=function(t){var e,i,n=[];for(e=t.length-1;e>=0;e--)!1!==(i=H(t[e]))&&(void 0===i.song||i.song===this?(i.state="removed",i.disconnect(this.gainNode),i.reset(),delete this.tracksById[i.id],delete this.tracksByName[i.name],n.push(i)):console.warn("can't remove: this track belongs to song",i.song.id));return n},Y=function(t){var e,i,n=[];for(i=t.length-1;i>=0;i--)(e=Q(t[i],this))&&n.push(e);return n},K=function(t,e){var i=[];return e.timeEvents.forEach((function(e){e.type===t&&i.push(e)})),i},W=function(t){var e=1e3*n.getTime(),i=e-t.timeStamp,s=t.millis+i;if(t.diff=i,t.timeStamp=e,!0===t.precounting)return t.metronome.millis+=i,void t.scheduler.update(i);t.prevMillis=t.millis,t.doLoop&&t.scheduler.looped&&s>=t.loopEnd?(t.followEvent.resetAllListeners(),t.playhead.set("millis",t.loopStart+(s-t.loopEnd)),t.followEvent.update(),t.scheduler.update(),T(t,"loop")):s>=t.durationMillis?(t.playhead.update("millis",t.durationMillis-t.millis),t.followEvent.update(),t.pause(),t.endOfSong=!0,T(t,"end")):(t.playhead.update("millis",i),t.followEvent.update(),t.scheduler.update()),t.jump=!1},tt.prototype.remove=function(){console.warn("Song.remove() is deprecated, please use sequencer.deleteSong()"),n.deleteSong(this)},tt.prototype.play=function(){var t,e;if(n.unlockWebAudio(),this.playing)this.pause();else{this.scheduler.firstRun=!0,this.doLoop=!1===this.illegalLoop&&!0===this.loop,this.endOfSong&&(this.followEvent.resetAllListeners(),this.playhead.set("millis",0),this.scheduler.setIndex(0)),this.timeStamp=1e3*n.getTime(),this.startTime=this.timeStamp;try{this.startTime2=window.performance.now()}catch(t){n.debug&&console.log("window.performance.now() not supported")}this.precounting&&(this.metronome.startTime=this.startTime,this.metronome.startTime2=this.startTime2,this.startTime+=this.metronome.precountDurationInMillis,this.startTime2+=this.metronome.precountDurationInMillis,t=this,e=this.startTime/1e3,h.playAfterPrecount=function(){n.getTime()>=e&&(t.precounting=!1,t.prerolling=!1,t.recording=!0,t.playing=!0,T(t,"record_start"),T(t,"play"),h.playAfterPrecount=void 0,delete h.playAfterPrecount)}),this.startMillis=this.millis,(t=this).playhead.update("millis",0),t.followEvent.update(),h[this.id]=function(){W(t)},this.paused=!1,this.stopped=!1,this.endOfSong=!1,!0!==this.precounting&&(this.playing=!0,T(this,"play"))}},tt.prototype.pause=function(){!0!==this.recording&&!0!==this.precounting?this.stopped||this.paused?this.play():(delete h[this.id],this.allNotesOff(),this.playing=!1,this.paused=!0,T(this,"pause")):this.stop()},tt.prototype.stop=function(){if(this.stopped)return this.followEvent.resetAllListeners(),this.playhead.set("millis",0),void this.scheduler.setIndex(0);!0!==this.recording&&!0!==this.precounting||this.stopRecording(),delete h[this.id],U(c,(function(t,e){0!==e.indexOf("unschedule_")&&0!==e.indexOf("event_")||delete c[e]})),this.allNotesOff(),this.playing=!1,this.paused=!1,this.stopped=!0,this.endOfSong=!1,this.followEvent.resetAllListeners(),this.playhead.set("millis",0),this.scheduler.setIndex(0),T(this,"stop")},tt.prototype.adjustLatencyForAllRecordings=function(t){this.audioRecordingLatency=t,this.tracks.forEach((function(e){e.setAudioRecordingLatency(t)}))},tt.prototype.setAudioRecordingLatency=function(t,e,i){var n,s,o;for(n=this.audioEvents.length-1;n>=0&&(void 0===(o=(s=this.audioEvents[n]).sampleId)||t!==o);n--);s.track.setAudioRecordingLatency(t,e,i)},tt.prototype.startRecording=tt.prototype.record=function(t){if(!0!==this.recording&&!0!==this.precounting){var e,i,n=!1,s=!1,o=this;for(this.metronome.precountDurationInMillis=0,this.playing?(this.precount=0,this.recordStartMillis=this.millis):void 0===t?(this.precount=0,this.recordStartMillis=this.millis):(this.setPlayhead("barsbeats",this.bar),this.metronome.createPrecountEvents(t),this.precount=t,this.recordStartMillis=this.millis-this.metronome.precountDurationInMillis),this.recordTimestampTicks=this.ticks,this.recordId="REC"+(new Date).getTime(),this.recordedNotes=[],this.recordedEvents=[],this.recordingNotes={},this.recordingAudio=!1,void 0!==this.keyEditor&&this.keyEditor.prepareForRecording(this.recordId),e=this.numTracks-1;e>=0;e--)"audio"===(i=this.tracks[e]).recordEnabled&&(this.recordingAudio=!0),"audio"===i.recordEnabled?(s=!0,i.prepareForRecording(this.recordId,(function(){!1===n&&(n=!0,J.call(o))}))):i.prepareForRecording(this.recordId);return!1===s&&J.call(this),this.recordId}this.stop()},J=function(){this.recordTimestamp=1e3*a.currentTime,!1===this.playing?(this.precount>0?(this.precounting=!0,this.prerolling=this.preroll,this.prerolling?T(this,"record_preroll"):T(this,"record_precount")):(this.recording=!0,T(this,"record_start")),this.play()):(this.recording=!0,this.precounting=!1,T(this,"record_start"))},Z=function(t,e,i){var n,s=this;t<this.numTracks?(n=this.tracks[t]).stopRecording(this.recordId,(function(o){void 0!==o&&(e[n.name]=o),t++,Z.call(s,t,e,i)})):i(e)},tt.prototype.stopRecording=function(){if(!1!==this.recording){this.recording=!1,this.prerolling=!1,this.precounting=!1,delete h.playAfterPrecount;var t=this;return Z.call(this,0,{},(function(e){t.update(),T(t,"recorded_events",e)})),this.update(),T(this,"record_stop"),this.recordId}},tt.prototype.undoRecording=function(t){var e,i;if(void 0===t)for(e=this.numTracks-1;e>=0;e--)this.tracks[e].undoRecording(this.recordId);else i=this.tracksByName,U(t,(function(t,e){i[e].undoRecording(t)}))},tt.prototype.getAudioRecordingData=function(t){var e,i,n;for(e=this.audioEvents.length-1;e>=0&&(void 0===(n=(i=this.audioEvents[e]).sampleId)||t!==n);e--);return void 0!==i&&i.track.getAudioRecordingData(t)},tt.prototype.quantize=function(){var t,e,i,s,o,r=et.call(arguments),a=r.length,c={};for(t=0;t<a;t++)i=r[t],"string"===(s=B(i))||"number"===s?o=i:"object"===s&&(c=i);for(t=this.numTracks-1;t>=0;t--)e=this.tracks[t],void 0===o&&(o=e.quantizeValue),n.quantize(e.events,o,this.ppq,c);return c},tt.prototype.undoQuantize=function(t){var e;if(void 0!==t)for(e=this.numTracks-1;e>=0;e--)this.tracks[e].undoQuantize(t);else n.debug>=2&&console.warn("please pass a quantize history object")},tt.prototype.quantizeRecording=function(t){var e,i;for(e=this.numTracks-1;e>=0;e--)(i=this.tracks[e]).recordId===this.recordId&&i.quantizeRecording(t)},tt.prototype.setLeftLocator=function(){var t=y(this,et.call(arguments));void 0!==t&&(this.loopStartPosition=t,this.loopStart=t.millis,this.loopStartTicks=t.ticks),this.illegalLoop=this.loopStart>=this.loopEnd,this.doLoop=!1===this.illegalLoop&&!0===this.loop,this.loopDuration=!0===this.illegalLoop?0:this.loopEnd-this.loopStart},tt.prototype.setRightLocator=function(){var t=y(this,et.call(arguments));this.illegalLoop,void 0!==t&&(this.loopEndPosition=t,this.loopEnd=t.millis,this.loopEndTicks=t.ticks),this.illegalLoop=this.loopEnd<=this.loopStart,this.doLoop=!1===this.illegalLoop&&!0===this.loop,this.loopDuration=!0===this.illegalLoop?0:this.loopEnd-this.loopStart},tt.prototype.setLoop=function(t){if(void 0===t)this.loop=!this.loop;else{if(!0!==t&&!1!==t)return void(n.debug>=1&&console.error('pass "true", "false" or no value'));this.loop=t}this.doLoop=!1===this.illegalLoop&&!0===this.loop},tt.prototype.setPlayhead=function(){this.jump=!0,this.scheduler.looped=!1,this.scheduler.firstRun=!0,this.timeStamp=1e3*n.getTime(),this.startTime=this.timeStamp,this.playing&&this.allNotesOff();var t=y(this,et.call(arguments)),e=t.millis;this.startMillis=e,this.playhead.set("millis",e),this.scheduler.setIndex(e)},tt.prototype.addEventListener=function(){return S.apply(this,arguments)},tt.prototype.removeEventListener=function(){_.apply(this,arguments)},tt.prototype.addEvent=tt.prototype.addEvents=function(){var t,e;return void 0===(t=this.tracks[0])&&(t=n.createTrack(),this.addTrack(t)),t.needsUpdate&&t.update(),void 0===(e=t.parts[0])&&(e=n.createPart(),t.addPart(e)),e.addEvents.apply(e,arguments),this},tt.prototype.addPart=tt.prototype.addParts=function(){var t=this.tracks[0];return void 0===t&&(t=n.createTrack(),this.addTrack(t)),t.addParts.apply(t,arguments),this},tt.prototype.addTrack=function(){var t=G(arguments),e=t[0],i=t.length;return("array"===B(e)||i>1)&&(console.warn("please use addTracks() if you want to get more that one tracks"),t=[e]),X(t,this)[0]},tt.prototype.addTracks=function(){return X(G(arguments),this)},tt.prototype.getTrack=function(t){return H(t,this)},tt.prototype.getTracks=function(){var t,e,i=G(arguments),n=[];for(e=i.length-1;e>=0;e--)(t=H(i[e],this))&&n.push(t);return n},tt.prototype.getPart=function(){var t=G(arguments);return t.length>1&&console.warn("please use getParts() if you want to get more that one part"),Y.call(this,t)[0]},tt.prototype.getParts=function(){var t=G(arguments);return Y.call(this,t)},tt.prototype.removeTrack=function(){var t=G(arguments);return t.length>1&&console.warn("please use removeTracks() if you want to remove more that one tracks"),V.call(this,t)[0]},tt.prototype.removeTracks=function(){return V.call(this,G(arguments))},tt.prototype.setPlaybackSpeed=function(t){if(t<.01||t>100)console.error("playback speed has to be > 0.01 and < 100");else{var e,i,n,s=this.ticks;this.playbackSpeed=t,this.update(!0),void 0!==this.loopStartTicks&&(e=this.getPosition("ticks",this.loopStartTicks),this.loopStart=e.millis,this.loopStartTicks=e.ticks),void 0!==this.loopEndTicks&&(i=this.getPosition("ticks",this.loopEndTicks),this.loopEnd=i.millis,this.loopEndTicks=i.ticks),n=this.getPosition("ticks",s),this.setPlayhead("ticks",n.ticks)}},tt.prototype.gridToSong=function(t,e,i,n){return O(this,t,e,i,n)},tt.prototype.noteToGrid=function(t,e){return M(t,e,this)},tt.prototype.eventToGrid=function(t,e,i){return x(t,e,i,this)},tt.prototype.positionToGrid=function(t,e){return C(t,e,this)},tt.prototype.getPosition=function(){return y(this,et.call(arguments))},tt.prototype.ticksToMillis=function(t,e){return k(this,t,e)},tt.prototype.millisToTicks=function(t,e){return b(this,t,e)},tt.prototype.ticksToBars=function(t,e){return P(this,t,e)},tt.prototype.millisToBars=function(t,e){return w(this,t,e)},tt.prototype.barsToTicks=function(){return E(this,et.call(arguments))},tt.prototype.barsToMillis=function(){return N(this,et.call(arguments))},tt.prototype.findEvent=tt.prototype.findEvents=function(t){return j(this,t)},tt.prototype.findNote=tt.prototype.findNotes=function(t){return z(this,t)},tt.prototype.getStats=function(t){return F(this,t)},tt.prototype.createGrid=function(t){return void 0===this.grid?this.grid=$(this,t):this.grid.update(t),this.grid},tt.prototype.update=function(t){A(this,t)},tt.prototype.updateGrid=function(t){return this.grid.update(t),this.grid},tt.prototype.updateTempoEvent=function(t,e){if(t.type===n.TEMPO)if(t.song===this){var i=this.ticks;this.percentage,t.bpm=e,this.update(!0),this.updatePlayheadAndLocators(i)}else n.debug>=4&&console.error("this event has not been added to this song yet");else n.debug>=4&&console.error("this is not a tempo event")},tt.prototype.updateTimeSignatureEvent=function(t,e,i){if(t.type===n.TIME_SIGNATURE)if(t.song===this){var s=this.ticks;this.percentage,t.nominator=e||t.nominator,t.denominator=i||t.denominator,this.update(!0),this.updatePlayheadAndLocators(s)}else n.debug>=4&&console.error("this event has not been added to this song yet");else n.debug>=4&&console.error("this is not a time signature event")},tt.prototype.getTempoEvents=function(){return K(n.TEMPO,this)},tt.prototype.getTimeSignatureEvents=function(){return K(n.TIME_SIGNATURE,this)},tt.prototype.updatePlayheadAndLocators=function(t){var e,i,n,s=this.loopStartPosition,o=this.loopEndPosition;void 0!==s&&(e=this.getPosition("ticks",s.ticks),this.loopStart=e.millis,this.loopStartTicks=e.ticks,this.loopStartPosition=e),void 0!==o&&((i=this.getPosition("ticks",o.ticks)).ticks>this.durationTicks&&(i=this.getPosition("ticks",this.bars)),this.loopEnd=i.millis,this.loopEndTicks=i.ticks,this.loopEndPosition=i),n=this.getPosition("ticks",t),this.doLoop&&n.ticks>this.durationTicks?this.setPlayhead("ticks",0):this.setPlayhead("ticks",n.ticks),this.loopDuration=!0===this.illegalLoop?0:this.loopEnd-this.loopStart},tt.prototype.setTempo=function(t,e){var i,s,o=K(n.TEMPO,this),r=this.ticks,a=(this.percentage,t/o[0].bpm);for(i=o.length-1;i>=0;i--)(s=o[i]).bpm=a*s.bpm;this.bpm=t,!1!==e&&(this.update(!0),this.updatePlayheadAndLocators(r))},tt.prototype.setTimeSignature=function(t,e,i){var s,o,r=K(n.TIME_SIGNATURE,this),a=(this.percentage,this.ticks);for(s=r.length-1;s>=0;s--)(o=r[s]).nominator=t,o.denominator=e;this.nominator=t,this.denominator=e,!1!==i&&(this.update(!0),this.updatePlayheadAndLocators(a))},tt.prototype.resetTempo=function(t){var e=K(n.TEMPO,this)[0],i=this.timeEvents;e.bpm=t,i=R(i,(function(t){return 81===t.type})),this.numTimeEvents=i.length,this.update(!0)},tt.prototype.resetTimeSignature=function(t,e){var i=K(n.TIME_SIGNATURE,this)[0],s=this.timeEvents,o=this.ticks;i.nominator=t,i.denominator=e,s=R(s,(function(t){return 88===t.type})),this.numTimeEvents=s.length,this.update(!0),this.updatePlayheadAndLocators(o)},tt.prototype.addTimeEvent=tt.prototype.addTimeEvents=function(){var t,e,i,s=G(arguments),o=this.ticks;for(t=s.length-1;t>=0;t--)"MidiEvent"===(e=s[t]).className&&(e.type===n.TEMPO?this.timeEvents.push(e):e.type===n.TIME_SIGNATURE&&(i=(i=this.getPosition("ticks",e.ticks)).beat>i.nominator/2?this.getPosition("barsbeats",i.bar+1):this.getPosition("barsbeats",i.bar),e.ticks=i.ticks,this.timeEvents.push(e)));this.numTimeEvents=this.timeEvents.length,this.update(!0),this.updatePlayheadAndLocators(o)},tt.prototype.removeTimeEvent=tt.prototype.removeTimeEvents=function(){var t,e,i=G(arguments),n=i.length,s=this.ticks,o=[];for(t=0;t<n;t++)(e=i[t])!==this.tempoEvent&&e!==this.timeSignatureEvent&&o.push(e);this.timeEvents=L(o,this.timeEvents),this.numTimeEvents=this.timeEvents.length,this.update(!0),this.updatePlayheadAndLocators(s)},tt.prototype.removeDoubleTimeEvents=function(){var t,e,i,n,s=[],o={81:{},88:{}};for(t=this.timeEvents.length-1;t>=0;t--)void 0===o[(e=this.timeEvents[t]).type][e.ticks]&&(n=e.type,i=e.ticks,o[n][i]=e,0===i&&(81===n?this.tempoEvent=e:88===n&&(this.timeSignatureEvent=e)));U(o[81],(function(t){s.push(t)})),U(o[88],(function(t){s.push(t)})),this.timeEvents=s,this.update(!0)},tt.prototype.setPitchRange=function(t,e){var i=this;i.lowestNote=t,i.highestNote=e,i.numNotes=i.pitchRange=i.highestNote-i.lowestNote+1},tt.prototype.trim=function(){I(this,!0)},tt.prototype.setDurationInBars=function(t){var e=this,i=e.findEvent("bar > "+t),n=[],s=[],o=[],r={},a={};return i.forEach((function(t){var e=t.trackId,i=t.partId;void 0===r[e]&&(r[e]=[]),r[e].push(t),void 0===a[i]&&(a[i]=t.part)})),U(r,(function(t,i){var n=e.getTrack(i);n.removeEvents(t),s.push(n)})),U(a,(function(t,e){0===t.events.length?(t.track.removePart(t),n.push(t)):o.push(t)})),e.bars=t,e.lastBar=t,{removedEvents:i,removedParts:n,changedTracks:s,changedParts:o}},tt.prototype.addEffect=function(){},tt.prototype.removeEffect=function(){},tt.prototype.setVolume=function(){var t,e,i=et.call(arguments),n=i.length,s=[];function o(e,i,n){for(i=0;i<n;i++){var r=e[i],a=B(r);"array"===a?o(r,0,r.length):"number"===a?t=r:"Track"===r.className&&s.push(r)}}if(1===n){if(t=i[0],isNaN(t))return void console.warn("please pass a number");this.volume=t<0?0:t>1?1:t,this.gainNode.gain.value=this.volume}else for(o(i,0,n),e=s.length-1;e>=0;e--)s[e].setVolume(t)},tt.prototype.getVolume=function(){return this.gainNode.gain.value},tt.prototype.connect=function(){this.gainNode.connect(r)},tt.prototype.disconnect=function(){this.gainNode.disconnect(r)},tt.prototype.getMidiInputs=function(t){m(t,this)},tt.prototype.getMidiOutputs=function(t){v(t,this)},tt.prototype.setTrackSolo=function(t,e){var i,n;for(i=this.numTracks-1;i>=0;i--)n=this.tracks[i],!0===e?n.mute=n===t?!e:e:!1===e&&(n.mute=!1),n.solo=n===t&&e},tt.prototype.muteAllTracks=function(t){var e;for(e=this.numTracks-1;e>=0;e--)this.tracks[e].mute=t},tt.prototype.setMetronomeVolume=function(t){this.metronome.setVolume(t)},tt.prototype.configureMetronome=function(t){this.metronome.configure(t)},tt.prototype.resetMetronome=function(){this.metronome.reset()},tt.prototype.setPrecount=function(t){this.precount=t},tt.prototype.allNotesOff=function(){U(this.tracks,(function(t){t.allNotesOff()})),this.metronome.allNotesOff(),this.resetExternalMidiDevices()},tt.prototype.resetExternalMidiDevices=function(){var t=this.scheduler.lastEventTime+100;isNaN(t)&&(t=100),U(this.midiOutputs,(function(e){e.send([176,123,0],t),e.send([176,121,0],t)}))},tt.prototype.addMidiEventListener=function(){return d(arguments,this)},tt.prototype.removeMidiEventListener=function(t){p(t,this)},tt.prototype.removeMidiEventListeners=function(){p(arguments,this)},tt.prototype.getMidiInputsAsDropdown=function(t){return g(t=t||{type:"input"},this)},tt.prototype.getMidiOutputsAsDropdown=function(t){return g(t=t||{type:"output"},this)},tt.prototype.setMidiInput=function(t,e){l(t,e,this)},tt.prototype.setMidiOutput=function(t,e){f(t,e,this)},tt.prototype.getNoteLengthName=function(t){return D(this,t)},n.createSong=function(t){return new tt(t)},n.protectedScope.addInitMethod((function(){a=n.protectedScope.context,c=n.protectedScope.timedTasks,h=n.protectedScope.repetitiveTasks,r=n.protectedScope.masterGainNode,t=n.createMidiEvent,$=n.protectedScope.createGrid,u=n.protectedScope.initMidiSong,l=n.protectedScope.setMidiInputSong,f=n.protectedScope.setMidiOutputSong,m=n.protectedScope.getMidiInputs,v=n.protectedScope.getMidiOutputs,d=n.protectedScope.addMidiEventListener,g=n.protectedScope.getMidiPortsAsDropdown,p=n.protectedScope.removeMidiEventListener,y=n.protectedScope.getPosition,b=n.protectedScope.millisToTicks,k=n.protectedScope.ticksToMillis,P=n.protectedScope.ticksToBars,w=n.protectedScope.millisToBars,E=n.protectedScope.barsToTicks,N=n.protectedScope.barsToMillis,B=n.protectedScope.typeString,L=n.protectedScope.removeFromArray,R=n.protectedScope.removeFromArray2,j=n.findEvent,z=n.findNote,F=n.getStats,O=n.gridToSong,M=n.noteToGrid,x=n.eventToGrid,C=n.positionToGrid,G=n.protectedScope.getArguments,U=n.protectedScope.objectForEach,D=n.protectedScope.getNoteLengthName,A=n.protectedScope.update,I=n.protectedScope.checkDuration,n.protectedScope.addMetronomeEvents,n.protectedScope.followEvent,e=n.protectedScope.createPlayhead,s=n.protectedScope.createScheduler,i=n.protectedScope.createFollowEvent,o=n.protectedScope.createMetronome,S=n.protectedScope.songAddEventListener,_=n.protectedScope.songRemoveEventListener,T=n.protectedScope.songDispatchEvent,q=n.protectedScope.addSong}))}(),function(){var t,e,i,s,o=Array.prototype.slice,r=0;s=function(){var t,e,i,n=o.call(arguments),s=n.length,r=n[0],a=n[1],c=[];if(s>2)for(t=2;t<s;)c.push(n[t]),t++;if(c.push(r),void 0!==(e=r.listeners[a])&&void 0!==e.length)for(t=e.length-1;t>=0;t--)(i=e[t]).callback&&i.callback.apply(null,c)},e=function(){var t,e=o.call(arguments),i=e[0];switch(i){case"play":case"stop":case"pause":case"end":case"record_start":case"record_stop":case"record_precount":case"record_preroll":case"recorded_events":case"latency_adjusted":case"loop_off":case"loop_on":case"loop":case"sustain_pedal":return void 0===this.listeners[i]&&(this.listeners[i]=[]),t=i+"_"+r++,this.listeners[i].push({id:t,callback:e[1]}),t;case"note":case"event":case"position":return this.followEvent.addEventListener(i,e[1],e[2]);default:console.log(i,"is not a supported event")}},i=function(){var e,i,n,s,r,a=o.call(arguments),c=a[0],h=a[1],u=[];if(-1!==c.indexOf("_")?(i=(e=c.split("_"))[0],n=c):i=c,"array"===t(i))return this.followEvent.removeEventListener(a);switch(i){case"play":case"stop":case"pause":case"end":case"record_start":case"record_stop":case"record_precount":case"record_preroll":case"recorded_events":case"latency_adjusted":case"loop_off":case"loop_on":case"loop":case"sustain_pedal":if((e=this.listeners[i])&&e.length>0){for(s=e.length-1;s>=0;s--)r=e[s],void 0!==n?r.id!==n&&u.push(r):void 0!==h&&r.callback!==h&&u.push(r);this.listeners[i]=[].concat(u)}break;case"note":case"event":case"position":return this.followEvent.removeEventListener(a);default:console.error("unsupported event")}},n.protectedScope.songAddEventListener=e,n.protectedScope.songRemoveEventListener=i,n.protectedScope.songDispatchEvent=s,n.protectedScope.addInitMethod((function(){t=n.protectedScope.typeString}))}(),function(){var t,e,i,s,o,r,a=0,c={bar:1,beat:1,sixteenth:1,tick:0,ticks:1,barsbeats:1,barsandbeats:1,hour:1,minute:1,second:1,millisecond:0,millis:1,time:1},h="= == === > >= < <= != !== %=";new RegExp(" "+h.replace(/\s+/g," | ")+" "),(r=function(t){this.song=t,this.allListenersById={},this.allListenersByType={},this.searchPatterns=[],this.eventListenersBySearchstring={},this.positionListenersBySearchstring={},this.allListenersByType={event:{instance:{},searchstring:{}},position:{ticks:[],repetitive:{},conditional_simple:{},conditional_complex:{}}}}).prototype.updateSong=function(){var e,i,n,s,o,r,c,h,u,d,p=[];for(s in h=this.allListenersByType.event.instance)if(h.hasOwnProperty(s)&&void 0===this.song.eventsById[s]){for(e=(p=h[s]).length-1;e>=0;e--)d=p[e],delete this.allListenersById[d];delete this.allListenersByType.event.instance[s]}for(s in p=[],h=this.allListenersByType.event.searchstring)h.hasOwnProperty(s)&&(p=p.concat(h[s]));for(e=p.length-1;e>=0;e--)delete this.allListenersById[p[e]];for(this.allListenersByType.event.searchstring={},r=this.allListenersByType.event.searchstring,e=this.searchPatterns.length-1;e>=0;e--)for(c=this.searchPatterns[e],o=t(this.song,c.searchstring),"note"===r.type&&(o=t(o,"type = NOTE_ON OR type = NOTE_OFF")),i=o.length-1;i>=0;i--)n=o[i],u={id:d="event_"+a++,event:n,type:c.type,subtype:c.subtype,callback:c.callback},this.allListenersById[d]=u,void 0===r[n.id]&&(r[n.id]=[]),r[n.id].push(d)},r.prototype.update=function(){var t,e,i,n,s=this.song,o=s.ticks;for(i=(e=this.song.playhead.collectedEvents).length,t=0;t<i;t++)n=e[t],this.callEventListeners(n.id,n);this.callListenersPositionTicks(o),s.bar!==this.bar&&(this.bar=s.bar,this.callListenersPositionRepetitive("bar"),this.callListenersPositionConditionalSimple("bar",this.bar),this.callListenersPositionConditionalComplex("bar",this.bar)),s.beat!==this.beat&&(this.beat=s.beat,this.callListenersPositionRepetitive("beat"),this.callListenersPositionConditionalSimple("beat",this.beat),this.callListenersPositionConditionalComplex("beat",this.beat)),s.sixteenth!==this.sixteenth&&(this.sixteenth=s.sixteenth,this.callListenersPositionRepetitive("sixteenth"),this.callListenersPositionConditionalSimple("sixteenth",this.sixteenth),this.callListenersPositionConditionalComplex("sixteenth",this.sixteenth)),s.hour!==this.hour&&(this.hour=s.hour,this.callListenersPositionRepetitive("hour"),this.callListenersPositionConditionalSimple("hour",this.hour),this.callListenersPositionConditionalComplex("hour",this.hour)),s.minute!==this.minute&&(this.minute=s.minute,this.callListenersPositionRepetitive("minute"),this.callListenersPositionConditionalSimple("minute",this.minute),this.callListenersPositionConditionalComplex("minute",this.minute)),s.second!==this.second&&(this.second=s.second,this.callListenersPositionRepetitive("second"),this.callListenersPositionConditionalSimple("second",this.second),this.callListenersPositionConditionalComplex("second",this.second))},r.prototype.callEventListeners=function(t,e){var i,n,s,o,r=[];for((s=this.allListenersByType.event.instance)[t]&&(r=r.concat(s[t])),(s=this.allListenersByType.event.searchstring)[t]&&(r=r.concat(s[t])),r.length,i=r.length-1;i>=0;i--)n=r[i],!0!==(o=this.allListenersById[n]).called&&(o.called=!0,o.callback(e))},r.prototype.callListenersPositionRepetitive=function(t){var e,i=this.allListenersByType.position.repetitive[t],n=this;i&&i.forEach((function(t){(e=n.allListenersById[t]).callback(e.searchstring)}))},r.prototype.callListenersPositionConditionalSimple=function(t,e){var i,n,s=!1,o=this.allListenersByType.position.conditional_simple[t],r=this;o&&o.forEach((function(t){switch(i=r.allListenersById[t],n=i.data,i.operator){case">":s=e>n;break;case"<":s=e<n;break;case"%=":s=e%n==0;break;case"!=":case"!==":s=e!==n;break;case"===":s=e===n}!0===s&&i.callback(i.searchstring)}))},r.prototype.callListenersPositionConditionalComplex=function(t,e){var i,n,s,o,r=this.allListenersByType.position.conditional_complex[t],a=this;r&&r.forEach((function(t){i=a.allListenersById[t],n=i.value1,s=i.value2,o=i.operator1,i.operator2,"<"===o?(e<n||e>s)&&i.callback(i.searchstring):">"===o&&e>n&&e<s&&i.callback(i.searchstring)}))},r.prototype.callListenersPositionTicks=function(t){var e,i,n=this.allListenersByType.position.ticks,s=n.length;for(e=0;e<s;e++)t>=(i=this.allListenersById[n[e]]).ticks&&!i.called&&(i.callback(i.searchstring),i.called=!0)},r.prototype.addEventListener=function(i,n,o){var r,c,h,u,d,p,l,f,m=[],v=e(n);if("function"!==e(o))return console.error(o,"is not a function; please provide a function for callback"),-1;if("position"===i)return f=this.addPositionEventListener(n,o);if("string"===v){if(c=t(this.song,n),this.searchPatterns.push({searchstring:n,callback:o,type:"event",subtype:"searchstring"}),0===c.length)return-1;p="searchstring",u=this.allListenersByType.event.searchstring,this.eventListenersBySearchstring[n]=d=[]}else{if(-1===(c=s(i,n)))return-1;p="instance",u=this.allListenersByType.event.instance}for("note"===i&&(c=t(c,"type = NOTE_ON OR type = NOTE_OFF")),r=c.length-1;r>=0;r--)h=c[r],l={id:f="event_"+a++,event:h,type:i,subtype:p,callback:o},this.allListenersById[f]=l,void 0===u[h.id]&&(u[h.id]=[]),u[h.id].push(f),m.push(f),"searchstring"===p&&d.push(f);return"searchstring"===p||"array"===v||"note"===i?m:m[0]},r.prototype.addPositionEventListener=function(t,n){var s,r,u,d,p=t.split(/[\s+]/g),l=p.length,f=p[0],m=p[1],v=p[2],g=p[3],y=p[4],b=e(v);if(1!==l&&3!==l&&5!==l)return console.error("invalid search string, please consult documentation"),!1;if(1!==c[f])return console.error(f,"is not a supported event id, please consult documentation"),-1;switch("="!==m&&"=="!==m||(m="==="),f){case"barsbeats":case"barsandbeats":case"time":case"ticks":case"millis":if(void 0===m||"==="!==m)return console.error(f,"can only be used conditionally with the operators '===', '==' or '='"),-1;g&&console.warn("this position event type can only be used with a single condition, ignoring second condition");break;case"bar":case"beat":case"sixteenth":case"hour":case"minute":case"second":if(v&&isNaN(v))return console.error("please provide a number"),-1;if(y&&isNaN(y))return console.error("please provide a number"),-1}if(m&&-1===h.indexOf(m))return console.error(m,"is not a supported operator, please use any of",h),-1;if(m&&void 0===v)console.error("operator without value");else{if(g&&-1===h.indexOf(m))return console.error(g,"is not a supported operator, please use any of",h),-1;if(!g||void 0!==y){if(m&&g&&!1===o(m,g))return console.error("you can't use "+m+" together with "+g),-1;if("function"!==e(n))return console.error(n,"is not a function; please provide a function for callback"),-1;switch(f){case"bar":case"beat":case"sixteenth":v-=0,y-=0;case"hour":case"minute":case"second":v-=0,y-=0,m&&("<="===m?(v++,m="<"):">="===m&&(v--,m=">")),g&&("<="===g?(y++,g="<"):">="===g&&(y--,g=">"));break;case"ticks":v-=0;break;case"barsbeats":case"barsandbeats":isNaN(v)?"string"===b?(v=(v=v.replace(/[\[\]\s]/g,"")).split(","),v=i(this.song,["barsbeats",v[0],v[1]||1,v[2]||1,v[3]||0]).ticks):console.error("please provide a number or an array of numbers"):v=i(this.song,["barsbeats",v,1,1,0]).ticks,f="ticks";break;case"millis":v=i(this.song,["millis",v]).ticks,f="ticks";break;case"time":isNaN(v)?"string"===b?(v=v.replace(/[\[\]\s]/g,""),console.log(v),1===(v=v.split(",")).length?(d=60*v[0]*1e3,v=i(this.song,["millis",d]).ticks):v=i(this.song,["time",v[0],v[1],v[2],v[3]]).ticks):console.error("please provide a number or an array of numbers"):(d=60*v*1e3,v=i(this.song,["millis",d]).ticks),console.log(v),f="ticks"}return r="position_"+a++,"ticks"===f?(u={id:r,callback:n,type:"position",subtype:"ticks",ticks:v,searchstring:t},this.allListenersByType.position.ticks.push(r)):m||g?m&&!g?(u={id:r,callback:n,type:"position",subtype:"conditional_simple",position_type:f,data:v,operator:m,searchstring:t},void 0===(s=this.allListenersByType.position.conditional_simple)[f]&&(s[f]=[]),s[f].push(r)):m&&g&&(u={id:r,callback:n,type:"position",subtype:"conditional_complex",position_type:f,value1:v,value2:y,operator1:m,operator2:g,searchstring:t},void 0===(s=this.allListenersByType.position.conditional_complex)[f]&&(s[f]=[]),s[f].push(r)):(u={id:r,callback:n,type:"position",subtype:"repetitive",position_type:f,searchstring:t},void 0===(s=this.allListenersByType.position.repetitive)[f]&&(s[f]=[]),s[f].push(r)),this.allListenersById[r]=u,this.positionListenersBySearchstring[t]=r,r}console.error("operator without value")}},r.prototype.removeEventListener=function(t){var i,n,s,o,r,a,c,h,u,d,p,l,f,m,v,g,y,b=[],k=[];if(i=t[0],1===(n=t.length))for(f=(h="array"===e(i)?i:[i]).length-1;f>=0;f--)if(c=h[f],void 0!==this.allListenersById[c]){if(s=(u=this.allListenersById[c]).type,o=u.subtype,"position"===s){for(m=(g=this.allListenersByType[s][o][u.position_type]).length-1;m>=0;m--)(d=g[m])!==c&&b.push(d);this.allListenersByType[u.type][u.subtype][u.position_type]=[].concat(b),delete this.allListenersById[c]}else if("event"===s||"note"===s){for(p=u.event.id,m=(g=this.allListenersByType.event[o][p]).length-1;m>=0;m--)if(d=g[m],u=this.allListenersById[d],d!==c){b.push(d);break}this.allListenersByType.event[o][p]=[].concat(b),delete this.allListenersById[c]}}else console.warn("no event listener found with id",c);else if(2===n||3===n)switch(s=t[0],r=t[1],a=t[2],y=e(r),s){case"position":if("string"===y){for(c=this.positionListenersBySearchstring[r],u=this.allListenersById[c],f=(g=this.allListenersByType[u.type][u.subtype][u.position_type]).length-1;f>=0;f--)(d=g[f])!==c&&b.push(d);this.allListenersByType[u.type][u.subtype][u.position_type]=[].concat(b),delete this.allListenersById[c],delete this.positionListenersBySearchstring[r]}break;case"event":case"note":if("string"===y){for(f=(g=this.eventListenersBySearchstring[r]).length-1;f>=0;f--)k.push(g[f]);for(p in l=this.allListenersByType.event.searchstring)if(l.hasOwnProperty(p)){for(b=[],f=(g=l[p]).length-1;f>=0;f--){for(d=g[f],v=!1,m=k.length-1;m>=0;m--)if(d===k[m]){v=!0;break}!1===v?b.push(d):delete this.allListenersById[g[f]]}this.allListenersByType.event.searchstring[p]=[].concat(b)}delete this.eventListenersBySearchstring[r]}else if("object"===y){if("MidiEvent"!==r.className&&"MidiNote"!==r.className)return void console.error("please provide a midi event or a midi note");if("MidiNote"===r.className?c=r.noteOn.id:"MidiEvent"===r.className&&(c=r.id),void 0!==this.allListenersByType.event.instance[c]?(s="instance",g=this.allListenersByType.event.instance[c]):void 0!==this.allListenersByType.event.searchstring[c]&&(s="searchstring",g=this.allListenersByType.event.searchstring[c]),void 0===g)return void console.warn("no event listener bound to event with id",c);for("MidiNote"===r.className&&(h=this.allListenersByType.event[s][r.noteOff.id],g=g.concat(h)),f=g.length-1;f>=0;f--)d=g[f],u=this.allListenersById[d],a&&u.callback!==a?b.push(u.id):delete this.allListenersById[u.id],this.allListenersByType.event[s][u.event.id]=[].concat(b)}}},r.prototype.resetAllListeners=function(){var t,e=this.allListenersById;for(t in e)e.hasOwnProperty(t)&&(e[t].called=!1)},s=function(t,i){var n,s,o=e(i),r=[];if("array"!==o&&void 0!==i&&"MidiEvent"!==i.className&&"MidiNote"!==i.className)return console.error(i," is not valid data for event type 'event', please consult documentation"),-1;if("array"===o)for(n=i.length-1;n>=0;n--)s=i[n],"event"!==t||"MidiEvent"===s.className||"AudioEvent"===s.className?"note"!==t||"MidiNote"===s.className?r.push(s):console.warn("skipping",s,"because it is not a MidiNote"):console.warn("skipping",s,"because it is not a MidiEvent nor an AudioEvent");else if("event"===t){if("MidiEvent"!==i.className&&"AudioEvent"!==i.className)return console.error(i," is not a MidiEvent nor an AudioEvent"),-1;r=[i]}else if("note"===t){if("MidiNote"!==i.className)return console.error(i," is not a MidiNote"),-1;r=[i.noteOn,i.noteOff]}return r},o=function(t,e){switch(t){case"=":case"==":case"===":return!1}switch(e){case"=":case"==":case"===":return!1}return!0},n.protectedScope.createFollowEvent=function(t){return new r(t)},n.protectedScope.addInitMethod((function(){e=n.protectedScope.typeString,i=n.protectedScope.getPosition,n.midiEventNumberByName,n.midiEventNameByNumber,t=n.findEvent}))}(),function(){var t,e,i,s,o,r,a;a=function(i,s,o,r,a){var c,h;if(void 0!==i)if(void 0!==s&&void 0!==o){if(void 0!==r&&void 0!==a)return c=e(s/r*i.ticks),h=i.highestNote-e(o/a*i.pitchRange),{position:t(i,["ticks",c]),note:h=n.createNote(h)};console.error("please provide width and height")}else console.error("please provide a coordinate");else console.error("please provide a song")},n.positionToSong=n.coordinatesToPosition=n.gridToSong=function(){var t=Array.prototype.slice.call(arguments),e=t.length,i=t[0];return 4===e&&"Song"!==i.className?a(n.getSong(),i,t[1],t[2],t[3]):a(i,t[1],t[2],t[3],t[4])},n.songToGrid=function(){var t=Array.prototype.slice.call(arguments),e=t.length,i=t[0],n=t[1];switch(e){case 3:o(i,n,t[2]);break;case 4:"x"===i?s(n,t[2],t[3]):"y"===i&&r(n,t[2],t[3]);break;case 6:break;default:console.error("wrong number of arguments")}},o=function(t,e,i,o){if(void 0===o&&(o=n.getSong()),t.type!==n.NOTE_ON&&t.type!==n.NOTE_OFF)return console.error("please provide a NOTE_ON or a NOTE_OFF event"),null;t.millis,o.durationMillis;var a=n.createNote(t.noteNumber);return{x:s(["ticks",t.ticks],e,o),y:r(a,i,o)}},s=function(s,o,r){void 0===r&&(r=n.getSong()),"array"!==i(s)&&"ticks"===s.type||(s=t(r,s));var a=e(s.ticks/r.quantizeTicks)*r.quantizeTicks;return a/=r.ticks,a*=o},r=function(t,e,i){void 0===i&&(i=n.getSong());var s,o=t.number;return o<i.lowestNote||o>i.highestNote?(console.error("note is out of range of the pitch range of this song"),null):(s=(s=(o-i.highestNote)/i.pitchRange)<0?-s:s,s*=e)},n.protectedScope.addInitMethod((function(){t=n.protectedScope.getPosition,e=n.protectedScope.floor,n.protectedScope.round,i=n.protectedScope.typeString}))}(),g(),function(){var t,e,i,s,o,r,a,c,h,u,d,p,l,f,m,v,g,y,b=n.debug,k=Array.prototype.slice,P=0;function w(e,i){var n=!1;return e?"Part"===e.className?n=e:"string"===t(e)?n=i.partsById[e]:!1===isNaN(e)&&(n=i.parts[e]):n=!1,n}function E(e,i){var n=!1;return e?"MidiEvent"===e.className||"AudioEvent"===e.className?n=e:"array"===t(e)&&4===e.length?n=r(e):"string"===t(e)?n=i.eventsById[e]:!1===isNaN(e)&&(n=i.events[e]):n=!1,n}function N(e,i){var n,s,o,r=0,a=0,c=(e=Array.prototype.slice.call(e))[0],h=[],u=[];if("array"===t(c)){for(a=c.length-1;a>=0;a--)(s=w(o=c[a],i))&&h.push(s);r=0===h.length?0:1}for(n=e.length,a=r;a<n;a++)(s=w(o=e[a],i))?h.push(s):u.push(o);return 0===h.length?(console.warn("no parts added"),!1):{parts:h,config:u}}function S(e,i){var n,s,o,r=0,a=0,c=(e=Array.prototype.slice.call(e))[0],h=[],u=[];if("array"===t(c)){for(a=c.length-1;a>=0;a--)(s=E(o=c[a],i))&&h.push(s);r=1}for(n=e.length,a=r;a<n;a++)(s=E(o=e[a],i))?h.push(s):u.push(o);return 0===h.length&&b>=2&&console.info("Please provide one or more events, or an array of events"),1===u.length&&"array"===t(u[0])&&(u=u[0]),{events:h,config:u}}function _(t,e){var i,n;if(!1===(t=o(t)))return!1;if(i=t[0],void 0===e&&"ticks"!==i)return console.error("Track has not been added to a song yet, you can only use tick values"),!1;switch(i){case"ticks":n=t[1];break;case"millis":n=e.millisToTicks(t[1]);break;case"barsbeats":case"barsandbeats":case"time":n=(t=e.getPosition(t,"ticks")).ticks}return n}function T(t,e){if(!1!==t){var i,n,s,o,r,a,c,u=e.song,d=t.parts,p=d.length,l=e.partsById;for(i=0;i<p;i++)if(!1!==(o=w(d[i]))){for(n in void 0!==o.track&&(o=o.copy()),o.hasAudioEvents&&void 0===e.audio&&(e.audio=h(e)),o.song=u,o.track=e,o.trackId=e.id,r=o.eventsById,c=0!==(a=o.ticks),r)r.hasOwnProperty(n)&&((s=r[n]).track=e,s.channel=e.channel,s.trackId=e.id,c&&(s.ticks+=a),s.state="new");o.state="new",o.needsUpdate=!0,l[o.id]=o}else console.error(o,"is not a part");e.needsUpdate=!0}}function A(t,e){if(!1!==t){var i,n,s,o=t.parts,r=t.config[0],a=r;for(s=o.length-1;s>=0;s--)(i=(n=o[s]).ticks+r)<0&&(i=0,a=-n.ticks),n.ticks=i,n.moveEvents(n.events,a),"new"!==n.state&&(n.state="changed");e.needsUpdate=!0}}function I(t,e){if(!1!==t){var i,n,s,o,r=e.song,a=t.parts,c=t.config;for(i=a.length-1;i>=0;i--)n=a[i],!1!==(s=_(c[i],r))?(o=s-n.ticks,n.ticks=s,n.moveAllEvents(o),"new"!==n.state&&(n.state="changed")):console.warn("wrong position data, skipping part",n.id);e.needsUpdate=!0}}function O(t,e){if(!1===t)return[];var i,n,s=[],o=t.parts;if(void 0===o)return console.log("weird situation, check this when it happens"),[];for(i=o.length-1;i>=0;i--)void 0===(n=o[i]).track||n.track===e?(s.push(n),n.state="removed",n.reset(!0,!0)):console.warn("can't remove: this part belongs to track",n.track.id);return e.needsUpdate=!0,s}function M(t,e){if(!1!==t){var i,n,s,o={},r=[],a=t;for(i=a.length-1;i>=0;i--)void 0===(s=a[i]).track||null===s.track||s.track===e?(void 0===o[n=s.partId]&&(o[n]=[]),o[n].push(s),r.push(s)):console.warn("can't remove: this event belongs to track",s.track.id);for(n in o)o.hasOwnProperty(n)&&e.partsById[n].removeEvents(o[n]);return e.needsUpdate=!0,r}}function x(t){var e;return void 0!==t.song&&void 0!==t.song.defaultInstrument&&(e=i(t.song.defaultInstrument,n.storage.instruments)),!1!==e&&void 0!==e||(e=i(n.defaultInstrument,n.storage.instruments)),e}(y=function(t,e,i){this.className="Track",this.id="T"+P+++(new Date).getTime(),this.type=e||"instrument",this.name=t||this.id,this.song=i,this.instrumentName="",this.events=[],this.eventsById={},this.notes=[],this.notesById={},this.parts=[],this.partsById={},this.numParts=0,this.numEvents=0,this.needsUpdate=!1,this.audioLatency=0,this.effects={},this.numEffects=0,this.volume=1,this.input=a.createGainNode(),this.input.gain.value=1,this.output=a.createGainNode(),this.output.gain.value=this.volume,this.panner=u(),this.input.connect(this.panner.node),this.panner.node.connect(this.output),this.lastEffect=this.input,this.midiInputs={},this.midiOutputs={},this.routeToMidiOut=!1,this.midiEventListeners={},this.monitor=!1,this.recordEnabled=!1,this.mute=!1,this.solo=!1,this.channel="any",this.quantizeValue=0,this.fixedLengthValue=0,this.autoQuantize=!1,this.retrospectiveRecording=[],this.recordingNotes={},this.enableRetrospectiveRecording=!1,"metronome"!==e&&this.setInstrument(this.instrumentName)}).prototype.addPart=y.prototype.addParts=function(){var t=N(arguments,this);T(t,this)},y.prototype.addPartAt=y.prototype.addPartsAt=function(){var t,e,i,n,s,o=N(arguments,this);if(!1!==o){if(e=o.parts,void 0===(t=o.config))return console.error("please provide position data"),!1;for(i=e.length-1;i>=0;i--)n=e[i],!1!==(s="ticks"===t[0]?t[1]:_(t[i],this.song))&&(n.ticks+=s);T(o,this)}},y.prototype.movePart=y.prototype.moveParts=function(){var t=N(arguments,this);A(t,this)},y.prototype.movePartTo=y.prototype.movePartsTo=function(){var t=N(arguments,this);I(t,this)},y.prototype.moveAllParts=function(t){this.moveParts({parts:this.parts,config:[t]})},y.prototype.copyPart=y.prototype.copyParts=function(){var t,e=N(arguments,this),i=[];if(!1!==e){if(0!==t.length)return(t=e.parts).forEach((function(t){i.push(t.copy())})),1===i.length?i[0]:i;console.error("no parts")}},y.prototype.removePart=function(){var t=N(arguments,this),e=O(t,this);return 1===e.length?e[0]:e},y.prototype.removeParts=function(){var t=N(arguments,this);return O(t,this)},y.prototype.getPart=function(t){return w(t)},y.prototype.getParts=function(){var e,i,n=Array.prototype.slice.call(arguments),s=[];return(i=function(n,o){e=n[o],"array"===t(e)?i(e,0):s.push(w(e))})(n,0),s},y.prototype.getPartAt=y.prototype.getPartsAt=function(t){var e=_(t,this.song),i=this.parts,n=[];if(!1!==e)return i.forEach((function(t){t.ticks===e&&n.push(t)})),n;console.error("please provide position as array, for instance: ['barsandbeats',5,1,2,0]")},y.prototype.getPartFromTo=y.prototype.getPartsFromTo=function(t,e){var i=this.parts,n=[],s=_(t,this.song),o=_(e,this.song);if(!1!==s){if(!1!==o)return i.forEach((function(t){(s>=t.start.ticks&&s<=t.end.ticks||o>=t.start.ticks&&o<=t.end.ticks)&&n.push(t)})),n;console.error("invalid position data for from position")}else console.error("invalid position data for from position")},y.prototype.getPartBetween=y.prototype.getPartBetween=function(t,e){var i=this.parts,n=[],s=_(t,this.song),o=_(o,this.song);if(!1!==s&&!1!==o)return i.forEach((function(t){t.start.ticks>=s&&t.end.ticks<=o&&n.push(t)})),n;console.error("please provide position as array, for instance: ['barsandbeats',5,1,2,0]")},y.prototype.copy=function(){var t,i,n,s=new y(e(this.name)),o=this.parts,r=[];if(s.song=null,s.instrumentId=this.instrumentId,s.numEffects=this.numEffects,this.numEffects>0)for(i in s.effects={},this.effects)this.effects.hasOwnProperty(i)&&(n=this.effects[i],s.effects[n.id]=n.copy());for(i=o.length-1;i>=0;i--)t=o[i],r.push(t.copy());return s.addParts(r),s},y.prototype.removeEvent=y.prototype.removeEvents=function(){var t=S(arguments,this);M(t.events,this)},y.prototype.removeEventsFromTo=function(t,e){console.warn("removeEventsFromTo() is temporarily disabled")},y.prototype.removeEventAt=y.prototype.removeEventsAt=function(t){console.warn("removeEventAt() is temporarily disabled")},y.prototype.removeAllEvents=function(){M(this.events,this)},y.prototype.transposePart=function(t,e){var i=t.getStats("noteNumber all"),n=0,s=127;this.song&&(n=this.song.lowestNote,s=this.song.highestNote),i.min+e<n?i.min:i.max+e>s?s=i.max:t.transposeAllEvents(e)},y.prototype.reset=function(){var t;for(t in this.song=null,this.audio&&this.audio.setSong(null),this.partsById)this.partsById.hasOwnProperty(t)&&this.partsById[t].reset(!1,!0);this.needsUpdate=!0},y.prototype.findEvent=function(t){return m(this,t)},y.prototype.findNote=function(t){return v(this,t)},y.prototype.getStats=function(t){return g(this,t)},y.prototype.update=function(){var t,e,i,n,s,o;for(e in this.parts=[],this.notes=[],this.events=[],this.partsById)if(this.partsById.hasOwnProperty(e)){if(!0===(i=this.partsById[e]).needsUpdate&&i.update(),0===i.events.length&&!1===i.keepWhenEmpty&&this.removePart(i),"new"===i.state&&void 0!==this.song)for(t=(s=i.events).length-1;t>=0;t--)(n=s[t]).song=this.song;"removed"!==i.state&&(this.parts.push(i),this.notes=this.notes.concat(i.notes),this.events=this.events.concat(i.events))}for(this.parts.sort((function(t,e){return t.ticks-e.ticks})),this.notes.sort((function(t,e){return t.ticks-e.ticks})),this.events.sort((function(t,e){return t.sortIndex-e.sortIndex})),this.numEvents=this.events.length,this.numNotes=this.notes.length,this.numParts=this.parts.length,t=this.numEvents-1;t>=0;t--)n=this.events[t],this.eventsById[n.id]=n;for(t=this.numNotes-1;t>=0;t--)o=this.notes[t],this.notesById[o.id]=o;this.needsUpdate=!1},y.prototype.getIndex=function(){var t,e=-1,i=this.song.tracks,n=i.length;if(n>0)for(t=0;t<n;t++)if(i[t].id===this.id){e=t;break}return e},y.prototype.addEffect=function(t,e){t&&(this.effects[t.id]=t,this.numEffects++,void 0!==this.lastEffect&&(this.lastEffect.disconnect(0),t.setInput(this.lastEffect)),t.output.connect(this.panner.node),this.lastEffect=t.output)},y.prototype.removeEffect=function(t){!1!==t&&(delete this.effects[t.id],this.numEffects--)},y.prototype.setEffectPosition=function(t,e){var i,n,s=this.numEffects-1;if(!(e<0||e>s))for(t.position=e,i=0;i<s-1;i++)(n=this.effects[i]).position>=e&&n!==t&&(n.position+=1)},y.prototype.setSolo=function(t){void 0===t&&(t=!this.solo),this.mute=!1,this.solo=t,this.song&&this.song.setTrackSolo(this,t)},y.prototype.setPartSolo=function(t,e){var i,n;for(i=this.numParts-1;i>=0;i--)n=this.parts[i],!0===e?n.mute=n===t?!e:e:!1===e&&(n.mute=!1),n.solo=n===t&&e},y.prototype.setVolume=function(t){isNaN(t)?n.debug>=1&&console.error("please pass a number"):t<0||t>1?n.debug>=1&&console.error("please pass a float between 0 and 1"):(this.volume=t,this.input.gain.value=this.volume)},y.prototype.getVolume=function(){return this.volume},y.prototype.setPanning=function(t){this.panner.setPosition(t)},y.prototype.connect=function(t){this.output.connect(t)},y.prototype.disconnect=function(t){this.output.disconnect(0)},y.prototype.setInstrument=function(t){""!==t&&void 0!==t&&!1!==t||(t=x(this));var e=c(t);!1===e&&(e=c(x(this))),e.track=this,this.instrument&&this.instrument.allNotesOff(),this.instrument=e,this.instrumentId=e.name,this.song&&(this.instrument.song=this.song)},y.prototype.setMidiInput=function(t,e){var i,o,r=this.midiInputs;if(e=void 0===e||e,"all"===t)return o=void 0!==this.song?this.song.midiInputs:n.midiInputs,void s(o,(function(t,i){!0===e?r[i]=t:delete r[i]}));void 0!==(i=this.song.midiInputs[t])&&(e?this.midiInputs[t]=i:delete this.midiInputs[t])},y.prototype.setMidiOutput=function(t,e){e=void 0===e||e;var i=this.song.midiOutputs[t],n=this;void 0!==i&&(!0===e&&this.instrument.allNotesOff(),e?this.midiOutputs[t]=i:delete this.midiOutputs[t],this.routeToMidiOut=!1,s(this.midiOutputs,(function(t,e){!1!==t&&(n.routeToMidiOut=!0)})))},y.prototype.prepareForRecording=function(t,e){"midi"!==this.recordEnabled&&"audio"!==this.recordEnabled||(this.recordPart=n.createPart(),this.addPart(this.recordPart),this.recordingNotes={},this.recordId=t,"audio"===this.recordEnabled&&(void 0===this.audio&&(this.audio=h(this)),this.audio.prepareForRecording(t,e)))},y.prototype.stopRecording=function(t,e){if(this.recordId===t)if(this.recordingNotes={},(this.autoQuantize||this.song.autoQuantize)&&(b>=1&&console.log("performing auto quantize"),this.quantizeRecording()),"midi"===this.recordEnabled)this.recordPart.update(),e(this.recordPart.events);else if("audio"===this.recordEnabled){var i=this;this.audio.stopRecording((function(t){var s=n.createAudioEvent({ticks:i.song.recordTimestampTicks,buffer:t.audioBuffer,sampleId:t.id});i.recordPart.addEvent(s),i.recordPart.update(),e([s])}))}},y.prototype.undoRecording=function(e){var i=t(e);"string"===i?this.recordId===e&&this.removePart(this.recordPart):"array"===i&&this.removeEvents(e)},y.prototype.setWaveformConfig=function(t){this.waveformConfig=t,void 0!==this.audio&&(this.audio.recorder.waveformConfig=t)},y.prototype.getAudioRecordingData=function(t){if(void 0!==this.audio)return void 0===t?(n.debug>=n.WARN&&console.warn("please provide a recording id"),!1):n.storage.audio.recordings[t]},y.prototype.encodeAudioRecording=function(t,e,i,s){if(void 0!==this.audio){if(void 0===t)return n.debug>=n.WARN&&console.warn("please provide a recording id"),void(s&&s(!1));var o=n.storage.audio.recordings[t];l(o.audioBuffer,e,i,(function(t){o.mp3=t,s(o)}))}},y.prototype.setAudioRecordingLatency=function(t,e,i){void 0!==this.audio&&this.audio.setAudioRecordingLatency(t,e,(function(e){var n,s,o,r=this.song.audioEvents;for(n=r.length-1;n>=0;n--)void 0!==(o=(s=r[n]).sampleId)&&t===o&&(s.buffer=e.audioBuffer);void 0!==i&&i()}))},y.prototype.quantizeRecording=function(t){return t=t||this.quantizeValue,n.quantize(this.recordPart.events,t,this.song.ppq)},y.prototype.quantize=function(){var e,i,s,o,r=k.call(arguments),a=r.length;for(e=0;e<a;e++)i=r[e],("string"===(s=t(i))||"number"===s)&&(o=i);return void 0===o&&(o=this.quantizeValue),n.quantize(this.events,o,this.song.ppq,history)},y.prototype.undoQuantize=function(t){if(void 0!==t){var e,i,s=t.tracks[this.id].quantizedEvents,o=s.length;for(e=0;e<o;e++)(i=s[e]).ticks=t.events[i.id].ticks}else n.debug>=2&&console.warn("please pass a quantize history object")},y.prototype.addMidiEventListener=function(){return d(arguments,this)},y.prototype.removeMidiEventListener=function(t){p(t,this)},y.prototype.allNotesOff=function(t){this.audio&&this.audio.allNotesOff(),this.instrument&&this.instrument.allNotesOff()},y.prototype.processMidiEvent=function(t){f(t,this)},n.protectedScope.Track=y,n.createTrack=function(t,e,i){return new y(t,e,i)},n.protectedScope.addInitMethod((function(){var y=n.protectedScope;g=n.getStats,m=n.findEvent,v=n.findNote,n.createPart,r=n.createMidiEvent,n.createMidiNote,c=n.createInstrument,u=n.createPanner,l=n.encodeAudio,a=y.context,i=y.findItem,d=y.addMidiEventListener,p=y.removeMidiEventListener,h=n.protectedScope.createAudioTrack,o=y.checkPosition,s=y.objectForEach,t=y.typeString,e=y.copyName,f=y.handleMidiMessageTrack}))}(),y(),b(),L=!1,R=[],n.protectedScope.callInitMethods(),n.protectedScope.context,B=n.protectedScope.initMidi,n.protectedScope.base64ToBinary,delete n.protectedScope,n.ready=function(){return new Promise(t=>{!0===L?t():R.push(t)})},n.addInstrument({name:"sinewave",folder:"heartbeat",autopan:!1,attack:200,keyrange:[21,108],release_duration:50}),n.addInstrument({name:"metronome",folder:"heartbeat",sample_path:"heartbeat/metronome",keyrange:[60,61],mapping:{60:{n:"lowtick"},61:{n:"hightick"}}}),n.addSamplePack({name:"metronome",folder:"heartbeat",mapping:{hightick:"UklGRkQFAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YSAFAACx/xf/dADOACwBsP3p+6H+zAGoBOkCCwBX/EH5OvxlA4kJ2wcSArT9E/ut+HT2evUx98n6OAF5CCUMwQvfCOsJxAx0DSIMEAq9BiAB3vhz7mLkT9sR133YxN2s5QLv0vrUBnwRnxuQJeEsSDCiMd8yFS8aKFIhohUsCKj64u625OraA9HuyPnElcP+wxvJWtW25637VQ0jHPgnBTDDM1o0CzKLK+8hzhgFDOz8Se4J47DYVtG0z5fQq9LB12rfA+j99roHAhelIyMwIjdTOuU8mjwIOGoxhCb5E53/j+3k3/fTY8pTw4y/Tr+ew8DMvdsk8RcHRRkSKO4yGTkHPkU/rzzyNcgsrR94Dp/5r+Zs17zOncoDxhfE38WLyn/TeOMi9r0IRxlRKIQzyTlOPKo9yjmWMcokDRLc/Y7rudtdzu/D2L1Iu+27JcG3yYrVLujl+3UOZx1UK5Q0qzmNPDk8ZjeeMPojzhH+/jLtPd5m0hHLHsYIw5TEMMnA0jvj8fSOBiwXASZgMzM8dUBGQbI+rzjpKkIZygZT9QflcdaRyqXCz7+VwUPH784r3K7s+v0KDu8bvyeLMb43NjrhOIo0dSvQHi0PnP6i7ovg3NTxy4/Gf8X8yH/QBtvX55P2Ygb0FcUjsy4LNmI5ejiXM38r7iC8FJwHPvok7dDgQdaJzlTKIsoFzsrVkuA87d/6qAi7FQ0h9ClKMLEz3TOrMBcqYSD8E9AFd/dS6kTf6dbU0XnQv9IH2MXfZ+ln9DEAFwwdFy8giib6KawqeChgI/UbHBOTCZj/vvXe7InlFuDN3P3b0d1F4gzpifG2+u4D7Qw1FfwbnCD+IlgjWyHLHPMVog2mBL37qvP+7NvnYuTv4rvjfubN6k3wpPZ0/WkEOwtiEUsWcxm+Gl4aOhhiFDAPIwmbAtn7TPVy77zqcefr5YHmHull7enyfPmcAHgHew1REr8Vhhd/F+AV1RJ0DikJWQNc/ZP3efKd7hvs2ur46rHs5u8e9N/48/0hA/8HFgwuD04RSBIREqsQOg7mCssGMAJW/Xn4G/TK8Lbuzu0I7qTvnPJy9sX6bP84BLYIbAwdD84QYxG7EOcODAxwCFMEAQC9+7P3SvTX8XHw+u9R8KTxIvSo9+X7VQCUBJ0IMwziDj4QLhAGD9UMrgnTBZcBRv1v+Xv2UfS+8tfx+vES87z0+vb3+Zf9ZgEQBSEIUArWC8kM2QyzC5EJEAdvBHgBXP5n++r4Avd89Wj07fMw9D31Jvfp+Uj9xQD9A8QG5QhXClELrAsvC9wJ7gd6BWIC3v6O+7T4PPZN9EHzWvNf9Pz1Fvit+qL9rQCHAwEG/weCCZUKFwvDCnIJcAcQBWcCaf8Z/CD55vaB9dD0wPSP9UL3m/k7/Mz+JwEyAw8FzAY7CBsJaQk5CWkI2gatBCICYf+j/Fr6vfiV9872sfZP91z4p/lR+3H9zf89AroEFAfjCP0Jcwo8CjAJdQdgBSEDkgDQ/Vj7ZfnR95T28fUd9v32Vvg2+nb8+/6xAWoE4AbDCP4JpAqbCqQJ0weEBfgCTACT/R37M/m+9672IPY69gb3afhW+tT8qf+MAj0FggcuCScKXAriCcMIEAfyBJYCFwCP/Rz7A/l793z2F/Zn9mH37fjd+i39yf9pAt0EFAfRCNkJGAqrCZYIvgZPBJ8B6P4//M350vdz9q/1lfUq9mz3RPmi+3H+bgFVBOQG3wgHCkwK0Am7CCAHCgWmAjAA",lowtick:"UklGRlQFAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YTAFAAB0/5v+U/4T/3gA0wFTAuUB+f8d/nT90f1q/ub+tf46/mb/8wFQA9gC7wCd/mr+FAGRA3cE6wJf/h36evmv+8v/NwRHBZUC2/60+//5EvuZ/aX/bgFOAp8Azvzh9wfzLPF68zT4y/2BAygIfQwaEjYY0x31Irwl8SOWHVESOgPh9NfpReFt22nYHddD2BXcZeDa5InqgPDx9nP+6gS4CBYLnw0zES0WXxv4HkcgLh/1G+EX1RNpD4wKigXH/6r5/fNu7lTpj+Zu5hHoXOtL71byr/Qp91L64v6OBO4JoQ5zEskU+hU1FiQVeRP7EWgP4Qr0BIT+tPid9C3y1vCh8FDxJvK28vvyy/LA8pLzU/XP95v6xvw4/uD/RAK2BSkKcg6BEScTZBMeEqkPTQxjCKEEVwFi/nv7h/hp9aDyAvHP8MfxLvM+9PX0uPW19g/4Lfr7/C4AKgNaBXQGywb0BhIHWQfWB1oIzAjtCF8IHwdtBakDVwKLAeYA8v9w/kj81/nQ94v29/XX9bz1bPUY9Uz1Z/aH+Hr7yP4MAi4F+wcfCnYLNgyfDPsMSw0sDUAMfgrcB5IEMwFb/iX8T/pT+O/1X/Mf8cbvrO+18MLyvfVP+Rf9wgAoBCEHpwnIC5EN4Q5AD3wO1Ay0CpsIvwbvBNcCbQAr/nX8Ofsf+vb4mvda9rj1z/WX9pL3a/hH+ZX6R/wn/vP/eQESA/AE+wYDCcwKFAyPDCkMFQuSCe4HVQbSBHQDCwI8ANL9JPuY+HX28vTq82PzdPMV9Az1MfZ49zD5gftx/sQBBQXLB8cJ/gqpCw8MigwWDXENXQ2rDDUL7QgDBswCdv8S/K74WPVk8hXwou4P7mvu1+9T8pz1Uvli/ZoBwgWRCcsMPg/CEEQR4RDADwoO9wusCVMH4ARSApn/ufzd+Wj3bvX78xzzx/L68qzz1vSD9qX4Gfvd/c0AhwO/BWwHmghvCQEKVQonClsJCwiIBh0F0gOgAm0BOwAx/03+XP0g/Lb6cPmX+F/4vfh++TH6s/os+7/7cvwL/Zz9XP5O/3IA3AF9AzsF9gaUCAAKHgueCzcL9wntB3sF4wIzAI396fp1+Gv2IvWn9N30p/Xi9m74G/ru+9P9k/8aAYEC1AMTBSIG0wYuB1gHkgcACGEISAhTBzEFWAKt/5L92fuU+vX50fmf+SP5i/gb+Bf4mviv+Sr7kvyb/Uj+r/4X/8r/+gCiAo0EUAaRBzwISwjqB3IHGQfCBv8FpgTMApQAKf67+5n5/vfn9jz2yPVn9SL1RPXq9SP3Dvmr+6f+sQGKBAcH+whOCh0Laws3C28KLAmDB5AFfQNoAVP/Zv3e+7P6sfnL+Cv4vPeM95b37feV+Jn51Poq/LL9mv+YAVYD3gQuBmcHSAikCIEI7Af+BuEFngQXA1sBv/9v/pf9MP3W/Fj8q/sR+6H6U/o3+mP6y/pN+/f7xvye/WH+Jf9mAD4CQAQJBisHtgf6Bw0I8QdsB1sGywT4AggBCP/o/KX6mPg19572jfaz9uf2S/cM+E35E/tW/af/5wH1A8AFKgfkB/AHgwfxBlAGgQVIBMMCJwGs/43+vP0i/Zr8Lfzl+9H76fvi+9f75fsf/In8BP10/ej9cf4O/7f/dAAcAaUBEgKMAhgDpAMEBCEEDwTfA3IDxQL8ASoBUwCG/87+J/6h/Rr9pPxk/Gb8oPwJ/XH9w/39/UD+qP41/9D/WwDeAGsBAgKdAhEDQQNAA0sDbwOVA5YDVwPOAhgCVAGRAA=="}}),n.addTask({type:"init midi",method:B,params:[]},(function(){R.forEach((function(t){t()})),L=!0,console.timeEnd(D)}),!1),e.a=n},function(t){t.exports=JSON.parse('{"a":"0.0.15"}')},function(t,e,i){(function(e){var n;n=function(){var n,s,o,r,a,c="undefined"==typeof window?e:window,h=Date.now||function(){return(new Date).getTime()},u=h(),d="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return h()-u},p=function(t){setTimeout(t,0)};function l(){this._orig=this,this._ready=!1,this._queue=[],this._log=[]}function f(t,e){this._bad?e instanceof Function&&e.apply(this,[new Error(this._err())]):t instanceof Function&&t.apply(this,[this])}function m(t,e){this._bad?t._crash(this._err()):setTimeout((function(){t._resume()}),e)}function v(t){this._bad&&t._break(this._err()),t._resume()}function g(t,e,i){t[i]=function(){var t=arguments,n=e._image();return this._push(v,[n]),n[i].apply(n,t)}}function y(t){this._bad||(t instanceof Function?t.apply(this):console.log(t))}function b(t){this._bad&&(t instanceof Function?t.apply(this):console.log(t))}function k(t){this._bad?t._crash(this._err()):(this._break("Closed"),t._resume())}function P(t){if(t.length){var e=t.shift();if(t.length){var i=this;this._slip(b,[function(){P.apply(i,[t])}])}try{this._repair(),e.apply(this)}catch(t){this._break(t.toString())}}else this._break()}function w(t,e){for(var i=0;i<t.length;i++)if(t[i]===e)return;t.push(e)}function E(t,e){for(var i=0;i<t.length;i++)if(t[i]===e)return void t.splice(i,1)}function N(){l.apply(this)}function S(t,e,i){if(void 0===e)return S(t,[],[]);if(t instanceof Object){for(var n=0;n<e.length;n++)if(e[n]===t)return i[n];var s;for(var o in s=t instanceof Array?[]:{},e.push(t),i.push(s),t)t.hasOwnProperty(o)&&(s[o]=S(t[o],e,i));return s}return t}l.prototype._exec=function(){for(;this._ready&&this._queue.length;){var t=this._queue.shift();t[0].apply(this,t[1])}},l.prototype._push=function(t,e){this._queue.push([t,e]),l.prototype._exec.apply(this)},l.prototype._slip=function(t,e){this._queue.unshift([t,e])},l.prototype._pause=function(){this._ready=!1},l.prototype._resume=function(){this._ready=!0,l.prototype._exec.apply(this)},l.prototype._break=function(t){this._orig._bad=!0,this._orig._log.push(t||"Unknown JZZ error")},l.prototype._repair=function(){this._orig._bad=!1},l.prototype._crash=function(t){this._break(t),this._resume()},l.prototype._err=function(){return this._log[this._log.length-1]},l.prototype.log=function(){return S(this._log)},l.prototype._image=function(){var t=function(){};t.prototype=this._orig;var e=new t;return e._ready=!1,e._queue=[],e},l.prototype._thenable=function(){var t=this,e=function(){};e.prototype=t;var i=new e;return i.then=function(e,i){return t._push(f,[e,i]),this},i},l.prototype.wait=function(t){if(!t)return this;var e=this._image();return this._push(m,[e,t]),e._thenable()},l.prototype.and=function(t){return this._push(y,[t]),this._thenable()},l.prototype.or=function(t){return this._push(b,[t]),this._thenable()},l.prototype._info={},l.prototype.info=function(){var t=S(this._orig._info);return void 0===t.engine&&(t.engine="none"),void 0===t.sysex&&(t.sysex=!0),t},l.prototype.name=function(){return this.info().name},l.prototype.close=function(){var t=new l;return this._close&&this._push(this._close,[]),this._push(k,[t]),t._thenable()},N.prototype=new l,N.prototype._info={name:"JZZ.js",ver:"0.9.4",version:"0.9.4",inputs:[],outputs:[]};var _,T=[],A=[],I=[],O=[];function M(){var t,e;for(_._info.engine=Z._type,_._info.version=Z._version,_._info.sysex=Z._sysex,_._info.inputs=[],_._info.outputs=[],T=[],A=[],Z._allOuts={},Z._allIns={},t=0;t<Z._outs.length;t++)(e=Z._outs[t]).engine=Z,Z._allOuts[e.name]=e,_._info.outputs.push({id:e.name,name:e.name,manufacturer:e.manufacturer,version:e.version,engine:Z._type}),T.push(e);for(t=0;t<$._outs.length;t++)e=$._outs[t],_._info.outputs.push({id:e.name,name:e.name,manufacturer:e.manufacturer,version:e.version,engine:e.type}),T.push(e);for(t=0;t<Z._ins.length;t++)(e=Z._ins[t]).engine=Z,Z._allIns[e.name]=e,_._info.inputs.push({id:e.name,name:e.name,manufacturer:e.manufacturer,version:e.version,engine:Z._type}),A.push(e);for(t=0;t<$._ins.length;t++)e=$._ins[t],_._info.inputs.push({id:e.name,name:e.name,manufacturer:e.manufacturer,version:e.version,engine:e.type}),A.push(e);if(_._watcher&&_._watcher._handles.length){var i=function(t,e,i,n){if(function(t,e,i,n){var s;if(t.length!=i.length||e.length!=n.length)return!0;for(s=0;s<t.length;s++)if(t[s].name!=i[s].name)return!0;for(s=0;s<e.length;s++)if(e[s].name!=n[s].name)return!0;return!1}(t,e,i,n)){var s,o=[],r=[],a=[],c=[],h={};for(s=0;s<t.length;s++)h[t[s].name]=!0;for(s=0;s<i.length;s++)h[i[s].name]||o.push(i[s]);for(h={},s=0;s<i.length;s++)h[i[s].name]=!0;for(s=0;s<t.length;s++)h[t[s].name]||a.push(t[s]);for(h={},s=0;s<e.length;s++)h[e[s].name]=!0;for(s=0;s<n.length;s++)h[n[s].name]||r.push(n[s]);for(h={},s=0;s<n.length;s++)h[n[s].name]=!0;for(s=0;s<e.length;s++)h[e[s].name]||c.push(e[s]);return{inputs:{added:o,removed:a},outputs:{added:r,removed:c}}}}(O,I,_._info.inputs,_._info.outputs);if(i){for(s=0;s<i.inputs.removed.length;s++)(e=Z._inMap[i.inputs.removed[s].name])&&e._closeAll();for(s=0;s<i.outputs.removed.length;s++)(e=Z._outMap[i.outputs.removed[s].name])&&e._closeAll();K(i)}}O=_._info.inputs,I=_._info.outputs}function x(){this._bad||Z._refresh(this)}function C(t,e){var i,n;t instanceof Function&&(t=t(e)),t instanceof Array||(t=[t]);var s=[],o=[],r=e.slice(),a=s;for(i=0;i<t.length;i++)if(void 0===t[i])a=o;else if(t[i]instanceof RegExp)for(n=0;n<r.length;n++)t[i].test(r[n].name)&&(a.push(r[n]),r.splice(n,1),n--);else for(n=0;n<r.length;n++)(t[i]+""==n+""||t[i]===r[n].name||t[i]instanceof Object&&t[i].name===r[n].name)&&(a.push(r[n]),r.splice(n,1),n--);return a==s?s:s.concat(r).concat(o)}function B(t,e){var i;i=e instanceof RegExp?"Port matching "+e+" not found":e instanceof Object||void 0===e?"Port not found":'Port "'+e+'" not found',t._crash(i)}function L(t,e){if(this._bad)t._crash(this._err());else{var i=C(e,T);if(!i.length)return void B(t,e);for(var n=function(t){return function(){t.engine._openOut(this,t.name)}},s=0;s<i.length;s++)i[s]=n(i[s]);t._slip(P,[i]),t._resume()}}function R(t,e){if(this._bad)t._crash(this._err());else{var i=C(e,A);if(!i.length)return void B(t,e);for(var n=function(t){return function(){t.engine._openIn(this,t.name)}},s=0;s<i.length;s++)i[s]=n(i[s]);t._slip(P,[i]),t._resume()}}function D(t,e){this._bad?t._crash():(t._slip(Q,[e]),t._resume())}function F(){l.apply(this),this._handles=[],this._outs=[]}function j(t){this._bad||this._receive(t)}function z(t){this._emit(t)}function U(t){t instanceof Function?w(this._orig._handles,t):w(this._orig._outs,t)}function q(t){void 0===t?(this._orig._handles=[],this._orig._outs=[]):t instanceof Function?E(this._orig._handles,t):E(this._orig._outs,t)}function V(t,e){this._orig._mpe||(this._orig._mpe=new Gt),this._orig._mpe.setup(t,e)}function W(t){if(t!=parseInt(t)||t<0||t>15)throw RangeError("Bad channel value (must not be less than 0 or more than 15): "+t)}function G(t,e){F.apply(this),this._port=t._orig,this._chan=e,g(this,this._port,"ch"),g(this,this._port,"mpe"),g(this,this._port,"connect"),g(this,this._port,"disconnect"),g(this,this._port,"close")}function H(t,e,i){F.apply(this),this._port=t._orig,this._master=e,this._band=i,g(this,this._port,"ch"),g(this,this._port,"mpe"),g(this,this._port,"connect"),g(this,this._port,"disconnect"),g(this,this._port,"close")}function X(){l.apply(this),this._handles=[],g(this,_,"refresh"),g(this,_,"openMidiOut"),g(this,_,"openMidiIn"),g(this,_,"onChange"),g(this,_,"close")}function Q(t){t instanceof Function&&(this._orig._handles.length||Z._watch(),w(this._orig._handles,t))}function Y(t){void 0===t?this._orig._handles=[]:E(this._orig._handles,t),this._orig._handles.length||Z._unwatch()}function K(t){for(n=0;n<_._watcher._handles.length;n++)_._watcher._handles[n].apply(_,[t])}N.prototype.refresh=function(){return this._push(x,[]),this._thenable()},N.prototype.openMidiOut=function(t){var e=new F;return this._push(x,[]),this._push(L,[e,t]),e._thenable()},N.prototype._openMidiOutNR=function(t){var e=new F;return this._push(L,[e,t]),e._thenable()},N.prototype.openMidiIn=function(t){var e=new F;return this._push(x,[]),this._push(R,[e,t]),e._thenable()},N.prototype._openMidiInNR=function(t){var e=new F;return this._push(R,[e,t]),e._thenable()},N.prototype.onChange=function(t){this._orig._watcher||(this._orig._watcher=new X);var e=this._orig._watcher._image();return this._push(D,[e,t]),e._thenable()},N.prototype._close=function(){Z._close()},F.prototype=new l,F.prototype._filter=function(t){if(this._orig._mpe){var e,i=0;this._handles&&this._handles.length&&(i=this._handles.length,e=this._handles[0]),this._outs&&this._outs.length&&(i=this._outs.length,e=this._outs[0]),1!=i||e._mpe||(t=this._orig._mpe.filter(t))}return t},F.prototype._receive=function(t){this._emit(this._filter(t))},F.prototype.send=function(){return this._push(j,[yt.apply(null,arguments)]),this._thenable()},F.prototype.note=function(t,e,i,n){return this.noteOn(t,e,i),n>0&&this.wait(n).noteOff(t,e),this._thenable()},F.prototype._emit=function(t){var e;for(e=0;e<this._handles.length;e++)this._handles[e].apply(this,[yt(t)._stamp(this)]);for(e=0;e<this._outs.length;e++){var i=yt(t);i._stamped(this._outs[e])||this._outs[e].send(i._stamp(this))}},F.prototype.emit=function(t){return this._push(z,[t]),this._thenable()},F.prototype.connect=function(t){return this._push(U,[t]),this._thenable()},F.prototype.disconnect=function(t){return this._push(q,[t]),this._thenable()},F.prototype.connected=function(){return this._orig._handles.length+this._orig._outs.length},F.prototype.ch=function(t){if(void 0===t)return this;W(t);var e=new G(this,t);return this._push(v,[e]),e._thenable()},F.prototype.mpe=function(t,e){if(void 0===t&&void 0===e)return this;Gt.validate(t,e);var i=e?new H(this,t,e):new G(this,t);return this._push(V,[t,e]),this._push(v,[i]),i._thenable()},G.prototype=new F,G.prototype.channel=function(){return this._chan},G.prototype._receive=function(t){this._port._receive(t)},G.prototype.note=function(t,e,i){return this.noteOn(t,e),i&&this.wait(i).noteOff(t),this._thenable()},H.prototype=new F,H.prototype.channel=function(){return this._master},H.prototype._receive=function(t){this._port._receive(t)},H.prototype.note=function(t,e,i){return this.noteOn(t,e),i&&this.wait(i).noteOff(t),this._thenable()},X.prototype=new l,X.prototype.connect=function(t){return this._push(Q,[t]),this._thenable()},X.prototype.disconnect=function(t){return this._push(Y,[t]),this._thenable()};var J,Z={},$={_outs:[],_ins:[]};function tt(){if(t.exports)return e=i(4),Z._type="node",Z._main=e,Z._pool=[],Z._newPlugin=function(){return new e.MIDI},void ct();var e;this._break()}function et(){var t=document.createElement("div");t.style.visibility="hidden",document.body.appendChild(t);var e=document.createElement("object");e.style.visibility="hidden",e.style.width="0px",e.style.height="0px",e.classid="CLSID:1ACE1618-1C7D-4561-AEE1-34842AA85E90",e.type="audio/x-jazz",document.body.appendChild(e),e.isJazz?function(t){Z._type="plugin",Z._main=t,Z._pool=[t],Z._newPlugin=function(){var e=document.createElement("object");return e.style.visibility="hidden",e.style.width="0px",t.style.height="0px",e.classid="CLSID:1ACE1618-1C7D-4561-AEE1-34842AA85E90",e.type="audio/x-jazz",document.body.appendChild(e),e.isJazz?e:void 0},ct()}(e):this._break()}if("undefined"!=typeof navigator&&navigator.requestMIDIAccess){J=navigator.requestMIDIAccess;try{-1!=J.toString().indexOf("JZZ(")&&(J=void 0)}catch(t){}}function it(){if(J){var t=this;return J({}).then((function(e){ht(e),t._resume()}),(function(e){t._crash(e)})),void this._pause()}this._break()}function nt(){if(J){var t=this;return J({sysex:!0}).then((function(e){ht(e,!0),t._resume()}),(function(e){t._crash(e)})),void this._pause()}this._break()}function st(){var t,e,i=this;this._pause(),document.addEventListener("jazz-midi-msg",(function n(){if(t=!0,e||(e=document.getElementById("jazz-midi-msg")),e){var s=[];try{s=JSON.parse(e.innerText)}catch(t){}e.innerText="",document.removeEventListener("jazz-midi-msg",n),"version"===s[0]?(function(t,e){function i(){for(var t=0;t<this.clients.length;t++)this._close(this.clients[t])}var n;Z._type="extension",Z._version=e,Z._sysex=!0,Z._pool=[],Z._outs=[],Z._ins=[],Z._inArr=[],Z._outArr=[],Z._inMap={},Z._outMap={},Z._outsW=[],Z._insW=[],Z.refreshClients=[],Z._msg=t,Z._newPlugin=function(){var t={id:Z._pool.length};Z._pool.push(t),t.id?document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["new"]})):t.ready=!0},Z._newPlugin(),Z._refresh=function(t){Z.refreshClients.push(t),t._pause(),p((function(){document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["refresh"]}))}))},Z._openOut=function(t,e){var n=Z._outMap[e];if(!n){Z._pool.length<=Z._outArr.length&&Z._newPlugin();var s=Z._pool[Z._outArr.length];(n={name:e,clients:[],info:{name:e,manufacturer:Z._allOuts[e].manufacturer,version:Z._allOuts[e].version,type:"MIDI-out",sysex:Z._sysex,engine:Z._type},_start:function(){document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["openout",s.id,e]}))},_close:function(t){Z._closeOut(t)},_closeAll:i,_receive:function(t){if(t.length){var e=t.slice();e.splice(0,0,"play",s.id),document.dispatchEvent(new CustomEvent("jazz-midi",{detail:e}))}}}).plugin=s,s.output=n,Z._outArr.push(n),Z._outMap[e]=n}t._orig._impl=n,w(n.clients,t._orig),t._info=n.info,t._receive=function(t){n._receive(t)},t._close=function(){n._close(this)},n.open||(t._pause(),n.plugin.ready&&n._start())},Z._openIn=function(t,e){var n=Z._inMap[e];if(!n){Z._pool.length<=Z._inArr.length&&Z._newPlugin();var s=Z._pool[Z._inArr.length];(n={name:e,clients:[],info:{name:e,manufacturer:Z._allIns[e].manufacturer,version:Z._allIns[e].version,type:"MIDI-in",sysex:Z._sysex,engine:Z._type},_start:function(){document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["openin",s.id,e]}))},_close:function(t){Z._closeIn(t)},_closeAll:i}).plugin=s,s.input=n,Z._inArr.push(n),Z._inMap[e]=n}t._orig._impl=n,w(n.clients,t._orig),t._info=n.info,t._close=function(){n._close(this)},n.open||(t._pause(),n.plugin.ready&&n._start())},Z._closeOut=function(t){var e=t._impl;E(e.clients,t._orig),e.clients.length||(e.open=!1,document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["closeout",e.plugin.id]})))},Z._closeIn=function(t){var e=t._impl;E(e.clients,t._orig),e.clients.length||(e.open=!1,document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["closein",e.plugin.id]})))},Z._close=function(){Z._unwatch()},Z._watch=function(){Z._insW=Z._ins,Z._outsW=Z._outs,n=setInterval((function(){document.dispatchEvent(new CustomEvent("jazz-midi",{detail:["refresh"]}))}),250)},Z._unwatch=function(){clearInterval(n),n=void 0},document.addEventListener("jazz-midi-msg",(function(){var t,e,i,n=Z._msg.innerText.split("\n");for(Z._msg.innerText="",e=0;e<n.length;e++){var s=[];try{s=JSON.parse(n[e])}catch(t){}if(s.length)if("refresh"===s[0]){if(s[1].ins){for(i=0;i<s[1].ins.length;i++)s[1].ins[i].type=Z._type;Z._ins=s[1].ins}if(s[1].outs){for(i=0;i<s[1].outs.length;i++)s[1].outs[i].type=Z._type;Z._outs=s[1].outs}for(M(),i=0;i<Z.refreshClients.length;i++)Z.refreshClients[i]._resume();Z.refreshClients=[]}else if("version"===s[0]){var o=Z._pool[s[1]];o&&(o.ready=!0,o.input&&o.input._start(),o.output&&o.output._start())}else if("openout"===s[0]){if(t=Z._pool[s[1]].output)if(s[2]==t.name){if(t.open=!0,t.clients)for(i=0;i<t.clients.length;i++)t.clients[i]._resume()}else if(t.clients)for(i=0;i<t.clients.length;i++)t.clients[i]._crash()}else if("openin"===s[0]){if(t=Z._pool[s[1]].input)if(s[2]==t.name){if(t.open=!0,t.clients)for(i=0;i<t.clients.length;i++)t.clients[i]._resume()}else if(t.clients)for(i=0;i<t.clients.length;i++)t.clients[i]._crash()}else if("midi"===s[0]&&(t=Z._pool[s[1]].input)&&t.clients)for(i=0;i<t.clients.length;i++){var r=yt(s.slice(3));t.clients[i]._emit(r)}}}))}(e,s[2]),i._resume()):i._crash()}}));try{document.dispatchEvent(new Event("jazz-midi"))}catch(t){}p((function(){t||i._crash()}))}function ot(){this._pause();var t=this;p((function(){t._crash()}))}function rt(t){for(var e=[],i=function(t){var e=["node","extension","plugin","webmidi"];if(!t||!t.engine)return e;var i,n,s,o=t.engine instanceof Array?t.engine:[t.engine],r={},a=[],c=[];for(s=0;s<o.length;s++){var h=o[s].toString().toLowerCase();r[h]||(r[h]=!0,"none"===h&&(i=!0),"etc"!==h&&void 0!==h||(n=!0),n?c.push(h):a.push(h),E(e,h))}return(n||a.length||c.length)&&(i=!1),i?[]:a.concat(n?e:c)}(t),n=0;n<i.length;n++)"webmidi"==i[n]?(t&&!0===t.sysex&&e.push(nt),t&&!0===t.sysex&&!0!==t.degrade||e.push(it)):"node"==i[n]?(e.push(tt),e.push(ot)):"extension"==i[n]?e.push(st):"plugin"==i[n]&&e.push(et);return e.push(at),e}function at(){Z._type="none",Z._sysex=!0,Z._outs=[],Z._ins=[],Z._refresh=function(){M()},Z._watch=function(){},Z._unwatch=function(){},Z._close=function(){}}function ct(){var t;function e(){for(var t=0;t<this.clients.length;t++)this._close(this.clients[t])}Z._inArr=[],Z._outArr=[],Z._inMap={},Z._outMap={},Z._outsW=[],Z._insW=[],Z._version=Z._main.version,Z._sysex=!0,Z._refresh=function(){var t,e;for(Z._outs=[],Z._ins=[],t=0;(e=Z._main.MidiOutInfo(t)).length;t++)Z._outs.push({type:Z._type,name:e[0],manufacturer:e[1],version:e[2]});for(t=0;(e=Z._main.MidiInInfo(t)).length;t++)Z._ins.push({type:Z._type,name:e[0],manufacturer:e[1],version:e[2]});M()},Z._openOut=function(t,i){var n=Z._outMap[i];if(!n){Z._pool.length<=Z._outArr.length&&Z._pool.push(Z._newPlugin()),n={name:i,clients:[],info:{name:i,manufacturer:Z._allOuts[i].manufacturer,version:Z._allOuts[i].version,type:"MIDI-out",sysex:Z._sysex,engine:Z._type},_close:function(t){Z._closeOut(t)},_closeAll:e,_receive:function(t){t.length&&this.plugin.MidiOutRaw(t.slice())}};var s=Z._pool[Z._outArr.length];n.plugin=s,Z._outArr.push(n),Z._outMap[i]=n}if(!n.open){var o=n.plugin.MidiOutOpen(i);if(o!==i)return o&&n.plugin.MidiOutClose(),void t._break();n.open=!0}t._orig._impl=n,w(n.clients,t._orig),t._info=n.info,t._receive=function(t){n._receive(t)},t._close=function(){n._close(this)}},Z._openIn=function(t,i){var n,s=Z._inMap[i];if(!s){Z._pool.length<=Z._inArr.length&&Z._pool.push(Z._newPlugin()),(s={name:i,clients:[],info:{name:i,manufacturer:Z._allIns[i].manufacturer,version:Z._allIns[i].version,type:"MIDI-in",sysex:Z._sysex,engine:Z._type},_close:function(t){Z._closeIn(t)},_closeAll:e,handle:function(t,e){for(var i=0;i<this.clients.length;i++){var n=yt(e);this.clients[i]._emit(n)}}}).onmidi=(n=s,function(t,e){n.handle(t,e)});var o=Z._pool[Z._inArr.length];s.plugin=o,Z._inArr.push(s),Z._inMap[i]=s}if(!s.open){var r=s.plugin.MidiInOpen(i,s.onmidi);if(r!==i)return r&&s.plugin.MidiInClose(),void t._break();s.open=!0}t._orig._impl=s,w(s.clients,t._orig),t._info=s.info,t._close=function(){s._close(this)}},Z._closeOut=function(t){var e=t._impl;E(e.clients,t._orig),e.clients.length||(e.open=!1,e.plugin.MidiOutClose())},Z._closeIn=function(t){var e=t._impl;E(e.clients,t._orig),e.clients.length||(e.open=!1,e.plugin.MidiInClose())},Z._close=function(){for(var t=0;t<Z._inArr.length;t++)Z._inArr[t].open&&Z._inArr[t].plugin.MidiInClose();Z._unwatch()},Z._watch=function(){t||(t=setInterval((function(){Z._refresh()}),250))},Z._unwatch=function(){t&&clearInterval(t),t=void 0}}function ht(t,e){var i;function n(){for(var t=0;t<this.clients.length;t++)this._close(this.clients[t])}Z._type="webmidi",Z._version=43,Z._sysex=!!e,Z._access=t,Z._inMap={},Z._outMap={},Z._outsW=[],Z._insW=[],Z._refresh=function(){Z._outs=[],Z._ins=[],Z._access.outputs.forEach((function(t){Z._outs.push({type:Z._type,name:t.name,manufacturer:t.manufacturer,version:t.version})})),Z._access.inputs.forEach((function(t){Z._ins.push({type:Z._type,name:t.name,manufacturer:t.manufacturer,version:t.version})})),M()},Z._openOut=function(t,e){var i,s=Z._outMap[e];s||(s={name:e,clients:[],info:{name:e,manufacturer:Z._allOuts[e].manufacturer,version:Z._allOuts[e].version,type:"MIDI-out",sysex:Z._sysex,engine:Z._type},_close:function(t){Z._closeOut(t)},_closeAll:n,_receive:function(t){s.dev&&t.length&&this.dev.send(t.slice())}}),Z._access.outputs.forEach((function(t){t.name===e&&(i=t)})),i?(s.dev=i,Z._outMap[e]=s,t._orig._impl=s,w(s.clients,t._orig),t._info=s.info,t._receive=function(t){s._receive(t)},t._close=function(){s._close(this)},s.dev.open&&(t._pause(),s.dev.open().then((function(){t._resume()}),(function(){t._crash()})))):t._break()},Z._openIn=function(t,e){var i,s,o=Z._inMap[e];o||(o={name:e,clients:[],info:{name:e,manufacturer:Z._allIns[e].manufacturer,version:Z._allIns[e].version,type:"MIDI-in",sysex:Z._sysex,engine:Z._type},_close:function(t){Z._closeIn(t)},_closeAll:n,handle:function(t){for(var e=0;e<this.clients.length;e++){var i=yt([].slice.call(t.data));this.clients[e]._emit(i)}}}),Z._access.inputs.forEach((function(t){t.name===e&&(i=t)})),i?(o.dev=i,o.dev.onmidimessage=(s=o,function(t){s.handle(t)}),Z._inMap[e]=o,t._orig._impl=o,w(o.clients,t._orig),t._info=o.info,t._close=function(){o._close(this)},o.dev.open&&(t._pause(),o.dev.open().then((function(){t._resume()}),(function(){t._crash()})))):t._break()},Z._closeOut=function(t){var e=t._impl;E(e.clients,t._orig),e.clients.length||(e.dev&&e.dev.close&&e.dev.close(),e.dev=void 0)},Z._closeIn=function(t){var e=t._impl;E(e.clients,t._orig),e.clients.length||(e.dev&&(e.dev.onmidimessage=null,e.dev.close&&e.dev.close()),e.dev=void 0)},Z._close=function(){Z._unwatch()},Z._watch=function(){Z._access.onstatechange=function(){i=!0,p((function(){i&&(Z._refresh(),i=!1)}))}},Z._unwatch=function(){Z._access.onstatechange=void 0}}var ut=function(t){return _||function(t){Ht(),(_=new N)._options=t,_._push(P,[rt(t)]),_.refresh(),_._resume()}(t),_._thenable()};function dt(){var t=this instanceof dt?this:t=new dt;return dt.prototype.reset.apply(t,arguments),t}function pt(){29.97==this.type&&!this.second&&this.frame<2&&this.minute%10&&(this.frame=2)}function lt(t){return[[24,25,29.97,30][t[7]>>1&3],(1&t[7])<<4|t[6],t[5]<<4|t[4],t[3]<<4|t[2],t[1]<<4|t[0]]}function ft(t){var e;switch(!t.backwards&&t.quarter>=4?t.decrFrame():t.backwards&&t.quarter<4&&t.incrFrame(),t.quarter>>1){case 0:e=t.frame;break;case 1:e=t.second;break;case 2:e=t.minute;break;default:e=t.hour}return 1&t.quarter?e>>=4:e&=15,7==t.quarter&&(25==t.type?e|=2:29.97==t.type?e|=4:30==t.type&&(e|=6)),!t.backwards&&t.quarter>=4?t.incrFrame():t.backwards&&t.quarter<4&&t.decrFrame(),e|t.quarter<<4}function mt(t){return 25==t.type?32|t.hour:29.97==t.type?64|t.hour:30==t.type?96|t.hour:t.hour}function vt(t){return t<10?"0"+t:t}function gt(t){for(var e=[],i=0;i<t.length;i++)e[i]=vt(t[i]);return e.join(":")}function yt(t){var e,i=this instanceof yt?this:i=new yt;if(t instanceof yt){for(e in i._from=t._from.slice(),t)t.hasOwnProperty(e)&&"_from"!=e&&(i[e]=t[e]);return i}if(i._from=[],void 0===t)return i;var n=t instanceof Array?t:arguments;for(e=0;e<n.length;e++)a=n[e],1==e&&(i[0]>=128&&i[0]<=175&&(a=yt.noteValue(a)),i[0]>=192&&i[0]<=207&&(a=yt.programValue(a))),(a!=parseInt(a)||a<0||a>255)&&Pt(n[e]),i.push(a);return i}ut.JZZ=ut,ut.info=function(){return N.prototype.info()},ut.Widget=function(t){var e=new F;if(t instanceof Object)for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e._resume(),e},N.prototype.Widget=ut.Widget,dt.prototype.reset=function(t){if(t instanceof dt)return this.setType(t.getType()),this.setHour(t.getHour()),this.setMinute(t.getMinute()),this.setSecond(t.getSecond()),this.setFrame(t.getFrame()),this.setQuarter(t.getQuarter()),this;var e=t instanceof Array?t:arguments;return this.setType(e[0]),this.setHour(e[1]),this.setMinute(e[2]),this.setSecond(e[3]),this.setFrame(e[4]),this.setQuarter(e[5]),this},dt.prototype.isFullFrame=function(){return 0==this.quarter||4==this.quarter},dt.prototype.getType=function(){return this.type},dt.prototype.getHour=function(){return this.hour},dt.prototype.getMinute=function(){return this.minute},dt.prototype.getSecond=function(){return this.second},dt.prototype.getFrame=function(){return this.frame},dt.prototype.getQuarter=function(){return this.quarter},dt.prototype.setType=function(t){if(void 0===t||24==t)this.type=24;else if(25==t)this.type=25;else if(29.97==t)this.type=29.97,pt.apply(this);else{if(30!=t)throw RangeError("Bad SMPTE frame rate: "+t);this.type=30}return this.frame>=this.type&&(this.frame=this.type-1),this},dt.prototype.setHour=function(t){if(void 0===t&&(t=0),t!=parseInt(t)||t<0||t>=24)throw RangeError("Bad SMPTE hours value: "+t);return this.hour=t,this},dt.prototype.setMinute=function(t){if(void 0===t&&(t=0),t!=parseInt(t)||t<0||t>=60)throw RangeError("Bad SMPTE minutes value: "+t);return this.minute=t,pt.apply(this),this},dt.prototype.setSecond=function(t){if(void 0===t&&(t=0),t!=parseInt(t)||t<0||t>=60)throw RangeError("Bad SMPTE seconds value: "+t);return this.second=t,pt.apply(this),this},dt.prototype.setFrame=function(t){if(void 0===t&&(t=0),t!=parseInt(t)||t<0||t>=this.type)throw RangeError("Bad SMPTE frame number: "+t);return this.frame=t,pt.apply(this),this},dt.prototype.setQuarter=function(t){if(void 0===t&&(t=0),t!=parseInt(t)||t<0||t>=8)throw RangeError("Bad SMPTE quarter frame: "+t);return this.quarter=t,this},dt.prototype.incrFrame=function(){return this.frame++,this.frame>=this.type&&(this.frame=0,this.second++,this.second>=60&&(this.second=0,this.minute++,this.minute>=60&&(this.minute=0,this.hour=this.hour>=23?0:this.hour+1))),pt.apply(this),this},dt.prototype.decrFrame=function(){return!this.second&&2==this.frame&&29.97==this.type&&this.minute%10&&(this.frame=0),this.frame--,this.frame<0&&(this.frame=29.97==this.type?29:this.type-1,this.second--,this.second<0&&(this.second=59,this.minute--,this.minute<0&&(this.minute=59,this.hour=this.hour?this.hour-1:23))),this},dt.prototype.incrQF=function(){return this.backwards=!1,this.quarter=this.quarter+1&7,0!=this.quarter&&4!=this.quarter||this.incrFrame(),this},dt.prototype.decrQF=function(){return this.backwards=!0,this.quarter=this.quarter+7&7,3!=this.quarter&&7!=this.quarter||this.decrFrame(),this},dt.prototype.read=function(t){if(t instanceof yt||(t=yt.apply(null,arguments)),240==t[0]&&127==t[1]&&1==t[3]&&1==t[4]&&247==t[9])return this.type=[24,25,29.97,30][t[5]>>5&3],this.hour=31&t[5],this.minute=t[6],this.second=t[7],this.frame=t[8],this.quarter=0,this._=void 0,this._b=void 0,this._f=void 0,!0;if(241==t[0]&&void 0!==t[1]){var e=t[1]>>4,i=15&t[1];return 0==e?7==this._&&(7==this._f&&(this.reset(lt(this._a)),this.incrFrame()),this.incrFrame()):3==e?4==this._&&this.decrFrame():4==e?3==this._&&this.incrFrame():7==e&&0===this._&&(0===this._b&&(this.reset(lt(this._a)),this.decrFrame()),this.decrFrame()),this._a||(this._a=[]),this._a[e]=i,this._f=this._f===e-1||0==e?e:void 0,this._b=this._b===e+1||7==e?e:void 0,this._=e,this.quarter=e,!0}return!1},dt.prototype.toString=function(){return gt([this.hour,this.minute,this.second,this.frame])},ut.SMPTE=dt,yt.prototype=[],yt.prototype.constructor=yt;var bt={};yt.noteValue=function(t){return void 0===t?void 0:bt[t.toString().toLowerCase()]},yt.programValue=function(t){return t},yt.freq=function(t,e){return void 0===e&&(e=440),e*Math.pow(2,(Et(yt.noteValue(t),t)-69)/12)};var kt={c:0,d:2,e:4,f:5,g:7,a:9,b:11,h:11};for(o in kt)if(kt.hasOwnProperty(o))for(a=0;a<12&&!((r=kt[o]+12*a)>127);a++)bt[o+a]=r,r>0&&(bt[o+"b"+a]=r-1,bt[o+"bb"+a]=r-2),r<127&&(bt[o+"#"+a]=r+1,bt[o+"##"+a]=r+2);for(a=0;a<128;a++)bt[a]=a;function Pt(t){throw RangeError("Bad MIDI value: "+t)}function wt(t){return W(t),parseInt(t)}function Et(t,e){return(t!=parseInt(t)||t<0||t>127)&&Pt(void 0===e?t:e),parseInt(t)}function Nt(t,e){return(t!=parseInt(t)||t<0||t>255)&&Pt(void 0===e?t:e),parseInt(t)}function St(t){return(t!=parseInt(t)||t<0||t>16383)&&Pt(t),127&parseInt(t)}function _t(t){return(t!=parseInt(t)||t<0||t>16383)&&Pt(t),parseInt(t)>>7}var Tt={noteOff:function(t,e,i){return void 0===i&&(i=64),[128+wt(t),Et(yt.noteValue(e),e),Et(i)]},noteOn:function(t,e,i){return void 0===i&&(i=127),[144+wt(t),Et(yt.noteValue(e),e),Et(i)]},aftertouch:function(t,e,i){return[160+wt(t),Et(yt.noteValue(e),e),Et(i)]},control:function(t,e,i){return[176+wt(t),Et(e),Et(i)]},program:function(t,e){return[192+wt(t),Et(yt.programValue(e),e)]},pressure:function(t,e){return[208+wt(t),Et(e)]},pitchBend:function(t,e){return[224+wt(t),St(e),_t(e)]},bankMSB:function(t,e){return[176+wt(t),0,Et(e)]},bankLSB:function(t,e){return[176+wt(t),32,Et(e)]},modMSB:function(t,e){return[176+wt(t),1,Et(e)]},modLSB:function(t,e){return[176+wt(t),33,Et(e)]},breathMSB:function(t,e){return[176+wt(t),2,Et(e)]},breathLSB:function(t,e){return[176+wt(t),34,Et(e)]},footMSB:function(t,e){return[176+wt(t),4,Et(e)]},footLSB:function(t,e){return[176+wt(t),36,Et(e)]},portamentoMSB:function(t,e){return[176+wt(t),5,Et(e)]},portamentoLSB:function(t,e){return[176+wt(t),37,Et(e)]},volumeMSB:function(t,e){return[176+wt(t),7,Et(e)]},volumeLSB:function(t,e){return[176+wt(t),39,Et(e)]},balanceMSB:function(t,e){return[176+wt(t),8,Et(e)]},balanceLSB:function(t,e){return[176+wt(t),40,Et(e)]},panMSB:function(t,e){return[176+wt(t),10,Et(e)]},panLSB:function(t,e){return[176+wt(t),42,Et(e)]},expressionMSB:function(t,e){return[176+wt(t),11,Et(e)]},expressionLSB:function(t,e){return[176+wt(t),43,Et(e)]},damper:function(t,e){return[176+wt(t),64,e?127:0]},portamento:function(t,e){return[176+wt(t),65,e?127:0]},sostenuto:function(t,e){return[176+wt(t),66,e?127:0]},soft:function(t,e){return[176+wt(t),67,e?127:0]},allSoundOff:function(t){return[176+wt(t),120,0]},allNotesOff:function(t){return[176+wt(t),123,0]}},At={mtc:function(t){return[241,ft(t)]},songPosition:function(t){return[242,St(t),_t(t)]},songSelect:function(t){return[243,Et(t)]},tune:function(){return[246]},clock:function(){return[248]},start:function(){return[250]},continue:function(){return[251]},stop:function(){return[252]},active:function(){return[254]},sxIdRequest:function(){return[240,126,127,6,1,247]},sxFullFrame:function(t){return[240,127,127,1,1,mt(t),t.getMinute(),t.getSecond(),t.getFrame(),247]},reset:function(){return[255]}};function It(t,e){var i=new yt;return i.ff=Nt(t),i.dd=void 0===e?"":function(t){t=""+t;for(var e=0;e<t.length;e++)t.charCodeAt(e)>255&&Pt(t[e]);return t}(e),i}var Ot={smf:function(t){if(t instanceof yt)return new yt(t);var e=t instanceof Array?t:arguments,i=Nt(e[0]),n="";return 2==e.length?n=zt(e[1]):e.length>2&&(n=zt(Array.prototype.slice.call(e,1))),It(i,n)},smfSeqNumber:function(t){if(t==parseInt(t)){if(t<0||t>65535)throw RangeError("Sequence number out of range: "+t);t=String.fromCharCode(t>>8)+String.fromCharCode(255&t)}else if(0==(t=""+t).length)t="\0\0";else if(1==t.length)t="\0"+t;else if(t.length>2)throw RangeError("Sequence number out of range: "+Wt(t));return It(0,t)},smfText:function(t){return It(1,ut.lib.toUTF8(t))},smfCopyright:function(t){return It(2,ut.lib.toUTF8(t))},smfSeqName:function(t){return It(3,ut.lib.toUTF8(t))},smfInstrName:function(t){return It(4,ut.lib.toUTF8(t))},smfLyric:function(t){return It(5,ut.lib.toUTF8(t))},smfMarker:function(t){return It(6,ut.lib.toUTF8(t))},smfCuePoint:function(t){return It(7,ut.lib.toUTF8(t))},smfProgName:function(t){return It(8,ut.lib.toUTF8(t))},smfDevName:function(t){return It(9,ut.lib.toUTF8(t))},smfChannelPrefix:function(t){if(t==parseInt(t))W(t),t=String.fromCharCode(t);else if(0==(t=""+t).length)t="\0";else if(t.length>1||t.charCodeAt(0)>15)throw RangeError("Channel number out of range: "+Wt(t));return It(32,t)},smfMidiPort:function(t){if(t==parseInt(t)){if(t<0||t>127)throw RangeError("Port number out of range: "+t);t=String.fromCharCode(t)}else if(0==(t=""+t).length)t="\0";else if(t.length>1||t.charCodeAt(0)>127)throw RangeError("Port number out of range: "+Wt(t));return It(33,t)},smfEndOfTrack:function(t){if(""!=zt(t))throw RangeError("Unexpected data: "+Wt(zt(t)));return It(47)},smfTempo:function(t){if(3==(""+t).length)return It(81,t);if(t==parseInt(t)&&t>0&&t<=16777215)return It(81,String.fromCharCode(t>>16)+String.fromCharCode(t>>8&255)+String.fromCharCode(255&t));throw RangeError("Out of range: "+Wt(zt(t)))},smfBPM:function(t){return Ot.smfTempo(Math.round(6e7/t))},smfSMPTE:function(t){if(t instanceof dt)return It(84,String.fromCharCode(t.hour)+String.fromCharCode(t.minute)+String.fromCharCode(t.second)+String.fromCharCode(t.frame)+String.fromCharCode(t.quarter%4*25));var e=""+t;if(5==e.length)return It(84,t);var i=t instanceof Array?t:Array.prototype.slice.call(arguments);return i.splice(0,0,30),Ot.smfSMPTE(new dt(i))},smfTimeSignature:function(t,e,i,n){var s,o,r,a,c=(""+t).match(/^\s*(\d+)\s*\/\s*(\d+)\s*$/);if(c){if(s=parseInt(c[1]),o=parseInt(c[2]),s>0&&s<=255&&o&&!(o&o-1)){for(r=o,o=0,r>>=1;r;r>>=1)o++;return r=e==parseInt(e)?e:24,a=i==parseInt(i)?i:8,It(88,String.fromCharCode(s)+String.fromCharCode(o)+String.fromCharCode(r)+String.fromCharCode(a))}if(4==(""+t).length)return It(88,t)}else{if(t==parseInt(t)&&e==parseInt(e)&&e&&!(e&e-1)){for(s=t,o=0,r=e,r>>=1;r;r>>=1)o++;return r=i==parseInt(i)?i:24,a=n==parseInt(n)?n:8,It(88,String.fromCharCode(s)+String.fromCharCode(o)+String.fromCharCode(r)+String.fromCharCode(a))}if(4==(""+t).length)return It(88,t)}throw RangeError("Wrong time signature: "+Wt(zt(t)))},smfKeySignature:function(t){var e=(t=""+t).match(/^\s*([A-H][b#]?)\s*(|maj|major|dur|m|min|minor|moll)\s*$/i);if(e){var i={CB:0,GB:1,DB:2,AB:3,EB:4,BB:5,F:6,C:7,G:8,D:9,A:10,E:11,B:12,H:12,"F#":13,"C#":14,"G#":15,"D#":16,"A#":17}[e[1].toUpperCase()],n={"":0,MAJ:0,MAJOR:0,DUR:0,M:1,MIN:1,MINOR:1,MOLL:1}[e[2].toUpperCase()];void 0!==i&&void 0!==n&&(n&&(i-=3),(i-=7)>=-7&&i<0?t=String.fromCharCode(256+i)+String.fromCharCode(n):i>=0&&i<=7&&(t=String.fromCharCode(i)+String.fromCharCode(n)))}if(2==t.length&&t.charCodeAt(1)<=1&&(t.charCodeAt(0)<=7||t.charCodeAt(0)<=255&&t.charCodeAt(0)>=249))return It(89,t);throw RangeError("Incorrect key signature: "+Wt(t))},smfSequencer:function(t){return It(127,zt(t))}};function Mt(t,e,i){t.prototype[e]=function(){return this.send(i.apply(0,arguments)),this}}function xt(t,e,i){t.prototype[e]=function(){return this.send(i.apply(0,[this._chan].concat(Array.prototype.slice.call(arguments)))),this}}function Ct(t,e){yt[t]=function(){return new yt(e.apply(0,arguments))}}function Bt(t,e){yt[t]=function(){return e.apply(0,arguments)}}function Lt(t,e){Ct(t,e),H.prototype[t]=function(){var t,i=Array.prototype.slice.call(arguments);i.length<e.length?i=[this._master].concat(i):(t=Et(yt.noteValue(i[0],i[0])),i[0]=this._master);var n=e.apply(0,i);return n.mpe=t,this.send(n),this}}for(o in At)At.hasOwnProperty(o)&&Ct(o,At[o]);for(o in Ot)Ot.hasOwnProperty(o)&&Bt(o,Ot[o]);for(o in Tt)Tt.hasOwnProperty(o)&&Lt(o,Tt[o]);function Rt(t,e){for(o in At)At.hasOwnProperty(o)&&Mt(t,o,At[o]);for(o in Ot)Ot.hasOwnProperty(o)&&Mt(t,o,Ot[o]);for(o in Tt)Tt.hasOwnProperty(o)&&Mt(t,o,Tt[o]);if(e)for(o in Tt)Tt.hasOwnProperty(o)&&xt(e,o,Tt[o])}Rt(F,G),H.prototype.noteOn=function(t,e){var i=yt.noteOn(this._master,t,e);return i._mpe=i[1],this.send(i),this},H.prototype.noteOff=function(t,e){var i=yt.noteOff(this._master,t,e);return i._mpe=i[1],this.send(i),this},H.prototype.aftertouch=function(t,e){var i=yt.aftertouch(this._master,t,e);return i._mpe=i[1],this.send(i),this};var Dt,Ft={a:10,b:11,c:12,d:13,e:14,f:15,A:10,B:11,C:12,D:13,E:14,F:15};for(o=0;o<16;o++)Ft[o]=o;function jt(t){for(var e=[],i=0;i<t.length;i++)e[i]=t.charCodeAt(i);return e}function zt(t){return t instanceof Array?function(t){for(var e="",i=0;i<t.length;i++)e+=String.fromCharCode(t[i]);return e}(t):void 0===t?"":""+t}function Ut(t){return(t<16?"0":"")+t.toString(16)}function qt(t){for(var e=[],i=0;i<t.length;i++)e[i]=Ut(t[i]);return e.join(" ")}function Vt(t){return t.length?": "+qt(jt(t)):""}function Wt(t){return t.length?": "+function(t){for(var e="",i=0;i<t.length;i++)"\n"==t[i]?e+="\\n":"\r"==t[i]?e+="\\r":"\t"==t[i]?e+="\\t":t.charCodeAt(i)<32?e+="\\x"+Ut(t.charCodeAt(i)):e+=t[i];return e}(ut.lib.fromUTF8(t)):""}function Gt(){var t=this instanceof Gt?this:t=new Gt;return t.reset(),arguments.length&&Gt.prototype.setup.apply(t,arguments),t}function Ht(){if(!Dt&&"undefined"!=typeof window){var t=window.AudioContext||window.webkitAudioContext;if(t){(Dt=new t)&&!Dt.createGain&&(Dt.createGain=Dt.createGainNode);var e=function(){if("running"!=Dt.state){Dt.resume();var t=Dt.createOscillator(),i=Dt.createGain();try{i.gain.value=0}catch(t){}i.gain.setTargetAtTime(0,Dt.currentTime,.01),t.connect(i),i.connect(Dt.destination),t.start||(t.start=t.noteOn),t.stop||(t.stop=t.noteOff),t.start(.1),t.stop(.11)}else document.removeEventListener("touchend",e),document.removeEventListener("mousedown",e),document.removeEventListener("keydown",e)};document.addEventListener("touchend",e),document.addEventListener("mousedown",e),document.addEventListener("keydown",e),e()}}}yt.prototype.getChannel=function(){if(32==this.ff&&1==this.dd.length&&this.dd.charCodeAt(0)<16)return this.dd.charCodeAt(0);var t=this[0];return void 0===t||t<128||t>239?void 0:15&t},yt.prototype.setChannel=function(t){if(void 0===(t=Ft[t]))return this;if(32==this.ff)this.dd=String.fromCharCode(t);else{var e=this[0];void 0!==e&&e>=128&&e<=239&&(this[0]=240&e|t)}return this},yt.prototype.getNote=function(){var t=this[0];if(!(void 0===t||t<128||t>175))return this[1]},yt.prototype.setNote=function(t){var e=this[0];return void 0===e||e<128||e>175?this:(void 0!==(t=yt.noteValue(t))&&(this[1]=t),this)},yt.prototype.getVelocity=function(){var t=this[0];if(!(void 0===t||t<128||t>159))return this[2]},yt.prototype.setVelocity=function(t){var e=this[0];return void 0===e||e<128||e>159?this:((t=parseInt(t))>=0&&t<128&&(this[2]=t),this)},yt.prototype.getSysExChannel=function(){if(240==this[0])return this[2]},yt.prototype.setSysExChannel=function(t){return 240==this[0]&&this.length>2&&(t=parseInt(t))>=0&&t<128&&(this[2]=t),this},yt.prototype.getData=function(){if(void 0!==this.dd)return this.dd.toString()},yt.prototype.setData=function(t){return this.dd=zt(t),this},yt.prototype.getText=function(){if(void 0!==this.dd)return ut.lib.fromUTF8(this.dd)},yt.prototype.setText=function(t){return this.dd=ut.lib.toUTF8(t),this},yt.prototype.getTempo=function(){if(81==this.ff&&void 0!==this.dd)return 65536*this.dd.charCodeAt(0)+256*this.dd.charCodeAt(1)+this.dd.charCodeAt(2)},yt.prototype.getBPM=function(){var t=this.getTempo();if(t)return 6e7/t},yt.prototype.getTimeSignature=function(){if(88==this.ff&&void 0!==this.dd)return[this.dd.charCodeAt(0),1<<this.dd.charCodeAt(1)]},yt.prototype.getKeySignature=function(){if(89==this.ff&&void 0!==this.dd){var t=this.dd.charCodeAt(0),e=this.dd.charCodeAt(1);if(128&t&&(t-=256),t>=-7&&t<=7&&e>=0&&e<=1)return[t,["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#","G#","D#","A#"][e?t+10:t+7],!!e]}},yt.prototype.isNoteOn=function(){var t=this[0];return!(void 0===t||t<144||t>159)&&this[2]>0},yt.prototype.isNoteOff=function(){var t=this[0];return!(void 0===t||t<128||t>159)&&(t<144||0==this[2])},yt.prototype.isSysEx=function(){return 240==this[0]},yt.prototype.isFullSysEx=function(){return 240==this[0]&&247==this[this.length-1]},yt.prototype.isSMF=function(){return this.ff>=0&&this.ff<=127},yt.prototype.isEOT=function(){return 47==this.ff},yt.prototype.isTempo=function(){return 81==this.ff},yt.prototype.isTimeSignature=function(){return 88==this.ff},yt.prototype.isKeySignature=function(){return 89==this.ff},yt.prototype.toString=function(){var t,e;if(!this.length){if(void 0!==this.ff){if(t="ff"+Ut(this.ff)+" -- ",0==this.ff)t+="Sequence Number: "+function(t){for(var e=0,i=0;i<t.length;i++)e=(e<<8)+t.charCodeAt(i);return e}(this.dd);else if(this.ff>0&&this.ff<10)t+=["","Text","Copyright","Sequence Name","Instrument Name","Lyric","Marker","Cue Point","Program Name","Device Name"][this.ff]+Wt(this.dd);else if(32==this.ff)t+="Channel Prefix"+Vt(this.dd);else if(33==this.ff)t+="MIDI Port"+Vt(this.dd);else if(47==this.ff)t+="End of Track"+Vt(this.dd);else if(81==this.ff)t+="Tempo: "+Math.round(100*this.getBPM())/100+" bpm";else if(84==this.ff)t+="SMPTE Offset: "+gt(jt(this.dd));else if(88==this.ff){var i=1<<this.dd.charCodeAt(1);t+="Time Signature: "+this.dd.charCodeAt(0)+"/"+i,t+=" "+this.dd.charCodeAt(2)+" "+this.dd.charCodeAt(3)}else if(89==this.ff){t+="Key Signature: ";var n=this.getKeySignature();n?(t+=n[1],n[2]&&(t+=" min")):t+="invalid"}else 127==this.ff?t+="Sequencer Specific"+Vt(this.dd):t+="SMF"+Vt(this.dd);return t}return"empty"}if(t=qt(this),this[0]<128)return t;if(e={241:"MIDI Time Code",242:"Song Position",243:"Song Select",244:"Undefined",245:"Undefined",246:"Tune request",248:"Timing clock",249:"Undefined",250:"Start",251:"Continue",252:"Stop",253:"Undefined",254:"Active Sensing",255:"Reset"}[this[0]])return t+" -- "+e;var s=this[0]>>4;return(e={8:"Note Off",10:"Aftertouch",12:"Program Change",13:"Channel Aftertouch",14:"Pitch Wheel"}[s])?t+" -- "+e:9==s?t+" -- "+(this[2]?"Note On":"Note Off"):11!=s?t:((e={0:"Bank Select MSB",1:"Modulation Wheel MSB",2:"Breath Controller MSB",4:"Foot Controller MSB",5:"Portamento Time MSB",6:"Data Entry MSB",7:"Channel Volume MSB",8:"Balance MSB",10:"Pan MSB",11:"Expression Controller MSB",12:"Effect Control 1 MSB",13:"Effect Control 2 MSB",16:"General Purpose Controller 1 MSB",17:"General Purpose Controller 2 MSB",18:"General Purpose Controller 3 MSB",19:"General Purpose Controller 4 MSB",32:"Bank Select LSB",33:"Modulation Wheel LSB",34:"Breath Controller LSB",36:"Foot Controller LSB",37:"Portamento Time LSB",38:"Data Entry LSB",39:"Channel Volume LSB",40:"Balance LSB",42:"Pan LSB",43:"Expression Controller LSB",44:"Effect control 1 LSB",45:"Effect control 2 LSB",48:"General Purpose Controller 1 LSB",49:"General Purpose Controller 2 LSB",50:"General Purpose Controller 3 LSB",51:"General Purpose Controller 4 LSB",64:"Damper Pedal On/Off",65:"Portamento On/Off",66:"Sostenuto On/Off",67:"Soft Pedal On/Off",68:"Legato Footswitch",69:"Hold 2",70:"Sound Controller 1",71:"Sound Controller 2",72:"Sound Controller 3",73:"Sound Controller 4",74:"Sound Controller 5",75:"Sound Controller 6",76:"Sound Controller 7",77:"Sound Controller 8",78:"Sound Controller 9",79:"Sound Controller 10",80:"General Purpose Controller 5",81:"General Purpose Controller 6",82:"General Purpose Controller 7",83:"General Purpose Controller 8",84:"Portamento Control",88:"High Resolution Velocity Prefix",91:"Effects 1 Depth",92:"Effects 2 Depth",93:"Effects 3 Depth",94:"Effects 4 Depth",95:"Effects 5 Depth",96:"Data Increment",97:"Data Decrement",98:"Non-Registered Parameter Number LSB",99:"Non-Registered Parameter Number MSB",100:"Registered Parameter Number LSB",101:"Registered Parameter Number MSB",120:"All Sound Off",121:"Reset All Controllers",122:"Local Control On/Off",123:"All Notes Off",124:"Omni Mode Off",125:"Omni Mode On",126:"Mono Mode On",127:"Poly Mode On"}[this[1]])||(e="Undefined"),t+" -- "+e)},yt.prototype._stamp=function(t){return this._from.push(t._orig?t._orig:t),this},yt.prototype._unstamp=function(t){if(void 0===t)this._from=[];else{t._orig&&(t=t._orig);var e=this._from.indexOf(t);e>-1&&this._from.splice(e,1)}return this},yt.prototype._stamped=function(t){t._orig&&(t=t._orig);for(var e=0;e<this._from.length;e++)if(this._from[e]==t)return!0;return!1},ut.MIDI=yt,Gt.validate=function(t){var e=t instanceof Array?t:arguments;if(e[0]!=parseInt(e[0])||e[0]<0||e[0]>14)throw RangeError("Bad master channel value: "+e[0]);if(e[1]!=parseInt(e[1])||e[1]<0||e[0]+e[1]>15)throw RangeError("Bad zone size value: "+e[1])},Gt.prototype.reset=function(){for(var t=0;t<16;t++)this[t]={band:0,master:t}},Gt.prototype.setup=function(t,e){var i;Gt.validate(t,e);var n=t+e;if((this[t].master!=t||this[t].band!=e)&&(e||this[t].band)){for(this[t].band?n<(i=t+this[t].band)&&(n=i):this[t].master==t-1?(i=t-1,n<(i+=this[i].band)&&(n=i),this[t-1]={band:0,master:t-1}):this[t].master!=t&&(i=this[t].master,n<(i+=this[i].band)&&(n=i),this[this[t].master].band=t-this[t].master-1),this[t].master=t,this[t].band=e,i=t+1;i<=t+e;i++)this[i].band&&n<i+this[i].band&&(n=i+this[i].band),this[i]={band:0,master:t};for(;i<=n;i++)this[i]={band:0,master:i}}},Gt.prototype.filter=function(t){var e=t.getChannel();if(!this[e]||!this[this[e].master].band)return t;var i,n,s,o=this[e].master,r=this[o].band;if(void 0!==t._mpe){for(s=256,i=o+1;i<=o+r;i++)if(this[i].notes){for(s>this[i].notes.length&&(e=i,s=this[i].notes.length),n=0;n<this[i].notes.length;n++)if(this[i].notes[n]==t._mpe){e=i,s=-1;break}}else s>0&&(e=i,s=0);t.setChannel(e),t._mpe=void 0}return e==o?t:(t.isNoteOn()?(this[e].notes||(this[e].notes=[]),w(this[e].notes,t.getNote())):t.isNoteOff()&&this[e].notes&&E(this[e].notes,t.getNote()),t)},ut.MPE=Gt,ut.lib={},ut.lib.now=d,ut.lib.schedule=p,ut.lib.openMidiOut=function(t,e){var i=new F;return e._openOut(i),i._info=e._info(t),i},ut.lib.openMidiIn=function(t,e){var i=new F;return e._openIn(i),i._info=e._info(t),i},ut.lib.registerMidiOut=function(t,e){for(var i=e._info(t),n=0;n<$._outs.length;n++)if($._outs[n].name==i.name)return!1;return i.engine=e,$._outs.push(i),_&&(M(),_._bad&&(_._repair(),_._resume())),!0},ut.lib.registerMidiIn=function(t,e){for(var i=e._info(t),n=0;n<$._ins.length;n++)if($._ins[n].name==i.name)return!1;return i.engine=e,$._ins.push(i),_&&(M(),_._bad&&(_._repair(),_._resume())),!0},ut.lib.copyMidiHelpers=Rt,ut.lib.getAudioContext=function(){return Ht(),Dt};var Xt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";ut.lib.fromBase64=function(t){var e,i,n,s,o,r,a="",c=0;for(t=t.replace(/[^A-Za-z0-9+/=]/g,"");c<t.length;)e=Xt.indexOf(t.charAt(c++))<<2|(s=Xt.indexOf(t.charAt(c++)))>>4,i=(15&s)<<4|(o=Xt.indexOf(t.charAt(c++)))>>2,n=(3&o)<<6|(r=Xt.indexOf(t.charAt(c++))),a+=String.fromCharCode(e),64!=o&&(a+=String.fromCharCode(i)),64!=r&&(a+=String.fromCharCode(n));return a},ut.lib.toBase64=function(t){var e,i,n,s,o,r=0,a=0,c="",h=[];if(!t)return t;do{e=(o=t.charCodeAt(r++)<<16|t.charCodeAt(r++)<<8|t.charCodeAt(r++))>>18&63,i=o>>12&63,n=o>>6&63,s=63&o,h[a++]=Xt.charAt(e)+Xt.charAt(i)+Xt.charAt(n)+Xt.charAt(s)}while(r<t.length);c=h.join("");var u=t.length%3;return u?c.slice(0,u-3)+"===".slice(u):c},ut.lib.fromUTF8=function(t){t=void 0===t?"":""+t;var e,i,n,s="";for(e=0;e<t.length;e++){if((i=t.charCodeAt(e))>255)return t;if(i<128)s+=t[e];else if(192==(224&i)){if(i=(31&i)<<6,++e>=t.length)return t;if(128!=(192&(n=t.charCodeAt(e))))return t;i+=63&n,s+=String.fromCharCode(i)}else if(224==(240&i)){if(i=(15&i)<<12,++e>=t.length)return t;if(128!=(192&(n=t.charCodeAt(e))))return t;if(i+=(63&n)<<6,++e>=t.length)return t;if(128!=(192&(n=t.charCodeAt(e))))return t;i+=63&n,s+=String.fromCharCode(i)}else if(240==(248&i)){if(i=(7&i)<<18,++e>=t.length)return t;if(128!=(192&(n=t.charCodeAt(e))))return t;if(i+=(63&n)<<12,++e>=t.length)return t;if(128!=(192&(n=t.charCodeAt(e))))return t;if(i+=(63&n)<<6,++e>=t.length)return t;if(128!=(192&(n=t.charCodeAt(e))))return t;if((i+=63&n)>1114111)return t;i-=65536,s+=String.fromCharCode(55296+(i>>10)),s+=String.fromCharCode(56320+(1023&i))}}return s},ut.lib.toUTF8=function(t){t=void 0===t?"":""+t;var e,i,n="";for(e=0;e<t.length;e++)(i=t.charCodeAt(e))<128?n+=t[e]:i<2048?(n+=String.fromCharCode(192+(i>>6)),n+=String.fromCharCode(128+(63&i))):i<65536?(n+=String.fromCharCode(224+(i>>12)),n+=String.fromCharCode(128+(i>>6&63)),n+=String.fromCharCode(128+(63&i))):(n+=String.fromCharCode(240+(i>>18)),n+=String.fromCharCode(128+(i>>12&63)),n+=String.fromCharCode(128+(i>>6&63)),n+=String.fromCharCode(128+(63&i)));return n};var Qt=[],Yt={},Kt={},Jt=c.Promise;function Zt(t,e,i){this.name=t,this.message=e,this.code=i}function $t(t,e){this.bubbles=!1,this.cancelBubble=!1,this.cancelable=!1,this.currentTarget=e,this.defaultPrevented=!1,this.eventPhase=0,this.path=[],this.port=t,this.returnValue=!0,this.srcElement=e,this.target=e,this.timeStamp=d(),this.type="statechange"}function te(t,e){this.bubbles=!1,this.cancelBubble=!1,this.cancelable=!1,this.currentTarget=t,this.data=e,this.defaultPrevented=!1,this.eventPhase=0,this.path=[],this.receivedTime=d(),this.returnValue=!0,this.srcElement=t,this.target=t,this.timeStamp=this.receivedTime,this.type="midimessage"}function ee(t,e){t.onstatechange&&t.onstatechange(new $t(t,t)),e.onstatechange&&e.onstatechange(new $t(t,e))}function ie(t,e){var i=this,n=!1,s=null,o=null;this.type="input",this.id=e.id,this.name=e.name,this.manufacturer=e.man,this.version=e.ver,Object.defineProperty(this,"state",{get:function(){return e.connected?"connected":"disconnected"},enumerable:!0}),Object.defineProperty(this,"connection",{get:function(){return n?e.proxy?"open":"pending":"closed"},enumerable:!0}),Object.defineProperty(this,"onmidimessage",{get:function(){return o},set:function(t){t instanceof Function?(o=t,n||i.open()):o=null},enumerable:!0}),Object.defineProperty(this,"onstatechange",{get:function(){return s},set:function(t){s=t instanceof Function?t:null},enumerable:!0}),this.open=function(){return new Jt((function(s,o){n?s(i):e.open().then((function(){n||(n=!0,ee(i,t)),s(i)}),(function(){o(new Zt("InvalidAccessError","Port is not available",15))}))}))},this.close=function(){return new Jt((function(s){n&&(n=!1,e.close(),ee(i,t)),s(i)}))},Object.freeze(this)}function ne(t){for(var e,i;t.length;){for(e=0;e<t.length&&!(t[e]==parseInt(t[e])&&t[e]>=128&&t[e]<=255&&247!=t[e]);e++);if(t.splice(0,e),!t.length)return;if(240==t[0]){for(e=1;e<t.length&&247!=t[e];e++);if(e==t.length)return;return t.splice(0,e+1)}if((i=oe(t[0])+1)>t.length)return;for(e=1;e<i&&!(t[e]!=parseInt(t[e])||t[e]<0||t[e]>=128);e++);if(e==i)return t.splice(0,e);t.splice(0,e)}}function se(t,e,i,s){var o=this;this.id=t,this.name=e,this.man=i,this.ver=s,this.connected=!0,this.ports=[],this.pending=[],this.proxy=void 0,this.queue=[],this.onmidi=function(t){var e;for(o.queue=o.queue.concat(t.slice()),e=ne(o.queue);e;e=ne(o.queue))for(n=0;n<o.ports.length;n++)o.ports[n][0].onmidimessage&&(240!=e[0]||o.ports[n][1])&&o.ports[n][0].onmidimessage(new te(o,new Uint8Array(e)))}}function oe(t){return t>=128&&t<=191||t>=224&&t<=239||242==t?2:t>=192&&t<=223||241==t||243==t?1:0}"function"!=typeof Jt&&((Jt=function(t){this.executor=t}).prototype.then=function(t,e){"function"!=typeof t&&(t=function(){}),"function"!=typeof e&&(e=function(){}),this.executor(t,e)}),se.prototype.open=function(){var t=this;return new Jt((function(e,i){var n;t.proxy||!t.connected?e():(t.pending.push([e,i]),1==t.pending.length&&ut().openMidiIn(t.name).or((function(){for(n=0;n<t.pending.length;n++)t.pending[n][1]();t.pending=[]})).and((function(){for(t.proxy=this,t.proxy.connect(t.onmidi),n=0;n<t.pending;n++)t.pending[n][0]();t.pending=[]})))}))},se.prototype.close=function(){var t;if(this.proxy){for(t=0;t<this.ports.length;t++)if("open"==this.ports[t].connection)return;this.proxy.close(),this.proxy=void 0}},se.prototype.disconnect=function(){this.connected=!1,this.proxy&&(this.proxy.close(),this.proxy=void 0)},se.prototype.reconnect=function(){var t,e,i=this,n=[];for(this.connected=!0,t=0;t<Qt.length;t++)"closed"==(e=Qt[t].inputs.get(this.id)).connection?ee(e,Qt[t]):n.push([e,Qt[t]]);n.length&&ut()._openMidiInNR(i.name).or((function(){for(t=0;t<n.length;t++)n[t][0].close()})).and((function(){for(i.proxy=this,i.proxy.connect(i.onmidi),t=0;t<n.length;t++)ee(n[t][0],n[t][1])}))};var re="Failed to execute 'send' on 'MIDIOutput': ";function ae(t,e){var i=this,n=!1,s=null;this.type="output",this.id=e.id,this.name=e.name,this.manufacturer=e.man,this.version=e.ver,Object.defineProperty(this,"state",{get:function(){return e.connected?"connected":"disconnected"},enumerable:!0}),Object.defineProperty(this,"connection",{get:function(){return n?e.proxy?"open":"pending":"closed"},enumerable:!0}),Object.defineProperty(this,"onstatechange",{get:function(){return s},set:function(t){s=t instanceof Function?t:null},enumerable:!0}),this.open=function(){return new Jt((function(s,o){n?s(i):e.open().then((function(){n||(n=!0,ee(i,t)),s(i)}),(function(){o(new Zt("InvalidAccessError","Port is not available",15))}))}))},this.close=function(){return new Jt((function(s){n&&(n=!1,i.clear(),e.close(),ee(i,t)),s(i)}))},this.clear=function(){},this.send=function(s,o){if(function(t,e){var i,n,s,o=[];for(i=0;i<t.length;i++)if(t[i]!=parseInt(t[i])||t[i]<0||t[i]>255)throw TypeError(re+t[i]+" is not a UInt8 value.");for(n=0,i=0;i<t.length;i++)if(n){if(t[i]>127)throw TypeError(re+"Unexpected status byte at index "+i+" ("+t[i]+").");s.push(t[i]),n--}else{if(t[i]<128)throw TypeError(re+"Running status is not allowed at index "+i+" ("+t[i]+").");if(247==t[i])throw TypeError(re+"Unexpected end of system exclusive message at index "+i+" ("+t[i]+").");if(s=[t[i]],o.push(s),240==t[i]){if(!e)throw new Zt("InvalidAccessError",re+"System exclusive messag is not allowed at index "+i+" ("+t[i]+").",15);for(n=-1;i<t.length;i++)if(s.push(t[i]),247==t[i]){n=0;break}}else n=oe(t[i])}if(n)throw TypeError(re+"Message is incomplete")}(s,t.sysexEnabled),!e.connected)throw new Zt("InvalidStateError","Port is not connected",11);if(n){var r=d();o>r?setTimeout((function(){e.proxy.send(s)}),o-r):e.proxy.send(s)}else this.open().then((function(){i.send(s,o)}))},Object.freeze(this)}function ce(t,e,i,n){this.id=t,this.name=e,this.man=i,this.ver=n,this.connected=!0,this.ports=[],this.pending=[],this.proxy=void 0}function he(t){this.has=function(e){return t.hasOwnProperty(e)&&t[e].connected},this.keys=function(){try{var e=new Map;for(var i in t)this.has(i)&&e.set(i,this.get(i));return e.keys()}catch(t){}},this.values=function(){try{var e=new Map;for(var i in t)this.has(i)&&e.set(i,this.get(i));return e.values()}catch(t){}},this.entries=function(){try{var e=new Map;for(var i in t)this.has(i)&&e.set(i,this.get(i));return e.entries()}catch(t){}},this.forEach=function(e,i){for(var n in void 0===i&&(i=this),t)this.has(n)&&e.call(i,this.get(n),n,this)},Object.defineProperty(this,"size",{get:function(){var e=0;for(var i in t)this.has(i)&&e++;return e},enumerable:!0})}function ue(t,e){this.get=function(i){if(Kt.hasOwnProperty(i)&&Kt[i].connected)return e[i]||(e[i]=new ie(t,Kt[i]),Kt[i].ports.push([e[i],t.sysexEnabled])),e[i]},Object.freeze(this)}function de(t,e){this.get=function(i){if(Yt.hasOwnProperty(i)&&Yt[i].connected)return e[i]||(e[i]=new ae(t,Yt[i]),Yt[i].ports.push([e[i],t.sysexEnabled])),e[i]},Object.freeze(this)}function pe(t){var e,i,n,s;for(e=0;e<t.inputs.added.length;e++)n=t.inputs.added[e],Kt.hasOwnProperty(n.id)||(Kt[n.id]=new se(n.id,n.name,n.manufacturer,n.version)),Kt[n.id].reconnect();for(e=0;e<t.outputs.added.length;e++)n=t.outputs.added[e],Yt.hasOwnProperty(n.id)||(Yt[n.id]=new ce(n.id,n.name,n.manufacturer,n.version)),Yt[n.id].reconnect();for(e=0;e<t.inputs.removed.length;e++)if(n=t.inputs.removed[e],Kt.hasOwnProperty(n.id)){for(s=[],i=0;i<Qt.length;i++)s.push([Qt[i].inputs.get(n.id),Qt[i]]);for(Kt[n.id].disconnect(),i=0;i<s.length;i++)ee(s[i][0],s[i][1])}for(e=0;e<t.outputs.removed.length;e++)if(n=t.outputs.removed[e],Yt.hasOwnProperty(n.id)){for(s=[],i=0;i<Qt.length;i++)s.push([Qt[i].outputs.get(n.id),Qt[i]]);for(Yt[n.id].disconnect(),i=0;i<s.length;i++)ee(s[i][0],s[i][1])}}function le(t){var e,i,n=null;this.sysexEnabled=t,this.inputs=new ue(this,{}),this.outputs=new de(this,{}),Object.defineProperty(this,"onstatechange",{get:function(){return n},set:function(t){n=t instanceof Function?t:null},enumerable:!0}),Object.freeze(this);var s=_._info;for(e=0;e<s.inputs.length;e++)i=s.inputs[e],Kt.hasOwnProperty(i.id)||(Kt[i.id]=new se(i.id,i.name,i.manufacturer,i.version));for(e=0;e<s.outputs.length;e++)i=s.outputs[e],Yt.hasOwnProperty(i.id)||(Yt[i.id]=new ce(i.id,i.name,i.manufacturer,i.version));Qt.length||ut().onChange(pe),Qt.push(this)}return ce.prototype.open=function(){var t=this;return new Jt((function(e,i){var n;t.proxy||!t.connected?e():(t.pending.push([e,i]),1==t.pending.length&&ut().openMidiOut(t.name).or((function(){for(n=0;n<t.pending.length;n++)t.pending[n][1]();t.pending=[]})).and((function(){for(t.proxy=this,n=0;n<t.pending.length;n++)t.pending[n][0]();t.pending=[]})))}))},ce.prototype.close=function(){var t;if(this.proxy){for(t=0;t<this.ports.length;t++)if("open"==this.ports[t].connection)return;this.proxy.close(),this.proxy=void 0}},ce.prototype.disconnect=function(){this.connected=!1,this.proxy&&(this.proxy.close(),this.proxy=void 0)},ce.prototype.reconnect=function(){var t,e,i=this,n=[];for(this.connected=!0,t=0;t<Qt.length;t++)"closed"==(e=Qt[t].outputs.get(this.id)).connection?ee(e,Qt[t]):n.push([e,Qt[t]]);n.length&&ut()._openMidiOutNR(i.name).or((function(){for(t=0;t<n.length;t++)n[t][0].close()})).and((function(){for(i.proxy=this,t=0;t<n.length;t++)ee(n[t][0],n[t][1])}))},ue.prototype=new he(Kt),ue.prototype.constructor=ue,de.prototype=new he(Yt),de.prototype.constructor=de,ut.requestMIDIAccess=function(t){return new Jt((function(e,i){ut.JZZ(t).or((function(){})).and((function(){var n=!(!t||!t.sysex);if(n&&!this.info().sysex)i(new Zt("SecurityError","Sysex is not allowed",18));else{var s=new le(n);e(s)}}))}))},"undefined"==typeof navigator||navigator.requestMIDIAccess||(navigator.requestMIDIAccess=ut.requestMIDIAccess),ut.close=function(){Z._close&&Z._close()},ut},t.exports=n()}).call(this,i(3))},function(t,e){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(t){"object"==typeof window&&(i=window)}t.exports=i},function(t,e,i){(function(e){var n="./bin/",s=e.versions.node.split(".");0==s[0]&&s[1]<=10?n+="0_10/":0==s[0]&&s[1]<=12?n+="0_12/":s[0]<=4?n+="4_9/":s[0]<=5?n+="5_12/":s[0]<=6?n+="6_14/":s[0]<=7?n+="7_10/":s[0]<=8?n+="8_12/":s[0]<=9?n+="9_11/":s[0]<=10?n+="10_15/":s[0]<=11&&(n+="11_14/"),"win32"==e.platform&&"ia32"==e.arch?n+="win32/jazz":"win32"==e.platform&&"x64"==e.arch?n+="win64/jazz":"darwin"==e.platform&&"x64"==e.arch?n+="macos64/jazz":"darwin"==e.platform&&"ia32"==e.arch?n+="macos32/jazz":"linux"==e.platform&&"x64"==e.arch?n+="linux64/jazz":"linux"==e.platform&&"ia32"==e.arch?n+="linux32/jazz":"linux"==e.platform&&"arm"==e.arch&&(n+="linuxa7/jazz"),t.exports=i(6)(n),t.exports.package=i(7)}).call(this,i(5))},function(t,e){var i,n,s=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function a(t){if(i===setTimeout)return setTimeout(t,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(t,0);try{return i(t,0)}catch(e){try{return i.call(null,t,0)}catch(e){return i.call(this,t,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:o}catch(t){i=o}try{n="function"==typeof clearTimeout?clearTimeout:r}catch(t){n=r}}();var c,h=[],u=!1,d=-1;function p(){u&&c&&(u=!1,c.length?h=c.concat(h):d=-1,h.length&&l())}function l(){if(!u){var t=a(p);u=!0;for(var e=h.length;e;){for(c=h,h=[];++d<e;)c&&c[d].run();d=-1,e=h.length}c=null,u=!1,function(t){if(n===clearTimeout)return clearTimeout(t);if((n===r||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(t);try{n(t)}catch(e){try{return n.call(null,t)}catch(e){return n.call(this,t)}}}(t)}}function f(t,e){this.fun=t,this.array=e}function m(){}s.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];h.push(new f(t,e)),1!==h.length||u||a(l)},f.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=m,s.addListener=m,s.once=m,s.off=m,s.removeListener=m,s.removeAllListeners=m,s.emit=m,s.prependListener=m,s.prependOnceListener=m,s.listeners=function(t){return[]},s.binding=function(t){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(t){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},function(t,e){function i(t){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}i.keys=function(){return[]},i.resolve=i,t.exports=i,i.id=6},function(t){t.exports=JSON.parse('{"name":"jazz-midi","version":"1.7.0","author":"jazz-soft (http://jazz-soft.net)","contributors":["sema (http://jazz-soft.net)"],"description":"Low-level MIDI support for Node.js","main":"index.js","scripts":{"test":"node test.js"},"repository":"","keywords":["midi","MIDI","music","sound"],"homepage":"http://jazz-soft.net","bugs":{"url":"http://jazz-soft.org"},"license":"MIT","_resolved":"https://registry.npmjs.org/jazz-midi/-/jazz-midi-1.7.0.tgz","_integrity":"sha512-9t1Hpc89HQB8oxDPZaWSSjSWEfVJAhnd4t66HUUAIFpps3JLT/Czs0/tOtnAwPSiAzAUUfcbGZpbr5kEqOLf+w==","_from":"jazz-midi@1.7.0"}')},,,,,function(t,e,i){"use strict";i.r(e);var n=i(0);i(2);window.onload=async()=>{await n.a.ready();const t=document.getElementById("stop"),e=document.getElementById("start");s(!1),n.a.addAssetPack({url:"/heartbeat/assets/examples/asset_pack_basic.json"},()=>{n.a.loadMusicXML("/heartbeat/assets/reunion.xml",i=>{i.tracks.forEach(t=>{t.setInstrument("piano")}),e.addEventListener("click",()=>{i.play()}),t.addEventListener("click",()=>{i.stop()}),s(!0)})})};const s=t=>{const e=document.querySelectorAll("input"),i=e.length;for(let n=0;n<i;n++){e[n].disabled=!t}}}]);